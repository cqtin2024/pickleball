<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TKD PICKLEBALL CHAMPIONSHIP 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f0f4f8; overflow-x: hidden; }
    #content-carousel { display: flex; width: 200vw; transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1); }
    .swipe-section { width: 100vw; flex-shrink: 0; padding: 1rem; min-height: calc(100vh - 160px); overflow-y: auto; }
    #refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; background-color: #0284c7; color: white; font-weight: bold; padding: 14px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
    #refresh-btn:hover { transform: scale(1.1); background-color: #0369a1; }
    .winner-glow { animation: glow 1s ease-in-out 2 alternate; }
    @keyframes glow { from { box-shadow: 0 0 10px #00e676; } to { box-shadow: 0 0 25px #00e676; } }
    .top1 { background-color: #d1fae5; font-weight: 700; animation: pulse1 1s ease-in-out infinite alternate; }
    .top2 { background-color: #e0f2fe; font-weight: 600; animation: pulse2 1s ease-in-out infinite alternate; }
    @keyframes pulse1 { from { box-shadow: 0 0 10px #22c55e; } to { box-shadow: 0 0 25px #22c55e; } }
    @keyframes pulse2 { from { box-shadow: 0 0 10px #0ea5e9; } to { box-shadow: 0 0 25px #0ea5e9; } }
  </style>
</head>
<body class="font-sans">
  <header class="fixed top-0 left-0 right-0 z-30 bg-white shadow-md p-4">
    <h1 class="text-xl font-extrabold text-blue-800 text-center">üèÜ TKD PICKLEBALL CHAMPIONSHIP 2025</h1>
    <p class="text-center text-gray-600 text-sm">Ng√†y 18/10/2025</p>
    <div id="tab-controls" class="flex justify-around mt-3 mb-2 max-w-lg mx-auto">
      <button onclick="goToSection(0)" class="tab-btn active px-4 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white">V√≤ng B·∫£ng</button>
      <button onclick="goToSection(1)" class="tab-btn px-4 py-2 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">Knock-out</button>
    </div>
    <div id="statusMessage" class="text-center text-sm font-medium text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  </header>

  <main id="main-content-wrapper" class="pt-[180px] md:pt-[150px] overflow-hidden">
    <div id="content-carousel">
      <section class="swipe-section" id="rounds"></section>
      <section class="swipe-section" id="knockout"></section>
    </div>
  </main>

  <button id="refresh-btn" title="T·∫£i l·∫°i d·ªØ li·ªáu" onclick="manualRefresh()">‚ü≥</button>

  <script>
    const BASE_URL = window.location.hostname.includes('github.io') ? './data/state.json' : 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
    const REFRESH_INTERVAL = 30000;

    const carousel = document.getElementById('content-carousel');
    let currentIndex = 0;
    let startX = 0, deltaX = 0, isSwiping = false, velocity = 0, lastX = 0, lastTime = 0;
    let lastWinner = null;

    if ('Notification' in window && Notification.permission !== 'granted') {
      Notification.requestPermission();
    }

    function sendNotification(title, body) {
      if (Notification.permission === 'granted') {
        new Notification(title, { body });
      }
    }

    function goToSection(index) {
      currentIndex = Math.max(0, Math.min(1, index));
      carousel.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)';
      carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
      updateTabs();
    }

    function updateTabs() {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.toggle('bg-blue-600', i === currentIndex);
        btn.classList.toggle('text-white', i === currentIndex);
        btn.classList.toggle('bg-blue-100', i !== currentIndex);
        btn.classList.toggle('text-blue-800', i !== currentIndex);
      });
    }

    function handleTouchStart(e) {
      startX = e.touches ? e.touches[0].clientX : e.clientX;
      isSwiping = true;
      velocity = 0;
      lastX = startX;
      lastTime = Date.now();
      carousel.style.transition = 'none';
    }

    function handleTouchMove(e) {
      if (!isSwiping) return;
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      deltaX = x - startX;
      const now = Date.now();
      velocity = (x - lastX) / (now - lastTime);
      lastX = x; lastTime = now;
      carousel.style.transform = `translateX(calc(${currentIndex * -100}vw + ${deltaX}px))`;
    }

    function handleTouchEnd() {
      if (!isSwiping) return;
      isSwiping = false;
      const threshold = 60;
      if (deltaX < -threshold || velocity < -0.5) currentIndex = Math.min(1, currentIndex + 1);
      else if (deltaX > threshold || velocity > 0.5) currentIndex = Math.max(0, currentIndex - 1);
      goToSection(currentIndex);
      deltaX = 0;
    }

    carousel.addEventListener('touchstart', handleTouchStart);
    carousel.addEventListener('touchmove', handleTouchMove);
    carousel.addEventListener('touchend', handleTouchEnd);
    carousel.addEventListener('mousedown', handleTouchStart);
    window.addEventListener('mousemove', e => { if (isSwiping) handleTouchMove(e); });
    window.addEventListener('mouseup', handleTouchEnd);

    async function fetchData() {
      const msg = document.getElementById('statusMessage');
      msg.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
      try {
        const res = await fetch(BASE_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i file JSON');
        const data = await res.json();
        msg.textContent = 'ƒê√£ t·∫£i d·ªØ li·ªáu (' + new Date().toLocaleTimeString('vi-VN') + ')';
        renderData(data);
        checkForFinalWinner(data.final);
      } catch (err) {
        msg.textContent = '‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu: ' + err.message;
      }
    }

    function checkForFinalWinner(final) {
      if (final && final.winner && final.winner !== lastWinner) {
        lastWinner = final.winner;
        const finalBox = document.querySelector('#knockout .winner-box');
        if (finalBox) finalBox.classList.add('winner-glow');
        sendNotification('K·∫øt qu·∫£ m·ªõi!', `üèÜ ${final.winner} ƒë√£ v√¥ ƒë·ªãch gi·∫£i ƒë·∫•u!`);
      }
    }

    function manualRefresh() {
      document.getElementById('refresh-btn').classList.add('animate-spin');
      fetchData().finally(() => {
        setTimeout(() => document.getElementById('refresh-btn').classList.remove('animate-spin'), 800);
      });
    }

    function renderData(data) {
      renderRounds(data);
      renderKnockout(data.semifinals, data.final);
    }

    function renderRounds(data) {
      const container = document.getElementById('rounds');
      container.innerHTML = `<h2 class='text-2xl font-bold text-blue-700 mb-3 text-center'>V√≤ng B·∫£ng</h2>`;
      container.innerHTML += renderTable(data.tableA, 'B·∫£ng A');
      container.innerHTML += renderTable(data.tableB, 'B·∫£ng B');
      container.innerHTML += renderMatchList(data.matchesA, 'K·∫øt qu·∫£ B·∫£ng A');
      container.innerHTML += renderMatchList(data.matchesB, 'K·∫øt qu·∫£ B·∫£ng B');
    }

    function renderTable(table, title) {
      if (!table) return '';
      let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr>`;
      const headers = Object.keys(table[0]);
      headers.forEach(h => html += `<th class='px-3 py-2'>${h}</th>`);
      html += '</tr></thead><tbody class="bg-white divide-y divide-gray-100">';
      table.forEach((row, i) => {
        let rowClass = '';
        if (i === 0) rowClass = 'top1';
        else if (i === 1) rowClass = 'top2';
        html += `<tr class='hover:bg-blue-50 ${rowClass}'>`;
        headers.forEach(h => html += `<td class='px-3 py-2 text-center'>${row[h]}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table></div></div>';
      return html;
    }

    function renderMatchList(matches, title) {
      if (!matches) return '';
      let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th>T·ªâ s·ªë</th><th>ƒê·ªôi B</th></tr></thead><tbody>`;
      matches.forEach(m => {
        const teamAClass = m.winner === m.teamA ? 'text-green-700 font-bold' : '';
        const teamBClass = m.winner === m.teamB ? 'text-green-700 font-bold' : '';
        html += `<tr class='hover:bg-blue-50'><td class='px-3 py-2 text-center'>${m.time}</td><td class='text-center'>${m.court}</td><td class='${teamAClass}'>${m.teamA}</td><td class='text-center'>${m.scoreA} - ${m.scoreB}</td><td class='${teamBClass}'>${m.teamB}</td></tr>`;
      });
      html += '</tbody></table></div></div>';
      return html;
    }

    function renderKnockout(semis, final) {
      const container = document.getElementById('knockout');
      let html = `<h2 class='text-2xl font-bold text-blue-700 mb-3 text-center'>Knock-out</h2>`;
      if (semis) html += renderMatchList(semis, 'B√°n K·∫øt');
      if (final) {
        html += `<div class='winner-box bg-white p-4 mt-4 rounded-xl shadow text-center'>
          <h3 class='text-lg font-semibold text-blue-800 mb-2'>Chung K·∫øt</h3>
          <p><strong>${final.teamA}</strong> (${final.scoreA}) vs (${final.scoreB}) <strong>${final.teamB}</strong></p>
          <p class='mt-2 text-green-600 font-semibold'>üèÜ V√¥ ƒë·ªãch: ${final.winner}</p>
          <p class='text-gray-700'>√Å qu√¢n: ${final.runnerUp}</p>
        </div>`;
      }
      container.innerHTML = html;
    }

    setInterval(fetchData, REFRESH_INTERVAL);
    fetchData();
  </script>
</body>
</html>
