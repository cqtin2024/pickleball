<script>
const BASE_URL = window.location.hostname.includes('github.io')
  ? './data/state.json'
  : 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';

const REFRESH_INTERVAL = 30000;
const carousel = document.getElementById('content-carousel');
let currentIndex = 0;
let startX = 0, deltaX = 0, isSwiping = false;

// ==== TAB & CAROUSEL ====
function goToSection(index) {
  currentIndex = Math.max(0, Math.min(2, index));
  carousel.style.transition = 'transform 0.35s cubic-bezier(0.25,1,0.5,1)';
  carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
  updateTabs();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateTabs() {
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.remove('active-knockout', 'active-pick', 'bg-blue-600', 'text-white');
    if (i === currentIndex) {
      if (i === 0) btn.classList.add('bg-blue-600', 'text-white');
      if (i === 1) btn.classList.add('active-knockout');
      if (i === 2) btn.classList.add('active-pick');
    }
  });
}

// ==== SWIPE HANDLERS ====
carousel.addEventListener('touchstart', e => {
  startX = e.touches[0].clientX;
  deltaX = 0;
  isSwiping = true;
  carousel.style.transition = 'none';
});

carousel.addEventListener('touchmove', e => {
  if (!isSwiping) return;
  const x = e.touches[0].clientX;
  deltaX = x - startX;
  carousel.style.transform = `translateX(${currentIndex * -100 + deltaX / window.innerWidth * 100}vw)`;
});

carousel.addEventListener('touchend', e => {
  isSwiping = false;
  carousel.style.transition = 'transform 0.35s cubic-bezier(0.25,1,0.5,1)';
  if (deltaX > 50) goToSection(currentIndex - 1);
  else if (deltaX < -50) goToSection(currentIndex + 1);
  else goToSection(currentIndex);
});

// ==== FETCH & REFRESH ====
async function fetchData() {
  const msg = document.getElementById('statusMessage');
  msg.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
  try {
    const res = await fetch(BASE_URL, { cache: 'no-store' });
    const data = await res.json();
    msg.textContent = 'ƒê√£ t·∫£i d·ªØ li·ªáu (' + new Date().toLocaleTimeString('vi-VN') + ')';
    renderData(data);
  } catch (err) {
    msg.textContent = '‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu: ' + err.message;
  }
}

function manualRefresh() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('animate-spin');
  fetchData().finally(() => setTimeout(() => btn.classList.remove('animate-spin'), 800));
}

setInterval(fetchData, REFRESH_INTERVAL);
fetchData();

// ==== RENDER DATA ====
function renderData(data) {
  renderRounds(data);
  renderKnockout(data.semifinals, data.final);
  renderPlayers(data);
}

// ---- V√íNG B·∫¢NG ----
function renderRounds(data) {
  const c = document.getElementById('rounds');
  c.innerHTML = `<h2 class='text-2xl font-bold text-blue-700 mb-3 text-center'>V√≤ng B·∫£ng</h2>` +
    renderTable(data.tableA, 'B·∫£ng A') +
    renderTable(data.tableB, 'B·∫£ng B') +
    renderMatchList(data.matchesA, 'K·∫øt qu·∫£ B·∫£ng A') +
    renderMatchList(data.matchesB, 'K·∫øt qu·∫£ B·∫£ng B');
}

function renderTable(table, title) {
  if (!table || table.length === 0) return '';
  let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
  const headers = Object.keys(table[0]).filter(h => h !== 'matchesPlayed');
  html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr>` +
    headers.map(h => `<th class='px-3 py-2'>${h}</th>`).join('') +
    `</tr></thead><tbody class='bg-white divide-y divide-gray-100'>`;
  table.forEach((row, i) => {
    let rowClass = i === 0 ? 'top1' : i === 1 ? 'top2' : '';
    html += `<tr class='hover:bg-blue-50 ${rowClass}'>` +
      headers.map(h => `<td class='px-3 py-2 text-center'>${row[h]}</td>`).join('') +
      `</tr>`;
  });
  html += '</tbody></table></div></div>';
  return html;
}

function renderMatchList(matches, title) {
  if (!matches || matches.length === 0) return '';
  let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
  html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th>T·ªâ s·ªë</th><th>ƒê·ªôi B</th></tr></thead><tbody>`;
  matches.forEach(m => {
    const aClass = m.winner === m.teamA ? 'text-green-700 font-bold' : '';
    const bClass = m.winner === m.teamB ? 'text-green-700 font-bold' : '';
    html += `<tr class='hover:bg-blue-50'><td class='px-3 py-2 text-center'>${m.time}</td><td>${m.court}</td><td class='${aClass}'>${m.teamA}</td><td class='text-center'>${m.scoreA} - ${m.scoreB}</td><td class='${bClass}'>${m.teamB}</td></tr>`;
  });
  html += '</tbody></table></div></div>';
  return html;
}

// ---- KNOCK-OUT ----
function renderKnockout(semis, final) {
  const c = document.getElementById('knockout');
  let html = `<h2 class='text-2xl font-bold text-green-700 mb-3 text-center'>Knock-out</h2>`;
  if (semis) html += renderMatchList(semis, 'B√°n K·∫øt');
  if (final) {
    html += `<div class='winner-box bg-white p-4 mt-4 rounded-xl shadow text-center'>
      <h3 class='text-lg font-semibold text-green-800 mb-2'>Chung K·∫øt</h3>
      <p><strong>${final.teamA}</strong> (${final.scoreA}) vs (${final.scoreB}) <strong>${final.teamB}</strong></p>
      <p class='mt-2 text-green-600 font-semibold winner-glow'>üèÜ V√¥ ƒë·ªãch: ${final.winner}</p>
      <p class='text-gray-700'>√Å qu√¢n: ${final.runnerUp}</p>
    </div>`;
  }
  c.innerHTML = html;
}

// ---- PICK TH·ª¶ ----
function renderPlayers(data) {
  const c = document.getElementById('players');
  c.innerHTML = `<h2 class='text-2xl font-bold text-yellow-700 mb-3 text-center'>Pick th·ªß</h2>`;
  c.innerHTML += renderTeamsList(data.mixedTeams, 'B·∫£ng A - Mixed');
  c.innerHTML += renderTeamsList(data.maleTeams, 'B·∫£ng B - Nam');
}

function renderTeamsList(teams, title) {
  if (!teams || teams.length === 0) return '';
  let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3><ul class='grid grid-cols-2 md:grid-cols-3 gap-2 text-center'>`;
  teams.forEach(t => html += `<li class='bg-yellow-50 rounded-md py-2 font-medium'>${t}</li>`);
  html += '</ul></div>';
  return html;
}
</script>
