<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TKD PICKLEBALL CHAMPIONSHIP 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f0f4f8; overflow-x: hidden; }
    #content-carousel { display: flex; width: 400vw; transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1); }
    .swipe-section { width: 100vw; flex-shrink: 0; padding: 1rem; min-height: calc(100vh - 160px); overflow-y: auto; }
    #refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; background-color: #0284c7; color: white; font-weight: bold; padding: 14px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
    #refresh-btn:hover { transform: scale(1.1); background-color: #0369a1; }
    .top1 { background-color: #d1fae5; font-weight: 700; animation: pulse1 1s ease-in-out infinite alternate; }
    .top2 { background-color: #e0f2fe; font-weight: 600; animation: pulse2 1s ease-in-out infinite alternate; }
    @keyframes pulse1 { from { box-shadow: 0 0 10px #22c55e; } to { box-shadow: 0 0 25px #22c55e; } }
    @keyframes pulse2 { from { box-shadow: 0 0 10px #0ea5e9; } to { box-shadow: 0 0 25px #0ea5e9; } }
    .tab-btn.active-knockout { background: linear-gradient(to right, #22c55e, #16a34a); color: #fff !important; box-shadow: 0 0 10px rgba(34,197,94,0.7); }
    .tab-btn.active-pick { background: linear-gradient(to right, #f59e0b, #d97706); color: white !important; box-shadow: 0 0 10px rgba(245,158,11,0.6); }
    /* Giảm padding và font size cho bảng xếp hạng trên mobile */
    table.compact th, table.compact td { padding: 4px 4px !important; font-size: 12px !important; }
    /* Tên đội được phép xuống dòng */
    table.compact .team-name-cell { min-width: 70px; }

    .champion-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #facc15; animation: glowGold 2s infinite alternate; }
    .runnerup-box { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #9ca3af; animation: glowSilver 2s infinite alternate; }
    @keyframes glowGold { from { box-shadow: 0 0 10px #facc15; } to { box-shadow: 0 0 25px #fbbf24; } }
    @keyframes glowSilver { from { box-shadow: 0 0 10px #9ca3af; } to { box-shadow: 0 0 25px #d1d5db; } }
  </style>
</head>
<body class="font-sans">
  <header class="fixed top-0 left-0 right-0 z-30 bg-white shadow-md p-4">
    <div class="flex items-center justify-center mb-1">
      <img src="https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/logoTKD.png" alt="Logo TKD" class="h-14 w-auto mr-2" />
      <h1 class="text-lg font-extrabold text-blue-800 text-center">TKD PICKLEBALL CHAMPIONSHIP 2025</h1>
    </div>
    <p class="text-center text-gray-600 text-xs">Ngày 18/10/2025</p>
    <div id="tab-controls" class="flex justify-start overflow-x-auto flex-nowrap mt-2 mb-2 mx-auto space-x-2 p-1">
      <button onclick="goToSection(0)" class="tab-btn active-pick flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full">Pick thủ</button>
      <button onclick="goToSection(1)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white">Bảng A</button>
      <button onclick="goToSection(2)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white">Bảng B</button>
      <button onclick="goToSection(3)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full bg-green-100 text-green-800">Knock-out</button>
    </div>
    <div id="statusMessage" class="text-center text-xs font-medium text-gray-600">Đang tải dữ liệu...</div>
  </header>

  <main id="main-content-wrapper" class="pt-[140px] md:pt-[150px] overflow-hidden">
    <div id="content-carousel">
      <section class="swipe-section" id="players"></section>
      <section class="swipe-section" id="roundsA"></section>
      <section class="swipe-section" id="roundsB"></section>
      <section class="swipe-section" id="knockout"></section>
    </div>
  </main>

  <button id="refresh-btn" title="Tải lại dữ liệu" onclick="manualRefresh()">⟳</button>

  <script>
    const BASE_URL = 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
    const REFRESH_INTERVAL = 10000;
    const carousel = document.getElementById('content-carousel');
    let currentIndex = 0, startX = 0, endX = 0;

    function goToSection(index) {
      currentIndex = Math.max(0, Math.min(3, index));
      carousel.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)';
      carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
      updateTabs();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateTabs() {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.remove('active-knockout', 'active-pick', 'bg-blue-600', 'text-white', 'bg-green-100', 'text-green-800');
        if (i === currentIndex) {
          if (i === 1 || i === 2) btn.classList.add('bg-blue-600', 'text-white');
          if (i === 3) btn.classList.add('active-knockout');
          if (i === 0) btn.classList.add('active-pick');
        } else {
           // Đảm bảo tab không hoạt động có style mặc định
           if (i === 3) btn.classList.add('bg-green-100', 'text-green-800');
           else btn.classList.add('bg-blue-600', 'text-white');
        }
      });
    }

    carousel.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    carousel.addEventListener('touchend', e => {
      endX = e.changedTouches[0].clientX;
      const delta = endX - startX;
      if (Math.abs(delta) > 50) {
        if (delta > 0) goToSection(currentIndex - 1);
        else goToSection(currentIndex + 1);
      }
    });

    async function fetchData() {
      const msg = document.getElementById('statusMessage');
      msg.textContent = 'Đang tải dữ liệu...';
      try {
        const res = await fetch(BASE_URL, { cache: 'no-store' });
        const data = await res.json();
        msg.textContent = 'Đã tải dữ liệu (' + new Date().toLocaleTimeString('vi-VN') + ')';
        renderData(data);
      } catch (err) {
        msg.textContent = '⚠️ Lỗi tải dữ liệu: ' + err.message;
      }
    }

    function manualRefresh() {
      document.getElementById('refresh-btn').classList.add('animate-spin');
      fetchData().finally(() => setTimeout(() => document.getElementById('refresh-btn').classList.remove('animate-spin'), 800));
    }

    function renderData(data) {
      renderRound('roundsA', data.tableA, data.matchesA, 'A');
      renderRound('roundsB', data.tableB, data.matchesB, 'B');
      renderKnockout(data.semifinals, data.final);
      renderPlayers(data);
    }

    function computeTotalsForTeam(teamName, matches) {
      if (!Array.isArray(matches)) return { PF: 0, PA: 0, W: 0, L: 0 };
      let PF = 0, PA = 0, W = 0, L = 0;
      for (const m of matches) {
        if (!m) continue;
        const a = m.teamA, b = m.teamB;
        if (a === teamName) {
          PF += Number(m.scoreA || 0);
          PA += Number(m.scoreB || 0);
          if (m.winner === a) W++; else if (m.winner === b) L++;
        } else if (b === teamName) {
          PF += Number(m.scoreB || 0);
          PA += Number(m.scoreA || 0);
          if (m.winner === b) W++; else if (m.winner === a) L++;
        }
      }
      return { PF, PA, W, L };
    }

    function renderRound(id, table, matches, label) {
      const c = document.getElementById(id);
      c.innerHTML = `<h2 class='text-xl font-bold text-blue-700 mb-3 text-center'>Bảng ${label}</h2>`; // Giảm font size
      c.innerHTML += renderTable(table, `Bảng ${label}`, matches);
      c.innerHTML += renderMatchList(matches, `Kết quả Bảng ${label}`);
    }

    function renderPlayers(data) {
      const c = document.getElementById('players');
      c.innerHTML = `<h2 class='text-xl font-bold text-yellow-700 mb-3 text-center'>Pick thủ</h2>`; // Giảm font size
      c.innerHTML += renderTeamsList(data.mixedTeams, 'Bảng A - Mixed');
      c.innerHTML += renderTeamsList(data.maleTeams, 'Bảng B - Nam');
    }

    function renderTeamsList(teams, title) {
      if (!teams) return '';
      // Giảm padding và font size
      let html = `<div class='bg-white p-3 mt-3 rounded-xl shadow'><h3 class='text-base font-semibold text-blue-800 mb-2 text-center'>${title}</h3><ul class='grid grid-cols-2 md:grid-cols-3 gap-2 text-center'>`;
      // Giảm padding và font size
      teams.forEach(t => html += `<li class='bg-yellow-50 rounded-md py-1 text-sm font-medium'>${t}</li>`);
      html += '</ul></div>';
      return html;
    }

    function renderTable(table, title, matches) {
      if (!Array.isArray(table) || table.length === 0) return `<p class='text-center text-gray-500'>Chưa có dữ liệu bảng.</p>`;
      // Giảm padding và font size
      let html = `<div class='bg-white p-3 mt-3 rounded-xl shadow'><h3 class='text-base font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      const headers = ['Đội', 'T', 'B', 'PF', 'PA', '+/-'];
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-xs compact'><thead class='bg-blue-600 text-white'><tr>` +
        headers.map(h => `<th class='px-2 py-1 text-center whitespace-nowrap'>${h}</th>`).join('') + `</tr></thead><tbody class='bg-white divide-y divide-gray-100'>`;

      table.forEach((row, i) => {
        let teamName = typeof row === 'string' ? row : row.team || row.Team || row.name || 'Không xác định';
        const totals = computeTotalsForTeam(teamName, matches);
        const pf = totals.PF, pa = totals.PA, pd = pf - pa;
        const wins = totals.W, losses = totals.L;
        let rowClass = i === 0 ? 'top1' : i === 1 ? 'top2' : '';
        
        // Điều chỉnh cột tên đội để không dùng whitespace-nowrap
        html += `<tr class='hover:bg-blue-50 ${rowClass}'>
                    <td class='px-2 py-1 text-center team-name-cell'>${teamName}</td>
                    <td class='text-center whitespace-nowrap'>${wins}</td>
                    <td class='text-center whitespace-nowrap'>${losses}</td>
                    <td class='text-center whitespace-nowrap'>${pf}</td>
                    <td class='text-center whitespace-nowrap'>${pa}</td>
                    <td class='text-center font-semibold whitespace-nowrap'>${pd>0?`+${pd}`:pd}</td>
                  </tr>`;
      });

      html += '</tbody></table></div></div>';
      return html;
    }

    function renderMatchList(matches, title) {
      if (!matches) return '';
      // Giảm padding và font size
      let html = `<div class='bg-white p-3 mt-3 rounded-xl shadow'><h3 class='text-base font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      // Điều chỉnh header: Gộp Giờ & Sân, dùng font nhỏ hơn
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'>
                  <thead class='bg-blue-600 text-white'><tr><th>Thời gian/Sân</th><th>Đội A</th><th>Tỉ số</th><th>Đội B</th></tr></thead>
                  <tbody>`;
      matches.forEach(m => {
        const aClass = m.winner === m.teamA ? 'text-green-700 font-bold' : '';
        const bClass = m.winner === m.teamB ? 'text-green-700 font-bold' : '';
        
        // Điều chỉnh hiển thị trận đấu trên mobile: Gộp Giờ/Sân, giảm padding, tăng font tỉ số
        html += `<tr class='hover:bg-blue-50'>
                    <td class='px-1 py-1 text-center text-xs whitespace-nowrap'>${m.time}<br/>(${m.court})</td>
                    <td class='${aClass} text-sm'>${m.teamA}</td>
                    <td class='text-center text-sm font-bold whitespace-nowrap'>${m.scoreA} - ${m.scoreB}</td>
                    <td class='${bClass} text-sm'>${m.teamB}</td>
                  </tr>`;
      });
      html += '</tbody></table></div></div>';
      return html;
    }

    function renderKnockout(semis, final) {
      const c = document.getElementById('knockout');
      c.innerHTML = `<h2 class='text-xl font-bold text-green-700 mb-3 text-center'>Knock-out</h2>`; // Giảm font size
      if (semis) html += renderMatchList(semis, 'Bán Kết');
      if (final) {
        // Điều chỉnh kích thước box và font cho Vô Địch
        html += `<div class='winner-box champion-box p-4 mt-4 rounded-xl shadow text-center'>
          <h3 class='text-xl font-extrabold text-yellow-700 mb-2 animate-pulse'>🏆 Vô Địch</h3>
          <p class='text-base font-semibold text-gray-800 mb-1'>${final.winner}</p>
          <p class='text-xs text-gray-700'>${final.teamA} (${final.scoreA}) vs (${final.scoreB}) ${final.teamB}</p>
        </div>
        <div class='winner-box runnerup-box p-3 mt-3 rounded-xl shadow text-center'>
          <h3 class='text-lg font-semibold text-gray-700 mb-1'>🥈 Á Quân</h3>
          <p class='text-base font-medium text-gray-800'>${final.runnerUp}</p>
        </div>`;
      }
      if (Array.isArray(semis) && semis.length > 0) {
        const losers = semis.map(s => s.loser).filter(l => l);
        if (losers.length > 0) {
          // Giảm padding và font size
          html += `<div class='bg-amber-50 p-3 mt-3 rounded-xl shadow text-center'>
            <h3 class='text-base font-semibold text-amber-700 mb-2'>🥉 Giải Đồng hạng 3</h3>
            <p>${losers.join(' và ')}</p>
          </div>`;
        }
      }
      c.innerHTML += html;
    }

    // Khởi tạo đầu tiên và đặt hẹn giờ
    document.addEventListener('DOMContentLoaded', () => {
        updateTabs(); // Thiết lập tab ban đầu
        setInterval(fetchData, REFRESH_INTERVAL);
        fetchData();
    });
  </script>
</body>
</html>
