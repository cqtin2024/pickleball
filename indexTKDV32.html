<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 ‚Äî Qu·∫£n l√Ω gi·∫£i Pickleball V14 GitHub (Court Config)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px; /* Smaller input on mobile */
      }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="d-flex align-items-center mb-4">
    <img src="https://i.imgur.com/logo-url.png" alt="Logo" class="logo me-3">
    <div>
      <h2 class="mb-0">TKD Championship 2025</h2>
      <p class="status mb-0">H·ªá th·ªëng Qu·∫£n l√Ω Gi·∫£i ƒë·∫•u Pickleball</p>
    </div>
  </div>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bang-a-tab" data-bs-toggle="tab" data-bs-target="#bang-a-tab-pane" type="button" role="tab" aria-controls="bang-a-tab-pane" aria-selected="true">B·∫£ng A</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="bang-b-tab" data-bs-toggle="tab" data-bs-target="#bang-b-tab-pane" type="button" role="tab" aria-controls="bang-b-tab-pane" aria-selected="false">B·∫£ng B</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="lich-dau-tab" data-bs-toggle="tab" data-bs-target="#lich-dau-tab-pane" type="button" role="tab" aria-controls="lich-dau-tab-pane" aria-selected="false">L·ªãch ƒê·∫•u Chi Ti·∫øt</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="vong-loai-tab" data-bs-toggle="tab" data-bs-target="#vong-loai-tab-pane" type="button" role="tab" aria-controls="vong-loai-tab-pane" aria-selected="false">V√≤ng Lo·∫°i Tr·ª±c Ti·∫øp</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="bang-a-tab-pane" role="tabpanel" aria-labelledby="bang-a-tab" tabindex="0">
      <h4 class="mt-3">B·∫£ng x·∫øp h·∫°ng B·∫£ng A</h4>
      <div id="bxhA"></div>
      <h4 class="mt-3">K·∫øt qu·∫£ thi ƒë·∫•u B·∫£ng A</h4>
      <div id="ketQuaA"></div>
    </div>
    <div class="tab-pane fade" id="bang-b-tab-pane" role="tabpanel" aria-labelledby="bang-b-tab" tabindex="0">
      <h4 class="mt-3">B·∫£ng x·∫øp h·∫°ng B·∫£ng B</h4>
      <div id="bxhB"></div>
      <h4 class="mt-3">K·∫øt qu·∫£ thi ƒë·∫•u B·∫£ng B</h4>
      <div id="ketQuaB"></div>
    </div>
    <div class="tab-pane fade" id="lich-dau-tab-pane" role="tabpanel" aria-labelledby="lich-dau-tab" tabindex="0">
      <h4 class="mt-3">L·ªãch thi ƒë·∫•u t·∫•t c·∫£ c√°c tr·∫≠n</h4>
      <div id="lichDau"></div>
    </div>
    <div class="tab-pane fade" id="vong-loai-tab-pane" role="tabpanel" aria-labelledby="vong-loai-tab" tabindex="0">
      <h4 class="mt-3">V√≤ng B√°n k·∫øt</h4>
      <div id="semifinals"></div>
      <h4 class="mt-3">Tr·∫≠n Chung k·∫øt</h4>
      <div id="finalMatch"></div>
      <hr>
      <h4 class="mt-3">K·∫øt qu·∫£ chung cu·ªôc</h4>
      <div id="finalResults">
        <p id="champion"></p>
        <p id="runnerUp"></p>
        <p id="thirdPlace"></p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// D·ªØ li·ªáu l·ªãch c·ªë ƒë·ªãnh (ƒê√É C·∫¨P NH·∫¨T: V√≤ng B·∫£ng, B√°n k·∫øt, Chung k·∫øt)
const FIXED_SCHEDULE_CSV = `B·∫£ng,Gi·ªù,S√¢n,ƒê·ªôi A,ƒê·ªôi B,T·ªâ s·ªë A,T·ªâ s·ªë B,M√£ ƒê·ªôi A,M√£ ƒê·ªôi B,L∆∞·ª£t tr·∫≠n
A,14:00,S√¢n7,Huy·ªÅn/Lu√¢n,Linh/M.H√πng,,,A4,A5,1
A,14:00,S√¢n 2,Giang/Long,H∆∞·ªùng/ƒê·∫°t,,,A3,A6,1
A,14:00,S√¢n 3,H·∫≠u/D≈©ng,H·∫°nh/Ti·∫øn,,,A1,A2,1
A,14:15,S√¢n7,Giang/Long,Huy·ªÅn/Lu√¢n,,,A3,A4,2
A,14:15,S√¢n 3,H·∫≠u/D≈©ng,H∆∞·ªùng/ƒê·∫°t,,,A1,A6,2
A,14:30,S√¢n 3,H·∫°nh/Ti·∫øn,Linh/M.H√πng,,,A2,A5,3
A,14:45,S√¢n7,H·∫≠u/D≈©ng,Linh/M.H√πng,,,A1,A5,4
A,14:45,S√¢n 2,Huy·ªÅn/Lu√¢n,H∆∞·ªùng/ƒê·∫°t,,,A4,A6,4
A,14:45,S√¢n 3,H·∫°nh/Ti·∫øn,Giang/Long,,,A2,A3,4
A,15:15,S√¢n 3,Giang/Long,Linh/M.H√πng,,,A3,A5,6
A,15:30,S√¢n 2,H·∫°nh/Ti·∫øn,H∆∞·ªùng/ƒê·∫°t,,,A2,A6,6
A,15:30,S√¢n 3,H·∫≠u/D≈©ng,Huy·ªÅn/Lu√¢n,,,A1,A4,7
A,16:00,S√¢n 3,H·∫≠u/D≈©ng,Giang/Long,,,A1,A3,9
A,16:15,S√¢n 2,H·∫°nh/Ti·∫øn,Huy·ªÅn/Lu√¢n,,,A2,A4,10
A,16:15,S√¢n 3,Linh/M.H√πng,H∆∞·ªùng/ƒê·∫°t,,,A5,A6,10
B,14:00,S√¢n 1,Tri·ªÅu/Minh,Hi·ªÉn/P.H√πng,,,B3,B6,1
B,14:15,S√¢n 1,Ti·ªáp/Th·ªßy,Ph∆∞∆°ng/Thanh,,,B1,B2,2
B,14:15,S√¢n 2,T√≠n/Khi√™m,√Ånh/To√†n,,,B4,B5,2
B,14:30,S√¢n7,Ph∆∞∆°ng/Thanh,√Ånh/To√†n,,,B2,B5,3
B,14:30,S√¢n 1,Tri·ªÅu/Minh,T√≠n/Khi√™m,,,B3,B4,3
B,14:30,S√¢n 2,Ti·ªáp/Th·ªßy,Hi·ªÉn/P.H√πng,,,B1,B6,3
B,15:00,S√¢n 2,Ti·ªáp/Th·ªßy,√Ånh/To√†n,,,B1,B5,5
B,15:00,S√¢n 3,T√≠n/Khi√™m,Hi·ªÉn/P.H√πng,,,B4,B6,6
B,15:15,S√¢n 2,Ph∆∞∆°ng/Thanh,Tri·ªÅu/Minh,,,B2,B3,8
B,15:45,S√¢n 2,Ti·ªáp/Th·ªßy,T√≠n/Khi√™m,,,B1,B4,9
B,15:45,S√¢n 3,Ph∆∞∆°ng/Thanh,Hi·ªÉn/P.H√πng,,,B2,B6,10
B,16:00,S√¢n 2,Tri·ªÅu/Minh,√Ånh/To√†n,,,B3,B5,11
B,16:30,S√¢n 2,Ti·ªáp/Th·ªßy,Tri·ªÅu/Minh,,,B1,B3,11
B,16:30,S√¢n 3,√Ånh/To√†n,Hi·ªÉn/P.H√πng,,,B5,B6,12
B,16:45,S√¢n 2,Ph∆∞∆°ng/Thanh,T√≠n/Khi√™m,,,B2,B4,
BK_A,16:45,S√¢n 3,Nh·∫•t b·∫£ng A,Nh√¨ b·∫£ng A,,,,,12
BK_B,17:05,S√¢n 3,Nh·∫•t b·∫£ng B,Nh√¨ b·∫£ng B,,,,,13
CK,17:25,S√¢n 3,Th·∫Øng BKA,Th·∫Øng BK B,,,,,14`;

// Bi·∫øn state l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh c·ªßa ·ª©ng d·ª•ng.
let state = {
  roundRobinMatches: [],
  groups: { A: [], B: [] },
  players: [],
  // C·∫≠p nh·∫≠t D·ªØ li·ªáu V√≤ng Lo·∫°i Tr·ª±c Ti·∫øp theo y√™u c·∫ßu c·ªßa ng∆∞·ªùi d√πng
  semifinals: [
    { id: 'SF1', teamA: 'Nh·∫•t b·∫£ng A', teamB: 'Nh√¨ b·∫£ng A', scoreA: null, scoreB: null, time: '16:45', court: 'S√¢n 3', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nh·∫•t b·∫£ng B', teamB: 'Nh√¨ b·∫£ng B', scoreA: null, scoreB: null, time: '17:05', court: 'S√¢n 3', winner: null, loser: null }
  ],
  final: { 
    id: 'F', 
    teamA: 'Th·∫Øng BKA', 
    teamB: 'Th·∫Øng BKB', 
    scoreA: null, 
    scoreB: null, 
    time: '17:25', 
    court: 'S√¢n 3', 
    winner: null, 
    runnerUp: null 
  },
  config: {}
};

// =========================================================================
// C√ÅC H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU V√Ä GIAO DI·ªÜN (ƒê∆∞·ª£c gi·ªØ nguy√™n)
// =========================================================================

function docReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
        setTimeout(fn, 1);
    } else {
        document.addEventListener("DOMContentLoaded", fn);
    }
}

function parseCSV(csv) {
    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',');
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length === headers.length) {
            const match = {};
            for (let j = 0; j < headers.length; j++) {
                // T√™n c·ªôt: B·∫£ng,Gi·ªù,S√¢n,ƒê·ªôi A,ƒê·ªôi B,T·ªâ s·ªë A,T·ªâ s·ªë B,M√£ ƒê·ªôi A,M√£ ƒê·ªôi B,L∆∞·ª£t tr·∫≠n
                const header = headers[j].trim();
                const value = values[j].trim();
                
                if (header === 'T·ªâ s·ªë A') {
                    match.scoreA = value === '' ? null : parseInt(value);
                } else if (header === 'T·ªâ s·ªë B') {
                    match.scoreB = value === '' ? null : parseInt(value);
                } else if (header === 'ƒê·ªôi A') {
                    match.teamA = value;
                } else if (header === 'ƒê·ªôi B') {
                    match.teamB = value;
                } else if (header === 'B·∫£ng') {
                    match.group = value;
                } else if (header === 'Gi·ªù') {
                    match.time = value;
                } else if (header === 'S√¢n') {
                    match.court = value;
                } else {
                    match[header] = value;
                }
            }
            data.push(match);
        }
    }
    return data;
}

function capNhatTiSo(inputElement, matchType, matchId, isScoreA, isFinalMatch) {
    const value = parseInt(inputElement.value);
    const score = isNaN(value) ? null : value;

    if (matchType === 'roundRobin') {
        const match = state.roundRobinMatches.find(m => m.id === matchId);
        if (match) {
            if (isScoreA) match.scoreA = score;
            else match.scoreB = score;
        }
    } else if (matchType === 'semifinals') {
        const match = state.semifinals.find(m => m.id === matchId);
        if (match) {
            if (isScoreA) match.scoreA = score;
            else match.scoreB = score;
            tinhKetQuaVongLoai(match, isFinalMatch);
        }
    } else if (matchType === 'final') {
        if (isScoreA) state.final.scoreA = score;
        else state.final.scoreB = score;
        tinhKetQuaVongLoai(state.final, true);
    }

    saveState();
    renderAll();
}

function tinhKetQuaVongLoai(match, isFinalMatch) {
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA > match.scoreB) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB > match.scoreA) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        } else {
            match.winner = 'H√≤a'; // Trong BO3 kh√¥ng n√™n c√≥ h√≤a, nh∆∞ng ƒë·ªÉ ph√≤ng ng·ª´a l·ªói nh·∫≠p li·ªáu
            match.loser = 'H√≤a';
        }

        if (isFinalMatch) {
            state.final.winner = match.winner;
            state.final.loser = match.loser;
        }
    } else {
        match.winner = null;
        match.loser = null;
    }
}

function parseFixedSchedule() {
    const allMatches = parseCSV(FIXED_SCHEDULE_CSV);
    state.roundRobinMatches = allMatches.filter(m => m.group === 'A' || m.group === 'B');
    state.roundRobinMatches.forEach((m, index) => m.id = 'RR' + index); // Th√™m ID cho ti·ªán qu·∫£n l√Ω
}

function tinhDiem() {
    state.players = {};
    state.groups.A.forEach(p => state.players[p] = { ten: p, thang: 0, thua: 0, setThang: 0, setThua: 0, tyLeSet: 0, diem: 0, hang: 0, group: 'A' });
    state.groups.B.forEach(p => state.players[p] = { ten: p, thang: 0, thua: 0, setThang: 0, setThua: 0, tyLeSet: 0, diem: 0, hang: 0, group: 'B' });

    state.roundRobinMatches.forEach(match => {
        if (match.scoreA !== null && match.scoreB !== null) {
            const teamA = match.teamA;
            const teamB = match.teamB;
            const pA = state.players[teamA];
            const pB = state.players[teamB];

            if (pA && pB) {
                pA.setThang += match.scoreA;
                pA.setThua += match.scoreB;
                pB.setThang += match.scoreB;
                pB.setThua += match.scoreA;

                if (match.scoreA > match.scoreB) {
                    pA.thang++; pA.diem += 3;
                    pB.thua++;
                } else if (match.scoreB > match.scoreA) {
                    pB.thang++; pB.diem += 3;
                    pA.thua++;
                } else {
                    // C·∫ßn x·ª≠ l√Ω h√≤a n·∫øu lu·∫≠t gi·∫£i cho ph√©p (th∆∞·ªùng kh√¥ng c√≥ trong BO3)
                }
            }
        }
    });

    // T√≠nh T·ª∑ l·ªá Set v√† x·∫øp h·∫°ng
    Object.values(state.players).forEach(p => {
        p.tyLeSet = p.setThua === 0 ? p.setThang : p.setThang / p.setThua;
    });

    // X·∫øp h·∫°ng: ∆∞u ti√™n 1: ƒêi·ªÉm, 2: Hi·ªáu s·ªë set (Set Th·∫Øng - Set Thua), 3: T·ªâ l·ªá set
    ['A', 'B'].forEach(group => {
        state.groups[group].sort((aName, bName) => {
            const a = state.players[aName];
            const b = state.players[bName];
            
            // 1. ƒêi·ªÉm
            if (b.diem !== a.diem) return b.diem - a.diem;
            
            // 2. Hi·ªáu s·ªë set (Set Th·∫Øng - Set Thua)
            const diffA = a.setThang - a.setThua;
            const diffB = b.setThang - b.setThua;
            if (diffB !== diffA) return diffB - diffA;

            // 3. T·ª∑ l·ªá set
            return b.tyLeSet - a.tyLeSet;
        });

        // G√°n l·∫°i th·ª© h·∫°ng
        state.groups[group].forEach((pName, index) => {
            state.players[pName].hang = index + 1;
        });
    });
}

function renderBXH(group) {
    const playersInGroup = state.groups[group].map(name => state.players[name]);
    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-primary">
        <tr>
          <th>H·∫°ng</th>
          <th>ƒê·ªôi</th>
          <th>Th·∫Øng</th>
          <th>Thua</th>
          <th>Set Th·∫Øng</th>
          <th>Set Thua</th>
          <th>ƒêi·ªÉm</th>
        </tr>
      </thead>
      <tbody>`;
      
    playersInGroup.forEach((p, index) => {
        html += `
        <tr>
          <td>${index + 1}</td>
          <td>${p.ten}</td>
          <td>${p.thang}</td>
          <td>${p.thua}</td>
          <td>${p.setThang}</td>
          <td>${p.setThua}</td>
          <td>${p.diem}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById(`bxh${group}`).innerHTML = html;
}

function renderKetQua(group) {
    const matches = state.roundRobinMatches.filter(m => m.group === group);
    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-success">
        <tr>
          <th>Gi·ªù</th>
          <th>S√¢n</th>
          <th>ƒê·ªôi A</th>
          <th>T·ªâ s·ªë</th>
          <th>ƒê·ªôi B</th>
          <th>L∆∞·ª£t</th>
        </tr>
      </thead>
      <tbody>`;
      
    matches.forEach(match => {
        const disabled = match.scoreA !== null && match.scoreB !== null ? 'disabled' : '';
        html += `
        <tr>
          <td>${match.time}</td>
          <td>${match.court}</td>
          <td class="text-start ${match.scoreA > match.scoreB ? 'fw-bold text-success' : ''}">${match.teamA}</td>
          <td class="match-score-cell">
            <div class="input-group input-group-sm d-flex justify-content-center">
                <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}" onchange="capNhatTiSo(this, 'roundRobin', '${match.id}', true, false)" class="form-control form-control-sm" style="width: 45px; text-align: center;">
                <span class="input-group-text p-1">-</span>
                <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}" onchange="capNhatTiSo(this, 'roundRobin', '${match.id}', false, false)" class="form-control form-control-sm" style="width: 45px; text-align: center;">
            </div>
          </td>
          <td class="text-end ${match.scoreB > match.scoreA ? 'fw-bold text-success' : ''}">${match.teamB}</td>
          <td>${match['L∆∞·ª£t tr·∫≠n']}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById(`ketQua${group}`).innerHTML = html;
}

function renderLichDau() {
    // L·∫•y t·∫•t c·∫£ c√°c tr·∫≠n v√≤ng b·∫£ng
    const roundMatches = state.roundRobinMatches.map(m => ({
        ...m,
        vong: 'V√≤ng B·∫£ng',
        id: m.id
    }));
    
    // Th√™m c√°c tr·∫≠n b√°n k·∫øt v√† chung k·∫øt v√†o l·ªãch
    const sfMatches = state.semifinals.map(m => ({
        ...m,
        group: m.id.startsWith('SF') ? m.id.replace('SF', 'BK ') : m.id, // S·ª≠ d·ª•ng BK thay cho B√°n K·∫øt
        vong: 'B√°n K·∫øt',
        teamA: m.teamA,
        teamB: m.teamB,
        id: m.id
    }));
    
    const finalMatch = {
        ...state.final,
        group: 'CK',
        vong: 'Chung K·∫øt',
        teamA: state.final.teamA,
        teamB: state.final.teamB,
        id: state.final.id
    };

    const allMatches = [...roundMatches, ...sfMatches, finalMatch].sort((a, b) => {
        // S·∫Øp x·∫øp theo gi·ªù, v√† sau ƒë√≥ theo b·∫£ng (V√≤ng B·∫£ng, BK, CK)
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        if (a.group < b.group) return -1;
        if (a.group > b.group) return 1;
        return 0;
    });

    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-dark">
        <tr>
          <th>V√≤ng</th>
          <th>Gi·ªù</th>
          <th>S√¢n</th>
          <th>B·∫£ng/Tr·∫≠n</th>
          <th>ƒê·ªôi A</th>
          <th>ƒê·ªôi B</th>
          <th>T·ªâ s·ªë</th>
        </tr>
      </thead>
      <tbody>`;
      
    allMatches.forEach(match => {
        const scoreDisplay = match.scoreA !== null && match.scoreB !== null ? `${match.scoreA} - ${match.scoreB}` : '-';
        html += `
        <tr>
          <td>${match.vong}</td>
          <td>${match.time}</td>
          <td>${match.court}</td>
          <td>${match.group}</td>
          <td class="text-start">${match.teamA}</td>
          <td class="text-end">${match.teamB}</td>
          <td>${scoreDisplay}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById('lichDau').innerHTML = html;
}

function renderVongLoai() {
    renderSemifinals();
    renderFinalMatch();
    renderFinalResults();
}

function renderSemifinals() {
    let sfHtml = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-danger">
        <tr>
          <th>Tr·∫≠n</th>
          <th>Gi·ªù</th>
          <th>S√¢n</th>
          <th>ƒê·ªôi A</th>
          <th>ƒê·ªôi B</th>
          <th>T·ªâ s·ªë</th>
          <th>Th·∫Øng</th>
        </tr>
      </thead>
      <tbody>`;

    state.semifinals.forEach(sf => {
        const disabledSF = sf.scoreA !== null && sf.scoreB !== null ? 'disabled' : '';
        sfHtml += `
        <tr>
          <td>${sf.id}</td>
          <td>${sf.time}</td>
          <td>${sf.court}</td>
          <td>${sf.teamA}</td>
          <td>${sf.teamB}</td>
          <td class="match-score-cell d-flex justify-content-center">
            <input type='number' min='0' value='${sf.scoreA !== null ? sf.scoreA : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", true, false)' class='form-control form-control-sm' ${disabledSF}>
            <span class="input-group-text p-1">-</span>
            <input type='number' min='0' value='${sf.scoreB !== null ? sf.scoreB : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", false, false)' class='form-control form-control-sm' ${disabledSF}>
          </td>
          <td>${sf.winner ? sf.winner : 'ƒêang ƒë·∫•u'}</td>
        </tr>`;
    });
    sfHtml += `</tbody></table></div>`;
    document.getElementById('semifinals').innerHTML = sfHtml;
}

function renderFinalMatch() {
    const final = state.final;
    const disabledF = final.scoreA !== null && final.scoreB !== null ? 'disabled' : '';

    // C·∫≠p nh·∫≠t t√™n ƒë·ªôi tham gia Chung k·∫øt d·ª±a tr√™n k·∫øt qu·∫£ B√°n k·∫øt
    const sf1 = state.semifinals.find(m => m.id === 'SF1');
    const sf2 = state.semifinals.find(m => m.id === 'SF2');
    
    if (sf1 && sf1.winner && sf1.winner !== 'H√≤a') {
        final.teamA = sf1.winner;
    } else {
        final.teamA = 'Th·∫Øng BKA'; 
    }
    
    if (sf2 && sf2.winner && sf2.winner !== 'H√≤a') {
        final.teamB = sf2.winner;
    } else {
        final.teamB = 'Th·∫Øng BKB';
    }

    let fHtml = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-primary">
        <tr>
          <th>Tr·∫≠n</th>
          <th>Gi·ªù</th>
          <th>S√¢n</th>
          <th>ƒê·ªôi A</th>
          <th>ƒê·ªôi B</th>
          <th>T·ªâ s·ªë</th>
          <th>V√¥ ƒë·ªãch</th>
        </tr>
      </thead>
      <tbody>
    <tr>
        <td>Chung K·∫øt</td>
        <td>${final.time}</td>
        <td>${final.court}</td>
        <td>${final.teamA}</td>
        <td>${final.teamB}</td>
        <td class="match-score-cell d-flex justify-content-center">
            <input type='number' min='0' value='${final.scoreA !== null ? final.scoreA : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", true, true)' class='form-control form-control-sm' ${disabledF}> 
            <span class="input-group-text p-1">-</span>
            <input type='number' min='0' value='${final.scoreB !== null ? final.scoreB : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", false, true)' class='form-control form-control-sm' ${disabledF}>
        </td>
        <td>${final.winner ? final.winner + ' V√¥ ƒë·ªãch' : 'ƒêang ƒë·∫•u'}</td>
    </tr>`;
    fHtml += `</tbody></table></div>`;
    document.getElementById('finalMatch').innerHTML = fHtml;
}

function renderFinalResults() {
    const final = state.final;
    const sf1Loser = state.semifinals[0].loser;
    const sf2Loser = state.semifinals[1].loser;
    
    let thirdPlaceTeams = [];
    if (sf1Loser && sf1Loser !== 'H√≤a') thirdPlaceTeams.push(sf1Loser);
    if (sf2Loser && sf2Loser !== 'H√≤a') thirdPlaceTeams.push(sf2Loser);

    document.getElementById('champion').innerHTML = final.winner 
        ? `<span class="badge bg-success">ü•á V√¥ ƒë·ªãch: ${final.winner}</span>` 
        : 'V√¥ ƒë·ªãch: ƒêang ch·ªù k·∫øt qu·∫£...';

    document.getElementById('runnerUp').innerHTML = final.loser 
        ? `<span class="badge bg-secondary">ü•à √Å qu√¢n: ${final.loser}</span>` 
        : '√Å qu√¢n: ƒêang ch·ªù k·∫øt qu·∫£...';
        
    document.getElementById('thirdPlace').innerHTML = thirdPlaceTeams.length === 2
        ? `<span class="badge bg-info">ü•â ƒê·ªìng h·∫°ng Ba: ${thirdPlaceTeams.join(' & ')}</span>`
        : 'ƒê·ªìng h·∫°ng Ba: ƒêang ch·ªù k·∫øt qu·∫£ B√°n k·∫øt...';
}

function saveState() {
    localStorage.setItem('tkdState2025', JSON.stringify(state));
}

function loadState() {
    const savedState = localStorage.getItem('tkdState2025');
    if (savedState) {
        // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã ƒë√£ l∆∞u nh∆∞ng gi·ªØ l·∫°i c·∫•u h√¨nh m·ªõi c·ªßa semifinals v√† final
        const loadedState = JSON.parse(savedState);
        
        // Ch·ªâ load d·ªØ li·ªáu v√≤ng b·∫£ng
        state.roundRobinMatches = loadedState.roundRobinMatches || [];

        // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu B√°n k·∫øt/Chung k·∫øt c≈©, c·∫≠p nh·∫≠t l·∫°i k·∫øt qu·∫£ cho ph√π h·ª£p v·ªõi c·∫•u h√¨nh m·ªõi
        if (loadedState.semifinals && loadedState.semifinals.length === 2) {
             // C·ªë g·∫Øng gi·ªØ l·∫°i t·ªâ s·ªë ƒë√£ nh·∫≠p n·∫øu c√≥
            state.semifinals[0].scoreA = loadedState.semifinals[0].scoreA;
            state.semifinals[0].scoreB = loadedState.semifinals[0].scoreB;
            tinhKetQuaVongLoai(state.semifinals[0], false);
            
            state.semifinals[1].scoreA = loadedState.semifinals[1].scoreA;
            state.semifinals[1].scoreB = loadedState.semifinals[1].scoreB;
            tinhKetQuaVongLoai(state.semifinals[1], false);
        }

        if (loadedState.final) {
            state.final.scoreA = loadedState.final.scoreA;
            state.final.scoreB = loadedState.final.scoreB;
            tinhKetQuaVongLoai(state.final, true);
        }

    } else {
        // L·∫ßn ƒë·∫ßu ch·∫°y, c·∫ßn x√°c ƒë·ªãnh nh√≥m cho c√°c c·∫ßu th·ªß
        const allTeams = [...new Set(state.roundRobinMatches.map(m => m.teamA).concat(state.roundRobinMatches.map(m => m.teamB)))];
        state.groups.A = allTeams.filter(t => t.startsWith('H')).sort(); // Gi·∫£ ƒë·ªãnh team A b·∫Øt ƒë·∫ßu b·∫±ng H (Huy·ªÅn, H·∫≠u, H·∫°nh...)
        state.groups.B = allTeams.filter(t => t.startsWith('T') || t.startsWith('P') || t.startsWith('√Å')).sort(); // Gi·∫£ ƒë·ªãnh team B b·∫Øt ƒë·∫ßu b·∫±ng T, P, √Å
        saveState();
    }
}

function init() {
    // 1. Ph√¢n t√≠ch l·ªãch thi ƒë·∫•u c·ªë ƒë·ªãnh
    parseFixedSchedule(); 
    
    // 2. Load d·ªØ li·ªáu ƒë√£ l∆∞u (n·∫øu c√≥)
    loadState(); 
    
    // 3. T√≠nh l·∫°i ƒëi·ªÉm v√† x·∫øp h·∫°ng
    tinhDiem(); 
    
    // 4. Render giao di·ªán
    renderAll();
}

function renderAll() {
    renderBXH('A');
    renderKetQua('A');
    renderBXH('B');
    renderKetQua('B');
    renderLichDau();
    renderVongLoai();
}

docReady(init);

</script>
</body>
</html>
