<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V14 GitHub (Court Config)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px; /* Smaller input on mobile */
      }
    }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="d-flex align-items-center mb-4">
    <img src="https://i.imgur.com/logo-url.png" alt="Logo" class="logo me-3">
    <div>
      <h2 class="mb-0">TKD Championship 2025</h2>
      <p class="status mb-0">Hệ thống Quản lý Giải đấu Pickleball</p>
    </div>
  </div>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="bang-a-tab" data-bs-toggle="tab" data-bs-target="#bang-a-tab-pane" type="button" role="tab" aria-controls="bang-a-tab-pane" aria-selected="true">Bảng A</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="bang-b-tab" data-bs-toggle="tab" data-bs-target="#bang-b-tab-pane" type="button" role="tab" aria-controls="bang-b-tab-pane" aria-selected="false">Bảng B</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="lich-dau-tab" data-bs-toggle="tab" data-bs-target="#lich-dau-tab-pane" type="button" role="tab" aria-controls="lich-dau-tab-pane" aria-selected="false">Lịch Đấu Chi Tiết</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="vong-loai-tab" data-bs-toggle="tab" data-bs-target="#vong-loai-tab-pane" type="button" role="tab" aria-controls="vong-loai-tab-pane" aria-selected="false">Vòng Loại Trực Tiếp</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="bang-a-tab-pane" role="tabpanel" aria-labelledby="bang-a-tab" tabindex="0">
      <h4 class="mt-3">Bảng xếp hạng Bảng A</h4>
      <div id="bxhA"></div>
      <h4 class="mt-3">Kết quả thi đấu Bảng A</h4>
      <div id="ketQuaA"></div>
    </div>
    <div class="tab-pane fade" id="bang-b-tab-pane" role="tabpanel" aria-labelledby="bang-b-tab" tabindex="0">
      <h4 class="mt-3">Bảng xếp hạng Bảng B</h4>
      <div id="bxhB"></div>
      <h4 class="mt-3">Kết quả thi đấu Bảng B</h4>
      <div id="ketQuaB"></div>
    </div>
    <div class="tab-pane fade" id="lich-dau-tab-pane" role="tabpanel" aria-labelledby="lich-dau-tab" tabindex="0">
      <h4 class="mt-3">Lịch thi đấu tất cả các trận</h4>
      <div id="lichDau"></div>
    </div>
    <div class="tab-pane fade" id="vong-loai-tab-pane" role="tabpanel" aria-labelledby="vong-loai-tab" tabindex="0">
      <h4 class="mt-3">Vòng Bán kết</h4>
      <div id="semifinals"></div>
      <h4 class="mt-3">Trận Chung kết</h4>
      <div id="finalMatch"></div>
      <hr>
      <h4 class="mt-3">Kết quả chung cuộc</h4>
      <div id="finalResults">
        <p id="champion"></p>
        <p id="runnerUp"></p>
        <p id="thirdPlace"></p>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Dữ liệu lịch cố định (ĐÃ CẬP NHẬT: Vòng Bảng, Bán kết, Chung kết)
const FIXED_SCHEDULE_CSV = `Bảng,Giờ,Sân,Đội A,Đội B,Tỉ số A,Tỉ số B,Mã Đội A,Mã Đội B,Lượt trận
A,14:00,Sân7,Huyền/Luân,Linh/M.Hùng,,,A4,A5,1
A,14:00,Sân 2,Giang/Long,Hường/Đạt,,,A3,A6,1
A,14:00,Sân 3,Hậu/Dũng,Hạnh/Tiến,,,A1,A2,1
A,14:15,Sân7,Giang/Long,Huyền/Luân,,,A3,A4,2
A,14:15,Sân 3,Hậu/Dũng,Hường/Đạt,,,A1,A6,2
A,14:30,Sân 3,Hạnh/Tiến,Linh/M.Hùng,,,A2,A5,3
A,14:45,Sân7,Hậu/Dũng,Linh/M.Hùng,,,A1,A5,4
A,14:45,Sân 2,Huyền/Luân,Hường/Đạt,,,A4,A6,4
A,14:45,Sân 3,Hạnh/Tiến,Giang/Long,,,A2,A3,4
A,15:15,Sân 3,Giang/Long,Linh/M.Hùng,,,A3,A5,6
A,15:30,Sân 2,Hạnh/Tiến,Hường/Đạt,,,A2,A6,6
A,15:30,Sân 3,Hậu/Dũng,Huyền/Luân,,,A1,A4,7
A,16:00,Sân 3,Hậu/Dũng,Giang/Long,,,A1,A3,9
A,16:15,Sân 2,Hạnh/Tiến,Huyền/Luân,,,A2,A4,10
A,16:15,Sân 3,Linh/M.Hùng,Hường/Đạt,,,A5,A6,10
B,14:00,Sân 1,Triều/Minh,Hiển/P.Hùng,,,B3,B6,1
B,14:15,Sân 1,Tiệp/Thủy,Phương/Thanh,,,B1,B2,2
B,14:15,Sân 2,Tín/Khiêm,Ánh/Toàn,,,B4,B5,2
B,14:30,Sân7,Phương/Thanh,Ánh/Toàn,,,B2,B5,3
B,14:30,Sân 1,Triều/Minh,Tín/Khiêm,,,B3,B4,3
B,14:30,Sân 2,Tiệp/Thủy,Hiển/P.Hùng,,,B1,B6,3
B,15:00,Sân 2,Tiệp/Thủy,Ánh/Toàn,,,B1,B5,5
B,15:00,Sân 3,Tín/Khiêm,Hiển/P.Hùng,,,B4,B6,6
B,15:15,Sân 2,Phương/Thanh,Triều/Minh,,,B2,B3,8
B,15:45,Sân 2,Tiệp/Thủy,Tín/Khiêm,,,B1,B4,9
B,15:45,Sân 3,Phương/Thanh,Hiển/P.Hùng,,,B2,B6,10
B,16:00,Sân 2,Triều/Minh,Ánh/Toàn,,,B3,B5,11
B,16:30,Sân 2,Tiệp/Thủy,Triều/Minh,,,B1,B3,11
B,16:30,Sân 3,Ánh/Toàn,Hiển/P.Hùng,,,B5,B6,12
B,16:45,Sân 2,Phương/Thanh,Tín/Khiêm,,,B2,B4,
BK_A,16:45,Sân 3,Nhất bảng A,Nhì bảng A,,,,,12
BK_B,17:05,Sân 3,Nhất bảng B,Nhì bảng B,,,,,13
CK,17:25,Sân 3,Thắng BKA,Thắng BK B,,,,,14`;

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = {
  roundRobinMatches: [],
  groups: { A: [], B: [] },
  players: [],
  // Cập nhật Dữ liệu Vòng Loại Trực Tiếp theo yêu cầu của người dùng
  semifinals: [
    { id: 'SF1', teamA: 'Nhất bảng A', teamB: 'Nhì bảng A', scoreA: null, scoreB: null, time: '16:45', court: 'Sân 3', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nhất bảng B', teamB: 'Nhì bảng B', scoreA: null, scoreB: null, time: '17:05', court: 'Sân 3', winner: null, loser: null }
  ],
  final: { 
    id: 'F', 
    teamA: 'Thắng BKA', 
    teamB: 'Thắng BKB', 
    scoreA: null, 
    scoreB: null, 
    time: '17:25', 
    court: 'Sân 3', 
    winner: null, 
    runnerUp: null 
  },
  config: {}
};

// =========================================================================
// CÁC HÀM XỬ LÝ DỮ LIỆU VÀ GIAO DIỆN (Được giữ nguyên)
// =========================================================================

function docReady(fn) {
    if (document.readyState === "complete" || document.readyState === "interactive") {
        setTimeout(fn, 1);
    } else {
        document.addEventListener("DOMContentLoaded", fn);
    }
}

function parseCSV(csv) {
    const lines = csv.trim().split('\n');
    const headers = lines[0].split(',');
    const data = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        if (values.length === headers.length) {
            const match = {};
            for (let j = 0; j < headers.length; j++) {
                // Tên cột: Bảng,Giờ,Sân,Đội A,Đội B,Tỉ số A,Tỉ số B,Mã Đội A,Mã Đội B,Lượt trận
                const header = headers[j].trim();
                const value = values[j].trim();
                
                if (header === 'Tỉ số A') {
                    match.scoreA = value === '' ? null : parseInt(value);
                } else if (header === 'Tỉ số B') {
                    match.scoreB = value === '' ? null : parseInt(value);
                } else if (header === 'Đội A') {
                    match.teamA = value;
                } else if (header === 'Đội B') {
                    match.teamB = value;
                } else if (header === 'Bảng') {
                    match.group = value;
                } else if (header === 'Giờ') {
                    match.time = value;
                } else if (header === 'Sân') {
                    match.court = value;
                } else {
                    match[header] = value;
                }
            }
            data.push(match);
        }
    }
    return data;
}

function capNhatTiSo(inputElement, matchType, matchId, isScoreA, isFinalMatch) {
    const value = parseInt(inputElement.value);
    const score = isNaN(value) ? null : value;

    if (matchType === 'roundRobin') {
        const match = state.roundRobinMatches.find(m => m.id === matchId);
        if (match) {
            if (isScoreA) match.scoreA = score;
            else match.scoreB = score;
        }
    } else if (matchType === 'semifinals') {
        const match = state.semifinals.find(m => m.id === matchId);
        if (match) {
            if (isScoreA) match.scoreA = score;
            else match.scoreB = score;
            tinhKetQuaVongLoai(match, isFinalMatch);
        }
    } else if (matchType === 'final') {
        if (isScoreA) state.final.scoreA = score;
        else state.final.scoreB = score;
        tinhKetQuaVongLoai(state.final, true);
    }

    saveState();
    renderAll();
}

function tinhKetQuaVongLoai(match, isFinalMatch) {
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA > match.scoreB) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB > match.scoreA) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        } else {
            match.winner = 'Hòa'; // Trong BO3 không nên có hòa, nhưng để phòng ngừa lỗi nhập liệu
            match.loser = 'Hòa';
        }

        if (isFinalMatch) {
            state.final.winner = match.winner;
            state.final.loser = match.loser;
        }
    } else {
        match.winner = null;
        match.loser = null;
    }
}

function parseFixedSchedule() {
    const allMatches = parseCSV(FIXED_SCHEDULE_CSV);
    state.roundRobinMatches = allMatches.filter(m => m.group === 'A' || m.group === 'B');
    state.roundRobinMatches.forEach((m, index) => m.id = 'RR' + index); // Thêm ID cho tiện quản lý
}

function tinhDiem() {
    state.players = {};
    state.groups.A.forEach(p => state.players[p] = { ten: p, thang: 0, thua: 0, setThang: 0, setThua: 0, tyLeSet: 0, diem: 0, hang: 0, group: 'A' });
    state.groups.B.forEach(p => state.players[p] = { ten: p, thang: 0, thua: 0, setThang: 0, setThua: 0, tyLeSet: 0, diem: 0, hang: 0, group: 'B' });

    state.roundRobinMatches.forEach(match => {
        if (match.scoreA !== null && match.scoreB !== null) {
            const teamA = match.teamA;
            const teamB = match.teamB;
            const pA = state.players[teamA];
            const pB = state.players[teamB];

            if (pA && pB) {
                pA.setThang += match.scoreA;
                pA.setThua += match.scoreB;
                pB.setThang += match.scoreB;
                pB.setThua += match.scoreA;

                if (match.scoreA > match.scoreB) {
                    pA.thang++; pA.diem += 3;
                    pB.thua++;
                } else if (match.scoreB > match.scoreA) {
                    pB.thang++; pB.diem += 3;
                    pA.thua++;
                } else {
                    // Cần xử lý hòa nếu luật giải cho phép (thường không có trong BO3)
                }
            }
        }
    });

    // Tính Tỷ lệ Set và xếp hạng
    Object.values(state.players).forEach(p => {
        p.tyLeSet = p.setThua === 0 ? p.setThang : p.setThang / p.setThua;
    });

    // Xếp hạng: ưu tiên 1: Điểm, 2: Hiệu số set (Set Thắng - Set Thua), 3: Tỉ lệ set
    ['A', 'B'].forEach(group => {
        state.groups[group].sort((aName, bName) => {
            const a = state.players[aName];
            const b = state.players[bName];
            
            // 1. Điểm
            if (b.diem !== a.diem) return b.diem - a.diem;
            
            // 2. Hiệu số set (Set Thắng - Set Thua)
            const diffA = a.setThang - a.setThua;
            const diffB = b.setThang - b.setThua;
            if (diffB !== diffA) return diffB - diffA;

            // 3. Tỷ lệ set
            return b.tyLeSet - a.tyLeSet;
        });

        // Gán lại thứ hạng
        state.groups[group].forEach((pName, index) => {
            state.players[pName].hang = index + 1;
        });
    });
}

function renderBXH(group) {
    const playersInGroup = state.groups[group].map(name => state.players[name]);
    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-primary">
        <tr>
          <th>Hạng</th>
          <th>Đội</th>
          <th>Thắng</th>
          <th>Thua</th>
          <th>Set Thắng</th>
          <th>Set Thua</th>
          <th>Điểm</th>
        </tr>
      </thead>
      <tbody>`;
      
    playersInGroup.forEach((p, index) => {
        html += `
        <tr>
          <td>${index + 1}</td>
          <td>${p.ten}</td>
          <td>${p.thang}</td>
          <td>${p.thua}</td>
          <td>${p.setThang}</td>
          <td>${p.setThua}</td>
          <td>${p.diem}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById(`bxh${group}`).innerHTML = html;
}

function renderKetQua(group) {
    const matches = state.roundRobinMatches.filter(m => m.group === group);
    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-success">
        <tr>
          <th>Giờ</th>
          <th>Sân</th>
          <th>Đội A</th>
          <th>Tỉ số</th>
          <th>Đội B</th>
          <th>Lượt</th>
        </tr>
      </thead>
      <tbody>`;
      
    matches.forEach(match => {
        const disabled = match.scoreA !== null && match.scoreB !== null ? 'disabled' : '';
        html += `
        <tr>
          <td>${match.time}</td>
          <td>${match.court}</td>
          <td class="text-start ${match.scoreA > match.scoreB ? 'fw-bold text-success' : ''}">${match.teamA}</td>
          <td class="match-score-cell">
            <div class="input-group input-group-sm d-flex justify-content-center">
                <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}" onchange="capNhatTiSo(this, 'roundRobin', '${match.id}', true, false)" class="form-control form-control-sm" style="width: 45px; text-align: center;">
                <span class="input-group-text p-1">-</span>
                <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}" onchange="capNhatTiSo(this, 'roundRobin', '${match.id}', false, false)" class="form-control form-control-sm" style="width: 45px; text-align: center;">
            </div>
          </td>
          <td class="text-end ${match.scoreB > match.scoreA ? 'fw-bold text-success' : ''}">${match.teamB}</td>
          <td>${match['Lượt trận']}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById(`ketQua${group}`).innerHTML = html;
}

function renderLichDau() {
    // Lấy tất cả các trận vòng bảng
    const roundMatches = state.roundRobinMatches.map(m => ({
        ...m,
        vong: 'Vòng Bảng',
        id: m.id
    }));
    
    // Thêm các trận bán kết và chung kết vào lịch
    const sfMatches = state.semifinals.map(m => ({
        ...m,
        group: m.id.startsWith('SF') ? m.id.replace('SF', 'BK ') : m.id, // Sử dụng BK thay cho Bán Kết
        vong: 'Bán Kết',
        teamA: m.teamA,
        teamB: m.teamB,
        id: m.id
    }));
    
    const finalMatch = {
        ...state.final,
        group: 'CK',
        vong: 'Chung Kết',
        teamA: state.final.teamA,
        teamB: state.final.teamB,
        id: state.final.id
    };

    const allMatches = [...roundMatches, ...sfMatches, finalMatch].sort((a, b) => {
        // Sắp xếp theo giờ, và sau đó theo bảng (Vòng Bảng, BK, CK)
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        if (a.group < b.group) return -1;
        if (a.group > b.group) return 1;
        return 0;
    });

    let html = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Vòng</th>
          <th>Giờ</th>
          <th>Sân</th>
          <th>Bảng/Trận</th>
          <th>Đội A</th>
          <th>Đội B</th>
          <th>Tỉ số</th>
        </tr>
      </thead>
      <tbody>`;
      
    allMatches.forEach(match => {
        const scoreDisplay = match.scoreA !== null && match.scoreB !== null ? `${match.scoreA} - ${match.scoreB}` : '-';
        html += `
        <tr>
          <td>${match.vong}</td>
          <td>${match.time}</td>
          <td>${match.court}</td>
          <td>${match.group}</td>
          <td class="text-start">${match.teamA}</td>
          <td class="text-end">${match.teamB}</td>
          <td>${scoreDisplay}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    document.getElementById('lichDau').innerHTML = html;
}

function renderVongLoai() {
    renderSemifinals();
    renderFinalMatch();
    renderFinalResults();
}

function renderSemifinals() {
    let sfHtml = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-danger">
        <tr>
          <th>Trận</th>
          <th>Giờ</th>
          <th>Sân</th>
          <th>Đội A</th>
          <th>Đội B</th>
          <th>Tỉ số</th>
          <th>Thắng</th>
        </tr>
      </thead>
      <tbody>`;

    state.semifinals.forEach(sf => {
        const disabledSF = sf.scoreA !== null && sf.scoreB !== null ? 'disabled' : '';
        sfHtml += `
        <tr>
          <td>${sf.id}</td>
          <td>${sf.time}</td>
          <td>${sf.court}</td>
          <td>${sf.teamA}</td>
          <td>${sf.teamB}</td>
          <td class="match-score-cell d-flex justify-content-center">
            <input type='number' min='0' value='${sf.scoreA !== null ? sf.scoreA : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", true, false)' class='form-control form-control-sm' ${disabledSF}>
            <span class="input-group-text p-1">-</span>
            <input type='number' min='0' value='${sf.scoreB !== null ? sf.scoreB : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", false, false)' class='form-control form-control-sm' ${disabledSF}>
          </td>
          <td>${sf.winner ? sf.winner : 'Đang đấu'}</td>
        </tr>`;
    });
    sfHtml += `</tbody></table></div>`;
    document.getElementById('semifinals').innerHTML = sfHtml;
}

function renderFinalMatch() {
    const final = state.final;
    const disabledF = final.scoreA !== null && final.scoreB !== null ? 'disabled' : '';

    // Cập nhật tên đội tham gia Chung kết dựa trên kết quả Bán kết
    const sf1 = state.semifinals.find(m => m.id === 'SF1');
    const sf2 = state.semifinals.find(m => m.id === 'SF2');
    
    if (sf1 && sf1.winner && sf1.winner !== 'Hòa') {
        final.teamA = sf1.winner;
    } else {
        final.teamA = 'Thắng BKA'; 
    }
    
    if (sf2 && sf2.winner && sf2.winner !== 'Hòa') {
        final.teamB = sf2.winner;
    } else {
        final.teamB = 'Thắng BKB';
    }

    let fHtml = `
    <div class="table-responsive">
    <table class="table table-striped table-sm table-bordered">
      <thead class="table-primary">
        <tr>
          <th>Trận</th>
          <th>Giờ</th>
          <th>Sân</th>
          <th>Đội A</th>
          <th>Đội B</th>
          <th>Tỉ số</th>
          <th>Vô địch</th>
        </tr>
      </thead>
      <tbody>
    <tr>
        <td>Chung Kết</td>
        <td>${final.time}</td>
        <td>${final.court}</td>
        <td>${final.teamA}</td>
        <td>${final.teamB}</td>
        <td class="match-score-cell d-flex justify-content-center">
            <input type='number' min='0' value='${final.scoreA !== null ? final.scoreA : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", true, true)' class='form-control form-control-sm' ${disabledF}> 
            <span class="input-group-text p-1">-</span>
            <input type='number' min='0' value='${final.scoreB !== null ? final.scoreB : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", false, true)' class='form-control form-control-sm' ${disabledF}>
        </td>
        <td>${final.winner ? final.winner + ' Vô địch' : 'Đang đấu'}</td>
    </tr>`;
    fHtml += `</tbody></table></div>`;
    document.getElementById('finalMatch').innerHTML = fHtml;
}

function renderFinalResults() {
    const final = state.final;
    const sf1Loser = state.semifinals[0].loser;
    const sf2Loser = state.semifinals[1].loser;
    
    let thirdPlaceTeams = [];
    if (sf1Loser && sf1Loser !== 'Hòa') thirdPlaceTeams.push(sf1Loser);
    if (sf2Loser && sf2Loser !== 'Hòa') thirdPlaceTeams.push(sf2Loser);

    document.getElementById('champion').innerHTML = final.winner 
        ? `<span class="badge bg-success">🥇 Vô địch: ${final.winner}</span>` 
        : 'Vô địch: Đang chờ kết quả...';

    document.getElementById('runnerUp').innerHTML = final.loser 
        ? `<span class="badge bg-secondary">🥈 Á quân: ${final.loser}</span>` 
        : 'Á quân: Đang chờ kết quả...';
        
    document.getElementById('thirdPlace').innerHTML = thirdPlaceTeams.length === 2
        ? `<span class="badge bg-info">🥉 Đồng hạng Ba: ${thirdPlaceTeams.join(' & ')}</span>`
        : 'Đồng hạng Ba: Đang chờ kết quả Bán kết...';
}

function saveState() {
    localStorage.setItem('tkdState2025', JSON.stringify(state));
}

function loadState() {
    const savedState = localStorage.getItem('tkdState2025');
    if (savedState) {
        // Cập nhật các giá trị đã lưu nhưng giữ lại cấu hình mới của semifinals và final
        const loadedState = JSON.parse(savedState);
        
        // Chỉ load dữ liệu vòng bảng
        state.roundRobinMatches = loadedState.roundRobinMatches || [];

        // Nếu đã có dữ liệu Bán kết/Chung kết cũ, cập nhật lại kết quả cho phù hợp với cấu hình mới
        if (loadedState.semifinals && loadedState.semifinals.length === 2) {
             // Cố gắng giữ lại tỉ số đã nhập nếu có
            state.semifinals[0].scoreA = loadedState.semifinals[0].scoreA;
            state.semifinals[0].scoreB = loadedState.semifinals[0].scoreB;
            tinhKetQuaVongLoai(state.semifinals[0], false);
            
            state.semifinals[1].scoreA = loadedState.semifinals[1].scoreA;
            state.semifinals[1].scoreB = loadedState.semifinals[1].scoreB;
            tinhKetQuaVongLoai(state.semifinals[1], false);
        }

        if (loadedState.final) {
            state.final.scoreA = loadedState.final.scoreA;
            state.final.scoreB = loadedState.final.scoreB;
            tinhKetQuaVongLoai(state.final, true);
        }

    } else {
        // Lần đầu chạy, cần xác định nhóm cho các cầu thủ
        const allTeams = [...new Set(state.roundRobinMatches.map(m => m.teamA).concat(state.roundRobinMatches.map(m => m.teamB)))];
        state.groups.A = allTeams.filter(t => t.startsWith('H')).sort(); // Giả định team A bắt đầu bằng H (Huyền, Hậu, Hạnh...)
        state.groups.B = allTeams.filter(t => t.startsWith('T') || t.startsWith('P') || t.startsWith('Á')).sort(); // Giả định team B bắt đầu bằng T, P, Á
        saveState();
    }
}

function init() {
    // 1. Phân tích lịch thi đấu cố định
    parseFixedSchedule(); 
    
    // 2. Load dữ liệu đã lưu (nếu có)
    loadState(); 
    
    // 3. Tính lại điểm và xếp hạng
    tinhDiem(); 
    
    // 4. Render giao diện
    renderAll();
}

function renderAll() {
    renderBXH('A');
    renderKetQua('A');
    renderBXH('B');
    renderKetQua('B');
    renderLichDau();
    renderVongLoai();
}

docReady(init);

</script>
</body>
</html>
