<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V113 GitHub (Court Config)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ngày thi đấu: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState" class="text-danger">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">Tổng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">Vòng Bảng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals">Vòng Chung Kết</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results">Kết quả Chung cuộc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">Cấu hình</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">Đang tải dữ liệu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Chế độ xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo Bảng đấu</option>
            <option value="court" selected>Theo Sân thi đấu</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import Lịch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export Lịch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA">Chưa có lịch thi đấu.</div>
        
        <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB">Chưa có lịch thi đấu.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">Lên lịch Vòng Chung kết (Tự động hóa)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">Vòng Bán kết (16:30, Sân 1-2)</h6>
            <div id="semifinalMatches">Chưa có lịch thi đấu bán kết. Kết quả Vòng Bảng sẽ tự động cập nhật lịch.</div>

            <h6 class="mt-4">Trận Chung kết (17:00, Sân 1)</h6>
            <div id="finalMatch">Chưa có lịch thi đấu chung kết.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">Bảng xếp hạng Vòng Bảng (Cập nhật liên tục)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hiệu Chung cuộc</h5>
        <p id="champion">Vô địch: Đang chờ kết quả...</p>
        <p id="runnerUp">Á quân: Đang chờ kết quả...</p>
        <p id="thirdPlace">Hạng Ba Đồng Hạng: Đang chờ kết quả...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">Công cụ Lập & Điền Lịch Thi đấu</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">Tạo lịch thi đấu Tối ưu (Tự động)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">Tạo lịch Cố định</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">Điền kết quả Tự động (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">Xóa Toàn bộ Lịch</button>
      </div>
      
      <hr>

      <h5 class="mt-4">⚙️ Cấu hình Sân thi đấu & Lịch Tối ưu</h5>
      <p class="text-muted small">Quản lý danh sách sân thi đấu. Sân được gán loại bảng đấu (A/B) để phục vụ chức năng tạo lịch Tối ưu.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Thêm Sân Mới</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">Tải cấu hình Mặc định</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>

      <h5 class="mt-4">💾 Cấu hình Kết nối GitHub</h5>
      <p class="text-muted">Nhập thông tin kho lưu trữ GitHub để tự động lưu trữ dữ liệu giải đấu.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (Ví dụ: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (Ví dụ: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="Dán GitHub Personal Access Token (PAT) tại đây">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">Lưu cấu hình Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Kiểm tra & Tải Dữ liệu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">🔑 Hướng dẫn lấy GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy cập <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (Bạn cần đăng nhập).</li>
                <li>Chọn **Generate new token** (hoặc **Generate new token (classic)** nếu bạn dùng tài khoản cũ).</li>
                <li>**Tên Token:** Đặt tên dễ nhớ (ví dụ: `TKDManager_AutoSave`).</li>
                <li>**Thời hạn:** Chọn tùy ý (nên chọn 90 ngày hoặc Tùy chỉnh).</li>
                <li>**Phạm vi (Scopes):** **BẮT BUỘC** tích chọn ô **`repo`** (cho phép truy cập vào kho lưu trữ).</li>
                <li>Nhấn **Generate token** và **SAO CHÉP** chuỗi Token vừa được tạo.</li>
                <li>Dán chuỗi Token đó vào ô "Dán GitHub Personal Access Token (PAT) tại đây" bên trên.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">⚠️ **Lưu ý:** Token chỉ hiển thị **MỘT LẦN**. Hãy sao chép ngay lập tức và giữ bí mật. Nếu mất, bạn phải tạo lại Token mới.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Thêm/Sửa Cấu hình Sân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">Tên Sân</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Giờ Bắt Đầu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Thời Lượng Tối Đa (Phút)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              Dành cho Bảng A (Nam - Nữ)
            </label>
            <div class="form-text">Nếu không chọn, sân sẽ dành cho Bảng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        Nội dung thông báo
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script>
// Ghi chú phiên bản: V113
// Dữ liệu lịch cố định từ file TKDPlayers - Sheet2 (1).csv (ĐÃ CẬP NHẬT)
const FIXED_SCHEDULE_CSV = `Giờ bắt đầu,Giờ kết thúc,Lượt trận,Sân 1,Sân 2,Sân 3,Sân 7,Thời lượng dự kiến
2:00,2:15,1,Tiệp/Thủy - Phương/Thanh,Giang/Long - Hường/Đạt,Hậu/Dũng - Hạnh/Tiến,Huyền/Luân - Linh/M.Hùng,0:15
2:15,2:30,2,Triều/Minh - Hiển/P.Hùng,Tín/Khiêm - Ánh/Toàn,Hậu/Dũng - Hường/Đạt,Giang/Long - Huyền/Luân,0:15
2:30,2:45,3,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,Hạnh/Tiến - Linh/M.Hùng,Triều/Minh - Hiển/P.Hùng,0:15
2:45,3:00,4,,Hạnh/Tiến - Giang/Long,Huyền/Luân - Hường/Đạt,Hậu/Dũng - Linh/M.Hùng,0:15
3:00,3:15,5,,Tiệp/Thủy - Ánh/Toàn,Tín/Khiêm - Hiển/M.Hùng,,0:15
3:15,3:30,6,,Phương/Thanh - Triều/Minh,Giang/Long - Linh/M.Hùng,,0:15
3:30,3:45,7,,Hạnh/Tiến - Hường/Đạt,Hậu/Dũng - Huyền/Luân,,0:15
3:45,4:00,8,,Tiệp/Thủy - Tín/Khiêm,Phương/Thanh - Hiển/P.Hùng,,0:15
4:00,4:15,9,,Triều/Minh - Ánh/Toàn,Tiệp/Thủy - Phương/Thanh,Hạnh/Tiến - Huyền/Luân,0:15
4:15,4:30,10,,Tín/Khiêm - Phương/Thanh,Giang/Long - Hậu/Dũng,,0:15
4:30,4:45,11,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Hậu/Dũng - Linh/M.Hùng,0:15
4:45,5:00,12,,,,0:15
5:00,5:15,13,Hậu/Dũng - Giang/Long,Huyền/Luân - Hạnh/Tiến,Linh/M.Hùng - Hường/Đạt,,0:15
5:15,5:30,14,Triều/Minh - Tiệp/Thủy,Ánh/Toàn - Hiển/P.Hùng,Phương/Thanh - Tín/Khiêm,,0:15
5:30,5:45,15,Hậu/Dũng - Huyền/Luân,Giang/Long - Linh/M.Hùng,Hạnh/Tiến - Hường/Đạt,,0:15
5:45,6:00,16,,,,0:15
6:00,6:15,17,Huyền/Luân - Giang/Long,Hậu/Dũng - Hường/Đạt,Hạnh/Tiến - Linh/M.Hùng,,0:15
6:15,6:30,18,Tiệp/Thủy - Hiển/P.Hùng,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,,0:15
6:30,6:45,19,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Tiệp/Thủy - Phương/Thanh,0:15
6:45,7:00,20,Triều/Minh - Hiển/P.Hùng,Tín/Khiêm - Ánh/Toàn,Hậu/Dũng - Hường/Đạt,Giang/Long - Huyền/Luân,0:15
7:00,7:15,21,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,Hạnh/Tiến - Linh/M.Hùng,Tiệp/Thủy - Hiển/P.Hùng,0:15
7:15,7:30,22,,Hạnh/Tiến - Giang/Long,Huyền/Luân - Hường/Đạt,Hậu/Dũng - Linh/M.Hùng,0:15
7:30,7:45,23,,Tiệp/Thủy - Ánh/Toàn,Tín/Khiêm - Hiển/P.Hùng,,0:15
7:45,8:00,24,,Phương/Thanh - Triều/Minh,Giang/Long - Linh/M.Hùng,,0:15
8:00,8:15,25,,Hạnh/Tiến - Hường/Đạt,Hậu/Dũng - Huyền/Luân,,0:15
8:15,8:30,26,,Tiệp/Thủy - Tín/Khiêm,Phương/Thanh - Hiển/P.Pùng,,0:15
8:30,8:45,27,,Triều/Minh - Ánh/Toàn,Tiệp/Thủy - Phương/Thanh,Hạnh/Tiến - Huyền/Luân,0:15
8:45,9:00,28,,Tín/Khiêm - Phương/Thanh,Giang/Long - Hậu/Dũng,,0:15
9:00,9:15,29,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Hậu/Dũng - Linh/M.Hùng,0:15
9:15,9:30,30,,,,0:15
9:30,9:45,31,Hậu/Dũng - Giang/Long,Huyền/Luân - Hạnh/Tiến,Linh/M.Hùng - Hường/Đạt,,0:15
9:45,10:00,32,Triều/Minh - Tiệp/Thủy,Ánh/Toàn - Hiển/P.Hùng,Phương/Thanh - Tín/Khiêm,,0:15
10:00,10:15,33,Hậu/Dũng - Huyền/Luân,Giang/Long - Linh/M.Hùng,Hạnh/Tiến - Hường/Đạt,,0:15
10:15,10:30,34,,,,0:15
10:30,10:45,35,Huyền/Luân - Giang/Long,Hậu/Dũng - Hường/Đạt,Hạnh/Tiến - Linh/M.Hùng,,0:15
10:45,11:00,36,Tiệp/Thủy - Hiển/P.Hùng,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,,0:15`;

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = { 
  mixedTeams: ["Hậu/Dũng","Hạnh/Tiến","Giang/Long","Huyền/Luân","Linh/M.Hùng","Hường/Đạt"], // Bảng A (Nam-Nữ)
  maleTeams: ["Tiệp/Thủy","Phương/Thanh","Triều/Minh","Tín/Khiêm","Ánh/Toàn","Hiển/P.Hùng"], // Bảng B (Nam)
  matchesA: [], 
  matchesB: [],
  tableA: [], // Bảng xếp hạng A
  tableB: [], // Bảng xếp hạng B
  
  // NEW: Court Configuration
  courts: [
    { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } // Bảng B (Male)
  ],
  
  // LOGIC BÁN KẾT: SF1: Nhất A vs Nhất B, SF2: Nhì B vs Nhì A
  semifinals: [
    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhất B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nhì B', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null },
  config: {}
};

let stateChanged = false; // Biến cờ theo dõi thay đổi dữ liệu
let currentSha = null; // Biến lưu trữ SHA của file trên GitHub
let autoSaveInterval = null; // Biến lưu trữ ID của interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * Hàm chuyển đổi tab
 * @param {string} tabId - ID của tab cần chuyển (ví dụ: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // Tắt tab đang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // Bật tab mới
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // Cập nhật view cho tab matches nếu chuyển đến
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API Functions ---

async function fetchFileSha(cfg) {
    const filePath = `${cfg.folder}/${cfg.file}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            currentSha = data.sha;
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            currentSha = null; 
            return { sha: null };
        } else {
            throw new Error(`Lỗi khi lấy SHA: ${response.statusText}`);
        }
    } catch (error) {
        console.error("Lỗi Fetch SHA:", error);
        throw new Error(`Lỗi kết nối hoặc API: ${error.message}`);
    }
}

async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) return;

    try {
        updateStatus('configStatus', 'info', 'Đang tải dữ liệu từ GitHub...');
        const result = await fetchFileSha(cfg);
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Tải dữ liệu chính
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // Tải cấu hình sân (NEW)
            if (loadedState.courts) {
                state.courts = loadedState.courts;
            }
            
            // Xử lý logic tải cho semifinals và final
            const loadedSemifinals = loadedState.semifinals;
            if (loadedSemifinals && loadedSemifinals.length === 2 && 
                (loadedSemifinals[0].teamA !== 'Nhất A' || loadedSemifinals[0].teamB !== 'Nhất B' ||
                 loadedSemifinals[1].teamA !== 'Nhì B' || loadedSemifinals[1].teamB !== 'Nhì A')
            ) {
                state.semifinals = loadedSemifinals;
            } else if (loadedSemifinals && loadedSemifinals.length === 2) {
                state.semifinals = loadedSemifinals;
            }

            state.final = loadedState.final || state.final;
            
            // Cập nhật giao diện
            renderMatchesView(); 
            tinhVaCapNhatXepHang();
            renderFinals();
            renderFinalResults();
            renderOverview();
            
            updateStatus('configStatus', 'success', `Tải dữ liệu thành công từ: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
            updateStatus('configStatus', 'warning', 'File dữ liệu chưa tồn tại trên GitHub. Vui lòng nhấn Lưu hoặc Tự động lưu để tạo file.');
        }

        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Lỗi tải dữ liệu: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi khi tải dữ liệu từ GitHub:", error);
    }
}

async function saveToGitHub() {
    if (!stateChanged) return;

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Không thể tự động lưu: Thiếu cấu hình GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Tạm dừng (Thiếu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'Đang lưu...';

    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    const content = b64EncodeUnicode(JSON.stringify(state));
    
    try {
        const result = await fetchFileSha(cfg);
        const sha = result.sha; 
        
        const payload = {
            message: `[Auto-save] Cập nhật trạng thái giải đấu TKD lúc ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'Đã Lưu';
        } else {
            if (response.status === 409) {
                console.warn("Lỗi 409 Conflict: Dữ liệu đã thay đổi trên GitHub. Đang cố gắng lấy SHA mới.");
                await fetchFileSha(cfg); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. Sẽ thử lưu lại sau 1 phút.';
            } else {
                throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lưu lên GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Lỗi Lưu';
    }
}

async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui lòng nhập đầy đủ Owner, Repo và Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'Đang kiểm tra kết nối...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`Lỗi truy cập kho lưu trữ. Mã: ${repoResponse.status}. (Kiểm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', 'Kết nối GitHub thành công! Đang tải dữ liệu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Kiểm tra kết nối thất bại: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi kiểm tra kết nối:", error);
    }
}

// --- Cấu hình & Khởi tạo ---

function renderConfig() {
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
}

function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Chưa có sân nào được cấu hình.</div>`;
        return;
    }
    
    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>Tên Sân</th>
                <th>Giờ Bắt Đầu</th>
                <th>Thời Lượng Max (Phút)</th>
                <th>Phân Loại</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>`;
        
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'Bảng A (Nam-Nữ)' : 'Bảng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">Xóa</button>
            </td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';

    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'Sửa Cấu hình Sân' : 'Thêm Sân Mới';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = '180';
        document.getElementById('courtIsMixed').checked = true;
    }

    modal.show();
}

function saveCourtChanges() {
    const indexStr = document.getElementById('courtIndex').value;
    const index = indexStr === '' ? null : parseInt(indexStr);
    
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;

    const statusDiv = document.getElementById('courtFormStatus');

    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui lòng nhập đầy đủ và hợp lệ các trường (Tên, Giờ, Thời lượng > 0).</div>`;
        return;
    }
    
    const isDuplicate = state.courts.some((c, i) => 
        i !== index && c.name.toLowerCase() === name.toLowerCase()
    );

    if (isDuplicate) {
         statusDiv.innerHTML = `<div class="alert alert-danger p-2">Tên sân "${name}" đã tồn tại.</div>`;
        return;
    }

    const newCourt = { 
        name, 
        startTime, 
        maxDurationMinutes, 
        isMixed 
    };

    if (index !== null) {
        state.courts[index] = newCourt;
    } else {
        state.courts.push(newCourt);
    }
    
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();

    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', `Đã ${index !== null ? 'cập nhật' : 'thêm'} sân "${name}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
    saveToGitHub();
}

function deleteCourt(index) {
    if (confirm(`Bạn có chắc chắn muốn xóa sân "${state.courts[index].name}"?`)) {
        const deletedCourtName = state.courts[index].name;
        state.courts.splice(index, 1);
        
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', `Đã xóa sân "${deletedCourtName}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
        saveToGitHub();
    }
}

function loadDefaultCourtConfig() {
    state.courts = [
        { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }
    ];
    
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', 'Đã tải cấu hình sân Mặc định. Dữ liệu sẽ được tự động lưu lên GitHub.');
    saveToGitHub();
}

function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'state.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}

function saveConfig(){
  const cfg = {
    owner: document.getElementById('cfgOwner').value,
    repo: document.getElementById('cfgRepo').value,
    folder: document.getElementById('cfgFolder').value,
    file: document.getElementById('cfgFile').value,
    token: document.getElementById('cfgToken').value
  };
  state.config = cfg;
  localStorage.setItem('pkb_config', JSON.stringify(cfg));
  updateStatus('configStatus', 'success', 'Đã lưu cấu hình GitHub vào trình duyệt. Vui lòng Kiểm tra & Tải Dữ liệu.');
}

function updateStatus(id, type, message) {
    const statusDiv = document.getElementById(id);
    statusDiv.innerHTML = `<div class="alert alert-${type} p-2 mt-2">${message}</div>`;
}

function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    
    if (state.config.token && state.config.owner && state.config.repo) {
        autoSaveInterval = setInterval(saveToGitHub, 60000);
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Hoạt động...';
    } else {
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Tắt';
    }
}


window.onload = function() {
    loadConfig();
    
    const viewModeSelect = document.getElementById('viewMode');
    if (viewModeSelect && viewModeSelect.value !== 'court') {
        viewModeSelect.value = 'court'; 
    }

    if (state.config.token) {
        loadFromGitHub(); 
    } else {
        renderConfig(); 
        renderMatchesView(); // Initial rendering
        tinhVaCapNhatXepHang();
        renderFinals();
        renderFinalResults();
        renderOverview(); 
        startAutoSave(); 
    }
};

// --- LOGIC XỬ LÝ LỊCH & TỶ SỐ (ĐÃ HOÀN THIỆN) ---

/**
 * Tạo tất cả các cặp đấu round-robin cho một danh sách đội.
 */
function generateAllMatches(teams) {
    const matches = [];
    for (let i = 0; i < teams.length; i++) {
        for (let j = i + 1; j < teams.length; j++) {
            matches.push({
                teamA: teams[i],
                teamB: teams[j],
                scoreA: null,
                scoreB: null,
                winner: null,
                loser: null,
                time: null, 
                court: null
            });
        }
    }
    return matches;
}

/**
 * Phân tích dữ liệu CSV cố định thành mảng trận đấu
 */
function parseCsvSchedule(csvData, type) {
    const lines = csvData.trim().split('\n');
    if (lines.length < 2) return [];

    const headers = lines[0].split(',');
    const matchesArray = [];
    const teamList = type === 'A' ? state.mixedTeams : state.maleTeams;

    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        const startTime = row[0].trim();
        
        // Bắt đầu từ cột Sân 1 (index 3) đến trước cột cuối (index headers.length - 1)
        for (let j = 3; j < headers.length - 1; j++) { 
            const courtName = headers[j].trim();
            const matchString = row[j].trim();
            
            if (matchString.includes(' - ')) {
                const [teamA, teamB] = matchString.split(' - ').map(t => t.trim());
                
                // Kiểm tra xem cả hai đội có thuộc nhóm (A/B) hiện tại không
                if (teamList.includes(teamA) && teamList.includes(teamB)) {
                     matchesArray.push({
                        teamA: teamA,
                        teamB: teamB,
                        scoreA: null,
                        scoreB: null,
                        winner: null,
                        loser: null,
                        time: startTime,
                        court: courtName
                    });
                }
            }
        }
    }
    return matchesArray;
}

/**
 * Tạo lịch thi đấu Tối ưu (Round-Robin cơ bản + gán Sân)
 */
function taoLichThiDauCungGio() {
    const allMatchesA = generateAllMatches(state.mixedTeams);
    const allMatchesB = generateAllMatches(state.maleTeams);
    
    // Lấy danh sách sân theo loại bảng
    const mixedCourts = state.courts.filter(c => c.isMixed).map(c => c.name);
    const maleCourts = state.courts.filter(c => !c.isMixed).map(c => c.name);

    // Gán sân và giờ đơn giản (Giờ cố định, sân luân phiên)
    state.matchesA = allMatchesA.map((m, i) => ({ 
        ...m, 
        time: state.courts[0]?.startTime || '14:00', // Dùng giờ bắt đầu của sân đầu tiên
        court: mixedCourts.length > 0 ? mixedCourts[i % mixedCourts.length] : null
    })).filter(m => m.court);

    state.matchesB = allMatchesB.map((m, i) => ({ 
        ...m, 
        time: state.courts[0]?.startTime || '14:00', 
        court: maleCourts.length > 0 ? maleCourts[i % maleCourts.length] : null
    })).filter(m => m.court);

    renderMatchesView(); 
    stateChanged = true;
    saveToGitHub();
    showModal('Thành công', 'Đã tạo lịch thi đấu Tối ưu (Round-Robin cơ bản). Vui lòng kiểm tra tab Vòng Bảng.');
}

/**
 * Tạo lịch thi đấu Cố định từ CSV mẫu
 */
function taoLichCoDinh() {
    state.matchesA = parseCsvSchedule(FIXED_SCHEDULE_CSV, 'A'); 
    state.matchesB = parseCsvSchedule(FIXED_SCHEDULE_CSV, 'B'); 

    // Cần phải tính lại xếp hạng sau khi load lịch (vì có thể có kết quả cũ)
    tinhVaCapNhatXepHang();

    renderMatchesView();
    stateChanged = true;
    saveToGitHub();
    showModal('Thành công', 'Đã tạo lịch thi đấu Cố định từ dữ liệu CSV mẫu. Vui lòng kiểm tra tab Vòng Bảng.');
}

/**
 * Điền kết quả Tự động (11 - X)
 */
function autoFillScores() {
    if(state.matchesA.length === 0 && state.matchesB.length === 0) {
        showModal('Lỗi', 'Không có lịch thi đấu để điền tỷ số tự động.');
        return;
    }

    // Vòng bảng
    state.matchesA.forEach(m => { m.scoreA = 11; m.scoreB = 5; m.winner = m.teamA; m.loser = m.teamB; }); 
    state.matchesB.forEach(m => { m.scoreA = 11; m.scoreB = 5; m.winner = m.teamA; m.loser = m.teamB; });

    // Vòng Chung kết (Nếu đã có đội)
    state.semifinals.forEach(m => {
        if (m.teamA !== 'Nhất A' && m.teamB !== 'Nhất B') {
            m.scoreA = 11; m.scoreB = 7; m.winner = m.teamA; m.loser = m.teamB;
        }
    });

    // Cập nhật đội thắng vào chung kết
    const sf1Winner = state.semifinals.find(m => m.id === 'SF1')?.winner;
    const sf2Winner = state.semifinals.find(m => m.id === 'SF2')?.winner;

    if (sf1Winner && sf2Winner) {
        state.final.teamA = sf1Winner;
        state.final.teamB = sf2Winner;
        state.final.scoreA = 11; state.final.scoreB = 8;
        state.final.winner = state.final.teamA; state.final.loser = state.final.teamB;
        state.final.runnerUp = state.final.loser;
    }

    tinhVaCapNhatXepHang();
    scheduleFinalsAuto(true);
    renderMatchesView();
    renderFinals();
    renderFinalResults();
    
    stateChanged = true;
    saveToGitHub();
    showModal('Thành công', 'Đã điền kết quả Tự động (11 - X) cho tất cả trận đấu.');
}

/**
 * Xóa Toàn bộ Lịch
 */
function clearAllSchedules() {
    if (confirm('BẠN CÓ CHẮC CHẮN MUỐN XÓA TOÀN BỘ LỊCH THI ĐẤU VÀ KẾT QUẢ KHÔNG? Hành động này không thể hoàn tác.')) {
        state.matchesA = [];
        state.matchesB = [];
        state.semifinals = [
             { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhất B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
             { id: 'SF2', teamA: 'Nhì B', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null };
        state.tableA = [];
        state.tableB = [];

        renderMatchesView();
        renderFinals();
        renderFinalResults();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal('Đã xóa', 'Toàn bộ lịch thi đấu và kết quả đã được xóa.');
    }
}

/**
 * Cập nhật tỷ số trận đấu (Vòng Bảng, Bán kết, Chung kết)
 */
function capNhatTiSo(inputElement, type, idOrIndex, teamIndex, isGroupMatch = true) {
    let score = parseInt(inputElement.value);
    if (isNaN(score) || inputElement.value === '') score = null;
    if (score !== null && score < 0) score = 0;
    
    let match;

    if (isGroupMatch) {
        const index = parseInt(idOrIndex);
        const matchesArray = type === 'A' ? state.matchesA : state.matchesB;
        match = matchesArray[index];
    } else {
        if (type === 'final') {
            match = state.final;
        } else {
            match = state.semifinals.find(m => m.id === idOrIndex);
        }
    }
    
    if (match) {
        if (teamIndex === 0) {
            match.scoreA = score;
        } else {
            match.scoreB = score;
        }

        // Logic xác định thắng/thua (11 điểm, cách 2)
        if (match.scoreA !== null && match.scoreB !== null) {
            if (match.scoreA >= 11 && match.scoreA - match.scoreB >= 2) {
                match.winner = match.teamA;
                match.loser = match.teamB;
            } else if (match.scoreB >= 11 && match.scoreB - match.scoreA >= 2) {
                match.winner = match.teamB;
                match.loser = match.teamA;
            } else {
                match.winner = null;
                match.loser = null;
            }
        } else {
             match.winner = null;
             match.loser = null;
        }

        stateChanged = true;

        if (isGroupMatch) {
            tinhVaCapNhatXepHang();
            scheduleFinalsAuto(true);
        } else {
            if (type === 'final') {
                state.final.runnerUp = match.loser; 
            }
            
            // Logic thăng hạng Bán kết lên Chung kết
            if (type === 'semifinals') {
                const sf1Winner = state.semifinals.find(m => m.id === 'SF1')?.winner;
                const sf2Winner = state.semifinals.find(m => m.id === 'SF2')?.winner;
                
                // Chỉ cập nhật đội vào chung kết nếu đã có người thắng
                if (sf1Winner) {
                     state.final.teamA = sf1Winner;
                } else if(state.final.teamA !== 'Thắng SF1' && !sf1Winner) {
                    state.final.teamA = 'Thắng SF1'; // Reset nếu người thắng bị xóa
                    state.final.scoreA = null; state.final.scoreB = null; state.final.winner = null; state.final.loser = null; state.final.runnerUp = null;
                }
                
                if (sf2Winner) {
                     state.final.teamB = sf2Winner;
                } else if(state.final.teamB !== 'Thắng SF2' && !sf2Winner) {
                    state.final.teamB = 'Thắng SF2'; // Reset nếu người thắng bị xóa
                    state.final.scoreA = null; state.final.scoreB = null; state.final.winner = null; state.final.loser = null; state.final.runnerUp = null;
                }
            }
        }
        
        renderMatchesView(); 
        renderFinals(); 
        renderFinalResults();
        renderOverview();
    }
}


// --- HÀM RENDER VÀ XẾP HẠNG ---

function tinhVaCapNhatXepHang() {
    const calculateRanking = (teams, matches) => {
        const rankings = teams.map(team => ({
            team: team,
            wins: 0,
            losses: 0,
            points: 0,
            scoreDiff: 0
        }));

        matches.forEach(match => {
            if (match.winner) {
                const winnerRank = rankings.find(r => r.team === match.winner);
                const loserRank = rankings.find(r => r.team === match.loser);
                
                if (winnerRank) {
                    winnerRank.wins++;
                    winnerRank.points += 2; 
                }
                if (loserRank) {
                    loserRank.losses++;
                    loserRank.points += 1; 
                }

                if (winnerRank) winnerRank.scoreDiff += 1;
                if (loserRank) loserRank.scoreDiff -= 1;
            }
        });
        
        // Sắp xếp: 1. Điểm, 2. Hiệu số, 3. Tên đội
        rankings.sort((a, b) => {
            if (b.points !== a.points) return b.points - a.points;
            if (b.scoreDiff !== a.scoreDiff) return b.scoreDiff - a.scoreDiff;
            return a.team.localeCompare(b.team);
        });

        return rankings;
    };

    state.tableA = calculateRanking(state.mixedTeams, state.matchesA);
    state.tableB = calculateRanking(state.maleTeams, state.matchesB);
    
    renderRankingTables();
}

function scheduleFinalsAuto(silent = false) {
    if (!silent && !confirm('Bạn có chắc chắn muốn lên lịch Vòng Chung kết dựa trên kết quả hiện tại của Vòng Bảng? Hành động này sẽ ghi đè lịch Bán kết hiện tại.')) {
        return;
    }
    
    if (state.tableA.length >= 2 && state.tableB.length >= 2) {
        const nhatA = state.tableA[0].team;
        const nhatB = state.tableB[0].team;
        const nhiA = state.tableA[1].team;
        const nhiB = state.tableB[1].team;

        // Cập nhật Bán kết (Giữ nguyên tỷ số nếu đã nhập)
        state.semifinals[0].teamA = nhatA;
        state.semifinals[0].teamB = nhatB;
        state.semifinals[1].teamA = nhiB;
        state.semifinals[1].teamB = nhiA;

        // Reset Chung kết nếu tên đội thay đổi
        state.final.teamA = 'Thắng SF1';
        state.final.teamB = 'Thắng SF2';
        state.final.scoreA = null;
        state.final.scoreB = null;
        state.final.winner = null;
        state.final.loser = null;
        state.final.runnerUp = null;

        stateChanged = true;
        
        renderFinals();
        renderFinalResults();
        
        if (!silent) {
            saveToGitHub();
            showModal('Thành công', 'Đã lên lịch Vòng Chung kết tự động dựa trên bảng xếp hạng hiện tại.');
            switchTab('finals');
        }
    } else {
        if (!silent) {
            showModal('Cảnh báo', 'Không đủ dữ liệu xếp hạng (cần ít nhất 2 đội ở mỗi bảng) để tạo lịch Chung kết.');
        }
    }
}

// --- HÀM RENDER CHI TIẾT VÒNG BẢNG ---

function renderMatchesView() {
    const mode = document.getElementById('viewMode').value;
    const container = document.getElementById('matchesViewContent');
    let html = '';

    if (mode === 'court') {
        html = renderMatchesByCourt();
    } else {
        html = renderMatchesByTable();
    }
    
    container.innerHTML = html;
}

/**
 * Hiển thị Vòng Bảng theo cấu trúc Bảng A / B
 */
function renderMatchesByTable() {
    let html = '';
    html += `<h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6>`;
    html += renderMatchTable(state.matchesA, 'A');
    
    html += `<h6 class="mt-4">Bảng B (Nam)</h6>`;
    html += renderMatchTable(state.matchesB, 'B');
    
    return html;
}

/**
 * Helper: Tạo HTML bảng cho một nhóm trận đấu Vòng Bảng
 */
function renderMatchTable(matches, type) {
    if (matches.length === 0) return `<div class="alert alert-info">Chưa có lịch thi đấu cho Bảng ${type}.</div>`;

    let html = `<div class='table-responsive'><table class='table table-sm table-striped'>
        <thead><tr><th>#</th><th>Giờ</th><th>Sân</th><th>Đội A</th><th class="text-center">Tỉ số</th><th>Đội B</th><th>Thắng</th></tr></thead><tbody>`;

    matches.forEach((match, index) => {
        const winnerClassA = match.winner === match.teamA ? 'winner' : (match.loser === match.teamA ? 'loser' : '');
        const winnerClassB = match.winner === match.teamB ? 'winner' : (match.loser === match.teamB ? 'loser' : '');
        const winnerText = match.winner ? match.winner : '';

        html += `<tr>
            <td>${index + 1}</td>
            <td>${match.time || '--'}</td>
            <td>${match.court || '--'}</td>
            <td class="${winnerClassA}">${match.teamA}</td>
            <td class="match-score-cell">
                <input type='number' min='0' value='${match.scoreA !== null ? match.scoreA : ''}' onchange='capNhatTiSo(this, "${type}", ${index}, 0)' class='form-control form-control-sm'> 
                - 
                <input type='number' min='0' value='${match.scoreB !== null ? match.scoreB : ''}' onchange='capNhatTiSo(this, "${type}", ${index}, 1)' class='form-control form-control-sm'>
            </td>
            <td class="${winnerClassB}">${match.teamB}</td>
            <td>${winnerText}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    return html;
}


/**
 * Hiển thị Vòng Bảng theo cấu trúc Giờ -> Sân
 */
function renderMatchesByCourt() {
    const allMatches = [...state.matchesA.map((m, i) => ({ ...m, type: 'A', index: i })), 
                        ...state.matchesB.map((m, i) => ({ ...m, type: 'B', index: i }))]
                        .filter(m => m.court && m.time) 
                        .sort((a, b) => {
                            if (a.time < b.time) return -1;
                            if (a.time > b.time) return 1;
                            if (a.court < b.court) return -1;
                            if (a.court > b.court) return 1;
                            return 0;
                        });

    if (allMatches.length === 0) return `<div class="alert alert-info">Chưa có lịch thi đấu được gán Sân và Giờ. Vui lòng tạo lịch trước.</div>`;

    const groupedByTime = allMatches.reduce((acc, match) => {
        const key = match.time;
        if (!acc[key]) acc[key] = [];
        acc[key].push(match);
        return acc;
    }, {});
    
    let html = `<h6 class="mt-4">Lịch thi đấu theo Giờ và Sân</h6>`;
    
    for (const time in groupedByTime) {
        const matchesAtTime = groupedByTime[time].sort((a, b) => a.court.localeCompare(b.court));
        
        html += `<h5 class="mt-3 mb-2 text-primary">Thời gian: ${time}</h5>`;
        html += `<div class='table-responsive'><table class='table table-sm table-striped'>
            <thead><tr><th>Sân</th><th>Đội A</th><th class="text-center">Tỉ số</th><th>Đội B</th><th>Thắng</th></tr></thead><tbody>`;

        matchesAtTime.forEach(match => {
            const winnerClassA = match.winner === match.teamA ? 'winner' : (match.loser === match.teamA ? 'loser' : '');
            const winnerClassB = match.winner === match.teamB ? 'winner' : (match.loser === match.teamB ? 'loser' : '');
            const winnerText = match.winner ? match.winner : '';
            const badgeType = match.type === 'A' ? 'badge bg-primary' : 'badge bg-info';

            html += `<tr>
                <td>${match.court} <span class="${badgeType}">${match.type}</span></td>
                <td class="${winnerClassA}">${match.teamA}</td>
                <td class="match-score-cell">
                    <input type='number' min='0' value='${match.scoreA !== null ? match.scoreA : ''}' onchange='capNhatTiSo(this, "${match.type}", ${match.index}, 0)' class='form-control form-control-sm'> 
                    - 
                    <input type='number' min='0' value='${match.scoreB !== null ? match.scoreB : ''}' onchange='capNhatTiSo(this, "${match.type}", ${match.index}, 1)' class='form-control form-control-sm'>
                </td>
                <td class="${winnerClassB}">${match.teamB}</td>
                <td>${winnerText}</td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
    }

    return html;
}

// --- HÀM RENDER KẾT QUẢ CHUNG KẾT (Giữ nguyên logic) ---

function renderFinals() {
    const sfHtml = state.semifinals.map(sf => {
        const winnerClass = sf.winner ? 'winner' : '';
        const disabledSF = (sf.teamA === 'Nhất A' || sf.teamB === 'Nhất B') ? 'disabled' : '';

        return `
        <tr>
            <td>${sf.time}</td>
            <td>${sf.court}</td>
            <td>${sf.id}</td>
            <td>${sf.teamA}</td>
            <td class="match-score-cell">
                <input type='number' min='0' value='${sf.scoreA !== null ? sf.scoreA : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", 0, false)' class='form-control form-control-sm' ${disabledSF}> 
                - 
                <input type='number' min='0' value='${sf.scoreB !== null ? sf.scoreB : ''}' onchange='capNhatTiSo(this, "semifinals", "${sf.id}", 1, false)' class='form-control form-control-sm' ${disabledSF}>
            </td>
            <td class="${winnerClass}">${sf.winner ? sf.winner : 'Đang đấu'}</td>
        </tr>`;
    }).join('');

    const sfTableHtml = `<div class='table-responsive'><table class='table table-sm table-striped'>
        <thead><tr><th>Giờ</th><th>Sân</th><th>Trận</th><th>Đội A</th><th class="text-center">Tỉ số</th><th>Thắng</th></tr></thead><tbody>${sfHtml}</tbody></table></div>`;
    
    document.getElementById('semifinalMatches').innerHTML = sfTableHtml;
    
    const final = state.final;
    const winnerClassF = final.winner ? 'winner' : '';
    // Vô hiệu hóa input nếu chưa có đội thắng bán kết được gán
    const disabledF = (final.teamA === 'Thắng SF1' || final.teamB === 'Thắng SF2') ? 'disabled' : '';
    
    let fHtml = `<div class='table-responsive'><table class='table table-sm table-striped'>
        <thead><tr><th>Giờ</th><th>Sân</th><th>Trận</th><th>Đội A</th><th>Đội B</th><th class="text-center">Tỉ số</th><th>Kết quả</th></tr></thead><tbody>`;
    fHtml += `
    <tr>
        <td>${final.time}</td>
        <td>${final.court}</td>
        <td>${final.id}</td>
        <td>${final.teamA}</td>
        <td>${final.teamB}</td>
        <td class="match-score-cell">
            <input type='number' min='0' value='${final.scoreA !== null ? final.scoreA : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", 0, false)' class='form-control form-control-sm' ${disabledF}> 
            - 
            <input type='number' min='0' value='${final.scoreB !== null ? final.scoreB : ''}' onchange='capNhatTiSo(this, "final", "${final.id}", 1, false)' class='form-control form-control-sm' ${disabledF}>
        </td>
        <td class="${winnerClassF}">${final.winner ? final.winner + ' Vô địch' : 'Đang đấu'}</td>
    </tr>`;
    fHtml += `</tbody></table></div>`;
    document.getElementById('finalMatch').innerHTML = fHtml;
}

function renderFinalResults() {
    const final = state.final;
    const sf1Loser = state.semifinals[0].loser;
    const sf2Loser = state.semifinals[1].loser;
    
    let thirdPlaceTeams = [];
    if (sf1Loser) thirdPlaceTeams.push(sf1Loser);
    if (sf2Loser) thirdPlaceTeams.push(sf2Loser);

    document.getElementById('champion').innerHTML = final.winner 
        ? `<span class="badge bg-success">🥇 Vô địch: ${final.winner}</span>` 
        : 'Vô địch: Đang chờ kết quả...';

    document.getElementById('runnerUp').innerHTML = final.runnerUp 
        ? `<span class="badge bg-secondary">🥈 Á quân: ${final.runnerUp}</span>` 
        : 'Á quân: Đang chờ kết quả...';
        
    document.getElementById('thirdPlace').innerHTML = thirdPlaceTeams.length >= 1
        ? `<span class="badge bg-info">🥉 Hạng Ba Đồng Hạng: ${thirdPlaceTeams.join(' & ')}</span>`
        : 'Hạng Ba Đồng Hạng: Đang chờ kết quả...';
}

function renderRankingTables() {
    const container = document.getElementById('rankingTables');
    let htmlA = renderSingleRankingTable('Bảng A (Nam - Nữ)', state.tableA);
    let htmlB = renderSingleRankingTable('Bảng B (Nam)', state.tableB);
    container.innerHTML = htmlA + htmlB;
}

function renderSingleRankingTable(title, tableData) {
    let html = `<div><h5>${title}</h5><div class='table-responsive'><table class='table table-sm table-striped'>
        <thead><tr><th>#</th><th>Đội</th><th>Thắng</th><th>Thua</th><th>Điểm</th><th>Hiệu số</th></tr></thead><tbody>`;
    
    tableData.forEach((row, index) => {
        const rank = index + 1;
        html += `<tr>
            <td>${rank}</td>
            <td>${row.team}</td>
            <td>${row.wins}</td>
            <td>${row.losses}</td>
            <td>${row.points}</td>
            <td>${row.scoreDiff}</td>
        </tr>`;
    });
    
    html += `</tbody></table></div></div>`;
    return html;
}

function renderOverview() {
    const allPlayers = [...state.mixedTeams, ...state.maleTeams]
        .flatMap(team => team.split('/')).map(p => p.trim());
    const uniquePlayers = Array.from(new Set(allPlayers)).sort();
    
    const totalMatches = state.matchesA.length + state.matchesB.length;
    const completedMatches = state.matchesA.filter(m => m.winner).length + state.matchesB.filter(m => m.winner).length;
    const percentage = totalMatches > 0 ? ((completedMatches / totalMatches) * 100).toFixed(1) : 0;

    let finalStatus = 'Chưa đấu';
    if (state.semifinals.some(m => m.winner)) finalStatus = 'Đang đấu Bán kết';
    if (state.final.winner) finalStatus = 'Đã kết thúc';
    else if (state.final.teamA !== 'Thắng SF1') finalStatus = 'Đang chờ Chung kết';

    let html = `
        <h5 class="mb-3">Thống kê Giải đấu</h5>
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card p-3 shadow-sm border-0">
                    <div class="text-secondary small">Tổng số Đội tham gia</div>
                    <h3 class="fw-bold">${state.mixedTeams.length + state.maleTeams.length}</h3>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card p-3 shadow-sm border-0">
                    <div class="text-secondary small">Tổng số Vận động viên</div>
                    <h3 class="fw-bold">${uniquePlayers.length}</h3>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card p-3 shadow-sm border-0">
                    <div class="text-secondary small">Trạng thái Vòng Chung kết</div>
                    <h3 class="fw-bold">${finalStatus}</h3>
                </div>
            </div>
        </div>
        
        <h5 class="mt-4 mb-3">Tiến độ Vòng Bảng</h5>
        <div class="progress mb-2" role="progressbar" style="height: 30px; font-size: 1rem;">
            <div class="progress-bar bg-primary" style="width: ${percentage}%">${percentage}% (${completedMatches}/${totalMatches})</div>
        </div>
        <p class="small text-muted">Số trận đã hoàn thành trên tổng số trận Vòng Bảng.</p>

        <h5 class="mt-4 mb-3">Chi tiết Bảng đấu</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="card p-3 shadow-sm">
                    <div class="text-secondary small">Bảng A (Nam - Nữ)</div>
                    <h5 class="fw-bold">${state.mixedTeams.length} Đội</h5>
                    <p class="small">${state.mixedTeams.join(', ')}</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 shadow-sm">
                    <div class="text-secondary small">Bảng B (Nam)</div>
                    <h5 class="fw-bold">${state.maleTeams.length} Đội</h5>
                    <p class="small">${state.maleTeams.join(', ')}</p>
                </div>
            </div>
        </div>
    `;
    document.getElementById('overviewContent').innerHTML = html;
}

// --- PLACEHOLDER FUNCTIONS (Cần được bổ sung logic đầy đủ) ---

function handleFileSelect(event) {
    showModal('Thông báo', 'Hàm import file CSV chưa được triển khai đầy đủ.');
    // Logic import file CSV (Cần được bổ sung)
}

function exportSchedule() {
    showModal('Thông báo', 'Hàm export lịch thi đấu chưa được triển khai đầy đủ.');
    // Logic export schedule (Cần được bổ sung)
}
</script>
