<!doctype html>
<html lang='vi'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width,initial-scale=1' />
  <title>Pickleball Tournament V9.7.6 (Match Details)</title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* B·ªï sung CSS tr·ª±c ti·∫øp ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh th·∫©m m·ªπ v√† d·ªÖ ƒë·ªçc */
    body { background:#fff; color:#111; font-family: 'Inter', sans-serif; }
    .navbar { background:#000; }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .btn { color:#fff !important; }
    .btn-dark { background:#000; color:#fff; border-color:#222; }
    .btn-info { background:#0d6efd !important; border-color:#0d6efd !important; }
    .section { border:1px solid #ddd; padding:12px; border-radius:6px; margin-bottom:12px; }
    .logo-preview { width:60px; height:60px; object-fit:contain; border:1px solid #222; background:#fff; border-radius:4px;}
    input.form-control, textarea.form-control { border:1px solid #222; border-radius:4px; }
    .small-muted { color:#666; font-size: 0.85em; }
    /* CSS cho B·∫£ng x·∫øp h·∫°ng v√† Knockout */
    .table-success { --bs-table-bg: #d1e7dd; } /* ƒê·ªôi ƒë·ªß ƒëi·ªÅu ki·ªán v√†o v√≤ng lo·∫°i */
    .match-info { font-size:0.9em; color:#555; }
    .team-tag { font-size:0.7em; margin-left:5px; }
    .badge { font-weight: 500; }
    .list-group-item:hover { background-color: #f8f9fa; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <a class="navbar-brand" href="#" id="tournamentNameDisplay">Pickleball Tournament V9.7.6</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-tab-pane" type="button" role="tab">C·∫•u H√¨nh ‚öôÔ∏è</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="players-teams-tab" data-bs-toggle="tab" data-bs-target="#players-teams-tab-pane" type="button" role="tab">Ng∆∞·ªùi Ch∆°i & ƒê·ªôi üë•</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-tab-pane" type="button" role="tab">V√≤ng B·∫£ng üìä</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="knockout-tab" data-bs-toggle="tab" data-bs-target="#knockout-tab-pane" type="button" role="tab">V√≤ng Lo·∫°i üèÜ</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test-tab-pane" type="button" role="tab">Test üß™</button></li>
      </ul>
      <button class="btn btn-outline-light me-2" onclick="openImportJsonModal()">Import JSON</button>
      <button class="btn btn-outline-light" onclick="exportTournament()">Export JSON</button>
    </div>
  </div>
</nav>
<div class="container mt-4">
  <div class="tab-content" id="myTabContent">

    <div class="tab-pane fade show active" id="config-tab-pane" role="tabpanel" tabindex="0">
      <h2>C·∫•u H√¨nh Gi·∫£i ƒê·∫•u</h2>

      <h5 class="mt-4">1. C·∫•u h√¨nh Chung</h5>
      <div class="section">
        <div class="mb-3">
          <label for="tournamentNameInput" class="form-label">T√™n Gi·∫£i ƒê·∫•u</label>
          <input type="text" class="form-control" id="tournamentNameInput" placeholder="V√≠ d·ª•: Gi·∫£i Pickleball M√πa Thu">
        </div>
        <div class="mb-3">
            <label for="logoInput" class="form-label">Logo Gi·∫£i ƒê·∫•u</label>
            <input class="form-control" type="file" id="logoInput" accept="image/*">
            <div class="mt-2">
                <img id="logoPreview" class="logo-preview" src="" alt="Logo Preview">
            </div>
            <p class="small-muted mt-2">Logo s·∫Ω ƒë∆∞·ª£c l∆∞u d∆∞·ªõi d·∫°ng Base64 trong d·ªØ li·ªáu gi·∫£i ƒë·∫•u.</p>
        </div>
      </div>

      <h5 class="mt-4">2. C·∫•u h√¨nh Ph√¢n b·∫£ng & Lo·∫°i</h5>
      <div class="section">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="groupSize" class="form-label">S·ªë ƒê·ªôi M·ªói B·∫£ng</label>
            <input type="number" class="form-control" id="groupSize" min="2" value="4">
            <div id="groupSizeFeedback" class="small-muted">S·ªë ƒë·ªôi t·ªëi thi·ªÉu l√† 2.</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="teamsPerGroupAdvance" class="form-label">S·ªë ƒê·ªôi V√†o V√≤ng Lo·∫°i (M·ªói B·∫£ng)</label>
            <input type="number" class="form-control" id="teamsPerGroupAdvance" min="1" value="2">
            <div id="teamsPerGroupAdvanceFeedback" class="small-muted">Ph·∫£i nh·ªè h∆°n S·ªë ƒê·ªôi M·ªói B·∫£ng.</div>
          </div>
        </div>
        <h6 class="mt-3">H√¨nh th·ª©c t√≠nh ƒëi·ªÉm V√≤ng B·∫£ng</h6>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="scoringType" id="scoringTypeClassic" value="classic" checked>
          <label class="form-check-label" for="scoringTypeClassic">Classic (3ƒë th·∫Øng, 1ƒë h√≤a, 0ƒë thua)</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="scoringType" id="scoringTypeSets" value="sets">
          <label class="form-check-label" for="scoringTypeSets">Sets (Th·∫Øng set ƒë∆∞·ª£c ƒëi·ªÉm)</label>
        </div>
      </div>

      <h5 class="mt-4">3. Th·ªÉ th·ª©c Thi ƒë·∫•u (S·ªë set/ƒêi·ªÉm/C√°ch bi·ªát)</h5>
      <p class="small-muted">C·∫•u h√¨nh chi ti·∫øt s·ªë set, ƒëi·ªÉm, v√† c√°ch bi·ªát th·∫Øng cho t·ª´ng v√≤ng ƒë·∫•u.</p>
      <div id="formatsList" class="section">
          </div>
      <button type="button" class="btn btn-dark mt-2" onclick="openFormatModal()">+ Th√™m V√≤ng ƒê·∫•u/Th·ªÉ Th·ª©c</button>
      
      <button class="btn btn-primary mt-4" onclick="saveTournamentConfig()">L∆∞u C·∫•u H√¨nh</button>
      
      <h5 class="mt-5">4. C√¥ng c·ª• qu·∫£n l√Ω d·ªØ li·ªáu</h5>
      <div class="section">
        <button class="btn btn-sm btn-outline-warning me-2" onclick="renderSavedList()">T·∫£i Gi·∫£i ƒê√£ L∆∞u (Ch·ª©c nƒÉng ch∆∞a ho√†n thi·ªán)</button>
        <button class="btn btn-sm btn-outline-danger" onclick="clearTournament()">X√≥a To√†n B·ªô Gi·∫£i ƒê·∫•u</button>
        <p class="small-muted mt-2">S·ª≠ d·ª•ng ch·ª©c nƒÉng "Export JSON" tr√™n thanh Navbar ƒë·ªÉ sao l∆∞u d·ªØ li·ªáu an to√†n.</p>
      </div>

    </div>
    <div class="tab-pane fade" id="players-teams-tab-pane" role="tabpanel" tabindex="0">
      <h2>Qu·∫£n L√Ω Ng∆∞·ªùi Ch∆°i & ƒê·ªôi</h2>
      
      <h5 class="mt-4">1. Danh S√°ch Ng∆∞·ªùi Ch∆°i (<span id="playerCount">0</span> ng∆∞·ªùi)</h5>
      <div class="section">
        <button class="btn btn-success me-2" onclick="openPlayerModal()">+ Th√™m Ng∆∞·ªùi Ch∆°i</button>
        <button class="btn btn-outline-secondary me-2" onclick="openImportCSVModal()">Import CSV</button>
        <button class="btn btn-outline-secondary" onclick="downloadCsvTemplate()">T·∫£i M·∫´u CSV</button>
        
        <div class="mt-3">
            <input type="text" class="form-control" id="playerSearchInput" onkeyup="renderPlayerList()" placeholder="T√¨m ki·∫øm ng∆∞·ªùi ch∆°i...">
        </div>
        <div class="mt-3" id="playerList">
          </div>
      </div>
      
      <h5 class="mt-4">2. Danh S√°ch ƒê·ªôi (<span id="teamCount">0</span> ƒë·ªôi)</h5>
      <div class="section">
        <button class="btn btn-info" onclick="openTeamModal()">+ Th√™m ƒê·ªôi M·ªõi</button>
        <div class="mt-3" id="teamList">
          </div>
      </div>
    </div>
    <div class="tab-pane fade" id="groups-tab-pane" role="tabpanel" tabindex="0">
      <h2>V√≤ng B·∫£ng & B·∫£ng X·∫øp H·∫°ng</h2>
      
      <h5 class="mt-4">1. Ph√¢n B·∫£ng & L·ªãch Thi ƒê·∫•u</h5>
      <div class="section">
        <div id="groupManagementControls">
            <p><strong>S·ªë ƒë·ªôi:</strong> <span id="teamCountGroupTab">0</span> | <strong>S·ªë b·∫£ng d·ª± ki·∫øn:</strong> <span id="numGroupsEstimate">0</span></p>
            <button class="btn btn-warning me-2" onclick="generateGroups()">Ph√¢n B·∫£ng T·ª± ƒê·ªông</button>
            <button class="btn btn-success" onclick="generateMatches()">T·∫°o L·ªãch Thi ƒê·∫•u</button>
        </div>
        <div class="mt-3" id="groupList">
          </div>
      </div>
      
      <h5 class="mt-4">2. B·∫£ng X·∫øp H·∫°ng</h5>
      <div class="section" id="standingsContainer">
        <p class="text-muted">Nh·∫•n "T·∫°o B·∫£ng X·∫øp H·∫°ng" ƒë·ªÉ xem k·∫øt qu·∫£.</p>
        <button class="btn btn-primary" onclick="updateStandings()">T·∫°o B·∫£ng X·∫øp H·∫°ng</button>
      </div>
      
    </div>
    <div class="tab-pane fade" id="knockout-tab-pane" role="tabpanel" tabindex="0">
      <h2>V√≤ng Lo·∫°i Tr·ª±c Ti·∫øp</h2>
      
      <div class="section">
        <button class="btn btn-danger" onclick="createKnockoutRounds()">T·∫°o C√¢y ƒê·∫•u Lo·∫°i (D·ª±a tr√™n BXH V√≤ng B·∫£ng)</button>
        <p class="small-muted mt-2">S·∫Ω t·∫°o ra c√¢y ƒë·∫•u lo·∫°i (Knockout Tree) d·ª±a tr√™n k·∫øt qu·∫£ v√≤ng b·∫£ng v√† s·ªë ƒë·ªôi v√†o v√≤ng lo·∫°i.</p>
        
        <div class="mt-3" id="knockoutTree">
          </div>
      </div>
    </div>
    <div class="tab-pane fade" id="test-tab-pane" role="tabpanel" tabindex="0">
      <h2>Ch·ª©c NƒÉng Test & Gi·∫£ L·∫≠p D·ªØ Li·ªáu</h2>
      <p class="small-muted">C√°c ch·ª©c nƒÉng n√†y gi√∫p t·∫°o nhanh ng∆∞·ªùi ch∆°i, ƒë·ªôi (c·∫∑p) v√† b·∫£ng ƒë·∫•u ƒë·ªÉ ki·ªÉm tra h·ªá th·ªëng.</p>

      <h5 class="mt-4">1. T·∫°o Ng∆∞·ªùi Ch∆°i T·ª± ƒê·ªông</h5>
      <div class="section">
        <div class="row g-3">
          <div class="col-md-4">
            <label for="maleCount" class="form-label">S·ªë l∆∞·ª£ng Nam</label>
            <input type="number" class="form-control" id="maleCount" min="0" value="10">
          </div>
          <div class="col-md-4">
            <label for="femaleCount" class="form-label">S·ªë l∆∞·ª£ng N·ªØ</label>
            <input type="number" class="form-control" id="femaleCount" min="0" value="6">
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-warning w-100" onclick="generateFakePlayers()">T·∫°o Ng∆∞·ªùi Ch∆°i</button>
          </div>
        </div>
        <p class="small-muted mt-2">S·∫Ω th√™m ng∆∞·ªùi ch∆°i m·ªõi v√†o danh s√°ch hi·ªán t·∫°i. C·∫ßn Nam v√† N·ªØ ƒë·ªÉ t·∫°o c√°c lo·∫°i h√¨nh c·∫∑p kh√°c nhau.</p>
      </div>
      
      <h5 class="mt-4">2. T·∫°o ƒê·ªôi (C·∫∑p) T·ª± ƒê·ªông t·ª´ Ng∆∞·ªùi Ch∆°i Hi·ªán C√≥</h5>
      <div class="section">
        <p>Ch·ªçn c√°c lo·∫°i h√¨nh c·∫∑p ƒë·∫•u mu·ªën t·∫°o (t·ª´ **<span id="playerCountTest">0</span>** ng∆∞·ªùi ch∆°i ƒë·ªôc l·∫≠p hi·ªán c√≥):</p>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="mixMaleMale" value="MM" checked>
          <label class="form-check-label" for="mixMaleMale">Nam - Nam</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="mixMaleFemale" value="MF" checked>
          <label class="form-check-label" for="mixMaleFemale">Nam - N·ªØ</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" id="mixFemaleFemale" value="FF" checked>
          <label class="form-check-label" for="mixFemaleFemale">N·ªØ - N·ªØ</label>
        </div>
        <button class="btn btn-success mt-3 w-100" onclick="generatePairs()">T·∫°o ƒê·ªôi (C·∫∑p) T·ª± ƒê·ªông</button>
        <p class="small-muted mt-2">S·∫Ω t·∫°o ra c√°c ƒë·ªôi 2 ng∆∞·ªùi (t·ª´ ng∆∞·ªùi ch∆°i ch∆∞a c√≥ ƒë·ªôi) v√† g·∫Øn tag (MM/MF/FF) v√†o ƒê·ªôi.</p>
      </div>

      <h5 class="mt-4">3. Ph√¢n B·∫£ng T·ª± ƒê·ªông theo Lo·∫°i H√¨nh ƒê·ªôi</h5>
      <div class="section">
        <p>Ph√¢n nh√≥m c√°c ƒë·ªôi (<span id="teamCountTest">0</span> ƒë·ªôi) theo lo·∫°i h√¨nh ƒë√£ t·∫°o ·ªü b∆∞·ªõc 2.</p>
        <div class="row g-3">
          <div class="col-md-4">
            <label for="groupsMM" class="form-label">S·ªë B·∫£ng Nam-Nam (MM)</label>
            <input type="number" class="form-control" id="groupsMM" min="0" value="1">
          </div>
          <div class="col-md-4">
            <label for="groupsMF" class="form-label">S·ªë B·∫£ng Nam-N·ªØ (MF)</label>
            <input type="number" class="form-control" id="groupsMF" min="0" value="1">
          </div>
          <div class="col-md-4">
            <label for="groupsFF" class="form-label">S·ªë B·∫£ng N·ªØ-N·ªØ (FF)</label>
            <input type="number" class="form-control" id="groupsFF" min="0" value="0">
          </div>
        </div>
        <button class="btn btn-primary mt-3 w-100" onclick="generateTestGroups()">T·∫°o B·∫£ng ƒê·∫•u (theo lo·∫°i)</button>
        <p class="small-muted mt-2">S·∫Ω x√≥a B·∫£ng v√† L·ªãch hi·ªán t·∫°i. C·∫ßn ƒë·ªß ƒë·ªôi theo c·∫•u h√¨nh **S·ªë ƒê·ªôi M·ªói B·∫£ng** ·ªü tab C·∫•u H√¨nh.</p>
      </div>
      
      <h5 class="mt-4">4. X√≥a D·ªØ Li·ªáu Th·ª≠ Nghi·ªám</h5>
      <div class="section">
          <p class="small-muted">S·ª≠ d·ª•ng c√°c ch·ª©c nƒÉng n√†y ƒë·ªÉ d·ªçn d·∫πp d·ªØ li·ªáu gi·∫£ l·∫≠p m·ªôt c√°ch nhanh ch√≥ng.</p>
          <button class="btn btn-outline-danger me-2" onclick="deleteAllPlayers()">X√≥a To√†n B·ªô Ng∆∞·ªùi Ch∆°i üßç</button>
          <button class="btn btn-outline-danger me-2" onclick="deleteAllTeams()">X√≥a To√†n B·ªô ƒê·ªôi üë•</button>
          <button class="btn btn-outline-danger" onclick="deleteAllGroupsAndMatches()">X√≥a To√†n B·ªô B·∫£ng & L·ªãch üìä</button>
      </div>

    </div>
    </div>
</div>
<div class="modal fade" id="editPlayerModal" tabindex="-1" aria-labelledby="editPlayerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editPlayerModalLabel">Th√™m/S·ª≠a Ng∆∞·ªùi Ch∆°i</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editPlayerModalBody">
                <form id="playerForm">
                    <input type="hidden" id="playerId">
                    <div class="mb-3">
                        <label for="playerName" class="form-label">T√™n *</label>
                        <input type="text" class="form-control" id="playerName" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="playerNickname" class="form-label">Nickname</label>
                            <input type="text" class="form-control" id="playerNickname">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="playerLevel" class="form-label">Level</label>
                            <select class="form-select" id="playerLevel">
                                <option value="1.0">1.0 (M·ªõi ch∆°i)</option>
                                <option value="2.0">2.0</option>
                                <option value="3.0" selected>3.0 (Trung b√¨nh)</option>
                                <option value="4.0">4.0</option>
                                <option value="5.0">5.0 (Chuy√™n nghi·ªáp)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="playerGender" class="form-label">Gi·ªõi t√≠nh</label>
                            <select class="form-select" id="playerGender">
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                                <option value="">Kh√°c/Kh√¥ng r√µ</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="playerDob" class="form-label">Ng√†y sinh</label>
                            <input type="date" class="form-control" id="playerDob">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="playerPhone" class="form-label">SƒêT</label>
                        <input type="text" class="form-control" id="playerPhone">
                    </div>
                    <div class="mb-3">
                        <label for="playerEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="playerEmail">
                    </div>
                    <div class="mb-3">
                        <label for="playerTeamId" class="form-label">ƒê·ªôi</label>
                        <select class="form-select" id="playerTeamId">
                            </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer" id="editPlayerModalFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="savePlayer()">L∆∞u Ng∆∞·ªùi Ch∆°i</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="editTeamModal" tabindex="-1" aria-labelledby="editTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTeamModalLabel">Th√™m ƒê·ªôi M·ªõi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="teamForm">
                    <input type="hidden" id="teamId">
                    <div class="mb-3">
                        <label for="teamName" class="form-label">T√™n ƒê·ªôi *</label>
                        <input type="text" class="form-control" id="teamName" required>
                    </div>
                    <div class="mb-3">
                        <label for="teamTag" class="form-label">H·∫°t Gi·ªëng (Tag - D√πng cho Test)</label>
                        <select class="form-select" id="teamTag">
                            <option value="">Kh√¥ng</option>
                            <option value="Top">Top (H·∫°t gi·ªëng 1)</option>
                            <option value="Mid">Mid (H·∫°t gi·ªëng 2)</option>
                            <option value="MM">MM (Test: Nam-Nam)</option>
                            <option value="MF">MF (Test: Nam-N·ªØ)</option>
                            <option value="FF">FF (Test: N·ªØ-N·ªØ)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveTeam()">L∆∞u ƒê·ªôi</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="setEditorModal" tabindex="-1" aria-labelledby="setEditorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="setEditorModalLabel">Nh·∫≠p K·∫øt Qu·∫£ Set</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="matchInfoDisplay"></h6>
                <p id="formatInfoDisplay" class="small-muted"></p>
                <input type="hidden" id="currentMatchId">
                <input type="hidden" id="currentMatchGroup">
                
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Set</th>
                            <th id="teamAHeader">ƒê·ªôi A</th>
                            <th id="teamBHeader">ƒê·ªôi B</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="setsTableBody">
                        </tbody>
                </table>
                <button class="btn btn-sm btn-outline-success" onclick="addSetRow()">+ Th√™m Set</button>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveSetResults()">L∆∞u K·∫øt Qu·∫£ Tr·∫≠n</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="importCsvModal" tabindex="-1" aria-labelledby="importCsvModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importCsvModalLabel">Import Ng∆∞·ªùi Ch∆°i t·ª´ CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">C·∫¢NH B√ÅO: Ng∆∞·ªùi ch∆°i m·ªõi s·∫Ω ƒë∆∞·ª£c th√™m. N·∫øu tr√πng t√™n, ng∆∞·ªùi ch∆°i c≈© v·∫´n ƒë∆∞·ª£c gi·ªØ.</p>
                <p class="small-muted">File CSV ph·∫£i c√≥ c√°c c·ªôt sau (theo ƒë√∫ng th·ª© t·ª±): 
                    <br><strong>T√™n (b·∫Øt bu·ªôc), Nickname, SƒêT, Email, T√™n ƒê·ªôi, Gi·ªõi t√≠nh, Ng√†y sinh (yyyy-mm-dd), Level (1.0 - 5.0)</strong>.
                    <br>B·∫°n c√≥ th·ªÉ b·ªè tr·ªëng c√°c c·ªôt t√πy ch·ªçn. Vui l√≤ng s·ª≠ d·ª•ng n√∫t "T·∫£i M·∫´u CSV" ƒë·ªÉ xem ƒë·ªãnh d·∫°ng ch√≠nh x√°c.
                </p>
                <div class="mb-3">
                    <label for="csvFileInput" class="form-label">Ch·ªçn File CSV</label>
                    <input class="form-control" type="file" id="csvFileInput" accept=".csv">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="handleImportCsv()">Import</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="importJsonModal" tabindex="-1" aria-labelledby="importJsonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importJsonModalLabel">Import Gi·∫£i ƒê·∫•u t·ª´ JSON</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="jsonFileInput" class="form-label">Ch·ªçn File JSON ƒë√£ Export</label>
                    <input class="form-control" type="file" id="jsonFileInput" accept=".json">
                </div>
                <p class="text-danger">C·∫¢NH B√ÅO: Vi·ªác Import s·∫Ω ghi ƒë√® to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="handleImportJson()">Import</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="formatModal" tabindex="-1" aria-labelledby="formatModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formatModalLabel">C·∫•u H√¨nh Th·ªÉ Th·ª©c V√≤ng ƒê·∫•u</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formatForm">
                    <div class="mb-3">
                        <label for="formatKey" class="form-label">T√™n V√≤ng ƒê·∫•u (Key - Kh√¥ng d·∫•u, kh√¥ng kho·∫£ng tr·∫Øng, v√≠ d·ª•: groupStage, semiFinal)</label>
                        <input type="text" class="form-control" id="formatKey" required placeholder="V√≠ d·ª•: quarterFinal">
                    </div>
                    <div class="row">
                        <div class="col-4 mb-3">
                            <label for="formatSets" class="form-label">S·ªë Set</label>
                            <input type="number" class="form-control" id="formatSets" required min="1" value="3">
                        </div>
                        <div class="col-4 mb-3">
                            <label for="formatPoints" class="form-label">ƒêi·ªÉm m·ªói Set</label>
                            <input type="number" class="form-control" id="formatPoints" required min="1" value="21">
                        </div>
                        <div class="col-4 mb-3">
                            <label for="formatLead" class="form-label">C√°ch bi·ªát th·∫Øng</label>
                            <input type="number" class="form-control" id="formatLead" required min="0" value="2">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveFormat()">L∆∞u Th·ªÉ Th·ª©c</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="matchDetailsModal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="matchDetailsModalLabel">Chi Ti·∫øt Tr·∫≠n ƒê·∫•u</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="matchDetailsId">
                <h6 id="matchDetailsTeamsDisplay" class="mb-3"></h6>
                <form id="matchDetailsForm">
                    <div class="mb-3">
                        <label for="matchCourt" class="form-label">S√¢n ƒê·∫•u</label>
                        <input type="text" class="form-control" id="matchCourt" placeholder="V√≠ d·ª•: S√¢n 1">
                    </div>
                    <div class="mb-3">
                        <label for="matchReferee" class="form-label">Tr·ªçng T√†i</label>
                        <input type="text" class="form-control" id="matchReferee" placeholder="V√≠ d·ª•: Anh D≈©ng">
                    </div>
                    <div class="mb-3">
                        <label for="matchScheduledTime" class="form-label">Gi·ªù D·ª± Ki·∫øn</label>
                        <input type="datetime-local" class="form-control" id="matchScheduledTime">
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <label for="matchStartTimeDisplay" class="form-label">Th·ªùi Gian B·∫Øt ƒê·∫ßu</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="matchStartTimeDisplay" readonly>
                            <button class="btn btn-success" type="button" id="startMatchButton" onclick="startMatch(document.getElementById('matchDetailsId').value)">B·∫•m B·∫Øt ƒê·∫ßu</button>
                        </div>
                        <input type="hidden" id="matchStartTime"> </div>
                    
                    <div class="mb-3">
                        <label for="matchDuration" class="form-label">Th·ªùi Gian Thi ƒê·∫•u (Ph√∫t)</label>
                        <input type="number" class="form-control" id="matchDuration" min="0" placeholder="Th·ªùi gian s·∫Ω t·ª± ƒë·ªông t√≠nh n·∫øu ƒë√£ c√≥ gi·ªù b·∫Øt ƒë·∫ßu">
                        <div id="durationHelp" class="small-muted mt-1"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="saveMatchDetails()">L∆∞u Chi Ti·∫øt</button>
            </div>
        </div>
    </div>
</div>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>
<script>
// Bi·∫øn to√†n c·ª•c l∆∞u tr·ªØ d·ªØ li·ªáu gi·∫£i ƒë·∫•u
let tournament = {
    name: "Gi·∫£i Pickleball M·ªõi",
    logo: "", // Base64 string
    config: {
        groupSize: 4, 
        teamsPerGroupAdvance: 2,
        scoringType: 'classic', // 'classic' (3-1-0) ho·∫∑c 'sets' (th·∫Øng set ƒë∆∞·ª£c ƒëi·ªÉm)
        stageOrder: ['groupStage', 'quarterFinal', 'semiFinal', 'final'] // <-- ƒê√É TH√äM D√íNG N√ÄY
    },
    players: [], // { id, name, teamId, nickname, phone, email, gender, dob, level } 
    teams: [], // { id, name, tag, groupId }
    groups: [], // { id, name, teamIds: [] }
    // C·∫≠p nh·∫≠t c·∫•u tr√∫c match: Th√™m referee, startTime, duration. ƒê·ªïi time -> scheduledTime
    matches: [], // { id, group, teamAId, teamBId, results: [], winnerId, court, referee, scheduledTime, startTime, duration, roundKey }
    standings: {}, // { groupId: [{ teamId, pts, wins, losses, setDiff, pointDiff }, ...] }
    knockout: [], // [ { round: 1, matches: [{ id, teamAId, teamBId, winnerId }] }, ...]
    
    // C·∫•u h√¨nh th·ªÉ th·ª©c cho t·ª´ng v√≤ng
    formats: {
        groupStage: { sets: 3, points: 21, lead: 2 },
        quarterFinal: { sets: 3, points: 21, lead: 2 },
        semiFinal: { sets: 3, points: 21, lead: 2 },
        final: { sets: 5, points: 15, lead: 2 }
    }
};

// --- C√ÅC H√ÄM TI·ªÜN √çCH CHUNG ---

function generateId() {
    return '_' + Math.random().toString(36).substr(2, 9);
}

// L·∫•y player object t·ª´ ID
function getPlayer(playerId) {
    return tournament.players.find(p => p.id === playerId);
}

// L·∫•y team object t·ª´ ID
function getTeam(teamId) {
    return tournament.teams.find(t => t.id === teamId);
}

// L·∫•y team object t·ª´ T√™n (case-insensitive)
function getTeamByName(teamName) {
    if (!teamName) return null;
    const normalizedName = teamName.trim().toLowerCase();
    return tournament.teams.find(t => t.name.trim().toLowerCase() === normalizedName);
}

// L·∫•y format c·ªßa tr·∫≠n ƒë·∫•u (m·∫∑c ƒë·ªãnh l√† groupStage)
function getMatchFormat(roundKey) {
    return tournament.formats[roundKey] || tournament.formats['groupStage'];
}

// ƒê·ªãnh d·∫°ng timestamp th√†nh chu·ªói gi·ªù/ph√∫t
function formatTime(timestamp) {
    if (!timestamp) return '-';
    const date = new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

// =======================================================
// === B·ªî SUNG: LOGIC QU·∫¢N L√ù TH·ª® T·ª∞ V√íNG ƒê·∫§U (STAGE ORDER) ===
// =======================================================

/**
 * L·∫•y t√™n hi·ªÉn th·ªã ti·∫øng Vi·ªát cho key c·ªßa v√≤ng ƒë·∫•u.
 */
function getStageDisplayName(key) {
    const names = {
        'groupStage': 'V√≤ng B·∫£ng',
        'quarterFinal': 'T·ª© K·∫øt',
        'semiFinal': 'B√°n K·∫øt',
        'final': 'Chung K·∫øt'
    };
    return names[key] || key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
}

/**
 * ƒê·∫£m b·∫£o m·∫£ng stageOrder trong config ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi t·∫•t c·∫£ c√°c format hi·ªán c√≥.
 */
function ensureStageOrder() {
    if (!tournament.config.stageOrder || !Array.isArray(tournament.config.stageOrder)) {
        tournament.config.stageOrder = [];
    }

    const allStages = new Set(Object.keys(tournament.formats));

    // 1. Lo·∫°i b·ªè c√°c stages kh√¥ng c√≤n t·ªìn t·∫°i
    tournament.config.stageOrder = tournament.config.stageOrder.filter(stage => allStages.has(stage));

    // 2. Th√™m c√°c stages m·ªõi (ch∆∞a c√≥ trong stageOrder) v√†o cu·ªëi
    Object.keys(tournament.formats).forEach(stage => {
         if (!tournament.config.stageOrder.includes(stage)) {
             tournament.config.stageOrder.push(stage);
         }
    });

    // Lo·∫°i b·ªè c√°c ph·∫ßn t·ª≠ tr√πng l·∫∑p
    tournament.config.stageOrder = [...new Set(tournament.config.stageOrder)];
}

/**
 * Di chuy·ªÉn th·ª© t·ª± v√≤ng ƒë·∫•u: -1 (L√™n), 1 (Xu·ªëng).
 */
function moveFormat(stageKey, direction) { 
    ensureStageOrder();

    const order = tournament.config.stageOrder;
    const oldIndex = order.indexOf(stageKey);
    
    if (oldIndex === -1) return;
    
    const newIndex = oldIndex + direction;
    
    // Ki·ªÉm tra gi·ªõi h·∫°n m·∫£ng
    if (newIndex >= 0 && newIndex < order.length) {
        // Ho√°n ƒë·ªïi v·ªã tr√≠
        [order[oldIndex], order[newIndex]] = [order[newIndex], order[oldIndex]];
        
        saveTournament(); // L∆∞u th·ª© t·ª± m·ªõi
        renderConfigTab(); // Render l·∫°i Tab C·∫•u H√¨nh
    }
}


// --- QU·∫¢N L√ù L∆ØU TR·ªÆ V√Ä KH·ªûI T·∫†O ---

function saveTournament() {
    try {
        localStorage.setItem('pickleballTournamentData', JSON.stringify(tournament));
    } catch (e) {
        alert('L·ªói l∆∞u tr·ªØ c·ª•c b·ªô. D·ªØ li·ªáu c√≥ th·ªÉ kh√¥ng ƒë∆∞·ª£c l∆∞u.');
    }
}

function exportTournament() {
    try {
        const dataStr = JSON.stringify(tournament, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${tournament.name.replace(/\s/g, '_')}_export.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        alert(`ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng! T√™n file: ${link.download}`);
    } catch (e) {
        alert('L·ªói khi xu·∫•t d·ªØ li·ªáu JSON.');
    }
}

function openImportJsonModal() {
    const modal = new bootstrap.Modal(document.getElementById('importJsonModal'));
    modal.show();
}

function handleImportJson() {
    const fileInput = document.getElementById('jsonFileInput');
    const file = fileInput.files[0];
    if (!file) {
        return alert('Vui l√≤ng ch·ªçn m·ªôt file JSON.');
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const importedData = JSON.parse(event.target.result);
            if (!importedData.name || !importedData.players || !importedData.teams) {
                return alert('File JSON kh√¥ng h·ª£p l·ªá. Thi·∫øu c·∫•u tr√∫c c∆° b·∫£n.');
            }
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ghi ƒë√® gi·∫£i ƒë·∫•u hi·ªán t·∫°i b·∫±ng d·ªØ li·ªáu "${importedData.name}"?`)) {
                
                // H·ª£p nh·∫•t d·ªØ li·ªáu, ƒë·∫£m b·∫£o kh√¥ng m·∫•t formats m·ªõi n·∫øu ng∆∞·ªùi d√πng load d·ªØ li·ªáu c≈©
                tournament = { 
                    ...tournament, 
                    ...importedData,
                    // ƒê·∫£m b·∫£o formats lu√¥n c√≥ c√°c key m·∫∑c ƒë·ªãnh n·∫øu d·ªØ li·ªáu c≈© thi·∫øu
                    formats: { ...tournament.formats, ...(importedData.formats || {}) }
                };

                // C·∫≠p nh·∫≠t c·∫•u tr√∫c players cho d·ªØ li·ªáu c≈© (b·ªï sung c√°c tr∆∞·ªùng m·ªõi)
                tournament.players = tournament.players.map(p => ({
                    id: p.id || generateId(), 
                    name: p.name, 
                    teamId: p.teamId || '', 
                    nickname: p.nickname || '', 
                    phone: p.phone || '',       
                    email: p.email || '',
                    gender: p.gender || '',     // Thu·ªôc t√≠nh m·ªõi
                    dob: p.dob || '',           // Thu·ªôc t√≠nh m·ªõi (Ng√†y sinh)
                    level: p.level || '3.0'     // Thu·ªôc t√≠nh m·ªõi (Level)
                }));
                
                // ƒê·∫£m b·∫£o match c√≥ roundKey v√† c√°c tr∆∞·ªùng m·ªõi (ho·∫∑c ƒë·ªïi t√™n) n·∫øu d·ªØ li·ªáu c≈© thi·∫øu
                tournament.matches = tournament.matches.map(m => ({
                    ...m, 
                    roundKey: m.roundKey || 'groupStage',
                    referee: m.referee || '', // Tr∆∞·ªùng m·ªõi
                    scheduledTime: m.time || m.scheduledTime || '', // ƒê·ªïi t√™n 'time' th√†nh 'scheduledTime'
                    startTime: m.startTime || null, // Tr∆∞·ªùng m·ªõi
                    duration: m.duration || null, // Tr∆∞·ªùng m·ªõi
                    // X√≥a tr∆∞·ªùng c≈© n·∫øu t·ªìn t·∫°i ƒë·ªÉ tr√°nh tr√πng l·∫∑p
                    time: undefined
                }));

                saveTournament();
                renderAllTabs();
                const modal = bootstrap.Modal.getInstance(document.getElementById('importJsonModal'));
                modal.hide();
                alert(`Import th√†nh c√¥ng gi·∫£i ƒë·∫•u: ${tournament.name}`);
            }
        } catch (error) {
            alert('L·ªói khi ƒë·ªçc ho·∫∑c ph√¢n t√≠ch c√∫ ph√°p file JSON. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãnh d·∫°ng.');
            console.error(error);
        }
    };
    reader.readAsText(file);
}

function loadTournament() {
    try {
        const data = localStorage.getItem('pickleballTournamentData');
        if (data) {
            const loadedData = JSON.parse(data);
            
            // H·ª£p nh·∫•t d·ªØ li·ªáu, ƒë·∫£m b·∫£o kh√¥ng m·∫•t formats m·ªõi n·∫øu ng∆∞·ªùi d√πng load d·ªØ li·ªáu c≈©
            tournament = { 
                ...tournament, 
                ...loadedData,
                // ƒê·∫£m b·∫£o formats lu√¥n c√≥ c√°c key m·∫∑c ƒë·ªãnh n·∫øu d·ªØ li·ªáu c≈© thi·∫øu
                formats: { ...tournament.formats, ...(loadedData.formats || {}) }
            };

            // C·∫≠p nh·∫≠t c·∫•u tr√∫c players cho d·ªØ li·ªáu c≈© (b·ªï sung c√°c tr∆∞·ªùng m·ªõi)
            tournament.players = tournament.players.map(p => ({
                id: p.id || generateId(), 
                name: p.name, 
                teamId: p.teamId || '', 
                nickname: p.nickname || '', 
                phone: p.phone || '',       
                email: p.email || '',
                gender: p.gender || '',     // Thu·ªôc t√≠nh m·ªõi
                dob: p.dob || '',           // Thu·ªôc t√≠nh m·ªõi (Ng√†y sinh)
                level: p.level || '3.0'     // Thu·ªôc t√≠nh m·ªõi (Level)
            }));
            
            // ƒê·∫£m b·∫£o match c√≥ roundKey v√† c√°c tr∆∞·ªùng m·ªõi (ho·∫∑c ƒë·ªïi t√™n) n·∫øu d·ªØ li·ªáu c≈© thi·∫øu
             tournament.matches = tournament.matches.map(m => ({
                ...m, 
                roundKey: m.roundKey || 'groupStage',
                referee: m.referee || '', // Tr∆∞·ªùng m·ªõi
                scheduledTime: m.time || m.scheduledTime || '', // ƒê·ªïi t√™n 'time' th√†nh 'scheduledTime'
                startTime: m.startTime || null, // Tr∆∞·ªùng m·ªõi
                duration: m.duration || null, // Tr∆∞·ªùng m·ªõi
                // X√≥a tr∆∞·ªùng c≈© n·∫øu t·ªìn t·∫°i ƒë·ªÉ tr√°nh tr√πng l·∫∑p
                time: undefined
            }));
        }
    } catch (e) {
        console.error("Kh√¥ng th·ªÉ load d·ªØ li·ªáu t·ª´ localStorage:", e);
    }
    renderAllTabs();
}

function clearTournament() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu gi·∫£i ƒë·∫•u hi·ªán t·∫°i? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        localStorage.removeItem('pickleballTournamentData');
        tournament = { 
            name: "Gi·∫£i Pickleball M·ªõi", 
            logo: "", 
            config: { 
                groupSize: 4, 
                teamsPerGroupAdvance: 2, 
                scoringType: 'classic',
                stageOrder: ['groupStage', 'quarterFinal', 'semiFinal', 'final'] // <-- ƒê√É TH√äM D√íNG N√ÄY
            },
            players: [], // { id, name, teamId, nickname, phone, email, gender, dob, level } 
            teams: [], // { id, name, tag, groupId }
            groups: [], // { id, name, teamIds: [] }
            matches: [], // { id, group, teamAId, teamBId, results: [], winnerId, court, referee, scheduledTime, startTime, duration, roundKey }
            standings: {}, // { groupId: [{ teamId, pts, wins, losses, setDiff, pointDiff }, ...] }
            knockout: [], // [ { round: 1, matches: [{ id, teamAId, teamBId, winnerId }] }, ...]
            formats: {
                groupStage: { sets: 3, points: 21, lead: 2 },
                quarterFinal: { sets: 3, points: 21, lead: 2 },
                semiFinal: { sets: 3, points: 21, lead: 2 },
                final: { sets: 5, points: 15, lead: 2 }
            }
        };
        renderAllTabs();
        alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu. Gi·∫£i ƒë·∫•u m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o.');
    }
}

// --- C√ÅC H√ÄM RENDER TABS ---

function renderNavbar() {
    document.getElementById('tournamentNameDisplay').textContent = tournament.name;
}

function renderAllTabs() {
    renderNavbar();
    renderConfigTab();
    renderPlayerList();
    renderTeamList();
    renderGroupControls();
    renderGroups();
    renderKnockout();
    renderTestTab();
}

// --- TAB C·∫§U H√åNH ---

function renderConfigTab() {
    document.getElementById('tournamentNameInput').value = tournament.name;
    document.getElementById('groupSize').value = tournament.config.groupSize;
    document.getElementById('teamsPerGroupAdvance').value = tournament.config.teamsPerGroupAdvance;
    document.getElementById('logoPreview').src = tournament.logo || '';

    document.getElementById('scoringTypeClassic').checked = tournament.config.scoringType === 'classic';
    document.getElementById('scoringTypeSets').checked = tournament.config.scoringType === 'sets';

    renderFormatsList();
}

function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            tournament.logo = e.target.result;
            document.getElementById('logoPreview').src = tournament.logo;
            saveTournament();
        };
        reader.readAsDataURL(file);
    }
}
document.getElementById('logoInput').addEventListener('change', handleLogoUpload);

function saveTournamentConfig() {
    const groupSize = parseInt(document.getElementById('groupSize').value);
    const teamsPerGroupAdvance = parseInt(document.getElementById('teamsPerGroupAdvance').value);
    
    if (groupSize < 2 || teamsPerGroupAdvance < 1 || teamsPerGroupAdvance > groupSize) {
        alert('C·∫•u h√¨nh ph√¢n b·∫£ng kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.');
        return;
    }

    tournament.name = document.getElementById('tournamentNameInput').value.trim() || "Gi·∫£i Pickleball M·ªõi";
    tournament.config.groupSize = groupSize;
    tournament.config.teamsPerGroupAdvance = teamsPerGroupAdvance;
    tournament.config.scoringType = document.querySelector('input[name="scoringType"]:checked').value;

    saveTournament();
    renderNavbar();
    alert('ƒê√£ l∆∞u c·∫•u h√¨nh gi·∫£i ƒë·∫•u!');
}

function renderFormatsList() {
    const list = document.getElementById('formatsList');
    
    // ƒê·∫£m b·∫£o stageOrder ƒë∆∞·ª£c ƒë·ªìng b·ªô tr∆∞·ªõc khi render
    ensureStageOrder(); 

    let formatsHtml = ``;

    if (tournament.config.stageOrder.length === 0) {
        list.innerHTML = '<p class="small-muted">Ch∆∞a c√≥ th·ªÉ th·ª©c n√†o. Th√™m th·ªÉ th·ª©c V√≤ng B·∫£ng (groupStage) ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>';
        return;
    }

    tournament.config.stageOrder.forEach((stageKey, index) => {
        const format = tournament.formats[stageKey] || {}; 
        const stageName = getStageDisplayName(stageKey);

        const isFirst = index === 0;
        const isLast = index === tournament.config.stageOrder.length - 1;

        // N√∫t L√™n (Di chuy·ªÉn l√™n: -1)
        const upButton = isFirst ? 
            `<button type="button" class="btn btn-sm btn-light text-muted me-2" disabled title="Di chuy·ªÉn l√™n">L√™n</button>` : 
            `<button type="button" class="btn btn-sm btn-dark me-2" onclick="moveFormat('${stageKey}', -1)" title="Di chuy·ªÉn l√™n"><i class="fas fa-arrow-up"></i> L√™n</button>`;
            
        // N√∫t Xu·ªëng (Di chuy·ªÉn xu·ªëng: 1)
        const downButton = isLast ? 
            `<button type="button" class="btn btn-sm btn-light text-muted" disabled title="Di chuy·ªÉn xu·ªëng">Xu·ªëng</button>` : 
            `<button type="button" class="btn btn-sm btn-dark" onclick="moveFormat('${stageKey}', 1)" title="Di chuy·ªÉn xu·ªëng"><i class="fas fa-arrow-down"></i> Xu·ªëng</button>`;

        // C·∫•u h√¨nh ScoreType cho V√≤ng B·∫£ng
        const groupStageConfig = stageKey === 'groupStage' ? `
            <div class="col-md-4 mb-3">
                <label class="form-label">Lo·∫°i H√¨nh T√≠nh ƒêi·ªÉm V√≤ng B·∫£ng</label>
                <select class="form-select" onchange="updateFormat('${stageKey}', 'scoreType', this.value)">
                    <option value="classic" ${tournament.config.scoringType === 'classic' ? 'selected' : ''}>Classic (3ƒë th·∫Øng, 1ƒë h√≤a, 0ƒë thua)</option>
                    <option value="sets" ${tournament.config.scoringType === 'sets' ? 'selected' : ''}>T√≠nh theo Set Th·∫Øng/Thua</option>
                </select>
                <small class="form-text text-muted">Classic: T√≠nh ƒëi·ªÉm theo tr·∫≠n. Sets: D·ª±a tr√™n Set th·∫Øng v√† Hi·ªáu s·ªë Set.</small>
            </div>
        ` : '';

        formatsHtml += `
            <div class="card mb-3 border-dark" id="format-card-${stageKey}">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Th·ªÉ Th·ª©c: ${stageName}</h5>
                    <div class="btn-group" role="group">
                        ${upButton}
                        ${downButton}
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="openFormatModal('${stageKey}')" title="S·ª≠a chi ti·∫øt th·ªÉ th·ª©c"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFormat('${stageKey}')" title="X√≥a th·ªÉ th·ª©c"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">S·ªë Set Th·∫Øng (Best of...)</label>
                            <input type="number" class="form-control" value="${format.sets || 1}" onchange="updateFormat('${stageKey}', 'sets', this.value)" min="1" max="9">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">ƒêi·ªÉm M·ªói Set (pointPerSet)</label>
                            <input type="number" class="form-control" value="${format.points || 21}" onchange="updateFormat('${stageKey}', 'points', this.value)" min="1">
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">C√°ch Bi·ªát Th·∫Øng T·ªëi Thi·ªÉu (minLead)</label>
                            <input type="number" class="form-control" value="${format.lead || 2}" onchange="updateFormat('${stageKey}', 'lead', this.value)" min="0">
                        </div>
                        
                        ${format.tieBreakPoint !== undefined ? `
                            <div class="col-md-4 mb-3">
                                <label class="form-label">ƒêi·ªÉm Tie-break (n·∫øu √°p d·ª•ng)</label>
                                <input type="number" class="form-control" value="${format.tieBreakPoint || 7}" onchange="updateFormat('${stageKey}', 'tieBreakPoint', this.value)" min="1">
                            </div>
                        ` : ''}

                        ${groupStageConfig}
                    </div>
                </div>
            </div>
        `;
    });

    list.innerHTML = formatsHtml;
}

function openFormatModal(key = '') {
    const modal = new bootstrap.Modal(document.getElementById('formatModal'));
    const modalTitle = document.getElementById('formatModalLabel');
    const formatKeyInput = document.getElementById('formatKey');
    const formatSetsInput = document.getElementById('formatSets');
    const formatPointsInput = document.getElementById('formatPoints');
    const formatLeadInput = document.getElementById('formatLead');

    if (key) {
        const format = tournament.formats[key];
        modalTitle.textContent = 'S·ª≠a Th·ªÉ Th·ª©c V√≤ng ƒê·∫•u';
        formatKeyInput.value = key;
        formatKeyInput.readOnly = key === 'groupStage' || key === 'final'; // Kh√¥ng cho s·ª≠a key m·∫∑c ƒë·ªãnh
        formatSetsInput.value = format.sets;
        formatPointsInput.value = format.points;
        formatLeadInput.value = format.lead;
    } else {
        modalTitle.textContent = 'Th√™m Th·ªÉ Th·ª©c V√≤ng ƒê·∫•u';
        formatKeyInput.value = '';
        formatKeyInput.readOnly = false;
        formatSetsInput.value = 3;
        formatPointsInput.value = 21;
        formatLeadInput.value = 2;
    }

    // X·ª≠ l√Ω n√∫t l∆∞u d·ª±a tr√™n vi·ªác l√† S·ª≠a hay Th√™m
    document.querySelector('#formatModal .btn-primary').onclick = function() {
        saveFormat(key);
    };

    modal.show();
}

function saveFormat(originalKey = '') {
    const formatKey = document.getElementById('formatKey').value.trim();
    const formatSets = parseInt(document.getElementById('formatSets').value);
    const formatPoints = parseInt(document.getElementById('formatPoints').value);
    const formatLead = parseInt(document.getElementById('formatLead').value);

    if (!formatKey || isNaN(formatSets) || isNaN(formatPoints) || isNaN(formatLead)) {
        return alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß v√† ch√≠nh x√°c c√°c th√¥ng tin th·ªÉ th·ª©c.');
    }

    if (originalKey && originalKey !== formatKey) {
        // ƒê·ªïi t√™n key: x√≥a key c≈© v√† th√™m key m·ªõi
        delete tournament.formats[originalKey];
        // C·∫≠p nh·∫≠t stageOrder
        const index = tournament.config.stageOrder.indexOf(originalKey);
        if (index > -1) {
            tournament.config.stageOrder.splice(index, 1, formatKey);
        }
    } else if (!originalKey && tournament.formats[formatKey]) {
        return alert(`V√≤ng ƒë·∫•u "${formatKey}" ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c ho·∫∑c S·ª≠a th·ªÉ th·ª©c ƒë√≥.`);
    } else if (!originalKey) {
        // Th√™m m·ªõi, th√™m v√†o stageOrder
        tournament.config.stageOrder.push(formatKey);
    }
    
    // L∆∞u c·∫•u h√¨nh
    tournament.formats[formatKey] = {
        sets: formatSets,
        points: formatPoints,
        lead: formatLead
    };
    
    // N·∫øu l√† v√≤ng b·∫£ng, c·∫≠p nh·∫≠t scoreType n·∫øu c·∫ßn
    if (formatKey === 'groupStage' && tournament.config.scoringType) {
         tournament.formats[formatKey].scoreType = tournament.config.scoringType;
    }
    
    saveTournament();
    renderConfigTab();
    bootstrap.Modal.getInstance(document.getElementById('formatModal')).hide();
}

// H√†m n√†y ƒë∆∞·ª£c g·ªçi t·ª´ giao di·ªán m·ªõi ƒë·ªÉ c·∫≠p nh·∫≠t c·∫•u h√¨nh chi ti·∫øt (sets, points, lead)
function updateFormat(stageKey, property, value) {
    if (stageKey === 'groupStage' && property === 'scoreType') {
        tournament.config.scoringType = value; // C·∫≠p nh·∫≠t global scoringType
    }
    
    if (tournament.formats[stageKey]) {
        // ƒê·∫£m b·∫£o gi√° tr·ªã l√† s·ªë n·∫øu kh√¥ng ph·∫£i l√† scoreType
        if (property !== 'scoreType') {
            tournament.formats[stageKey][property] = parseInt(value);
        } else {
            tournament.formats[stageKey][property] = value;
        }
    }
    saveTournament();
    // Kh√¥ng c·∫ßn render l·∫°i to√†n b·ªô tab, ch·ªâ c·∫ßn l∆∞u.
}

function deleteFormat(key) {
    if (key === 'groupStage' || key === 'final') {
        return alert('Kh√¥ng th·ªÉ x√≥a th·ªÉ th·ª©c V√≤ng B·∫£ng ho·∫∑c Chung K·∫øt m·∫∑c ƒë·ªãnh.');
    }
    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·ªÉ th·ª©c "${key}"?`)) {
        delete tournament.formats[key];
        
        // Lo·∫°i b·ªè kh·ªèi stageOrder
        const index = tournament.config.stageOrder.indexOf(key);
        if (index > -1) {
            tournament.config.stageOrder.splice(index, 1);
        }
        
        saveTournament();
        renderConfigTab();
        alert(`ƒê√£ x√≥a th·ªÉ th·ª©c ${key}.`);
    }
}

// --- TAB NG∆Ø·ªúI CH∆†I & ƒê·ªòI ---

function renderPlayerList() {
    document.getElementById('playerCount').textContent = tournament.players.length;
    document.getElementById('playerCountTest').textContent = tournament.players.filter(p => !p.teamId).length;
    
    const list = document.getElementById('playerList');
    const search = document.getElementById('playerSearchInput').value.toLowerCase();
    
    let html = '';
    const filteredPlayers = tournament.players.filter(p => 
        p.name.toLowerCase().includes(search) || 
        p.nickname.toLowerCase().includes(search) ||
        (getTeam(p.teamId) && getTeam(p.teamId).name.toLowerCase().includes(search))
    ).sort((a, b) => a.name.localeCompare(b.name, 'vi'));

    if (filteredPlayers.length === 0) {
        list.innerHTML = `<p class="text-muted">${search ? 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi ch∆°i n√†o.' : 'Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i n√†o.'}</p>`;
        return;
    }
    
    filteredPlayers.forEach(p => {
        const team = getTeam(p.teamId);
        const teamName = team ? `<span class="badge bg-secondary">${team.name}</span>` : '<span class="badge bg-warning text-dark">ƒê·ªôc l·∫≠p</span>';
        
        let playerInfo = '';
        if (p.phone) playerInfo += ` | ${p.phone}`;
        if (p.gender) playerInfo += ` | ${p.gender}`;
        if (p.level) playerInfo += ` | Level: ${p.level}`;
        
        html += `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <div>
                    <strong>${p.name} ${p.nickname ? `(${p.nickname})` : ''}</strong> 
                    <p class="small-muted mb-0">${teamName} ${playerInfo}</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="openPlayerModal('${p.id}')">S·ª≠a</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePlayer('${p.id}')">X√≥a</button>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function openPlayerModal(playerId = '') {
    const modal = new bootstrap.Modal(document.getElementById('editPlayerModal'));
    const modalTitle = document.getElementById('editPlayerModalLabel');
    const playerIdInput = document.getElementById('playerId');
    const playerTeamIdSelect = document.getElementById('playerTeamId');
    
    // Clear old data
    document.getElementById('playerForm').reset();
    
    // Load Teams into Select
    let teamOptions = '<option value="">(Ch·ªçn ƒê·ªôi)</option>';
    tournament.teams.forEach(t => {
        teamOptions += `<option value="${t.id}">${t.name}</option>`;
    });
    playerTeamIdSelect.innerHTML = teamOptions;

    if (playerId) {
        modalTitle.textContent = 'S·ª≠a Ng∆∞·ªùi Ch∆°i';
        const player = getPlayer(playerId);
        playerIdInput.value = player.id;
        document.getElementById('playerName').value = player.name;
        document.getElementById('playerNickname').value = player.nickname;
        document.getElementById('playerLevel').value = player.level || '3.0';
        document.getElementById('playerGender').value = player.gender || '';
        document.getElementById('playerDob').value = player.dob;
        document.getElementById('playerPhone').value = player.phone;
        document.getElementById('playerEmail').value = player.email;
        playerTeamIdSelect.value = player.teamId || '';
    } else {
        modalTitle.textContent = 'Th√™m Ng∆∞·ªùi Ch∆°i M·ªõi';
        playerIdInput.value = generateId();
        document.getElementById('playerLevel').value = '3.0'; // Default level
    }

    modal.show();
}

function savePlayer() {
    const id = document.getElementById('playerId').value;
    const name = document.getElementById('playerName').value.trim();
    const nickname = document.getElementById('playerNickname').value.trim();
    const level = document.getElementById('playerLevel').value;
    const gender = document.getElementById('playerGender').value;
    const dob = document.getElementById('playerDob').value;
    const phone = document.getElementById('playerPhone').value.trim();
    const email = document.getElementById('playerEmail').value.trim();
    const teamId = document.getElementById('playerTeamId').value;
    
    if (!name) {
        return alert('T√™n ng∆∞·ªùi ch∆°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
    }
    
    const existingPlayerIndex = tournament.players.findIndex(p => p.id === id);
    
    const newPlayer = {
        id: id,
        name: name,
        nickname: nickname,
        level: level,
        gender: gender,
        dob: dob,
        phone: phone,
        email: email,
        teamId: teamId
    };

    if (existingPlayerIndex > -1) {
        tournament.players[existingPlayerIndex] = newPlayer; // Update
    } else {
        tournament.players.push(newPlayer); // Add new
    }

    saveTournament();
    renderPlayerList();
    bootstrap.Modal.getInstance(document.getElementById('editPlayerModal')).hide();
}

function deletePlayer(id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi ch∆°i n√†y?')) {
        tournament.players = tournament.players.filter(p => p.id !== id);
        saveTournament();
        renderPlayerList();
        renderTeamList(); // ƒê·ªÉ c·∫≠p nh·∫≠t l·∫°i Team List (n·∫øu team ƒë√≥ b·ªã x√≥a)
        alert('ƒê√£ x√≥a ng∆∞·ªùi ch∆°i.');
    }
}

function renderTeamList() {
    document.getElementById('teamCount').textContent = tournament.teams.length;
    document.getElementById('teamCountTest').textContent = tournament.teams.length;
    
    const list = document.getElementById('teamList');
    
    let html = '';
    
    if (tournament.teams.length === 0) {
        list.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ ƒë·ªôi n√†o.</p>';
        return;
    }
    
    tournament.teams.forEach(t => {
        const teamPlayers = tournament.players.filter(p => p.teamId === t.id);
        const playerNames = teamPlayers.map(p => p.name + (p.nickname ? ` (${p.nickname})` : '')).join(', ');
        const groupInfo = t.groupId ? ` - <span class="badge bg-info">B·∫£ng ${t.groupId}</span>` : '';
        const tag = t.tag ? `<span class="team-tag badge bg-secondary">${t.tag}</span>` : '';

        html += `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <div>
                    <strong>${t.name} ${tag}</strong>
                    <p class="small-muted mb-0">Th√†nh vi√™n: ${playerNames || 'Ch∆∞a c√≥ th√†nh vi√™n'}${groupInfo}</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="openTeamModal('${t.id}')">S·ª≠a</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTeam('${t.id}')">X√≥a</button>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

function openTeamModal(teamId = '') {
    const modal = new bootstrap.Modal(document.getElementById('editTeamModal'));
    const modalTitle = document.getElementById('editTeamModalLabel');
    const teamIdInput = document.getElementById('teamId');
    
    // Clear old data
    document.getElementById('teamForm').reset();

    if (teamId) {
        modalTitle.textContent = 'S·ª≠a ƒê·ªôi';
        const team = getTeam(teamId);
        teamIdInput.value = team.id;
        document.getElementById('teamName').value = team.name;
        document.getElementById('teamTag').value = team.tag || '';
    } else {
        modalTitle.textContent = 'Th√™m ƒê·ªôi M·ªõi';
        teamIdInput.value = generateId();
    }

    modal.show();
}

function saveTeam() {
    const id = document.getElementById('teamId').value;
    const name = document.getElementById('teamName').value.trim();
    const tag = document.getElementById('teamTag').value;
    
    if (!name) {
        return alert('T√™n ƒë·ªôi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
    }
    
    const existingTeamIndex = tournament.teams.findIndex(t => t.id === id);
    
    // Ensure team name is unique
    if (tournament.teams.some(t => t.name === name && t.id !== id)) {
        return alert(`ƒê·ªôi c√≥ t√™n "${name}" ƒë√£ t·ªìn t·∫°i.`);
    }

    const newTeam = {
        id: id,
        name: name,
        tag: tag,
        groupId: existingTeamIndex > -1 ? tournament.teams[existingTeamIndex].groupId : '' // Preserve group ID
    };

    if (existingTeamIndex > -1) {
        tournament.teams[existingTeamIndex] = newTeam; // Update
    } else {
        tournament.teams.push(newTeam); // Add new
    }

    saveTournament();
    renderTeamList();
    renderPlayerList(); // To update player team association in list
    bootstrap.Modal.getInstance(document.getElementById('editTeamModal')).hide();
}

function deleteTeam(id) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë·ªôi n√†y? Th√†nh vi√™n c·ªßa ƒë·ªôi s·∫Ω tr·ªü th√†nh ng∆∞·ªùi ch∆°i ƒë·ªôc l·∫≠p.')) {
        tournament.teams = tournament.teams.filter(t => t.id !== id);
        tournament.players.forEach(p => {
            if (p.teamId === id) {
                p.teamId = '';
            }
        });
        
        // X√≥a ƒë·ªôi kh·ªèi b·∫£ng ƒë·∫•u v√† l·ªãch
        tournament.groups.forEach(g => {
            g.teamIds = g.teamIds.filter(teamId => teamId !== id);
        });
        tournament.matches = tournament.matches.filter(m => m.teamAId !== id && m.teamBId !== id);
        
        saveTournament();
        renderTeamList();
        renderPlayerList();
        renderGroups();
        alert('ƒê√£ x√≥a ƒë·ªôi th√†nh c√¥ng.');
    }
}

// --- TAB V√íNG B·∫¢NG ---

function renderGroupControls() {
    const teamCount = tournament.teams.length;
    const groupSize = tournament.config.groupSize;
    const numGroups = Math.ceil(teamCount / groupSize);
    
    document.getElementById('teamCountGroupTab').textContent = teamCount;
    document.getElementById('numGroupsEstimate').textContent = numGroups;
}

// H√†m ph√¢n b·∫£ng (ƒê∆°n gi·∫£n: Chia ƒë·ªÅu)
function generateGroups() {
    if (tournament.teams.length < 2) {
        return alert('C·∫ßn √≠t nh·∫•t 2 ƒë·ªôi ƒë·ªÉ ph√¢n b·∫£ng.');
    }
    
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA B·∫¢NG V√Ä L·ªäCH THI ƒê·∫§U hi·ªán t·∫°i v√† Ph√¢n B·∫£ng l·∫°i cho ${tournament.teams.length} ƒë·ªôi?`)) {
        return;
    }

    // 1. X√≥a d·ªØ li·ªáu c≈©
    tournament.groups = [];
    tournament.matches = [];
    tournament.standings = {};
    tournament.teams.forEach(t => t.groupId = ''); // reset team group association

    const teamsToGroup = [...tournament.teams];
    const groupSize = tournament.config.groupSize;
    let groupIndex = 1;

    // S·∫Øp x·∫øp ng·∫´u nhi√™n ƒë·ªÉ ph√¢n b·∫£ng
    teamsToGroup.sort(() => 0.5 - Math.random()); 

    while (teamsToGroup.length > 0) {
        const groupId = `G${groupIndex}`;
        const newGroup = { 
            id: groupId, 
            name: `B·∫£ng ${groupId}`, 
            teamIds: [] 
        };
        
        // L·∫•y nh√≥m ƒë·ªôi cho b·∫£ng n√†y (t·ªëi ƒëa groupSize)
        const teamsInGroup = teamsToGroup.splice(0, groupSize);
        
        teamsInGroup.forEach(team => {
            newGroup.teamIds.push(team.id);
            // C·∫≠p nh·∫≠t groupId cho team
            const teamObj = getTeam(team.id);
            if (teamObj) teamObj.groupId = groupId;
        });
        
        tournament.groups.push(newGroup);
        groupIndex++;
    }

    saveTournament();
    renderGroups();
    alert(`ƒê√£ ph√¢n b·∫£ng th√†nh c√¥ng ${tournament.groups.length} b·∫£ng.`);
}

// H√†m t·∫°o l·ªãch thi ƒë·∫•u (Round Robin)
function generateMatches() {
    if (tournament.groups.length === 0) {
        return alert('Vui l√≤ng t·∫°o b·∫£ng ƒë·∫•u tr∆∞·ªõc khi t·∫°o l·ªãch thi ƒë·∫•u.');
    }
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA L·ªäCH THI ƒê·∫§U hi·ªán t·∫°i v√† T·∫†O L·ªäCH M·ªöI?')) {
        return;
    }
    
    tournament.matches = []; // X√≥a l·ªãch c≈©
    let matchIdCounter = 1;

    tournament.groups.forEach(group => {
        const teamIds = group.teamIds;
        const numTeams = teamIds.length;
        
        // T·∫°o l·ªãch thi ƒë·∫•u v√≤ng tr√≤n 1 l∆∞·ª£t (Round Robin)
        for (let i = 0; i < numTeams; i++) {
            for (let j = i + 1; j < numTeams; j++) {
                tournament.matches.push({
                    id: `M${matchIdCounter++}`,
                    group: group.id,
                    teamAId: teamIds[i],
                    teamBId: teamIds[j],
                    results: [], // [ [scoreA, scoreB], [scoreA, scoreB], ... ]
                    winnerId: null,
                    court: '',
                    referee: '',
                    scheduledTime: '',
                    startTime: null,
                    duration: null,
                    roundKey: 'groupStage'
                });
            }
        }
    });

    saveTournament();
    renderGroups();
    alert(`ƒê√£ t·∫°o th√†nh c√¥ng ${tournament.matches.length} tr·∫≠n ƒë·∫•u v√≤ng b·∫£ng.`);
}

function renderGroups() {
    const container = document.getElementById('groupList');
    let html = '';

    if (tournament.groups.length === 0) {
        container.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ b·∫£ng ƒë·∫•u n√†o ƒë∆∞·ª£c t·∫°o.</p>';
        return;
    }
    
    // S·∫Øp x·∫øp b·∫£ng ƒë·∫•u theo t√™n (G1, G2, ...)
    const sortedGroups = [...tournament.groups].sort((a, b) => a.id.localeCompare(b.id));

    sortedGroups.forEach(group => {
        const groupMatches = tournament.matches.filter(m => m.group === group.id);
        
        let matchesHtml = '';
        if (groupMatches.length === 0) {
            matchesHtml = '<p class="small-muted">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u. Nh·∫•n "T·∫°o L·ªãch Thi ƒê·∫•u".</p>';
        } else {
            groupMatches.forEach(match => {
                const teamA = getTeam(match.teamAId) || { name: 'ƒê·ªôi B·ªã X√≥a A' };
                const teamB = getTeam(match.teamBId) || { name: 'ƒê·ªôi B·ªã X√≥a B' };
                const scoreDisplay = formatScore(match.results);
                const winnerBadge = match.winnerId ? `<span class="badge ${match.winnerId === teamA.id ? 'bg-success' : 'bg-danger'}">${getTeam(match.winnerId)?.name} Win</span>` : `<span class="badge bg-secondary">Ch∆∞a ƒë·∫•u</span>`;
                const matchTime = match.scheduledTime ? ` (${formatTime(new Date(match.scheduledTime))})` : '';
                const matchCourt = match.court ? ` - ${match.court}` : '';

                matchesHtml += `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div>
                            <strong>${teamA.name} vs ${teamB.name}</strong>
                            <p class="small-muted mb-0">${scoreDisplay} ${matchTime}${matchCourt}</p>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-info me-2" onclick="openMatchDetailsModal('${match.id}')" title="Chi ti·∫øt tr·∫≠n ƒë·∫•u"><i class="fas fa-info-circle"></i></button>
                            <button class="btn btn-sm btn-primary" onclick="openSetEditorModal('${match.id}')">Nh·∫≠p KQ</button>
                        </div>
                    </div>
                `;
            });
        }
        
        const teamNames = group.teamIds.map(id => getTeam(id)?.name).filter(Boolean).join(', ');
        
        html += `
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">${group.name}</h5>
                    <p class="small-muted mb-0">(${group.teamIds.length} ƒë·ªôi): ${teamNames}</p>
                </div>
                <div class="card-body p-0">
                    ${matchesHtml}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ƒê·ªãnh d·∫°ng k·∫øt qu·∫£ set th√†nh chu·ªói hi·ªÉn th·ªã
function formatScore(results) {
    if (!results || results.length === 0) return '';
    
    let scoreStr = results.map(set => `${set[0]}-${set[1]}`).join(', ');
    
    // ƒê·∫øm s·ªë set th·∫Øng/thua
    const winsA = results.filter(set => set[0] > set[1]).length;
    const winsB = results.filter(set => set[1] > set[0]).length;
    
    return `[${winsA}-${winsB}] (${scoreStr})`;
}

// --- QU·∫¢N L√ù K·∫æT QU·∫¢ TR·∫¨N ƒê·∫§U (SET EDITOR) ---

function openSetEditorModal(matchId) {
    const match = tournament.matches.find(m => m.id === matchId);
    if (!match) return;
    
    const teamA = getTeam(match.teamAId) || { name: 'ƒê·ªôi A' };
    const teamB = getTeam(match.teamBId) || { name: 'ƒê·ªôi B' };
    const format = getMatchFormat(match.roundKey);

    document.getElementById('setEditorModalLabel').textContent = `Nh·∫≠p K·∫øt Qu·∫£ - ${match.id} (${getStageDisplayName(match.roundKey)})`;
    document.getElementById('matchInfoDisplay').textContent = `${teamA.name} vs ${teamB.name}`;
    document.getElementById('formatInfoDisplay').textContent = `Th·ªÉ th·ª©c: Best of ${format.sets * 2 - 1} | ${format.points} ƒëi·ªÉm | C√°ch bi·ªát ${format.lead} | Set th·∫Øng: ${format.sets}`;
    
    document.getElementById('currentMatchId').value = match.id;
    document.getElementById('currentMatchGroup').value = match.group;
    document.getElementById('teamAHeader').textContent = teamA.name;
    document.getElementById('teamBHeader').textContent = teamB.name;
    
    const setsTableBody = document.getElementById('setsTableBody');
    setsTableBody.innerHTML = '';
    
    // Load existing sets
    match.results.forEach((set, index) => {
        addSetRow(set[0], set[1], index + 1);
    });
    
    // Add an empty set row if needed
    if (match.results.length === 0 || !match.winnerId) {
        addSetRow();
    }
    
    const modal = new bootstrap.Modal(document.getElementById('setEditorModal'));
    modal.show();
}

function addSetRow(scoreA = '', scoreB = '', setNumber = 0) {
    const setsTableBody = document.getElementById('setsTableBody');
    const newRow = setsTableBody.insertRow();
    
    const currentSets = setsTableBody.rows.length;
    setNumber = setNumber || currentSets;

    newRow.innerHTML = `
        <td>Set ${setNumber}</td>
        <td><input type="number" class="form-control form-control-sm score-a" value="${scoreA}" min="0"></td>
        <td><input type="number" class="form-control form-control-sm score-b" value="${scoreB}" min="0"></td>
        <td>
            <button class="btn btn-sm btn-outline-danger" onclick="removeSetRow(this)">X√≥a</button>
        </td>
    `;
    
    // Update set numbering
    updateSetNumbers();
}

function removeSetRow(button) {
    const row = button.closest('tr');
    row.remove();
    updateSetNumbers();
}

function updateSetNumbers() {
    const rows = document.getElementById('setsTableBody').rows;
    for (let i = 0; i < rows.length; i++) {
        rows[i].cells[0].textContent = `Set ${i + 1}`;
    }
}

function saveSetResults() {
    const matchId = document.getElementById('currentMatchId').value;
    const match = tournament.matches.find(m => m.id === matchId);
    if (!match) return;

    const format = getMatchFormat(match.roundKey);
    const setLimit = format.sets; // S·ªë set c·∫ßn th·∫Øng (v√≠ d·ª•: 2 trong Best of 3)
    
    const rows = document.getElementById('setsTableBody').rows;
    let newResults = [];
    let winsA = 0;
    let winsB = 0;
    
    let isValid = true;
    let errorMessages = [];

    for (let i = 0; i < rows.length; i++) {
        const inputA = rows[i].querySelector('.score-a');
        const inputB = rows[i].querySelector('.score-b');
        
        const scoreA = parseInt(inputA.value);
        const scoreB = parseInt(inputB.value);
        
        // B·ªè qua set tr·ªëng n·∫øu kh√¥ng ph·∫£i l√† set cu·ªëi c√πng
        if ((isNaN(scoreA) || isNaN(scoreB)) && i < rows.length - 1) {
            errorMessages.push(`Set ${i + 1}: Vui l√≤ng nh·∫≠p ƒë·ªß ƒëi·ªÉm cho c·∫£ hai ƒë·ªôi.`);
            isValid = false;
            break;
        } else if (isNaN(scoreA) || isNaN(scoreB)) {
            // Cho ph√©p set cu·ªëi c√πng tr·ªëng n·∫øu ƒë√£ c√≥ ng∆∞·ªùi th·∫Øng
            if (winsA < setLimit && winsB < setLimit) {
                errorMessages.push(`Set ${i + 1}: Vui l√≤ng nh·∫≠p ƒëi·ªÉm ho·∫∑c x√≥a set n√†y.`);
                isValid = false;
                break;
            }
            continue; // B·ªè qua set cu·ªëi tr·ªëng n·∫øu ƒë√£ c√≥ ng∆∞·ªùi th·∫Øng
        }

        // Ki·ªÉm tra logic th·∫Øng set
        let setWinner = null;
        if (scoreA > scoreB) {
            // Th·∫Øng setA
            if (scoreA < format.points) {
                errorMessages.push(`Set ${i + 1}: ƒêi·ªÉm th·∫Øng (${scoreA}) ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ${format.points}.`);
                isValid = false;
            } else if (scoreA - scoreB < format.lead) {
                errorMessages.push(`Set ${i + 1}: C√°ch bi·ªát (${scoreA - scoreB}) ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ${format.lead} ƒëi·ªÉm.`);
                isValid = false;
            } else {
                setWinner = 'A';
            }
        } else if (scoreB > scoreA) {
            // Th·∫Øng setB
            if (scoreB < format.points) {
                errorMessages.push(`Set ${i + 1}: ƒêi·ªÉm th·∫Øng (${scoreB}) ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ${format.points}.`);
                isValid = false;
            } else if (scoreB - scoreA < format.lead) {
                errorMessages.push(`Set ${i + 1}: C√°ch bi·ªát (${scoreB - scoreA}) ph·∫£i ƒë·∫°t t·ªëi thi·ªÉu ${format.lead} ƒëi·ªÉm.`);
                isValid = false;
            } else {
                setWinner = 'B';
            }
        } else if (scoreA === scoreB && (scoreA !== 0 || scoreB !== 0)) {
            errorMessages.push(`Set ${i + 1}: K·∫øt qu·∫£ h√≤a (${scoreA}-${scoreB}) kh√¥ng h·ª£p l·ªá.`);
            isValid = false;
        }

        if (!isValid) break;
        
        if (setWinner === 'A') winsA++;
        if (setWinner === 'B') winsB++;
        
        newResults.push([scoreA, scoreB]);
        
        // Ki·ªÉm tra th·∫Øng tr·∫≠n (n·∫øu ch∆∞a ph·∫£i l√† set cu·ªëi c√πng)
        if (winsA === setLimit || winsB === setLimit) {
            // N·∫øu ƒë√£ ƒë·ªß set th·∫Øng, b·ªè qua c√°c set c√≤n l·∫°i
            break;
        }
    }

    if (!isValid) {
        return alert('L·ªói nh·∫≠p li·ªáu:\n' + errorMessages.join('\n'));
    }
    
    // X√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng tr·∫≠n
    let winnerId = null;
    if (winsA === setLimit) {
        winnerId = match.teamAId;
    } else if (winsB === setLimit) {
        winnerId = match.teamBId;
    } else if (newResults.length > 0 && winsA + winsB === newResults.length && winsA + winsB === format.sets * 2 - 1) {
        // Tr∆∞·ªùng h·ª£p Best of 5, h√≤a 2-2, set cu·ªëi ch∆∞a ƒë·∫•u nh∆∞ng kh√¥ng ai th·∫Øng set limit
        // C·∫ßn ƒë·∫£m b·∫£o r·∫±ng sau khi v√≤ng l·∫∑p d·ª´ng, ph·∫£i c√≥ ng∆∞·ªùi th·∫Øng set limit
        if (match.roundKey !== 'groupStage') {
             return alert(`K·∫øt qu·∫£ ch∆∞a ƒë·ªß ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng. C·∫ßn ${setLimit} set th·∫Øng.`);
        }
    }


    match.results = newResults;
    match.winnerId = winnerId;
    
    saveTournament();
    renderGroups();
    
    // C·∫≠p nh·∫≠t Knockout n·∫øu tr·∫≠n n√†y l√† tr·∫≠n Knockout
    if (match.roundKey !== 'groupStage') {
        updateKnockoutWinner(match);
    }
    
    bootstrap.Modal.getInstance(document.getElementById('setEditorModal')).hide();
}

// --- QU·∫¢N L√ù CHI TI·∫æT TR·∫¨N ƒê·∫§U ---

function openMatchDetailsModal(matchId) {
    const match = tournament.matches.find(m => m.id === matchId);
    if (!match) return;
    
    const teamA = getTeam(match.teamAId) || { name: 'ƒê·ªôi A' };
    const teamB = getTeam(match.teamBId) || { name: 'ƒê·ªôi B' };

    document.getElementById('matchDetailsModalLabel').textContent = `Chi Ti·∫øt Tr·∫≠n ƒê·∫•u ${match.id} (${getStageDisplayName(match.roundKey)})`;
    document.getElementById('matchDetailsId').value = match.id;
    document.getElementById('matchDetailsTeamsDisplay').textContent = `${teamA.name} vs ${teamB.name}`;

    document.getElementById('matchCourt').value = match.court || '';
    document.getElementById('matchReferee').value = match.referee || '';
    
    // ƒê·ªãnh d·∫°ng l·∫°i datetime-local
    const scheduledTimeValue = match.scheduledTime ? match.scheduledTime.substring(0, 16) : '';
    document.getElementById('matchScheduledTime').value = scheduledTimeValue;

    document.getElementById('matchStartTime').value = match.startTime || '';
    document.getElementById('matchStartTimeDisplay').value = match.startTime ? new Date(match.startTime).toLocaleString('vi-VN', {hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric'}) : 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    
    document.getElementById('matchDuration').value = match.duration || '';
    
    updateMatchDurationDisplay(match);

    const modal = new bootstrap.Modal(document.getElementById('matchDetailsModal'));
    modal.show();
}

function startMatch(matchId) {
    const match = tournament.matches.find(m => m.id === matchId);
    if (!match) return;

    if (match.startTime) {
        if (!confirm('Tr·∫≠n ƒë·∫•u ƒë√£ ƒë∆∞·ª£c ghi nh·∫≠n gi·ªù b·∫Øt ƒë·∫ßu. B·∫°n c√≥ mu·ªën C·∫¨P NH·∫¨T l·∫°i gi·ªù b·∫Øt ƒë·∫ßu kh√¥ng?')) {
            return;
        }
    }
    
    match.startTime = new Date().toISOString();
    document.getElementById('matchStartTime').value = match.startTime;
    document.getElementById('matchStartTimeDisplay').value = new Date(match.startTime).toLocaleString('vi-VN', {hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit', year: 'numeric'});
    
    updateMatchDurationDisplay(match);
    saveTournament();
    alert('ƒê√£ ghi nh·∫≠n gi·ªù b·∫Øt ƒë·∫ßu tr·∫≠n ƒë·∫•u!');
}

function saveMatchDetails() {
    const matchId = document.getElementById('matchDetailsId').value;
    const match = tournament.matches.find(m => m.id === matchId);
    if (!match) return;

    match.court = document.getElementById('matchCourt').value.trim();
    match.referee = document.getElementById('matchReferee').value.trim();
    
    const scheduledTimeInput = document.getElementById('matchScheduledTime').value;
    match.scheduledTime = scheduledTimeInput ? new Date(scheduledTimeInput).toISOString() : '';
    
    const durationInput = document.getElementById('matchDuration').value;
    match.duration = durationInput ? parseInt(durationInput) : null;
    
    // C·∫≠p nh·∫≠t duration n·∫øu start time ƒë√£ c√≥ v√† duration ch∆∞a nh·∫≠p
    if (match.startTime && !match.duration) {
        const endTime = new Date();
        const startTime = new Date(match.startTime);
        const durationMs = endTime.getTime() - startTime.getTime();
        match.duration = Math.round(durationMs / 60000); // Minutes
        document.getElementById('matchDuration').value = match.duration;
    }
    
    saveTournament();
    renderGroups(); // Update match list in group tab
    renderKnockout(); // Update match list in knockout tab
    bootstrap.Modal.getInstance(document.getElementById('matchDetailsModal')).hide();
    alert('ƒê√£ l∆∞u chi ti·∫øt tr·∫≠n ƒë·∫•u!');
}

function updateMatchDurationDisplay(match) {
    const helpDisplay = document.getElementById('durationHelp');
    if (match.startTime) {
        if (match.duration) {
            helpDisplay.textContent = `Tr·∫≠n ƒë·∫•u ƒë√£ ho√†n th√†nh, t·ªïng th·ªùi gian: ${match.duration} ph√∫t.`;
        } else {
            const now = new Date();
            const start = new Date(match.startTime);
            const durationMs = now.getTime() - start.getTime();
            const currentDuration = Math.round(durationMs / 60000);
            helpDisplay.textContent = `ƒê√£ ƒë·∫•u ƒë∆∞·ª£c kho·∫£ng ${currentDuration} ph√∫t (t√≠nh ƒë·∫øn hi·ªán t·∫°i). Nh·∫≠p s·ªë ph√∫t ho√†n th√†nh ƒë·ªÉ ghi nh·∫≠n.`;
        }
        document.getElementById('startMatchButton').textContent = 'C·∫≠p nh·∫≠t Gi·ªù B·∫Øt ƒê·∫ßu';
    } else {
        helpDisplay.textContent = 'Tr·∫≠n ƒë·∫•u ch∆∞a b·∫Øt ƒë·∫ßu. Nh·∫•n "B·∫•m B·∫Øt ƒê·∫ßu" khi tr·∫≠n ƒë·∫•u ch√≠nh th·ª©c di·ªÖn ra.';
        document.getElementById('startMatchButton').textContent = 'B·∫•m B·∫Øt ƒê·∫ßu';
    }
}


// --- B·∫¢NG X·∫æP H·∫†NG (STANDINGS) ---

function updateStandings() {
    tournament.standings = {};
    const scoringType = tournament.config.scoringType;

    if (tournament.groups.length === 0) {
        return alert('Vui l√≤ng t·∫°o b·∫£ng ƒë·∫•u tr∆∞·ªõc.');
    }
    
    tournament.groups.forEach(group => {
        let groupStandings = group.teamIds.map(teamId => ({
            teamId: teamId,
            pts: 0,
            wins: 0,
            losses: 0,
            setWins: 0,
            setLosses: 0,
            pointDiff: 0,
            matchesPlayed: 0
        }));

        const groupMatches = tournament.matches.filter(m => m.group === group.id && m.winnerId);
        
        groupMatches.forEach(match => {
            const teamAId = match.teamAId;
            const teamBId = match.teamBId;
            const winnerId = match.winnerId;
            
            const idxA = groupStandings.findIndex(s => s.teamId === teamAId);
            const idxB = groupStandings.findIndex(s => s.teamId === teamBId);
            
            if (idxA === -1 || idxB === -1) return; // B·ªè qua n·∫øu ƒë·ªôi b·ªã x√≥a

            const teamA = groupStandings[idxA];
            const teamB = groupStandings[idxB];
            
            teamA.matchesPlayed++;
            teamB.matchesPlayed++;

            // T√≠nh ƒëi·ªÉm v√† hi·ªáu s·ªë set/ƒëi·ªÉm
            const setResults = match.results;
            let setWinsA = 0;
            let setWinsB = 0;
            let totalPointsA = 0;
            let totalPointsB = 0;

            setResults.forEach(set => {
                const scoreA = set[0];
                const scoreB = set[1];
                totalPointsA += scoreA;
                totalPointsB += scoreB;
                
                if (scoreA > scoreB) setWinsA++;
                else if (scoreB > scoreA) setWinsB++;
            });

            teamA.setWins += setWinsA;
            teamA.setLosses += setWinsB;
            teamB.setWins += setWinsB;
            teamB.setLosses += setWinsA;

            teamA.pointDiff += (totalPointsA - totalPointsB);
            teamB.pointDiff += (totalPointsB - totalPointsA);

            if (winnerId === teamAId) {
                teamA.wins++;
                teamB.losses++;
                
                if (scoringType === 'classic') {
                    teamA.pts += 3;
                } else if (scoringType === 'sets') {
                    teamA.pts += setWinsA;
                    teamB.pts += setWinsB;
                }
            } else if (winnerId === teamBId) {
                teamB.wins++;
                teamA.losses++;
                
                if (scoringType === 'classic') {
                    teamB.pts += 3;
                } else if (scoringType === 'sets') {
                    teamB.pts += setWinsB;
                    teamA.pts += setWinsA;
                }
            } 
            // Kh√¥ng t√≠nh h√≤a v√¨ Pickleball th∆∞·ªùng kh√¥ng c√≥ h√≤a sau khi ƒë·∫•u ƒë·ªß set
            // N·∫øu c√≥ h√≤a set (ƒëi·ªÉm b·∫±ng nhau), n√≥ s·∫Ω b·ªã lo·∫°i tr·ª´ b·ªüi logic th·∫Øng set.
        });

        // S·∫Øp x·∫øp B·∫£ng x·∫øp h·∫°ng:
        // 1. ƒêi·ªÉm (pts)
        // 2. S·ªë tr·∫≠n th·∫Øng (wins) - quan tr·ªçng cho classic
        // 3. Hi·ªáu s·ªë Set (setWins - setLosses)
        // 4. Hi·ªáu s·ªë ƒêi·ªÉm (pointDiff)
        groupStandings.sort((a, b) => {
            if (b.pts !== a.pts) return b.pts - a.pts;
            if (b.wins !== a.wins) return b.wins - a.wins;
            const setDiffA = a.setWins - a.setLosses;
            const setDiffB = b.setWins - b.setLosses;
            if (setDiffB !== setDiffA) return setDiffB - setDiffA;
            return b.pointDiff - a.pointDiff;
        });

        tournament.standings[groupId] = groupStandings;
    });

    saveTournament();
    renderStandings();
    alert('ƒê√£ c·∫≠p nh·∫≠t B·∫£ng X·∫øp H·∫°ng!');
}

function renderStandings() {
    const container = document.getElementById('standingsContainer');
    let html = '';
    const teamsToAdvance = tournament.config.teamsPerGroupAdvance;
    const scoringTypeDisplay = tournament.config.scoringType === 'classic' ? 'ƒêi·ªÉm (3-0)' : 'ƒêi·ªÉm Set';

    for (const groupId in tournament.standings) {
        const standings = tournament.standings[groupId];
        
        let tableRows = '';
        standings.forEach((s, index) => {
            const team = getTeam(s.teamId);
            if (!team) return;
            
            const isQualified = index < teamsToAdvance;
            const rowClass = isQualified ? 'table-success' : '';
            const qualifiedBadge = isQualified ? `<span class="badge bg-primary ms-2">V√≤ng Lo·∫°i</span>` : '';
            const rank = index + 1;
            const setDiff = s.setWins - s.setLosses;
            
            tableRows += `
                <tr class="${rowClass}">
                    <th scope="row">${rank}</th>
                    <td>${team.name} ${qualifiedBadge}</td>
                    <td>${s.matchesPlayed}</td>
                    <td>${s.pts}</td>
                    <td>${s.wins}-${s.losses}</td>
                    <td>${s.setWins}-${s.setLosses} (${setDiff > 0 ? '+' : ''}${setDiff})</td>
                    <td>${s.pointDiff > 0 ? '+' : ''}${s.pointDiff}</td>
                </tr>
            `;
        });
        
        html += `
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">B·∫£ng X·∫øp H·∫°ng ${groupId}</h5>
                    <p class="small-muted mb-0">Top ${teamsToAdvance} ƒë·ªôi v√†o v√≤ng lo·∫°i.</p>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-sm mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ƒê·ªôi</th>
                                <th>Tr·∫≠n</th>
                                <th>${scoringTypeDisplay}</th>
                                <th>T-B</th>
                                <th>Set T-B (HS)</th>
                                <th>ƒêi·ªÉm HS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html || '<p class="text-muted">Nh·∫•n "T·∫°o B·∫£ng X·∫øp H·∫°ng" sau khi c√≥ k·∫øt qu·∫£.</p>';
}

// --- V√íNG LO·∫†I TR·ª∞C TI·∫æP (KNOCKOUT) ---

function createKnockoutRounds() {
    if (Object.keys(tournament.standings).length === 0) {
        return alert('Vui l√≤ng t·∫°o B·∫£ng X·∫øp H·∫°ng tr∆∞·ªõc khi t·∫°o v√≤ng lo·∫°i.');
    }
    
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA V√íNG LO·∫†I HI·ªÜN T·∫†I v√† t·∫°o c√¢y ƒë·∫•u lo·∫°i m·ªõi d·ª±a tr√™n BXH?')) {
        return;
    }
    
    const teamsToAdvance = tournament.config.teamsPerGroupAdvance;
    let qualifiedTeams = [];
    
    // Thu th·∫≠p c√°c ƒë·ªôi ƒë·ªß ƒëi·ªÅu ki·ªán
    for (const groupId in tournament.standings) {
        const standings = tournament.standings[groupId];
        standings.slice(0, teamsToAdvance).forEach(s => {
            qualifiedTeams.push({
                teamId: s.teamId,
                group: groupId,
                rank: standings.indexOf(s) + 1
            });
        });
    }
    
    if (qualifiedTeams.length < 2) {
        return alert('Kh√¥ng ƒë·ªß ƒë·ªôi (√≠t h∆°n 2 ƒë·ªôi) ƒë·ªÉ t·∫°o v√≤ng lo·∫°i.');
    }
    
    // S·ªë ƒë·ªôi v√≤ng Knockout ph·∫£i l√† l≈©y th·ª´a c·ªßa 2 (4, 8, 16, 32...)
    let numTeamsKnockout = 2;
    while (numTeamsKnockout < qualifiedTeams.length) {
        numTeamsKnockout *= 2;
    }
    
    if (numTeamsKnockout > qualifiedTeams.length && !confirm(`T·ªïng s·ªë ƒë·ªôi ƒë·ªß ƒëi·ªÅu ki·ªán l√† ${qualifiedTeams.length}. H·ªá th·ªëng s·∫Ω t·∫°o c√¢y ƒë·∫•u ${numTeamsKnockout} ƒë·ªôi. C√°c su·∫•t c√≤n l·∫°i s·∫Ω ƒë∆∞·ª£c b·ªëc thƒÉm ng·∫´u nhi√™n (ho·∫∑c nh·∫≠n Byes). Ti·∫øp t·ª•c?`)) {
        return;
    }
    
    tournament.knockout = [];
    tournament.matches = tournament.matches.filter(m => m.roundKey === 'groupStage'); // Gi·ªØ l·∫°i match v√≤ng b·∫£ng
    let matchIdCounter = tournament.matches.length + 1;
    
    // 1. Ph√¢n b·ªï c√°c ƒë·ªôi (Seeding)
    const teams = qualifiedTeams.map(t => t.teamId);
    
    // S·∫Øp x·∫øp c√°c ƒë·ªôi: H·∫°ng 1 b·∫£ng A vs H·∫°ng 2 b·∫£ng B, H·∫°ng 1 b·∫£ng B vs H·∫°ng 2 b·∫£ng A...
    // T·∫°m th·ªùi s·∫Øp x·∫øp theo th·ª© t·ª± b·ªëc thƒÉm ƒë∆°n gi·∫£n (ƒë·ªÉ d·ªÖ ki·ªÉm so√°t)
    teams.sort(() => 0.5 - Math.random()); 
    
    // 2. T·∫°o V√≤ng ƒê·∫ßu Ti√™n (Round of N)
    const numMatchesInRound = numTeamsKnockout / 2;
    const roundKey = getKnockoutRoundKey(numTeamsKnockout);
    const knockoutFormat = tournament.formats[roundKey] || getMatchFormat('quarterFinal'); // D√πng format T·ª© K·∫øt m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥

    let roundMatches = [];
    
    for (let i = 0; i < numMatchesInRound; i++) {
        const teamAId = teams[i] || 'BYE';
        const teamBId = teams[numTeamsKnockout - 1 - i] || 'BYE';
        
        // N·∫øu m·ªôt ƒë·ªôi l√† BYE, ƒë·ªôi c√≤n l·∫°i t·ª± ƒë·ªông th·∫Øng (ho·∫∑c ƒë·ªôi BYE th·∫Øng n·∫øu c·∫£ hai l√† BYE)
        let winnerId = null;
        if (teamAId === 'BYE') winnerId = teamBId;
        else if (teamBId === 'BYE') winnerId = teamAId;
        else if (teamAId === 'BYE' && teamBId === 'BYE') winnerId = 'BYE';
        
        const match = {
            id: `M${matchIdCounter++}`,
            group: 'KO',
            teamAId: teamAId,
            teamBId: teamBId,
            results: [],
            winnerId: winnerId === 'BYE' ? null : winnerId,
            court: '',
            referee: '',
            scheduledTime: '',
            startTime: null,
            duration: null,
            roundKey: roundKey
        };
        
        roundMatches.push(match);
        tournament.matches.push(match);
    }
    
    tournament.knockout.push({
        round: 1,
        name: `V√≤ng ${numTeamsKnockout}`,
        matchIds: roundMatches.map(m => m.id),
        roundKey: roundKey
    });
    
    // 3. T·∫°o c√°c v√≤ng c√≤n l·∫°i (d·ª± ki·∫øn)
    let currentRound = 2;
    let currentNumTeams = numMatchesInRound;
    
    while (currentNumTeams >= 2) {
        const nextNumTeams = currentNumTeams / 2;
        const nextRoundKey = getKnockoutRoundKey(nextNumTeams);
        
        const predictedMatches = [];
        for (let i = 0; i < nextNumTeams; i++) {
             const match = {
                id: `M${matchIdCounter++}`,
                group: 'KO',
                teamAId: `Winner M${(currentRound - 2) * numMatchesInRound + i * 2 + 1}`, // Gi·∫£ ƒë·ªãnh ID tr·∫≠n ƒë·∫•u tr∆∞·ªõc
                teamBId: `Winner M${(currentRound - 2) * numMatchesInRound + i * 2 + 2}`,
                results: [],
                winnerId: null,
                court: '',
                referee: '',
                scheduledTime: '',
                startTime: null,
                duration: null,
                roundKey: nextRoundKey
            };
            predictedMatches.push(match);
            tournament.matches.push(match);
        }
        
        tournament.knockout.push({
            round: currentRound,
            name: `V√≤ng ${nextNumTeams}`,
            matchIds: predictedMatches.map(m => m.id),
            roundKey: nextRoundKey
        });
        
        if (nextNumTeams === 1) break;

        currentNumTeams = nextNumTeams;
        currentRound++;
    }

    saveTournament();
    renderKnockout();
    alert(`ƒê√£ t·∫°o c√¢y ƒë·∫•u lo·∫°i ${numTeamsKnockout} ƒë·ªôi th√†nh c√¥ng.`);
}

// Chuy·ªÉn s·ªë ƒë·ªôi th√†nh t√™n v√≤ng ƒë·∫•u
function getKnockoutRoundKey(numTeams) {
    if (numTeams === 2) return 'final';
    if (numTeams === 4) return 'semiFinal';
    if (numTeams === 8) return 'quarterFinal';
    if (numTeams === 16) return 'roundOf16';
    if (numTeams === 32) return 'roundOf32';
    return `roundOf${numTeams}`;
}

// C·∫≠p nh·∫≠t ng∆∞·ªùi th·∫Øng tr·∫≠n Knockout ƒë·ªÉ t·ª± ƒë·ªông fill v√†o tr·∫≠n ti·∫øp theo
function updateKnockoutWinner(completedMatch) {
    if (!completedMatch.winnerId || completedMatch.roundKey === 'groupStage') return;
    
    const currentRoundIndex = tournament.knockout.findIndex(r => r.roundKey === completedMatch.roundKey);
    const nextRound = tournament.knockout[currentRoundIndex + 1];

    if (!nextRound) {
        if (completedMatch.roundKey === 'final') alert(`CH√öC M·ª™NG! ƒê·ªôi ${getTeam(completedMatch.winnerId)?.name} ƒë√£ v√¥ ƒë·ªãch gi·∫£i ƒë·∫•u!`);
        return;
    }
    
    // T√¨m tr·∫≠n ƒë·∫•u ti·∫øp theo s·∫Ω nh·∫≠n ng∆∞·ªùi th·∫Øng n√†y
    const currentMatchesInRound = tournament.matches.filter(m => m.roundKey === completedMatch.roundKey);
    const currentMatchIndex = currentMatchesInRound.findIndex(m => m.id === completedMatch.id);
    const nextMatchIndexInRound = Math.floor(currentMatchIndex / 2);
    
    const nextMatch = tournament.matches.find(m => m.id === nextRound.matchIds[nextMatchIndexInRound]);
    
    if (nextMatch) {
        const winnerId = completedMatch.winnerId;
        const winnerName = getTeam(winnerId)?.name;
        
        if (currentMatchIndex % 2 === 0) {
            // Tr·∫≠n ƒë·∫•u l√† nh√°nh A (0, 2, 4...) -> fill v√†o teamA c·ªßa tr·∫≠n ti·∫øp theo
            nextMatch.teamAId = winnerId;
        } else {
            // Tr·∫≠n ƒë·∫•u l√† nh√°nh B (1, 3, 5...) -> fill v√†o teamB c·ªßa tr·∫≠n ti·∫øp theo
            nextMatch.teamBId = winnerId;
        }
        
        // T·ª± ƒë·ªông th·∫Øng (BYE) n·∫øu ƒë·ªôi c√≤n l·∫°i l√† BYE
        if (nextMatch.teamAId === 'BYE' && nextMatch.teamBId !== 'BYE') {
            nextMatch.winnerId = nextMatch.teamBId;
            updateKnockoutWinner(nextMatch);
        } else if (nextMatch.teamBId === 'BYE' && nextMatch.teamAId !== 'BYE') {
            nextMatch.winnerId = nextMatch.teamAId;
            updateKnockoutWinner(nextMatch);
        }
    }
    
    saveTournament();
    renderKnockout();
}

function renderKnockout() {
    const container = document.getElementById('knockoutTree');
    let html = '';
    
    // S·∫Øp x·∫øp c√°c v√≤ng ƒë·∫•u theo th·ª© t·ª± ƒë√£ ƒë·ªãnh s·∫µn trong config
    ensureStageOrder();
    const orderedStages = tournament.config.stageOrder;
    
    // L·ªçc ra c√°c v√≤ng ƒë·∫•u knockout (kh√¥ng ph·∫£i v√≤ng b·∫£ng)
    const knockoutRounds = tournament.knockout.sort((a, b) => {
        // S·∫Øp x·∫øp theo th·ª© t·ª± hi·ªÉn th·ªã trong config
        return orderedStages.indexOf(a.roundKey) - orderedStages.indexOf(b.roundKey);
    });
    
    if (knockoutRounds.length === 0) {
        container.innerHTML = '<p class="text-muted">Nh·∫•n "T·∫°o C√¢y ƒê·∫•u Lo·∫°i" ƒë·ªÉ b·∫Øt ƒë·∫ßu v√≤ng lo·∫°i.</p>';
        return;
    }

    knockoutRounds.forEach(round => {
        const roundDisplayName = getStageDisplayName(round.roundKey);
        let matchesHtml = '';
        
        round.matchIds.forEach(matchId => {
            const match = tournament.matches.find(m => m.id === matchId);
            if (!match) return;
            
            const teamA = getTeam(match.teamAId) || { name: `Winner M${match.teamAId.substring(1)}` };
            const teamB = getTeam(match.teamBId) || { name: `Winner M${match.teamBId.substring(1)}` };
            
            const teamAName = match.teamAId === 'BYE' ? `<span class="badge bg-warning text-dark">BYE</span>` : teamA.name;
            const teamBName = match.teamBId === 'BYE' ? `<span class="badge bg-warning text-dark">BYE</span>` : teamB.name;
            
            const scoreDisplay = formatScore(match.results);
            const winnerBadge = match.winnerId ? `<span class="badge bg-success">${getTeam(match.winnerId)?.name} WIN</span>` : `<span class="badge bg-secondary">Ch∆∞a ƒë·∫•u</span>`;
            
            matchesHtml += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${match.id}: ${teamAName} vs ${teamBName}</strong>
                        <p class="small-muted mb-0">${scoreDisplay} ${winnerBadge}</p>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-info me-2" onclick="openMatchDetailsModal('${match.id}')" title="Chi ti·∫øt tr·∫≠n ƒë·∫•u"><i class="fas fa-info-circle"></i></button>
                        ${match.teamAId !== 'BYE' && match.teamBId !== 'BYE' ? 
                            `<button class="btn btn-sm btn-primary" onclick="openSetEditorModal('${match.id}')">Nh·∫≠p KQ</button>` : 
                            '<button class="btn btn-sm btn-light text-muted" disabled>Auto Win</button>'}
                    </div>
                </div>
            `;
        });
        
        html += `
            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">${roundDisplayName} (V√≤ng ${round.round})</h5>
                </div>
                <div class="list-group list-group-flush">
                    ${matchesHtml}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// --- TAB TEST & GI·∫¢ L·∫¨P D·ªÆ LI·ªÜU ---

function renderTestTab() {
    document.getElementById('playerCountTest').textContent = tournament.players.filter(p => !p.teamId).length;
    document.getElementById('teamCountTest').textContent = tournament.teams.length;
}

function generateFakePlayers() {
    const maleCount = parseInt(document.getElementById('maleCount').value) || 0;
    const femaleCount = parseInt(document.getElementById('femaleCount').value) || 0;
    
    if (maleCount + femaleCount === 0) return alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng ng∆∞·ªùi ch∆°i.');

    const namesMale = ["An", "B·∫£o", "C∆∞·ªùng", "D≈©ng", "Giang", "H·∫£i", "Kh√°nh", "Long", "Minh", "Nam", "Ph√∫c", "Quang", "S∆°n", "Th·∫Øng", "Tu·∫•n", "Vi·ªát"];
    const namesFemale = ["Anh", "Chi", "Di·ªáp", "H√†", "H∆∞∆°ng", "Linh", "Mai", "Ng·ªçc", "Ph∆∞∆°ng", "Trang", "Uy√™n", "Y·∫øn"];

    let newPlayers = [];

    for (let i = 0; i < maleCount; i++) {
        const baseName = namesMale[i % namesMale.length];
        newPlayers.push({
            id: generateId(),
            name: `${baseName} Nam ${i + 1}`,
            nickname: `MN${i + 1}`,
            level: '3.0',
            gender: 'Nam',
            dob: '',
            phone: '',
            email: '',
            teamId: ''
        });
    }

    for (let i = 0; i < femaleCount; i++) {
        const baseName = namesFemale[i % namesFemale.length];
        newPlayers.push({
            id: generateId(),
            name: `${baseName} N·ªØ ${i + 1}`,
            nickname: `FN${i + 1}`,
            level: '3.0',
            gender: 'N·ªØ',
            dob: '',
            phone: '',
            email: '',
            teamId: ''
        });
    }

    tournament.players.push(...newPlayers);
    saveTournament();
    renderPlayerList();
    renderTestTab();
    alert(`ƒê√£ t·∫°o ${newPlayers.length} ng∆∞·ªùi ch∆°i gi·∫£ l·∫≠p.`);
}

function generatePairs() {
    const playersWithoutTeam = tournament.players.filter(p => !p.teamId);
    
    if (playersWithoutTeam.length < 2) {
        return alert('Kh√¥ng ƒë·ªß ng∆∞·ªùi ch∆°i ƒë·ªôc l·∫≠p ƒë·ªÉ t·∫°o ƒë·ªôi (c·∫ßn t·ªëi thi·ªÉu 2).');
    }
    
    const mixMaleMale = document.getElementById('mixMaleMale').checked;
    const mixMaleFemale = document.getElementById('mixMaleFemale').checked;
    const mixFemaleFemale = document.getElementById('mixFemaleFemale').checked;
    
    const males = playersWithoutTeam.filter(p => p.gender === 'Nam');
    const females = playersWithoutTeam.filter(p => p.gender === 'N·ªØ');
    
    let newTeams = [];
    let pairedPlayerIds = new Set();
    let teamCounter = tournament.teams.length + 1;

    // Helper to create a team
    const createTeam = (p1, p2, tag) => {
        const teamId = generateId();
        const teamName = `${p1.nickname}/${p2.nickname}`.toUpperCase();
        newTeams.push({ id: teamId, name: teamName, tag: tag, groupId: '' });
        p1.teamId = teamId;
        p2.teamId = teamId;
        pairedPlayerIds.add(p1.id);
        pairedPlayerIds.add(p2.id);
    };

    // 1. Male-Male (MM)
    if (mixMaleMale) {
        const availableMales = males.filter(p => !pairedPlayerIds.has(p.id));
        for (let i = 0; i < Math.floor(availableMales.length / 2); i++) {
            createTeam(availableMales[i * 2], availableMales[i * 2 + 1], 'MM');
        }
    }
    
    // 2. Female-Female (FF)
    if (mixFemaleFemale) {
        const availableFemales = females.filter(p => !pairedPlayerIds.has(p.id));
        for (let i = 0; i < Math.floor(availableFemales.length / 2); i++) {
            createTeam(availableFemales[i * 2], availableFemales[i * 2 + 1], 'FF');
        }
    }
    
    // 3. Male-Female (MF) - ∆∞u ti√™n l·∫•y ng∆∞·ªùi c√≤n l·∫°i
    if (mixMaleFemale) {
        const availableMales = males.filter(p => !pairedPlayerIds.has(p.id));
        const availableFemales = females.filter(p => !pairedPlayerIds.has(p.id));
        
        const limit = Math.min(availableMales.length, availableFemales.length);
        for (let i = 0; i < limit; i++) {
            createTeam(availableMales[i], availableFemales[i], 'MF');
        }
    }

    tournament.teams.push(...newTeams);
    saveTournament();
    renderPlayerList();
    renderTeamList();
    renderTestTab();
    alert(`ƒê√£ t·∫°o ${newTeams.length} ƒë·ªôi (c·∫∑p ƒë·∫•u) m·ªõi.`);
}

function generateTestGroups() {
    const groupsMMCount = parseInt(document.getElementById('groupsMM').value) || 0;
    const groupsMFCount = parseInt(document.getElementById('groupsMF').value) || 0;
    const groupsFFCount = parseInt(document.getElementById('groupsFF').value) || 0;
    
    if (!confirm('H√†nh ƒë·ªông n√†y s·∫Ω X√ìA B·∫¢NG V√Ä L·ªäCH THI ƒê·∫§U hi·ªán t·∫°i v√† t·∫°o b·∫£ng m·ªõi theo lo·∫°i h√¨nh ƒë·ªôi.')) {
        return;
    }
    
    // X√≥a d·ªØ li·ªáu c≈©
    tournament.groups = [];
    tournament.matches = [];
    tournament.standings = {};
    tournament.teams.forEach(t => t.groupId = '');

    const groupSize = tournament.config.groupSize;
    let groupIndex = 1;

    const createGroupsForTag = (tag, count) => {
        const teams = tournament.teams.filter(t => t.tag === tag);
        if (teams.length === 0) return;
        
        teams.sort(() => 0.5 - Math.random()); // X√°o tr·ªôn
        
        const numTeamsPerGroup = Math.ceil(teams.length / count);

        for (let i = 0; i < count; i++) {
            const groupTeams = teams.splice(0, numTeamsPerGroup > groupSize ? groupSize : numTeamsPerGroup); // L·∫•y t·ªëi ƒëa groupSize (n·∫øu c√≤n)
            if (groupTeams.length < 2) continue; // B·ªè qua n·∫øu kh√¥ng ƒë·ªß 2 ƒë·ªôi
            
            const groupId = `G${groupIndex++}`;
            const newGroup = { id: groupId, name: `B·∫£ng ${tag} ${groupId}`, teamIds: groupTeams.map(t => t.id) };
            
            groupTeams.forEach(t => getTeam(t.id).groupId = groupId); // C·∫≠p nh·∫≠t groupId cho team
            tournament.groups.push(newGroup);
        }
    };

    createGroupsForTag('MM', groupsMMCount);
    createGroupsForTag('MF', groupsMFCount);
    createGroupsForTag('FF', groupsFFCount);
    
    saveTournament();
    renderGroups();
    alert(`ƒê√£ t·∫°o ${tournament.groups.length} b·∫£ng ƒë·∫•u th·ª≠ nghi·ªám.`);
}

function deleteAllPlayers() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ ng∆∞·ªùi ch∆°i?')) {
        tournament.players = [];
        tournament.teams.forEach(t => t.groupId = ''); // X√≥a team association as well
        saveTournament();
        renderAllTabs();
        alert('ƒê√£ x√≥a to√†n b·ªô ng∆∞·ªùi ch∆°i.');
    }
}

function deleteAllTeams() {
     if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ ƒë·ªôi? Ng∆∞·ªùi ch∆°i s·∫Ω tr·ªü th√†nh ƒë·ªôc l·∫≠p.')) {
        tournament.teams = [];
        tournament.players.forEach(p => p.teamId = '');
        tournament.groups = [];
        tournament.matches = [];
        tournament.standings = {};
        saveTournament();
        renderAllTabs();
        alert('ƒê√£ x√≥a to√†n b·ªô ƒë·ªôi, b·∫£ng ƒë·∫•u v√† l·ªãch thi ƒë·∫•u.');
    }
}

function deleteAllGroupsAndMatches() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA T·∫§T C·∫¢ b·∫£ng ƒë·∫•u, l·ªãch thi ƒë·∫•u v√† b·∫£ng x·∫øp h·∫°ng?')) {
        tournament.groups = [];
        tournament.matches = [];
        tournament.standings = {};
        tournament.knockout = [];
        tournament.teams.forEach(t => t.groupId = '');
        saveTournament();
        renderAllTabs();
        alert('ƒê√£ x√≥a to√†n b·ªô b·∫£ng ƒë·∫•u, l·ªãch thi ƒë·∫•u v√† b·∫£ng x·∫øp h·∫°ng.');
    }
}

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
document.addEventListener('DOMContentLoaded', () => {
    loadTournament();
});
</script>

</body>
</html>
