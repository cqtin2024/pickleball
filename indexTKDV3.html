<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 ‚Äî Qu·∫£n l√Ω gi·∫£i Pickleball V11 Optimized</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:url('https://placehold.co/64x64/0d6efd/ffffff?text=TKD') center center no-repeat;
      background-size: cover;
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <div class="logo" role="img" aria-label="Logo TKD"></div>
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ng√†y thi ƒë·∫•u: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState">T·∫Øt</span></div>
      <div id="lastSaved" class="text-end status">Ch∆∞a l∆∞u</div>
    </div>
  </div>

  <!-- C√°c tab ƒëi·ªÅu h∆∞·ªõng -->
  <ul class="nav nav-tabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview">T·ªïng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches">V√≤ng B·∫£ng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals">V√≤ng Chung K·∫øt</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results">K·∫øt qu·∫£ Chung cu·ªôc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config">C·∫•u h√¨nh</button></li>
  </ul>

  <!-- N·ªôi dung c·ªßa c√°c tab -->
  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview"><div id="overviewContent">Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng qu·∫£n l√Ω gi·∫£i ƒë·∫•u TKD 2025. Vui l√≤ng chuy·ªÉn sang tab 'V√≤ng B·∫£ng' ƒë·ªÉ t·∫°o l·ªãch thi ƒë·∫•u.</div></div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">T·∫°o l·ªãch thi ƒë·∫•u T·ªëi ∆∞u (T·ª± ƒë·ªông)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">T·∫°o l·ªãch C·ªë ƒë·ªãnh (Theo File)</button>
        <!-- N√∫t m·ªõi: T·ª± ƒë·ªông ƒëi·ªÅn k·∫øt qu·∫£ -->
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">ƒêi·ªÅn k·∫øt qu·∫£ T·ª± ƒë·ªông (11 - X)</button>
      </div>
      
      <!-- B·∫£ng A (Nam-N·ªØ) -->
      <h6 class="mt-4">B·∫£ng A (Nam - N·ªØ)</h6><div id="tableMatchesA">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
      
      <!-- B·∫£ng B (Nam) -->
      <h6 class="mt-4">B·∫£ng B (Nam)</h6><div id="tableMatchesB">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
      
      <!-- N√∫t l√™n l·ªãch Chung k·∫øt ch·ªâ c√≤n ch·ª©c nƒÉng reset/kh·ªüi t·∫°o -->
      <!-- Vi·ªác c·∫≠p nh·∫≠t ƒë·ªôi ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông h√≥a -->
      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">L√™n l·ªãch V√≤ng Chung k·∫øt (T·ª± ƒë·ªông h√≥a)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">V√≤ng B√°n k·∫øt (16:30, S√¢n 1-2)</h6>
            <div id="semifinalMatches">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u b√°n k·∫øt. K·∫øt qu·∫£ V√≤ng B·∫£ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch.</div>

            <h6 class="mt-4">Tr·∫≠n Chung k·∫øt (17:00, S√¢n 1)</h6>
            <div id="finalMatch">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u chung k·∫øt.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <!-- B·∫£ng x·∫øp h·∫°ng V√≤ng B·∫£ng -->
        <h5 class="mb-3">B·∫£ng x·∫øp h·∫°ng V√≤ng B·∫£ng (C·∫≠p nh·∫≠t li√™n t·ª•c)</h5>
        <div id="rankingTables" class="ranking-container">
            <!-- B·∫£ng x·∫øp h·∫°ng A v√† B ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
        </div>

        <hr class="my-4">

        <!-- K·∫øt qu·∫£ Chung cu·ªôc -->
        <h5 class="mb-3">Danh hi·ªáu Chung cu·ªôc</h5>
        <p id="champion">V√¥ ƒë·ªãch: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="runnerUp">√Å qu√¢n: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="thirdPlace">H·∫°ng Ba ƒê·ªìng H·∫°ng: ƒêang ch·ªù k·∫øt qu·∫£...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <p class="text-muted">C√°c th√¥ng s·ªë n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ l∆∞u/t·∫£i d·ªØ li·ªáu gi·∫£i ƒë·∫•u t·ª´ d·ªãch v·ª• ngo√†i.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (V√≠ d·ª•: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (V√≠ d·ª•: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="players.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="D√°n token t·∫°i ƒë√¢y">
      <button class="btn btn-primary" onclick="saveConfig()">L∆∞u c·∫•u h√¨nh</button>
      <div class="mt-2" id="configStatus"></div>
    </div>
  </div>
</div>

<script>
// D·ªØ li·ªáu l·ªãch c·ªë ƒë·ªãnh t·ª´ file TKDPlayers - Sheet2.csv (ƒë√£ ƒë∆∞·ª£c nh√∫ng)
const FIXED_SCHEDULE_CSV = `TKD CHAMPIONSHIPS 2025,,,,,\r\n,,,,,\r\nTime,Match,Court 1,Court 2,Court 3,Court 7\r\n2:00,1,Ti·ªáp/Th·ªßy - Ph∆∞∆°ng/Thanh,Giang/Long - H∆∞·ªùng/ƒê·∫°t,H·∫≠u/D≈©ng - H·∫°nh/Ti·∫øn,Huy·ªÅn/Lu√¢n - Linh/H√πng\r\n2:15,2,Tri·ªÅu/Minh - Hi·ªÉn/H√πng,T√≠n/Khi√™m - √Ånh/To√†n,H·∫≠u/D≈©ng - H∆∞·ªùng/ƒê·∫°t,Giang/Long - Huy·ªÅn/Lu√¢n\r\n2:30,3,Ph∆∞∆°ng/Thanh - √Ånh/To√†n,Tri·ªÅu/Minh - T√≠n/Khi√™m,H·∫°nh/Ti·∫øn - Linh/H√πng,Ti·ªáp/Th·ªßy - Hi·ªÉn/H√πng\r\n2:45,4,d·ª± ph√≤ng,H·∫°nh/Ti·∫øn - Giang/Long,Huy·ªÅn/Lu√¢n - H∆∞·ªùng/ƒê·∫°t,H·∫≠u/D≈©ng - Linh/H√πng\r\n3:00,5,,Ti·ªáp/Th·ªßy - √Ånh/To√†n,T√≠n/Khi√™m - Hi·ªÉn/H√πng,\r\n3:15,6,,Ph∆∞∆°ng/Thanh - Tri·ªÅu/Minh,Giang/Long - Linh/H√πng,\r\n3:30,7,,H·∫°nh/Ti·∫øn - H∆∞·ªùng/ƒê·∫°t,H·∫≠u/D≈©ng - Huy·ªÅn/Lu√¢n,\r\n3:45,8,,Ti·ªáp/Th·ªßy - T√≠n/Khi√™m,Ph∆∞∆°ng/Thanh - Hi·ªÉn/H√πng,\r\n4:00,9,,Tri·ªÅu/Minh - √Ånh/To√†n,Ti·ªáp/Th·ªßy - Ph∆∞∆°ng/Thanh,H·∫°nh/Ti·∫øn - Huy·ªÅn/Lu√¢n,\r\n4:15,10,,T√≠n/Khi√™m - Ph∆∞∆°ng/Thanh,Giang/Long - H·∫≠u/D≈©ng,\r\n4:30,11,,H·∫≠u/D≈©ng - H·∫°nh/Ti·∫øn,Giang/Long - H∆∞·ªùng/ƒê·∫°t,Huy·ªÅn/Lu√¢n - Linh/H√πng,H·∫≠u/D≈©ng - Linh/H√πng\r\n4:45,12,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng\r\n5:00,13,H·∫≠u/D≈©ng - Giang/Long,Huy·ªÅn/Lu√¢n - H·∫°nh/Ti·∫øn,Linh/H√πng - H∆∞·ªùng/ƒê·∫°t,\r\n5:15,14,Tri·ªÅu/Minh - Ti·ªáp/Th·ªßy,√Ånh/To√†n - Hi·ªÉn/H√πng,Ph∆∞∆°ng/Thanh - T√≠n/Khi√™m,\r\n5:30,15,H·∫≠u/D≈©ng - Huy·ªÅn/Lu√¢n,Giang/Long - Linh/H√πng,H·∫°nh/Ti·∫øn - H∆∞·ªùng/ƒê·∫°t,\r\n5:45,16,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng\r\n6:00,17,Huy·ªÅn/Lu√¢n - Giang/Long,H·∫≠u/D≈©ng - H∆∞·ªùng/ƒê·∫°t,H·∫°nh/Ti·∫øn - Linh/H√πng,\r\n6:15,18,Ti·ªáp/Th·ªßy - Hi·ªÉn/H√πng,Ph∆∞∆°ng/Thanh - √Ånh/To√†n,Tri·ªÅu/Minh - T√≠n/Khi√™m,\r\n6:30,19,H·∫≠u/D≈©ng - H·∫°nh/Ti·∫øn,Giang/Long - H∆∞·ªùng/ƒê·∫°t,Huy·ªÅn/Lu√¢n - Linh/H√πng,Ti·ªáp/Th·ªßy - Ph∆∞∆°ng/Thanh\r\n6:45,20,Tri·ªÅu/Minh - Hi·ªÉn/H√πng,T√≠n/Khi√™m - √Ånh/To√†n,H·∫≠u/D≈©ng - H∆∞·ªùng/ƒê·∫°t,Giang/Long - Huy·ªÅn/Lu√¢n\r\n7:00,21,Ph∆∞∆°ng/Thanh - √Ånh/To√†n,Tri·ªÅu/Minh - T√≠n/Khi√™m,H·∫°nh/Ti·∫øn - Linh/H√πng,Ti·ªáp/Th·ªßy - Hi·ªÉn/H√πng\r\n7:15,22,d·ª± ph√≤ng,H·∫°nh/Ti·∫øn - Giang/Long,Huy·ªÅn/Lu√¢n - H∆∞·ªùng/ƒê·∫°t,H·∫≠u/D≈©ng - Linh/H√πng\r\n7:30,23,,Ti·ªáp/Th·ªßy - √Ånh/To√†n,T√≠n/Khi√™m - Hi·ªÉn/H√πng,\r\n7:45,24,,Ph∆∞∆°ng/Thanh - Tri·ªÅu/Minh,Giang/Long - Linh/H√πng,\r\n8:00,25,,H·∫°nh/Ti·∫øn - H∆∞·ªùng/ƒê·∫°t,H·∫≠u/D≈©ng - Huy·ªÅn/Lu√¢n,\r\n8:15,26,,Ti·ªáp/Th·ªßy - T√≠n/Khi√™m,Ph∆∞∆°ng/Thanh - Hi·ªÉn/H√πng,\r\n8:30,27,,Tri·ªÅu/Minh - √Ånh/To√†n,Ti·ªáp/Th·ªßy - Ph∆∞∆°ng/Thanh,H·∫°nh/Ti·∫øn - Huy·ªÅn/Lu√¢n,\r\n8:45,28,,T√≠n/Khi√™m - Ph∆∞∆°ng/Thanh,Giang/Long - H·∫≠u/D≈©ng,\r\n9:00,29,,H·∫≠u/D≈©ng - H·∫°nh/Ti·∫øn,Giang/Long - H∆∞·ªùng/ƒê·∫°t,Huy·ªÅn/Lu√¢n - Linh/H√πng,H·∫≠u/D≈©ng - Linh/H√πng\r\n9:15,30,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng\r\n9:30,31,H·∫≠u/D≈©ng - Giang/Long,Huy·ªÅn/Lu√¢n - H·∫°nh/Ti·∫øn,Linh/H√πng - H∆∞·ªùng/ƒê·∫°t,\r\n9:45,32,Tri·ªÅu/Minh - Ti·ªáp/Th·ªßy,√Ånh/To√†n - Hi·ªÉn/H√πng,Ph∆∞∆°ng/Thanh - T√≠n/Khi√™m,\r\n10:00,33,H·∫≠u/D≈©ng - Huy·ªÅn/Lu√¢n,Giang/Long - Linh/H√πng,H·∫°nh/Ti·∫øn - H∆∞·ªùng/ƒê·∫°t,\r\n10:15,34,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng,d·ª± ph√≤ng\r\n10:30,35,Huy·ªÅn/Lu√¢n - Giang/Long,H·∫≠u/D≈©ng - H∆∞·ªùng/ƒê·∫°t,H·∫°nh/Ti·∫øn - Linh/H√πng,\r\n10:45,36,Ti·ªáp/Th·ªßy - Hi·ªÉn/H√πng,Ph∆∞∆°ng/Thanh - √Ånh/To√†n,Tri·ªÅu/Minh - T√≠n/Khi√™m,`;

// Bi·∫øn state l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh c·ªßa ·ª©ng d·ª•ng.
let state = { 
  mixedTeams: ["H·∫≠u/D≈©ng","H·∫°nh/Ti·∫øn","Giang/Long","Huy·ªÅn/Lu√¢n","Linh/H√πng","H∆∞·ªùng/ƒê·∫°t"], 
  maleTeams: ["Ti·ªáp/Th·ªßy","Ph∆∞∆°ng/Thanh","Tri·ªÅu/Minh","T√≠n/Khi√™m","√Ånh/To√†n","Hi·ªÉn/H√πng"], 
  matchesA: [], 
  matchesB: [],
  tableA: [], // B·∫£ng x·∫øp h·∫°ng A
  tableB: [], // B·∫£ng x·∫øp h·∫°ng B
  semifinals: [
    { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 1', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 2', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'S√¢n 1', winner: null, runnerUp: null },
  config: {}
};

// --- Kh·ªüi t·∫°o v√† T·∫£i C·∫•u h√¨nh ---
function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'players.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}
window.onload = function() {
    loadConfig();
    // Kh·ªüi t·∫°o b·∫£ng x·∫øp h·∫°ng v√† k·∫øt qu·∫£ ngay khi t·∫£i trang
    tinhVaCapNhatXepHang();
    renderFinals();
    renderFinalResults();
};

// --- V√≤ng B·∫£ng: T·∫°o L·ªãch C·ªë ƒê·ªãnh ---
function parseFixedSchedule(csvContent, mixedTeams, maleTeams) {
    const allMatches = [];
    const rows = csvContent.trim().split('\r\n').slice(3); 
    // √Ånh x·∫° t√™n c·ªôt sang t√™n S√¢n ƒë·∫•u chu·∫©n
    const COURT_MAP = { 2: 'S√¢n 1', 3: 'S√¢n 2', 4: 'S√¢n 3', 5: 'S√¢n 7' }; 
    
    rows.forEach(row => {
        // S·ª≠ d·ª•ng regex ƒë·ªÉ t√°ch c·ªôt an to√†n h∆°n
        const columns = row.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g) || [];
        const time = columns[0] ? columns[0].trim() : '';

        // B·∫Øt ƒë·∫ßu t·ª´ c·ªôt th·ª© 3 (index 2) ch·ª©a Court 1, 2, 3, 7
        for (let i = 2; i <= 5; i++) { 
            let matchString = columns[i] ? columns[i].trim() : '';
            const courtName = COURT_MAP[i];

            if (matchString && matchString.toLowerCase() !== 'd·ª± ph√≤ng' && matchString !== '-' && matchString.includes(' - ')) {
                const teams = matchString.split(' - ');
                if (teams.length === 2) {
                    const teamA = teams[0].trim();
                    const teamB = teams[1].trim();

                    // X√°c ƒë·ªãnh b·∫£ng ƒë·∫•u d·ª±a tr√™n ƒë·ªôi tham gia
                    let bang = null;
                    if (mixedTeams.includes(teamA) && mixedTeams.includes(teamB)) {
                        bang = 'A'; 
                    } else if (maleTeams.includes(teamA) && maleTeams.includes(teamB)) {
                        bang = 'B'; 
                    }
                    
                    if (bang) {
                         allMatches.push({
                            teamA,
                            teamB,
                            time,
                            court: courtName,
                            bang,
                            scoreA: null,
                            scoreB: null
                        });
                    }
                }
            }
        }
    });

    allMatches.sort((a, b) => {
        const timeToMinutes = (t) => {
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        };
        return timeToMinutes(a.time) - timeToMinutes(b.time);
    });

    const matchesA = allMatches.filter(m => m.bang === 'A');
    const matchesB = allMatches.filter(m => m.bang === 'B');
    
    return { matchesA, matchesB };
}

function taoLichCoDinh() {
    const csvData = parseFixedSchedule(FIXED_SCHEDULE_CSV, state.mixedTeams, state.maleTeams);
    state.matchesA = csvData.matchesA;
    state.matchesB = csvData.matchesB;
    renderMatches();
    tinhVaCapNhatXepHang(); // C·∫≠p nh·∫≠t BXH sau khi t·∫°o l·ªãch m·ªõi (s·∫Ω t·ª± ƒë·ªông g·ªçi scheduleFinalsAuto)
}

// --- V√≤ng B·∫£ng: T·∫°o L·ªãch T·ªëi ∆Øu ---

function taoLichThiDauCungGio(){
  const start = new Date('2025-10-18T14:00:00');
  const duration = 15 * 60000; 

  state.matchesA = distributeMatchesSameTime(state.mixedTeams, ['S√¢n 2','S√¢n 3'], start, duration);
  state.matchesB = distributeMatchesSameTime(state.maleTeams, ['S√¢n 7','S√¢n 8'], start, duration);

  renderMatches();
  tinhVaCapNhatXepHang(); // C·∫≠p nh·∫≠t BXH sau khi t·∫°o l·ªãch m·ªõi (s·∫Ω t·ª± ƒë·ªông g·ªçi scheduleFinalsAuto)
}

function distributeMatchesSameTime(teams, courts, start, duration){
  const matches = [];
  const nextTime = {}; 
  teams.forEach(t => nextTime[t] = new Date(start.getTime() - duration));

  let queue = [];
  for(let i=0; i < teams.length; i++){
    for(let j=i+1; j < teams.length; j++) queue.push([teams[i], teams[j]]);
  }

  let time = new Date(start);
  let totalCourts = courts.length;

  while(queue.length){
    let matchesScheduledInThisSlot = 0;
    
    for(let c=0; c < totalCourts && queue.length; c++){
      let idx = queue.findIndex(p => new Date(nextTime[p[0]]) <= time && new Date(nextTime[p[1]]) <= time);
      
      if(idx >= 0){
        let [teamA, teamB] = queue.splice(idx,1)[0];
        
        matches.push({
          teamA, 
          teamB, 
          scoreA: null, 
          scoreB: null, 
          time: time.toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}), 
          court: courts[c]
        });
        
        nextTime[teamA] = new Date(time.getTime() + duration);
        nextTime[teamB] = new Date(time.getTime() + duration);
        matchesScheduledInThisSlot++;
      }
    }
    
    if (matchesScheduledInThisSlot > 0 || totalCourts > 0) {
      time = new Date(time.getTime() + duration);
    } else if (queue.length > 0) {
        time = new Date(time.getTime() + duration);
    } else {
        break; 
    }
  }

  return matches;
}

// --- V√≤ng B·∫£ng: ƒêi·ªÅn k·∫øt qu·∫£ T·ª± ƒë·ªông ---
function autoFillScores() {
    const fillMatchScores = (matches) => {
        matches.forEach(m => {
            if (m.scoreA === null && m.scoreB === null) {
                // ƒê·ªôi th·∫Øng lu√¥n l√† 11
                const winnerScore = 11;
                // ƒê·ªôi thua t·ª´ 0 ƒë·∫øn 10
                const loserScore = Math.floor(Math.random() * 11);
                
                // Ch·ªçn ng·∫´u nhi√™n ƒë·ªôi th·∫Øng
                if (Math.random() < 0.5) {
                    // Team A th·∫Øng
                    m.scoreA = winnerScore;
                    m.scoreB = loserScore;
                } else {
                    // Team B th·∫Øng
                    m.scoreA = loserScore;
                    m.scoreB = winnerScore;
                }
            }
        });
    };

    fillMatchScores(state.matchesA);
    fillMatchScores(state.matchesB);
    
    renderMatches();
    tinhVaCapNhatXepHang(); // T·ª± ƒë·ªông c·∫≠p nh·∫≠t BXH v√† l·ªãch CK
}


// --- V√≤ng B·∫£ng: Hi·ªÉn th·ªã v√† C·∫≠p nh·∫≠t T·ªâ s·ªë ---

function renderMatches(){
  document.getElementById('tableMatchesA').innerHTML = renderMatchesTable(state.matchesA,'A');
  document.getElementById('tableMatchesB').innerHTML = renderMatchesTable(state.matchesB,'B');
}

function renderMatchesTable(list,id){
  if(!list.length)return'<div>Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u</div>';
  let html="<div class='table-responsive'><table class='table table-bordered table-sm'><thead><tr><th>ƒê·ªôi A</th><th>ƒê·ªôi B</th><th class='text-center'>T·ªâ s·ªë</th><th>Gi·ªù</th><th>S√¢n</th></tr></thead><tbody>";
  list.forEach((m,i)=>{
    html+=`<tr>
      <td>${m.teamA}</td>
      <td>${m.teamB}</td>
      <td class='match-score-cell d-flex justify-content-center align-items-center gap-1'>
        <input type='number' min='0' value='${m.scoreA !== null ? m.scoreA : ''}' onchange='capNhatTiSo("match", "${id}", ${i}, this.value, true)' class='form-control form-control-sm'> 
        - 
        <input type='number' min='0' value='${m.scoreB !== null ? m.scoreB : ''}' onchange='capNhatTiSo("match", "${id}", ${i}, this.value, false)' class='form-control form-control-sm'>
      </td>
      <td>${m.time}</td>
      <td>${m.court}</td>
    </tr>`;
  });
  return html+="</tbody></table></div>";
}

/**
 * H√†m c·∫≠p nh·∫≠t t·ªâ s·ªë chung cho c·∫£ V√≤ng B·∫£ng v√† V√≤ng Chung k·∫øt.
 */
function capNhatTiSo(type, id, index, val, isA){
  const score = val === '' ? null : (parseInt(val) >= 0 ? parseInt(val) : 0); 

  if (type === 'match') {
      // C·∫≠p nh·∫≠t V√≤ng B·∫£ng
      const list = id === 'A' ? state.matchesA : state.matchesB;
      if(isA) list[index].scoreA = score;
      else list[index].scoreB = score;
      // T·ª± ƒë·ªông c·∫≠p nh·∫≠t BXH v√† l·ªãch CK sau khi c√≥ k·∫øt qu·∫£
      tinhVaCapNhatXepHang();
  } else if (type === 'semifinal') {
      // C·∫≠p nh·∫≠t B√°n k·∫øt
      if(isA) state.semifinals[index].scoreA = score;
      else state.semifinals[index].scoreB = score;
      updateMatchResult(state.semifinals[index]);
      updateFinalMatch();
  } else if (type === 'final') {
      // C·∫≠p nh·∫≠t Chung k·∫øt
      if(isA) state.final.scoreA = score;
      else state.final.scoreB = score;
      updateMatchResult(state.final);
  }
  
  // Sau khi c·∫≠p nh·∫≠t t·ªâ s·ªë V√≤ng CK, c·∫ßn render l·∫°i V√≤ng Chung K·∫øt v√† K·∫øt Qu·∫£
  if (type !== 'match') {
      renderFinals();
      renderFinalResults();
  }
}

// --- V√≤ng B·∫£ng: T√≠nh v√† Hi·ªÉn th·ªã X·∫øp H·∫°ng Li√™n T·ª•c ---

/**
 * T√≠nh to√°n BXH, c·∫≠p nh·∫≠t state, t·ª± ƒë·ªông l√™n l·ªãch CK, sau ƒë√≥ render ra giao di·ªán Results.
 */
function tinhVaCapNhatXepHang(){
  const A = tinhDiemBang(state.matchesA);
  const B = tinhDiemBang(state.matchesB);
  
  state.tableA = A; 
  state.tableB = B;

  // T·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch Chung k·∫øt ngay khi BXH thay ƒë·ªïi
  scheduleFinalsAuto();
  
  renderBangXepHang('A', A); 
  renderBangXepHang('B', B);
}

/**
 * T√≠nh to√°n ƒëi·ªÉm, hi·ªáu s·ªë v√† x·∫øp h·∫°ng cho m·ªôt b·∫£ng ƒë·∫•u.
 * @param {Array<Object>} matches Danh s√°ch c√°c tr·∫≠n ƒë·∫•u c·ªßa b·∫£ng.
 * @returns {Array<Object>} Danh s√°ch c√°c ƒë·ªôi ƒë√£ ƒë∆∞·ª£c x·∫øp h·∫°ng.
 */
function tinhDiemBang(matches){
  const teamsInMatch = new Set();
  matches.forEach(m => {
      teamsInMatch.add(m.teamA);
      teamsInMatch.add(m.teamB);
  });
  
  const table = {};
  teamsInMatch.forEach(team => table[team] = {team, wins: 0, losses: 0, pointsW: 0, pointsL: 0});

  matches.forEach(m => {
    // N·∫øu ch∆∞a c√≥ t·ªâ s·ªë, b·ªè qua
    if(!table[m.teamA] || !table[m.teamB]) return;
    if(m.scoreA == null || m.scoreB == null) return;
    
    const aWin = m.scoreA > m.scoreB; 
    const bWin = m.scoreB > m.scoreA;
    
    if(aWin) {
      table[m.teamA].wins++; 
      table[m.teamB].losses++;
    } else if(bWin) {
      table[m.teamB].wins++; 
      table[m.teamA].losses++;
    }
    
    table[m.teamA].pointsW += m.scoreA; 
    table[m.teamA].pointsL += m.scoreB;
    table[m.teamB].pointsW += m.scoreB; 
    table[m.teamB].pointsL += m.scoreA;
  });
  
  let list = Object.values(table);
  list.forEach(t => { 
    t.diff = t.pointsW - t.pointsL; 
    t.points = t.wins * 2; 
  });
  
  // S·∫Øp x·∫øp: ƒêi·ªÉm > Hi·ªáu s·ªë > ƒêi·ªÉm th·∫Øng
  list.sort((a,b) => 
    b.points - a.points || 
    b.diff - a.diff || 
    b.pointsW - a.pointsW || 
    a.team.localeCompare(b.team) // S·ª≠ d·ª•ng t√™n ƒë·ªôi ƒë·ªÉ tie-breaker cu·ªëi c√πng
  ); 
  
  return list;
}

/**
 * Hi·ªÉn th·ªã b·∫£ng x·∫øp h·∫°ng ra giao di·ªán Results.
 */
function renderBangXepHang(bang,list){
  let html=`<h6 class="mt-4">B·∫£ng ${bang}</h6><div class='table-responsive'><table class='table table-striped table-sm'><thead><tr><th>H·∫°ng</th><th>ƒê·ªôi</th><th>Th·∫Øng</th><th>Thua</th><th>ƒêi·ªÉm</th><th>Hi·ªáu s·ªë</th></tr></thead><tbody>`;
  list.forEach((r, index)=>{ 
    html+=`<tr>
      <td>${index + 1}</td>
      <td>${r.team}</td>
      <td>${r.wins}</td>
      <td>${r.losses}</td>
      <td><span class="badge bg-primary">${r.points}</span></td>
      <td>${r.diff}</td>
    </tr>` 
  });
  html+='</tbody></table></div>';
  
  // X√°c ƒë·ªãnh v·ªã tr√≠ render
  const targetId = bang === 'A' ? 'rankingTableA' : 'rankingTableB';
  let targetElement = document.getElementById(targetId);

  // N·∫øu ch∆∞a c√≥, t·∫°o m·ªõi v√† th√™m v√†o rankingTables container
  if (!targetElement) {
      targetElement = document.createElement('div');
      targetElement.id = targetId;
      document.getElementById('rankingTables').appendChild(targetElement);
  }
  
  targetElement.innerHTML = html;
}

// --- V√≤ng Chung K·∫øt: L√™n L·ªãch v√† C·∫≠p Nh·∫≠t ---

/**
 * T·ª± ƒë·ªông l√™n l·ªãch B√°n k·∫øt d·ª±a tr√™n BXH V√≤ng B·∫£ng.
 * N·∫øu ch∆∞a ƒë·ªß 4 ƒë·ªôi (Nh·∫•t/Nh√¨ A, Nh·∫•t/Nh√¨ B) th√¨ gi·ªØ nguy√™n placeholder.
 */
function scheduleFinalsAuto() {
    
    const teamA1 = state.tableA[0]?.team || 'Nh·∫•t A';
    const teamA2 = state.tableA[1]?.team || 'Nh√¨ A';
    const teamB1 = state.tableB[0]?.team || 'Nh·∫•t B';
    const teamB2 = state.tableB[1]?.team || 'Nh√¨ B';

    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu 4 ƒë·ªôi ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh, n·∫øu kh√¥ng gi·ªØ nguy√™n t√™n ƒë·ªôi
    if (teamA1.startsWith('Nh·∫•t') || teamA2.startsWith('Nh√¨') || teamB1.startsWith('Nh·∫•t') || teamB2.startsWith('Nh√¨')) {
        // N·∫øu thi·∫øu ƒë·ªôi, gi·ªØ nguy√™n state b√°n k·∫øt/chung k·∫øt v√† ch·ªâ render
    } else {
        // C√≥ ƒë·ªß 4 ƒë·ªôi, ti·∫øn h√†nh c·∫≠p nh·∫≠t ƒë·ªôi v√†o B√°n k·∫øt
        // N·∫øu t√™n ƒë·ªôi ƒë√£ c√≥ thay ƒë·ªïi, reset t·ªâ s·ªë
        if (state.semifinals[0].teamA !== teamA1 || state.semifinals[0].teamB !== teamB2) {
             state.semifinals[0] = { ...state.semifinals[0], teamA: teamA1, teamB: teamB2, scoreA: null, scoreB: null, winner: null, loser: null };
        }
        if (state.semifinals[1].teamA !== teamB1 || state.semifinals[1].teamB !== teamA2) {
             state.semifinals[1] = { ...state.semifinals[1], teamA: teamB1, teamB: teamA2, scoreA: null, scoreB: null, winner: null, loser: null };
        }
    }
    
    // Lu√¥n g·ªçi updateFinalMatch ƒë·ªÉ c·∫≠p nh·∫≠t ƒë·ªôi CK (n·∫øu B√°n k·∫øt ƒë√£ c√≥ k·∫øt qu·∫£)
    updateFinalMatch();
    
    // Lu√¥n render l·∫°i giao di·ªán V√≤ng Chung K·∫øt v√† K·∫øt Qu·∫£
    renderFinals();
    renderFinalResults();
}

/**
 * H√†m n√†y d√πng cho n√∫t b·∫•m th·ªß c√¥ng (t∆∞∆°ng ƒë∆∞∆°ng v·ªõi scheduleFinalsAuto nh∆∞ng kh√¥ng c·∫ßn b·∫•m)
 */
function scheduleFinalsManual() {
    scheduleFinalsAuto();
}


/**
 * C·∫≠p nh·∫≠t ng∆∞·ªùi th·∫Øng/thua c·ªßa m·ªôt tr·∫≠n ƒë·∫•u (B√°n k·∫øt/Chung k·∫øt).
 */
function updateMatchResult(match) {
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA > match.scoreB) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB > match.scoreA) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        } else {
            // Tr∆∞·ªùng h·ª£p h√≤a: kh√¥ng x√°c ƒë·ªãnh ng∆∞·ªùi th·∫Øng/thua
            match.winner = null; 
            match.loser = null;
        }
    } else {
        match.winner = null;
        match.loser = null;
    }
}

/**
 * C·∫≠p nh·∫≠t ƒë·ªôi v√†o tr·∫≠n Chung k·∫øt sau khi B√°n k·∫øt c√≥ k·∫øt qu·∫£.
 */
function updateFinalMatch() {
    const sf1Winner = state.semifinals[0].winner;
    const sf2Winner = state.semifinals[1].winner;
    
    let finalTeamA = 'Th·∫Øng SF1';
    let finalTeamB = 'Th·∫Øng SF2';
    
    // C·∫≠p nh·∫≠t ƒë·ªôi A
    if (sf1Winner && state.final.teamA !== sf1Winner) {
        finalTeamA = sf1Winner;
        state.final.scoreA = null; // Reset t·ªâ s·ªë n·∫øu ƒë·ªôi thay ƒë·ªïi
    } else if (sf1Winner) {
        finalTeamA = sf1Winner;
    }
    
    // C·∫≠p nh·∫≠t ƒë·ªôi B
    if (sf2Winner && state.final.teamB !== sf2Winner) {
        finalTeamB = sf2Winner;
        state.final.scoreB = null; // Reset t·ªâ s·ªë n·∫øu ƒë·ªôi thay ƒë·ªïi
    } else if (sf2Winner) {
        finalTeamB = sf2Winner;
    }

    // G√°n l·∫°i ƒë·ªôi v√† c·∫≠p nh·∫≠t k·∫øt qu·∫£ Chung k·∫øt
    state.final.teamA = finalTeamA;
    state.final.teamB = finalTeamB;
    updateMatchResult(state.final);
}

/**
 * Render giao di·ªán V√≤ng Chung K·∫øt (B√°n k·∫øt v√† Chung k·∫øt).
 */
function renderFinals(){
    // 1. Render B√°n k·∫øt
    let sfHtml = `<div class='table-responsive'><table class='table table-bordered table-sm'><thead><tr><th>Tr·∫≠n</th><th>ƒê·ªôi A</th><th>ƒê·ªôi B</th><th class='text-center'>T·ªâ s·ªë</th><th>K·∫øt qu·∫£</th></tr></thead><tbody>`;
    state.semifinals.forEach((m, i) => {
        const teamAClass = m.winner === m.teamA ? 'winner' : (m.loser === m.teamA ? 'loser' : '');
        const teamBClass = m.winner === m.teamB ? 'winner' : (m.loser === m.teamB ? 'loser' : '');
        
        // V√¥ hi·ªáu h√≥a input n·∫øu t√™n ƒë·ªôi l√† placeholder
        const disabled = m.teamA.startsWith('Nh·∫•t') || m.teamB.startsWith('Nh√¨') ? 'disabled' : '';

        sfHtml += `<tr>
            <td>${m.id} (${m.time}, ${m.court})</td>
            <td class="${teamAClass}">${m.teamA}</td>
            <td class="${teamBClass}">${m.teamB}</td>
            <td class='match-score-cell d-flex justify-content-center align-items-center gap-1'>
                <input type='number' min='0' value='${m.scoreA !== null ? m.scoreA : ''}' onchange='capNhatTiSo("semifinal", "${m.id}", ${i}, this.value, true)' class='form-control form-control-sm' ${disabled}> 
                - 
                <input type='number' min='0' value='${m.scoreB !== null ? m.scoreB : ''}' onchange='capNhatTiSo("semifinal", "${m.id}", ${i}, this.value, false)' class='form-control form-control-sm' ${disabled}>
            </td>
            <td>${m.winner ? m.winner + ' th·∫Øng' : 'ƒêang ƒë·∫•u'}</td>
        </tr>`;
    });
    sfHtml += `</tbody></table></div>`;
    document.getElementById('semifinalMatches').innerHTML = sfHtml;

    // 2. Render Chung k·∫øt
    const final = state.final;
    const teamAClassF = final.winner === final.teamA ? 'winner' : (final.loser === final.teamA ? 'loser' : '');
    const teamBClassF = final.winner === final.teamB ? 'winner' : (final.loser === final.teamB ? 'loser' : '');
    
    // V√¥ hi·ªáu h√≥a input n·∫øu t√™n ƒë·ªôi l√† placeholder
    const disabledF = final.teamA.startsWith('Th·∫Øng') || final.teamB.startsWith('Th·∫Øng') ? 'disabled' : '';

    let fHtml = `<div class='table-responsive'><table class='table table-bordered table-sm'><thead><tr><th>Tr·∫≠n</th><th>ƒê·ªôi A</th><th>ƒê·ªôi B</th><th class='text-center'>T·ªâ s·ªë</th><th>K·∫øt qu·∫£</th></tr></thead><tbody>`;
    fHtml += `<tr>
        <td>Chung k·∫øt (${final.time}, ${final.court})</td>
        <td class="${teamAClassF}">${final.teamA}</td>
        <td class="${teamBClassF}">${final.teamB}</td>
        <td class='match-score-cell d-flex justify-content-center align-items-center gap-1'>
            <input type='number' min='0' value='${final.scoreA !== null ? final.scoreA : ''}' onchange='capNhatTiSo("final", "${final.id}", 0, this.value, true)' class='form-control form-control-sm' ${disabledF}> 
            - 
            <input type='number' min='0' value='${final.scoreB !== null ? final.scoreB : ''}' onchange='capNhatTiSo("final", "${final.id}", 0, this.value, false)' class='form-control form-control-sm' ${disabledF}>
        </td>
        <td>${final.winner ? final.winner + ' V√¥ ƒë·ªãch' : 'ƒêang ƒë·∫•u'}</td>
    </tr>`;
    fHtml += `</tbody></table></div>`;
    document.getElementById('finalMatch').innerHTML = fHtml;
}

/**
 * Render k·∫øt qu·∫£ chung cu·ªôc (V√¥ ƒë·ªãch, √Å qu√¢n, H·∫°ng 3).
 */
function renderFinalResults() {
    const final = state.final;
    const sf1Loser = state.semifinals[0].loser;
    const sf2Loser = state.semifinals[1].loser;
    
    let thirdPlaceTeams = [];
    if (sf1Loser) thirdPlaceTeams.push(sf1Loser);
    if (sf2Loser) thirdPlaceTeams.push(sf2Loser);

    // C·∫≠p nh·∫≠t gi·∫£i V√¥ ƒë·ªãch
    document.getElementById('champion').innerHTML = final.winner 
        ? `<span class="badge bg-success">ü•á V√¥ ƒë·ªãch: ${final.winner}</span>` 
        : 'V√¥ ƒë·ªãch: ƒêang ch·ªù k·∫øt qu·∫£...';

    // C·∫≠p nh·∫≠t gi·∫£i √Å qu√¢n
    document.getElementById('runnerUp').innerHTML = final.loser 
        ? `<span class="badge bg-secondary">ü•à √Å qu√¢n: ${final.loser}</span>` 
        : '√Å qu√¢n: ƒêang ch·ªù k·∫øt qu·∫£...';
        
    // C·∫≠p nh·∫≠t gi·∫£i H·∫°ng Ba ƒê·ªìng H·∫°ng
    document.getElementById('thirdPlace').innerHTML = thirdPlaceTeams.length === 2
        ? `<span class="badge bg-info">ü•â H·∫°ng Ba ƒê·ªìng H·∫°ng: ${thirdPlaceTeams.join(' & ')}</span>`
        : 'H·∫°ng Ba ƒê·ªìng H·∫°ng: ƒêang ch·ªù k·∫øt qu·∫£ B√°n k·∫øt.';
}

// --- C·∫•u h√¨nh ---
function saveConfig(){
  const cfg = {
    owner: document.getElementById('cfgOwner').value,
    repo: document.getElementById('cfgRepo').value,
    folder: document.getElementById('cfgFolder').value,
    file: document.getElementById('cfgFile').value,
    token: document.getElementById('cfgToken').value
  };
  localStorage.setItem('pkb_config', JSON.stringify(cfg));
  document.getElementById('configStatus').innerHTML = '<div class="alert alert-success p-2 mt-2">ƒê√£ l∆∞u c·∫•u h√¨nh v√†o tr√¨nh duy·ªát.</div>';
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
