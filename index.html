<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TKD Championship 2025 ‚Äî Qu·∫£n l√Ω gi·∫£i Pickleball T·ª± ƒë·ªông C·∫≠p nh·∫≠t</title>
    <!-- T·∫£i Tailwind CSS v√† Bootstrap 5 (cho Tab v√† l∆∞·ªõi) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS t√πy ch·ªânh ƒë·ªÉ l√†m ƒë·∫πp v√† ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n */
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }

        body { 
            background: #f0f4f8; /* M√†u n·ªÅn nh·∫π nh√†ng */
            font-family: 'Inter', sans-serif; 
            color: #333; 
            padding: 20px; 
            min-height: 100vh;
        }
        .container-main { 
            max-width: 1300px; 
            margin: auto; 
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        
        /* Ti√™u ƒë·ªÅ ch√≠nh */
        .header-title {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 0;
            border-radius: 12px;
            margin-bottom: 25px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        /* Th·∫ª k·∫øt qu·∫£ chung cu·ªôc (Champion/Runner-up/Third) */
        .result-card {
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
            transition: all 0.3s ease-in-out;
            border: 2px solid transparent;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* ƒê·ªãnh d·∫°ng ri√™ng cho th·∫ª V√¥ ƒê·ªãch */
        #champion-card {
            background-color: #fff8e1; /* V√†ng nh·∫°t */
            border-color: var(--warning-color);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
            transform: scale(1.05); /* N·ªïi b·∫≠t h∆°n */
        }
        
        /* ƒê·ªãnh d·∫°ng ri√™ng cho th·∫ª √Å Qu√¢n */
        #runnerUp-card {
            background-color: #e9ecef; /* X√°m nh·∫°t */
            border-color: #6c757d;
        }
        
        /* ƒê·ªãnh d·∫°ng ri√™ng cho th·∫ª H·∫°ng Ba */
        #thirdPlace-card {
            background-color: #e0f7fa; /* Xanh ng·ªçc nh·∫°t */
            border-color: var(--info-color);
        }

        /* Tabs */
        .nav-tabs .nav-link {
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color) var(--primary-color) #fff;
            background-color: #fff;
        }
        
        /* B·∫£ng */
        .table-container {
            border: 1px solid #dee2e6;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        table th { 
            background: var(--primary-color); 
            color: #fff; 
            position: sticky; 
            top: 0; 
            z-index: 10;
            font-weight: 600;
        }
        table.table-striped > tbody > tr:nth-of-type(odd) > * { 
            background-color: #f8f9fa; 
        }

        /* Tr·∫°ng th√°i tr·∫≠n ƒë·∫•u */
        .match-score-cell { font-weight: bold; text-align: center; }
        .winner-team { color: var(--success-color); font-weight: 700; text-shadow: 0 0 1px rgba(25, 135, 84, 0.5); }
        .loser-team { color: #dc3545; font-weight: 500; opacity: 0.7; }
        .match-row-completed td { background-color: #e6f7ff !important; } /* Light blue for completed matches */
        
        /* B·∫£ng x·∫øp h·∫°ng */
        .ranking-table tr.top-2 { 
            background-color: #d1e7dd !important; 
            font-weight: bold; 
            border-left: 5px solid var(--success-color);
        }
        .badge-position-1 { background-color: var(--warning-color); color: #333; font-size: 1.1em; }
        .badge-position-2 { background-color: #adb5bd; font-size: 1.05em; }
        
        /* N√∫t l√†m m·ªõi */
        .btn-refresh { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            z-index: 1000; 
            border-radius: 50%; 
            width: 60px; 
            height: 60px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); 
            transition: all 0.3s; 
            background: var(--primary-color);
            border: none;
        }
        .btn-refresh:hover { 
            transform: scale(1.1); 
            background: #0b5ed7;
        }

        /* Skeleton Loader Effect - Khung ch·ªù */
        .skeleton-loader {
            animation: pulse 1.5s infinite ease-in-out;
            background-color: #e2e8f0; /* M√†u n·ªÅn ch·ªù (gray-200) */
            border-radius: 6px;
            color: transparent; /* ·∫®n ch·ªØ */
            display: inline-block;
            min-height: 1.5rem; /* ƒê·∫£m b·∫£o chi·ªÅu cao t·ªëi thi·ªÉu */
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container-main { padding: 20px; }
            .header-title { font-size: 1.5rem; }
            .btn-refresh { width: 50px; height: 50px; bottom: 15px; right: 15px; }
            h4.mt-3 { font-size: 1.25rem; }
        }
    </style>
</head>
<body>

    <div class="container-main">
        <div class="header-title text-center shadow-lg">
            <h1 class="mb-0 text-3xl font-bold">TKD Championship 2025 Pickleball üéæ</h1>
            <p class="text-sm font-light mt-1 opacity-80">H·ªá th·ªëng c·∫≠p nh·∫≠t k·∫øt qu·∫£ t·ª± ƒë·ªông t·ª´ d·ªØ li·ªáu GitHub</p>
        </div>

        <!-- K·∫øt qu·∫£ chung cu·ªôc n·ªïi b·∫≠t -->
        <div class="row mb-5 text-gray-700">
            <div class="col-lg-4 col-md-6 mb-3">
                <div id="champion-card" class="result-card shadow-lg">
                    <div class="text-xl font-semibold mb-1">ü•á V√¥ ƒë·ªãch:</div>
                    <!-- Khung ch·ªù ban ƒë·∫ßu -->
                    <div id="champion" class="text-2xl font-extrabold text-success">
                        <span class="skeleton-loader w-3/4 h-8 block mx-auto"></span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
                <div id="runnerUp-card" class="result-card shadow-md">
                    <div class="text-xl font-semibold mb-1">ü•à √Å qu√¢n:</div>
                    <!-- Khung ch·ªù ban ƒë·∫ßu -->
                    <div id="runnerUp" class="text-2xl font-extrabold text-gray-600">
                        <span class="skeleton-loader w-3/4 h-8 block mx-auto"></span>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3">
                <div id="thirdPlace-card" class="result-card shadow-md">
                    <div class="text-xl font-semibold mb-1">ü•â H·∫°ng ba:</div>
                    <!-- Khung ch·ªù ban ƒë·∫ßu -->
                    <div id="thirdPlace" class="text-2xl font-extrabold text-info-700">
                        <span class="skeleton-loader w-3/4 h-8 block mx-auto"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs border-b-2 border-gray-200" id="myTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="group-tab" data-bs-toggle="tab" data-bs-target="#group-tab-pane" type="button" role="tab">V√≤ng B·∫£ng</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="knockout-tab" data-bs-toggle="tab" data-bs-target="#knockout-tab-pane" type="button" role="tab">B√°n K·∫øt & Chung K·∫øt</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="standings-tab" data-bs-toggle="tab" data-bs-target="#standings-tab-pane" type="button" role="tab">B·∫£ng X·∫øp H·∫°ng</button></li>
        </ul>

        <div class="tab-content" id="myTabContent">
            
            <!-- V√≤ng B·∫£ng Tab -->
            <div class="tab-pane fade show active" id="group-tab-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <h4 class="mt-3 text-primary font-bold border-b pb-1">B·∫£ng A (Mixed)</h4>
                        <div id="groupMatchesA" class="table-container table-responsive">
                            <p class="text-center text-gray-500 p-5">ƒêang t·∫£i l·ªãch ƒë·∫•u B·∫£ng A...</p>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h4 class="mt-3 text-primary font-bold border-b pb-1">B·∫£ng B (Male)</h4>
                        <div id="groupMatchesB" class="table-container table-responsive">
                            <p class="text-center text-gray-500 p-5">ƒêang t·∫£i l·ªãch ƒë·∫•u B·∫£ng B...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- B√°n K·∫øt & Chung K·∫øt Tab -->
            <div class="tab-pane fade" id="knockout-tab-pane" role="tabpanel">
                <h4 class="mt-3 text-primary font-bold border-b pb-1">V√≤ng B√°n K·∫øt</h4>
                <div id="semifinalMatches" class="table-container table-responsive">
                     <p class="text-center text-gray-500 p-5">ƒêang t·∫£i l·ªãch ƒë·∫•u B√°n k·∫øt...</p>
                </div>
                
                <h4 class="mt-4 text-primary font-bold border-b pb-1">Tr·∫≠n Chung K·∫øt</h4>
                <div id="finalMatch" class="table-container table-responsive">
                     <p class="text-center text-gray-500 p-5">ƒêang t·∫£i l·ªãch ƒë·∫•u Chung k·∫øt...</p>
                </div>
            </div>

            <!-- B·∫£ng X·∫øp H·∫°ng Tab -->
            <div class="tab-pane fade" id="standings-tab-pane" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <h4 class="mt-3 text-primary font-bold border-b pb-1">B·∫£ng A (Mixed)</h4>
                        <div id="standingsA" class="table-container table-responsive">
                            <p class="text-center text-gray-500 p-5">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng B·∫£ng A...</p>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <h4 class="mt-3 text-primary font-bold border-b pb-1">B·∫£ng B (Male)</h4>
                        <div id="standingsB" class="table-container table-responsive">
                            <p class="text-center text-gray-500 p-5">ƒêang t·∫£i b·∫£ng x·∫øp h·∫°ng B·∫£ng B...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- N√∫t Refresh -->
        <button class="btn btn-primary btn-refresh" onclick="capNhatToanBoDuLieuTuXa()" title="C·∫≠p nh·∫≠t k·∫øt qu·∫£ t·ª´ GitHub">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.54a.5.5 0 0 1 .83-.375l2.67 2.479a.5.5 0 0 1 0 .752l-2.67 2.479a.5.5 0 0 1-.83-.375z"/>
            </svg>
        </button>
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center hidden transition-opacity duration-300" style="display: none;">
            <div class="bg-white p-6 rounded-xl shadow-2xl flex items-center transform scale-105">
                <svg class="animate-spin -ml-1 mr-3 h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-800 text-lg font-semibold">ƒêang c·∫≠p nh·∫≠t k·∫øt qu·∫£...</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // D·ªØ li·ªáu ban ƒë·∫ßu (ch·ªâ c√≤n c·∫•u tr√∫c khung, kh√¥ng c√≤n l·ªãch ƒë·∫•u c·ª• th·ªÉ)
        const LOCAL_STATE_JSON = JSON.parse(`{
            "mixedTeams": [],
            "maleTeams": [],
            "matchesA": [],
            "matchesB": [],
            "standings": [],
            "semifinals": [
                { "id": "SF1", "teamA": "Ch∆∞a x√°c ƒë·ªãnh", "teamB": "Ch∆∞a x√°c ƒë·ªãnh", "scoreA": null, "scoreB": null, "time": "16:30", "court": "S√¢n 1", "winner": null, "loser": null },
                { "id": "SF2", "teamA": "Ch∆∞a x√°c ƒë·ªãnh", "teamB": "Ch∆∞a x√°c ƒë·ªãnh", "scoreA": null, "scoreB": null, "time": "16:30", "court": "S√¢n 2", "winner": null, "loser": null }
            ],
            "final": {
                "id": "FIN", "teamA": "Th·∫Øng SF1", "teamB": "Th·∫Øng SF2", "scoreA": null, "scoreB": null, "time": "17:00", "court": "S√¢n 1", "winner": null, "loser": null
            }
        }`);
        
        // URL t·∫£i l·ªãch ƒë·∫•u v√† t·ªâ s·ªë (D·ªØ li·ªáu ch√≠nh)
        const REMOTE_STATE_URL = 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
        
        // URL t·∫£i danh s√°ch ƒë·ªôi ban ƒë·∫ßu (D·ªØ li·ªáu ph·ª•)
        const PLAYER_DATA_URL = 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/players.json';

        const MAX_RETRIES = 5;
        const BASE_DELAY = 1000; // 1 second

        let state = {};

        // --- Utility Functions ---

        // H√†m hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
        function toggleLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            indicator.style.display = show ? 'flex' : 'none';
        }

        // T·∫°o ID duy nh·∫•t cho tr·∫≠n ƒë·∫•u v√≤ng b·∫£ng ƒë·ªÉ h·ª£p nh·∫•t d·ªØ li·ªáu (kh√¥ng d√πng trong phi√™n b·∫£n n√†y nh∆∞ng gi·ªØ l·∫°i)
        function generateMatchId(match) {
            const teams = [match.teamA, match.teamB].sort();
            return `${match.bang}-${teams[0]}-${teams[1]}`;
        }
        
        // C·∫≠p nh·∫≠t k·∫øt qu·∫£ th·∫Øng/thua cho tr·∫≠n ƒë·∫•u v√≤ng lo·∫°i (SF, FIN)
        function kiemTraKetQuaKnockout(match) {
            if (match.scoreA !== null && match.scoreB !== null) {
                const scoreA = parseInt(match.scoreA);
                const scoreB = parseInt(match.scoreB);
                
                if (scoreA > scoreB) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else if (scoreB > scoreA) {
                    match.winner = match.teamB;
                    match.loser = match.teamA;
                } else {
                    match.winner = null;
                    match.loser = null;
                }
            } else {
                match.winner = null;
                match.loser = null;
            }
        }

        // T√≠nh to√°n l·∫°i B·∫£ng x·∫øp h·∫°ng
        function tinhBangXepHang() {
            const newStandings = {};
            
            // Kh·ªüi t·∫°o b·∫£ng x·∫øp h·∫°ng m·ªõi t·ª´ danh s√°ch ƒë·ªôi ƒë√£ t·∫£i
            state.standings.forEach(s => {
                newStandings[s.team] = { ...s, wins: 0, losses: 0, pointsW: 0, pointsL: 0, diff: 0, points: 0 };
            });

            const allGroupMatches = [...state.matchesA, ...state.matchesB];

            allGroupMatches.forEach(match => {
                const { teamA, teamB, scoreA, scoreB } = match;

                if (scoreA !== null && scoreB !== null) {
                    const sA = parseInt(scoreA);
                    const sB = parseInt(scoreB);
                    
                    // Ch·ªâ x·ª≠ l√Ω n·∫øu c·∫£ hai ƒë·ªôi t·ªìn t·∫°i trong b·∫£ng x·∫øp h·∫°ng (ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o t·ª´ players.json)
                    if (newStandings[teamA] && newStandings[teamB]) {
                        if (sA > sB) {
                            newStandings[teamA].wins++;
                            newStandings[teamB].losses++;
                            match.winner = teamA;
                            match.loser = teamB;
                        } else if (sB > sA) {
                            newStandings[teamB].wins++;
                            newStandings[teamA].losses++;
                            match.winner = teamB;
                            match.loser = teamA;
                        } else {
                            // H√≤a (gi·∫£ ƒë·ªãnh 1 ƒëi·ªÉm cho m·ªói ƒë·ªôi n·∫øu lu·∫≠t cho ph√©p)
                            newStandings[teamA].points += 1;
                            newStandings[teamB].points += 1;
                            match.winner = null;
                            match.loser = null;
                        }
                        
                        if (sA !== sB) {
                            // 3 ƒëi·ªÉm cho th·∫Øng, 0 ƒëi·ªÉm cho thua
                            if (sA > sB) newStandings[teamA].points += 3;
                            if (sB > sA) newStandings[teamB].points += 3;
                        }

                        newStandings[teamA].pointsW += sA;
                        newStandings[teamA].pointsL += sB;
                        newStandings[teamB].pointsW += sB;
                        newStandings[teamB].pointsL += sA;
                    }
                } else {
                    match.winner = null;
                    match.loser = null;
                }
            });

            // C·∫≠p nh·∫≠t l·∫°i state.standings v√† t√≠nh Diff
            state.standings = Object.values(newStandings).map(s => {
                s.diff = s.pointsW - s.pointsL;
                return s;
            });
            
            // S·∫Øp x·∫øp
            state.standings.sort((a, b) => {
                if (b.bang === a.bang) {
                    if (b.points !== a.points) return b.points - a.points; // ƒêi·ªÉm
                    if (b.diff !== a.diff) return b.diff - a.diff;         // Hi·ªáu s·ªë
                    return b.pointsW - a.pointsW;                         // ƒêi·ªÉm th·∫Øng
                }
                return 0; // Gi·ªØ nguy√™n th·ª© t·ª± n·∫øu kh√°c b·∫£ng
            });
        }
        
        // C·∫≠p nh·∫≠t c√°c tr·∫≠n ƒë·∫•u B√°n k·∫øt v√† Chung k·∫øt d·ª±a tr√™n B·∫£ng x·∫øp h·∫°ng
        function capNhatTranhChungKet() {
            // L·∫•y 2 ƒë·ªôi d·∫´n ƒë·∫ßu m·ªói b·∫£ng (gi·∫£ s·ª≠ b·∫£ng x·∫øp h·∫°ng ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp)
            const topA = state.standings.filter(s => s.bang === 'A').slice(0, 2).map(s => s.team);
            const topB = state.standings.filter(s => s.bang === 'B').slice(0, 2).map(s => s.team);
            
            // L·∫•y c√°c tr·∫≠n b√°n k·∫øt hi·ªán t·∫°i (s·∫Ω b·ªã ghi ƒë√® n·∫øu state.json cung c·∫•p ƒë·∫ßy ƒë·ªß)
            const sf1 = state.semifinals[0];
            const sf2 = state.semifinals[1];

            // C·∫≠p nh·∫≠t c√°c tr·∫≠n b√°n k·∫øt (gi·∫£ ƒë·ªãnh th·ªÉ th·ª©c 1A vs 2B, 1B vs 2A)
            if (topA.length >= 2 && topB.length >= 2) {
                // SF1: 1A vs 2B
                sf1.teamA = topA[0] || 'Ch∆∞a x√°c ƒë·ªãnh A1';
                sf1.teamB = topB[1] || 'Ch∆∞a x√°c ƒë·ªãnh B2';
                
                // SF2: 1B vs 2A
                sf2.teamA = topB[0] || 'Ch∆∞a x√°c ƒë·ªãnh B1';
                sf2.teamB = topA[1] || 'Ch∆∞a x√°c ƒë·ªãnh A2';
            }

            // C·∫≠p nh·∫≠t tr·∫≠n chung k·∫øt
            const sf1Winner = sf1.winner;
            const sf2Winner = sf2.winner;
            
            state.final.teamA = sf1Winner || 'Th·∫Øng SF1';
            state.final.teamB = sf2Winner || 'Th·∫Øng SF2';

            // Ki·ªÉm tra k·∫øt qu·∫£ v√≤ng lo·∫°i (ch·ªâ c·∫≠p nh·∫≠t t√™n ƒë·ªôi n·∫øu ƒë√£ c√≥ k·∫øt qu·∫£)
            state.semifinals.forEach(kiemTraKetQuaKnockout);
            kiemTraKetQuaKnockout(state.final);
        }

        // T·∫£i danh s√°ch ƒë·ªôi t·ª´ players.json v√† kh·ªüi t·∫°o state
        async function initializeStateFromPlayers() {
            console.log("ƒêang t·∫£i danh s√°ch ƒë·ªôi t·ª´ players.json...");
            toggleLoading(true);
            try {
                const response = await fetch(PLAYER_DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const playerData = await response.json();
                
                // C·∫≠p nh·∫≠t ƒë·ªôi v√†o state
                state.mixedTeams = playerData.mixedTeams || [];
                state.maleTeams = playerData.maleTeams || [];
                
                // Kh·ªüi t·∫°o Standings r·ªóng
                const newStandings = [];
                state.mixedTeams.forEach(team => {
                    newStandings.push({ team, wins: 0, losses: 0, pointsW: 0, pointsL: 0, bang: "A", diff: 0, points: 0 });
                });
                state.maleTeams.forEach(team => {
                    newStandings.push({ team, wins: 0, losses: 0, pointsW: 0, pointsL: 0, bang: "B", diff: 0, points: 0 });
                });
                state.standings = newStandings;
                
                console.log("Kh·ªüi t·∫°o danh s√°ch ƒë·ªôi v√† b·∫£ng x·∫øp h·∫°ng th√†nh c√¥ng.");
                toggleLoading(false);
            } catch (error) {
                console.error("L·ªói khi t·∫£i ho·∫∑c x·ª≠ l√Ω players.json:", error.message);
                toggleLoading(false);
                // Hi·ªÉn th·ªã th√¥ng b√°o trong giao di·ªán n·∫øu c√≥ l·ªói nghi√™m tr·ªçng
                const defaultContent = `<p class="text-center text-red-500 p-5 font-bold">L·ªñI T·∫¢I D·ªÆ LI·ªÜU ƒê·ªòI: Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë·ªôi. ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫∑c ƒë·ªãnh.</p>`;
                document.getElementById('groupMatchesA').innerHTML = defaultContent;
                document.getElementById('groupMatchesB').innerHTML = defaultContent;
            }
        }


        // --- Rendering Functions ---

        // Render B·∫£ng x·∫øp h·∫°ng
        function renderStandings() {
            const renderTable = (standings, elementId) => {
                const bang = elementId.slice(-1);
                // L·∫•y c√°c ƒë·ªôi thu·ªôc b·∫£ng t∆∞∆°ng ·ª©ng
                const filteredStandings = standings.filter(s => s.bang === bang);
                
                if (filteredStandings.length === 0) {
                    document.getElementById(elementId).innerHTML = `<p class="text-center text-gray-500 p-5">Ch∆∞a c√≥ d·ªØ li·ªáu b·∫£ng x·∫øp h·∫°ng.</p>`;
                    return;
                }
                
                let html = `
                <table class="table table-bordered table-striped table-hover mt-3 ranking-table">
                    <thead>
                        <tr>
                            <th class="text-center" style="width: 5%;">#</th>
                            <th>ƒê·ªôi</th>
                            <th class="text-center" style="width: 10%;">Th·∫Øng</th>
                            <th class="text-center" style="width: 10%;">Thua</th>
                            <th class="text-center" style="width: 10%;">ƒêi·ªÉm TB</th>
                            <th class="text-center" style="width: 10%;">Hi·ªáu s·ªë</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                filteredStandings.forEach((s, index) => {
                    const rank = index + 1;
                    const rowClass = rank <= 2 ? 'top-2' : ''; // ƒê·ªôi v√†o v√≤ng trong
                    const badgeClass = rank === 1 ? 'badge-position-1' : (rank === 2 ? 'badge-position-2' : 'bg-secondary');

                    html += `
                        <tr class="${rowClass}">
                            <td class="text-center"><span class="badge ${badgeClass} rounded-full">${rank}</span></td>
                            <td>${s.team}</td>
                            <td class="text-center">${s.wins}</td>
                            <td class="text-center">${s.losses}</td>
                            <td class="text-center">${s.points}</td>
                            <td class="text-center">${s.diff > 0 ? '+' : ''}${s.diff}</td>
                        </tr>`;
                });

                html += `</tbody></table>`;
                document.getElementById(elementId).innerHTML = html;
            };

            renderTable(state.standings, 'standingsA');
            renderTable(state.standings, 'standingsB');
        }

        // Render Tr·∫≠n ƒë·∫•u V√≤ng B·∫£ng
        function renderGroupMatches() {
            const renderTable = (matches, elementId) => {
                if (matches.length === 0) {
                    document.getElementById(elementId).innerHTML = `<p class="text-center text-gray-500 p-5">Ch∆∞a c√≥ l·ªãch ƒë·∫•u v√≤ng b·∫£ng ƒë∆∞·ª£c c√¥ng b·ªë.</p>`;
                    return;
                }
                
                let html = `
                <table class="table table-bordered table-striped table-hover mt-3">
                    <thead>
                        <tr>
                            <th style="width: 10%;">Gi·ªù</th>
                            <th style="width: 10%;">S√¢n</th>
                            <th style="width: 35%;">ƒê·ªôi A</th>
                            <th class="text-center" style="width: 15%;">T·ªâ s·ªë</th>
                            <th style="width: 30%;">ƒê·ªôi B</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                matches.forEach(match => {
                    const isCompleted = match.scoreA !== null && match.scoreB !== null;
                    const rowClass = isCompleted ? 'match-row-completed' : '';
                    
                    let teamA_class = '';
                    let teamB_class = '';
                    if (isCompleted) {
                        if (match.winner === match.teamA) {
                            teamA_class = 'winner-team';
                            teamB_class = 'loser-team';
                        } else if (match.winner === match.teamB) {
                            teamA_class = 'loser-team';
                            teamB_class = 'winner-team';
                        }
                    }

                    html += `
                        <tr class="${rowClass}">
                            <td class="text-gray-500">${match.time || 'N/A'}</td>
                            <td class="font-semibold text-sm text-info-700">${match.court || 'N/A'}</td>
                            <td class="${teamA_class}">${match.teamA || 'ƒêang ch·ªù...'}</td>
                            <td class="match-score-cell">${match.scoreA !== null ? match.scoreA : '-'} - ${match.scoreB !== null ? match.scoreB : '-'}</td>
                            <td class="${teamB_class}">${match.teamB || 'ƒêang ch·ªù...'}</td>
                        </tr>`;
                });

                html += `</tbody></table>`;
                document.getElementById(elementId).innerHTML = html;
            };

            renderTable(state.matchesA, 'groupMatchesA');
            renderTable(state.matchesB, 'groupMatchesB');
        }

        // Render Tr·∫≠n ƒë·∫•u B√°n k·∫øt
        function renderSemifinals() {
            if (state.semifinals.length === 0) {
                document.getElementById('semifinalMatches').innerHTML = `<p class="text-center text-gray-500 p-5">Ch∆∞a c√≥ l·ªãch ƒë·∫•u B√°n k·∫øt.</p>`;
                return;
            }
            
            let sfHtml = `
            <table class="table table-bordered table-striped table-hover mt-3">
                <thead>
                    <tr>
                        <th style="width: 8%;">Tr·∫≠n</th>
                        <th style="width: 10%;">Gi·ªù</th>
                        <th style="width: 10%;">S√¢n</th>
                        <th style="width: 27%;">ƒê·ªôi A</th>
                        <th class="text-center" style="width: 15%;">T·ªâ s·ªë</th>
                        <th style="width: 25%;">ƒê·ªôi B</th>
                        <th style="width: 20%;">K·∫øt qu·∫£</th>
                    </tr>
                </thead>
                <tbody>`;
            
            state.semifinals.forEach(sf => {
                kiemTraKetQuaKnockout(sf); // ƒê·∫£m b·∫£o winner/loser ƒë∆∞·ª£c t√≠nh l·∫°i
                const isCompleted = sf.scoreA !== null && sf.scoreB !== null;
                const rowClass = isCompleted ? 'match-row-completed' : '';
                
                let teamA_class = '';
                let teamB_class = '';
                if (isCompleted) {
                    if (sf.winner === sf.teamA) {
                        teamA_class = 'winner-team';
                        teamB_class = 'loser-team';
                    } else if (sf.winner === sf.teamB) {
                        teamA_class = 'loser-team';
                        teamB_class = 'winner-team';
                    }
                }
                
                sfHtml += `
                    <tr class="${rowClass}">
                        <td class="font-bold">${sf.id}</td>
                        <td class="text-gray-500">${sf.time || 'N/A'}</td>
                        <td class="font-semibold text-sm text-info-700">${sf.court || 'N/A'}</td>
                        <td class="${teamA_class}">${sf.teamA || 'ƒêang ch·ªù...'}</td>
                        <td class="match-score-cell">${sf.scoreA !== null ? sf.scoreA : '-'} - ${sf.scoreB !== null ? sf.scoreB : '-'}</td>
                        <td class="${teamB_class}">${sf.teamB || 'ƒêang ch·ªù...'}</td>
                        <td>${sf.winner ? `<span class="badge bg-success p-2 shadow-sm">Th·∫Øng: ${sf.winner}</span>` : '<span class="badge bg-warning p-2">ƒêang ch·ªù</span>'}</td>
                    </tr>`;
            });
            
            sfHtml += `</tbody></table>`;
            document.getElementById('semifinalMatches').innerHTML = sfHtml;
        }

        // Render Tr·∫≠n ƒë·∫•u Chung k·∫øt
        function renderFinalMatch() {
            const final = state.final;
            
            if (!final || !final.id) {
                 document.getElementById('finalMatch').innerHTML = `<p class="text-center text-gray-500 p-5">Ch∆∞a c√≥ l·ªãch ƒë·∫•u Chung k·∫øt.</p>`;
                return;
            }
            
            kiemTraKetQuaKnockout(final); // ƒê·∫£m b·∫£o winner/loser ƒë∆∞·ª£c t√≠nh l·∫°i

            const isCompleted = final.scoreA !== null && final.scoreB !== null;
            const rowClass = isCompleted ? 'match-row-completed' : '';

            let teamA_class = '';
            let teamB_class = '';
            if (isCompleted) {
                if (final.winner === final.teamA) {
                    teamA_class = 'winner-team';
                    teamB_class = 'loser-team';
                } else if (final.winner === final.teamB) {
                    teamA_class = 'loser-team';
                    teamB_class = 'winner-team';
                }
            }

            let fHtml = `
            <table class="table table-bordered table-striped table-hover mt-3">
                <thead>
                    <tr>
                        <th style="width: 8%;">Tr·∫≠n</th>
                        <th style="width: 10%;">Gi·ªù</th>
                        <th style="width: 10%;">S√¢n</th>
                        <th style="width: 27%;">ƒê·ªôi A</th>
                        <th class="text-center" style="width: 15%;">T·ªâ s·ªë</th>
                        <th style="width: 25%;">ƒê·ªôi B</th>
                        <th style="width: 20%;">K·∫øt qu·∫£</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="${rowClass}">
                        <td class="font-bold">${final.id}</td>
                        <td class="text-gray-500">${final.time || 'N/A'}</td>
                        <td class="font-semibold text-sm text-info-700">${final.court || 'N/A'}</td>
                        <td class="${teamA_class}">${final.teamA || 'ƒêang ch·ªù...'}</td>
                        <td class="match-score-cell">${final.scoreA !== null ? final.scoreA : '-'} - ${final.scoreB !== null ? final.scoreB : '-'}</td>
                        <td class="${teamB_class}">${final.teamB || 'ƒêang ch·ªù...'}</td>
                        <td>${final.winner ? `<span class="badge bg-warning text-dark p-2 shadow-sm">üèÜ ${final.winner}</span>` : '<span class="badge bg-warning p-2">ƒêang ch·ªù</span>'}</td>
                    </tr>
                </tbody>
            </table>`;
            document.getElementById('finalMatch').innerHTML = fHtml;
        }
        
        // Render K·∫øt qu·∫£ chung cu·ªôc
        function renderFinalResults() {
            const final = state.final;
            
            // ƒê·∫£m b·∫£o winner/loser ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n l·∫°i
            kiemTraKetQuaKnockout(final); 

            // L·∫•y ƒë·ªôi thua B√°n k·∫øt (ƒê·ªìng h·∫°ng 3)
            const sf1Loser = state.semifinals[0]?.loser;
            const sf2Loser = state.semifinals[1]?.loser;
            
            let thirdPlaceTeams = [];
            if (sf1Loser) thirdPlaceTeams.push(sf1Loser);
            if (sf2Loser) thirdPlaceTeams.push(sf2Loser);

            // Khung ch·ªù (Skeleton Loader HTML)
            const loadingHtml = `<span class="skeleton-loader w-3/4 h-8 block mx-auto"></span>`;

            // V√¥ ƒë·ªãch
            document.getElementById('champion').innerHTML = final.winner 
                ? `<span class="text-warning-800">${final.winner}</span>` 
                : loadingHtml;

            // √Å qu√¢n
            document.getElementById('runnerUp').innerHTML = final.loser 
                ? `<span class="text-gray-700">${final.loser}</span>` 
                : loadingHtml;
                
            // H·∫°ng ba (ƒê·ªìng h·∫°ng 3)
            document.getElementById('thirdPlace').innerHTML = thirdPlaceTeams.length === 2
                ? `<span class="text-info-700">${thirdPlaceTeams.join(' & ')}</span>`
                : loadingHtml;
        }

        // --- Core Logic Functions ---

        // H√†m h·ª£p nh·∫•t d·ªØ li·ªáu t·ª´ remote v√†o state hi·ªán t·∫°i
        function mergeRemoteState(remoteState) {
            console.log("B·∫Øt ƒë·∫ßu h·ª£p nh·∫•t d·ªØ li·ªáu t·ª´ xa (matches, scores, knockout)...");

            // Thay th·∫ø to√†n b·ªô l·ªãch ƒë·∫•u v√† knockout b·∫±ng d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ remote
            state.matchesA = remoteState.matchesA || [];
            state.matchesB = remoteState.matchesB || [];
            
            // N·∫øu remoteState.semifinals t·ªìn t·∫°i, s·ª≠ d·ª•ng n√≥. N·∫øu kh√¥ng, gi·ªØ nguy√™n m·∫∑c ƒë·ªãnh.
            if (remoteState.semifinals && remoteState.semifinals.length > 0) {
                 state.semifinals = remoteState.semifinals;
            }
            
            // N·∫øu remoteState.final t·ªìn t·∫°i, s·ª≠ d·ª•ng n√≥. N·∫øu kh√¥ng, gi·ªØ nguy√™n m·∫∑c ƒë·ªãnh.
            if (remoteState.final && remoteState.final.id) {
                state.final = remoteState.final;
            }

            // B·∫Øt bu·ªôc ch·∫°y l·∫°i c√°c h√†m t√≠nh to√°n:
            tinhBangXepHang();
            capNhatTranhChungKet(); // C·∫≠p nh·∫≠t t√™n ƒë·ªôi v√†o SF/FIN v√† t√≠nh k·∫øt qu·∫£
            console.log("H·ª£p nh·∫•t v√† t√≠nh to√°n l·∫°i ho√†n t·∫•t.");
        }

        // T·∫£i v√† c·∫≠p nh·∫≠t to√†n b·ªô d·ªØ li·ªáu t·ª´ xa
        async function capNhatToanBoDuLieuTuXa() {
            toggleLoading(true);
            try {
                let data = null;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        const response = await fetch(REMOTE_STATE_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        data = await response.json();
                        break; // Success, exit loop
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed for ${REMOTE_STATE_URL}:`, error);
                        if (i < MAX_RETRIES - 1) {
                            const delay = BASE_DELAY * Math.pow(2, i);
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error("T·∫£i d·ªØ li·ªáu l·ªãch ƒë·∫•u v√† k·∫øt qu·∫£ th·∫•t b·∫°i sau nhi·ªÅu l·∫ßn th·ª≠.");
                        }
                    }
                }

                if (data) {
                    mergeRemoteState(data);
                    renderAll();
                    console.log("C·∫≠p nh·∫≠t giao di·ªán th√†nh c√¥ng.");
                } else {
                     throw new Error("Kh√¥ng th·ªÉ t·∫£i v√† x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ xa (state.json).");
                }
            } catch (error) {
                console.error("L·ªói c·∫≠p nh·∫≠t d·ªØ li·ªáu:", error.message);
                // Hi·ªÉn th·ªã l·ªói tr√™n console (thay v√¨ alert)
                console.error(`L·ªñI: ${error.message}`);
            } finally {
                toggleLoading(false);
            }
        }

        // H√†m g·ªçi t·∫•t c·∫£ c√°c h√†m render
        function renderAll() {
            renderStandings();
            renderGroupMatches();
            renderSemifinals();
            renderFinalMatch();
            renderFinalResults();
        }

        // H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng
        window.onload = async function() {
            console.log("Kh·ªüi t·∫°o ·ª©ng d·ª•ng...");
            state = JSON.parse(JSON.stringify(LOCAL_STATE_JSON)); // Sao ch√©p s√¢u c·∫•u tr√∫c c∆° b·∫£n

            // 1. T·∫£i danh s√°ch ƒë·ªôi v√† kh·ªüi t·∫°o b·∫£ng x·∫øp h·∫°ng (t·ª´ players.json)
            await initializeStateFromPlayers();

            // 2. T·∫£i l·ªãch ƒë·∫•u v√† k·∫øt qu·∫£ (t·ª´ state.json) v√† render
            capNhatToanBoDuLieuTuXa();
        };

    </script>
</body>
</html>
