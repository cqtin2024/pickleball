<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD PICKLEBALL CHAMPIONSHIP 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Layout */
    body { background:#f0f4f8; margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial; overflow-x:hidden; }
    header { position:fixed; top:0; left:0; right:0; z-index:40; background:#fff; box-shadow:0 6px 18px rgba(2,6,23,0.06); padding:10px 12px; }
    #content-carousel{display:flex; width:400vw; will-change:transform; transition:transform .36s cubic-bezier(.25,1,.5,1);}
    .swipe-section{width:100vw; flex-shrink:0; padding:12px; min-height:calc(100vh - 120px); overflow-y:auto;}
    /* Header compact */
    .hdr-row { display:flex; align-items:center; justify-content:center; gap:10px; position:relative; }
    .hdr-row img { height:44px; width:auto; display:block; }
    .hdr-title { text-align:center; }
    .hdr-title h1{ margin:0; font-size:16px; font-weight:800; color:#0b63a3; line-height:1; }
    .hdr-title p{ margin:0; font-size:11px; color:#6b7280; margin-top:2px; }

    /* Status top-right */
    #statusMessage{ position:absolute; top:8px; right:12px; font-size:11px; color:#6b7280; }

    /* Tabs */
    #tab-controls{ display:flex; gap:8px; justify-content:space-between; max-width:820px; margin:8px auto 0; padding:4px 6px; }
    .tab-btn{ padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; font-size:13px; border:none; }
    .tab-btn.bg-blue{ background:#0ea5e9; color:white; }
    .tab-btn.active-knockout{ background:linear-gradient(90deg,#22c55e,#16a34a); color:#fff; box-shadow:0 6px 16px rgba(34,197,94,0.18); }
    .tab-btn.active-pick{ background:linear-gradient(90deg,#f59e0b,#d97706); color:#fff; box-shadow:0 6px 16px rgba(245,158,11,0.15); }

    /* Refresh button */
    #refresh-btn{ position:fixed; right:16px; bottom:18px; z-index:50; background:#0284c7; color:white; border-radius:999px; width:48px; height:48px; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow:0 8px 20px rgba(2,132,199,0.18); border:none; }

    /* Tables compact for mobile */
    table.compact{ width:100%; border-collapse:collapse; font-size:12px; }
    table.compact thead th{ padding:6px 6px; text-align:center; font-weight:700; background:#0369a1; color:#fff; font-size:12px; }
    table.compact tbody td{ padding:6px 6px; border-bottom:1px solid #eef2f7; vertical-align:middle; }
    /* Column sizing: first col wider, rest small and centered */
    table.compact th:nth-child(1), table.compact td:nth-child(1){ width:45%; text-align:left; padding-left:8px; }
    table.compact th:nth-child(n+2), table.compact td:nth-child(n+2){ width:11%; text-align:center; }

    /* Highlight top1/top2 */
    .top1{ background:#d1fae5; font-weight:800; }
    .top2{ background:#e0f2fe; font-weight:700; }

    /* Knockout highlight */
    .champion-box{ background: linear-gradient(135deg,#fef3c7,#fde68a); border-left:4px solid #f59e0b; padding:14px; border-radius:12px; box-shadow:0 8px 30px rgba(249,168,38,0.12); }
    .runnerup-box{ background: linear-gradient(135deg,#f3f4f6,#e5e7eb); border-left:4px solid #9ca3af; padding:10px; border-radius:10px; margin-top:10px; }

    /* match list */
    .match-table thead th{ background:#0ea5e9; color:white; font-weight:700; font-size:13px; padding:8px; }
    .match-table td{ padding:8px; border-bottom:1px solid #eef2f7; font-size:13px; }

    /* small screens */
    @media(min-width:768px){
      table.compact th:nth-child(1), table.compact td:nth-child(1){ width:50%; }
      table.compact th:nth-child(n+2), table.compact td:nth-child(n+2){ width:auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="hdr-row">
      <img src="https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/logoTKD.png" alt="Logo TKD" />
      <div class="hdr-title">
        <h1>TKD PICKLEBALL CHAMPIONSHIP 2025</h1>
        <p>Ngày 18/10/2025</p>
      </div>
      <div id="statusMessage">Đang tải dữ liệu...</div>
    </div>

    <div id="tab-controls" aria-hidden="false">
      <!-- Pick thủ leftmost -->
      <button class="tab-btn active-pick" data-index="0" id="tab-pick">Pick thủ</button>
      <button class="tab-btn bg-blue" data-index="1" id="tab-a">Bảng A</button>
      <button class="tab-btn bg-blue" data-index="2" id="tab-b">Bảng B</button>
      <button class="tab-btn" data-index="3" id="tab-ko">Knock-out</button>
    </div>
  </header>

  <main style="padding-top:110px;">
    <div id="content-carousel">
      <section class="swipe-section" id="players"></section>
      <section class="swipe-section" id="roundsA"></section>
      <section class="swipe-section" id="roundsB"></section>
      <section class="swipe-section" id="knockout"></section>
    </div>
  </main>

  <button id="refresh-btn" title="Tải lại dữ liệu">⟳</button>

  <script>
  /***** Cấu hình *****/
  const BASE_URL = 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
  const REFRESH_INTERVAL = 10000; // 10s

  /***** DOM refs *****/
  const carousel = document.getElementById('content-carousel');
  const tabs = Array.from(document.querySelectorAll('#tab-controls .tab-btn'));
  const statusMessage = document.getElementById('statusMessage');
  const refreshBtn = document.getElementById('refresh-btn');

  let currentIndex = 0;
  let startX = 0;
  let currentTranslate = 0;
  let isDragging = false;

  /***** Tab helpers *****/
  function setActiveTab(index){
    currentIndex = Math.max(0, Math.min(3, index));
    carousel.style.transition = 'transform .36s cubic-bezier(.25,1,.5,1)';
    carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
    tabs.forEach((btn,i)=>{
      btn.classList.remove('active-knockout','active-pick');
      if(i===currentIndex){
        if(i===3) btn.classList.add('active-knockout');
        if(i===0) btn.classList.add('active-pick');
      }
    });
    window.scrollTo({top:0,behavior:'smooth'});
  }
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=> setActiveTab(Number(btn.dataset.index)));
  });

  /***** Touch / swipe with translate while dragging and snap on release *****/
  carousel.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    isDragging = true;
    carousel.style.transition = 'none';
  }, {passive:true});

  carousel.addEventListener('touchmove', e => {
    if(!isDragging) return;
    const x = e.touches[0].clientX;
    const dx = x - startX;
    const base = -currentIndex * window.innerWidth;
    // follow finger a bit (resist beyond edges)
    let translate = base + dx;
    const maxTranslate = 0;
    const minTranslate = - (3 * window.innerWidth);
    if(translate > maxTranslate + 80) translate = maxTranslate + 80;
    if(translate < minTranslate - 80) translate = minTranslate - 80;
    carousel.style.transform = `translateX(${translate}px)`;
  }, {passive:true});

  carousel.addEventListener('touchend', e => {
    isDragging = false;
    const endX = e.changedTouches[0].clientX;
    const delta = endX - startX;
    // snap only on release
    if(Math.abs(delta) > 50){
      if(delta > 0) setActiveTab(currentIndex - 1);
      else setActiveTab(currentIndex + 1);
    } else {
      // small movement: snap back to current
      setActiveTab(currentIndex);
    }
  });

  /***** Fetch & render logic *****/
  async function fetchData(){
    statusMessage.textContent = 'Đang tải dữ liệu...';
    try {
      const res = await fetch(BASE_URL + '?_=' + Date.now(), {cache:'no-store'});
      if(!res.ok) throw new Error(res.status + ' ' + res.statusText);
      const data = await res.json();
      statusMessage.textContent = 'Đã tải (' + new Date().toLocaleTimeString('vi-VN') + ')';
      renderData(data);
    } catch(err){
      statusMessage.textContent = '⚠️ Lỗi tải dữ liệu';
      console.error(err);
    }
  }

  refreshBtn.addEventListener('click', ()=>{
    refreshBtn.style.transform = 'scale(.98)';
    refreshBtn.disabled = true;
    fetchData().finally(()=>{ setTimeout(()=>{ refreshBtn.style.transform=''; refreshBtn.disabled=false; },600); });
  });

  function renderData(state){
    renderPlayers(state);
    renderRound('roundsA', state.tableA, state.matchesA, 'A');
    renderRound('roundsB', state.tableB, state.matchesB, 'B');
    renderKnockout(state.semifinals, state.final);
  }

  function computeTotalsForTeam(teamName, matches){
    if(!Array.isArray(matches)) return {PF:0,PA:0,W:0,L:0};
    let PF=0, PA=0, W=0, L=0;
    for(const m of matches){
      if(!m) continue;
      const a = m.teamA, b = m.teamB;
      if(a === teamName){
        PF += Number(m.scoreA || 0);
        PA += Number(m.scoreB || 0);
        if(typeof m.winner !== 'undefined'){ if(m.winner === a) W++; else L++; }
      } else if(b === teamName){
        PF += Number(m.scoreB || 0);
        PA += Number(m.scoreA || 0);
        if(typeof m.winner !== 'undefined'){ if(m.winner === b) W++; else L++; }
      }
    }
    return {PF,PA,W,L};
  }

  /* Render helpers */
  function renderPlayers(data){
    const el = document.getElementById('players');
    let html = `<h2 style="font-size:18px;font-weight:700;color:#c2410c;text-align:center;margin-bottom:10px">Pick thủ</h2>`;
    html += `<div style="display:flex;gap:10px;flex-wrap:wrap;justify:center">`;
    html += `<div style="background:#fff;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);min-width:180px"><h3 style="font-weight:700">Bảng A - Mixed</h3><ul style="padding-left:14px;margin:6px 0;">${(data.mixedTeams||[]).map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
    html += `<div style="background:#fff;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);min-width:180px"><h3 style="font-weight:700">Bảng B - Nam</h3><ul style="padding-left:14px;margin:6px 0;">${(data.maleTeams||[]).map(t=>`<li>${t}</li>`).join('')}</ul></div>`;
    html += `</div>`;
    el.innerHTML = html;
  }

  function renderRound(containerId, table, matches, label){
    const c = document.getElementById(containerId);
    let html = `<h2 style="font-size:18px;font-weight:700;color:#0b63a3;text-align:center">Bảng ${label}</h2>`;
    html += renderTable(table, matches);
    html += renderMatchList(matches, `Kết quả Bảng ${label}`);
    c.innerHTML = html;
  }

  function renderTable(table, matches){
    if(!Array.isArray(table) || table.length===0) return `<p style="text-align:center;color:#6b7280">Chưa có dữ liệu bảng.</p>`;
    let html = `<div style="background:#fff;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:12px"><table class="compact" role="table"><thead><tr><th>Đội</th><th>T</th><th>B</th><th>PF</th><th>PA</th><th>+/-</th></tr></thead><tbody>`;
    table.forEach((row,i)=>{
      let teamName = (typeof row==='string')?row:(row.team||row.Team||row.name||Object.values(row).find(v=>typeof v==='string')||'Không xác định');
      // Use table values if present, otherwise compute from matches
      let wins = (row && (row.W ?? row.wins ?? row.Wins)) ?? null;
      let losses = (row && (row.L ?? row.losses ?? row.Losses)) ?? null;
      let pf = (row && (row.PF ?? row.pointsFor)) ?? null;
      let pa = (row && (row.PA ?? row.pointsAgainst)) ?? null;
      if((pf===null || pa===null) && Array.isArray(matches)){
        const totals = computeTotalsForTeam(teamName, matches);
        if(pf===null) pf = totals.PF;
        if(pa===null) pa = totals.PA;
        if(wins===null) wins = totals.W;
        if(losses===null) losses = totals.L;
      }
      // ensure numbers
      wins = (wins===null||typeof wins==='undefined')?0:wins;
      losses = (losses===null||typeof losses==='undefined')?0:losses;
      pf = Number(pf||0);
      pa = Number(pa||0);
      const pd = pf - pa;
      const rowClass = i===0 ? 'top1' : i===1 ? 'top2' : '';
      html += `<tr class="${rowClass}"><td style="padding-left:8px">${teamName}</td><td style="text-align:center">${wins}</td><td style="text-align:center">${losses}</td><td style="text-align:center">${pf}</td><td style="text-align:center">${pa}</td><td style="text-align:center;font-weight:700">${pd>0?'+'+pd:pd}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    return html;
  }

  function renderMatchList(matches, title){
    if(!Array.isArray(matches)) return '';
    let html = `<div style="background:#fff;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)"><h3 style="text-align:center;margin:0 0 8px;font-weight:700;color:#0b63a3">${title}</h3>`;
    html += `<div style="overflow-x:auto"><table class="match-table" style="width:100%"><thead><tr><th>Giờ</th><th>Sân</th><th>Đội A</th><th>Tỉ số</th><th>Đội B</th></tr></thead><tbody>`;
    matches.forEach(m=>{
      const aClass = m.winner===m.teamA ? 'font-weight:700;color:#16a34a' : '';
      const bClass = m.winner===m.teamB ? 'font-weight:700;color:#16a34a' : '';
      html += `<tr><td style="text-align:center">${m.time||''}</td><td style="text-align:center">${m.court||''}</td><td style="${aClass}">${m.teamA||''}</td><td style="text-align:center">${m.scoreA==null?'':m.scoreA} - ${m.scoreB==null?'':m.scoreB}</td><td style="${bClass}">${m.teamB||''}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
    return html;
  }

  function renderKnockout(semis, final){
    const c = document.getElementById('knockout');
    let html = `<h2 style="font-size:18px;font-weight:700;color:#16a34a;text-align:center">Knock-out</h2>`;
    if(Array.isArray(semis) && semis.length>0) html += renderMatchList(semis,'Bán Kết');
    if(final){
      html += `<div style="margin-top:12px">${/* champion */''}
        <div class="champion-box"><div style="font-size:16px;font-weight:800">🏆 Vô Địch</div><div style="font-size:15px;margin-top:8px;font-weight:700">${final.winner||final.teamA}</div><div style="font-size:12px;color:#374151;margin-top:6px">${final.teamA} (${final.scoreA})  —  (${final.scoreB}) ${final.teamB}</div></div>
        <div class="runnerup-box"><div style="font-size:14px;font-weight:700">🥈 Á Quân</div><div style="font-size:14px;margin-top:6px;font-weight:600">${final.runnerUp||''}</div></div>
      </div>`;
    }
    // bronze: losers of semis (both get bronze)
    if(Array.isArray(semis) && semis.length>=1){
      const losers = semis.map(s=>s.loser).filter(Boolean);
      if(losers.length>0){
        html += `<div style="background:#fff;padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-top:12px"><h3 style="color:#92400e;font-weight:700">🥉 Đồng hạng 3</h3><p>${losers.join(' và ')}</p></div>`;
      }
    }
    c.innerHTML = html;
  }

  /***** Init and auto-refresh *****/
  fetchData();
  setInterval(fetchData, REFRESH_INTERVAL);

  // Expose manual refresh (for other code that might call it)
  function manualRefresh(){ fetchData(); }
  window.manualRefresh = manualRefresh;

  </script>
</body>
</html>
