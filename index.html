<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .header { display:flex; gap:16px; align-items:center; }
    .logo { width:64px; height:64px; object-fit:contain; border-radius:8px; border:1px solid #e6eefc; padding:6px; background:#fff; }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    .save-indicator { font-weight:600; }
    textarea { font-family: monospace; }
    .small-muted { color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="header">
      <img id="logoImg" class="logo" src="data/logoTKD.png" alt="Logo">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div class="small-muted">Ngày thi đấu: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation"><button class="nav-link active" id="tab-overview" data-bs-toggle="tab" data-bs-target="#overview">Tổng quan</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-players" data-bs-toggle="tab" data-bs-target="#players">Người chơi</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-teams" data-bs-toggle="tab" data-bs-target="#teams">Đội</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-matches" data-bs-toggle="tab" data-bs-target="#matches">Trận đấu</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-results" data-bs-toggle="tab" data-bs-target="#results">Kết quả</button></li>
    <li class="nav-item" role="presentation"><button class="nav-link" id="tab-config" data-bs-toggle="tab" data-bs-target="#config">Cấu hình</button></li>
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <!-- Overview -->
    <div class="tab-pane fade show active p-3" id="overview">
      <h5>Tổng quan giải đấu</h5>
      <p>TKD Championship 2025 — <strong>18/10/2025</strong></p>
      <p class="small-muted">Logo được lấy từ <code>data/logoTKD.png</code>. Dữ liệu chính: <code>data/players.json</code>.</p>
      <div id="overviewContent"></div>
    </div>

    <!-- Players -->
    <div class="tab-pane fade p-3" id="players">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Danh sách người chơi</h5>
        <div>
          <button class="btn btn-sm btn-primary" onclick="openAddPlayer()">Thêm người chơi</button>
          <button class="btn btn-sm btn-secondary" onclick="downloadJSON()">Xuất JSON</button>
        </div>
      </div>
      <div id="playersTable" class="table-responsive border rounded p-2 bg-white">Đang tải...</div>
    </div>

    <!-- Teams -->
    <div class="tab-pane fade p-3" id="teams">
      <h5>Đội (teams)</h5>
      <div id="teamsContent">Đang tải...</div>
    </div>

    <!-- Matches -->
    <div class="tab-pane fade p-3" id="matches">
      <h5>Lịch & kết quả trận đấu</h5>
      <div id="matchesContent">Đang tải...</div>
    </div>

    <!-- Results -->
    <div class="tab-pane fade p-3" id="results">
      <h5>Kết quả tổng hợp</h5>
      <div id="resultsContent">Đang tải...</div>
    </div>

    <!-- Config -->
    <div class="tab-pane fade p-3" id="config">
      <h5>Cấu hình file GitHub & Auto-save</h5>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (vd: yourname)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (vd: Pickleball)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" placeholder="Folder (vd: data)" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" placeholder="File (vd: players.json)" value="players.json"></div>
      </div>

      <div class="mb-2 d-flex gap-2">
        <input id="cfgToken" type="password" class="form-control" placeholder="Dán GitHub token (PAT) tại đây — lưu cục bộ">
        <button class="btn btn-outline-secondary" onclick="clearLocalToken()">Xóa token</button>
      </div>

      <div class="mb-2">
        <label class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="cfgAutoSave">
          <span class="form-check-label">Bật auto-save (lưu tự động nếu có thay đổi)</span>
        </label>
      </div>

      <div class="mb-1 small-muted">Auto-save sẽ gửi yêu cầu ghi (repository_dispatch) khi có thay đổi và tối đa 1 lần/15s.</div>
      <div class="mt-2">
        <button class="btn btn-primary me-2" onclick="saveConfig()">Lưu cấu hình</button>
        <button class="btn btn-secondary" onclick="loadFromGithub()">Tải dữ liệu trực tiếp từ GitHub</button>
      </div>
      <div id="cfgStatus" class="mt-2 small-muted"></div>
    </div>
  </div>
</div>

<script>
/* ============================
   Dữ liệu mẫu (nạp từ players.json upload của bạn)
   Nội dung gốc được cung cấp ở file players.json — dùng làm default nếu không load từ GitHub.
   (Nguồn dữ liệu mẫu: players.json bạn đã gửi). :contentReference[oaicite:1]{index=1}
   ============================ */
const defaultData = {
  "females": ["Hậu","Hạnh","Giang","Huyền","Linh","Hường"],
  "males": ["Dũng","Tiến","Long","Luân","M.Hùng","Đạt","Thủy","Tiệp","Thanh","Phương","Minh","Triều","Tín","Khiêm","Ánh","Toàn","Hiển","P.Hùng"],
  "mixedTeams": ["Hậu-Dũng","Hạnh-Tiến","Giang-Long","Huyền-Luân","Linh-M.Hùng","Hường-Đạt"],
  "maleTeams": ["Thủy-Tiệp","Thanh-Phương","Minh-Triều","Tín-Khiêm","Ánh-Toàn","Hiển-P.Hùng"],
  "tableA": { "Hậu-Dũng":{"wins":5,"losses":0,"points_for":55,"points_against":32}, "Hạnh-Tiến":{"wins":3,"losses":2,"points_for":44,"points_against":38} },
  "tableB": { "Thủy-Tiệp":{"wins":4,"losses":1,"points_for":53,"points_against":34} },
  "matchesA":[["Hậu-Dũng","Hường-Đạt",11,2],["Hạnh-Tiến","Linh-M.Hùng",1,11]],
  "matchesB":[["Thủy-Tiệp","Hiển-P.Hùng",9,11]],
  "finalResults":{"third":"Thủy-Tiệp","fourth":"Hạnh-Tiến"},
  "finalMatchSets": [],
  "thirdPlaceMatch":["Hạnh-Tiến","Thủy-Tiệp",7,15],
  "thirdPlaceMode":"touch_15",
  "hasThirdPlace": true
};

/* ========= App state ========= */
let state = JSON.parse(JSON.stringify(defaultData)); // deep copy
let lastSavedState = null;
let autoSaveTimer = null;
const AUTO_SAVE_INTERVAL_MS = 15000; // 15s
let autoSaveEnabled = false;

/* ========= Init UI ========= */
document.addEventListener('DOMContentLoaded', () => {
  loadConfigFromLocal();
  renderAll();
  // start autosave check loop (runs always but only sends when enabled and changed)
  setInterval(autoSaveCheck, 3000); // check every 3s; actual sending respects 15s rule
});

/* ========= Renderers ========= */
function renderAll() {
  renderOverview();
  renderPlayers();
  renderTeams();
  renderMatches();
  renderResults();
  updateAutoStatus();
}

function renderOverview() {
  const el = document.getElementById('overviewContent');
  const html = `
    <div class="row g-2">
      <div class="col-md-4"><strong>Số nam:</strong> ${state.males ? state.males.length : 0}</div>
      <div class="col-md-4"><strong>Số nữ:</strong> ${state.females ? state.females.length : 0}</div>
      <div class="col-md-4"><strong>Tổng đội (mixed+male):</strong> ${(state.mixedTeams?state.mixedTeams.length:0)+(state.maleTeams?state.maleTeams.length:0)}</div>
    </div>
  `;
  el.innerHTML = html;
}

function renderPlayers() {
  const area = document.getElementById('playersTable');
  const all = [];
  if (state.males) state.males.forEach(n => all.push({Giới: 'Nam', Tên: n}));
  if (state.females) state.females.forEach(n => all.push({Giới: 'Nữ', Tên: n}));
  if (!all.length) return area.innerHTML = '<div class="small-muted">Chưa có người chơi</div>';
  const headers = Object.keys(all[0]);
  let html = '<table class="table table-striped"><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  all.forEach(row => {
    html += '<tr>' + headers.map(h => `<td>${escapeHtml(row[h])}</td>`).join('') + '</tr>';
  });
  html += '</tbody></table>';
  area.innerHTML = html;
}

function renderTeams() {
  const el = document.getElementById('teamsContent');
  let html = '';
  html += '<h6>Mixed Teams</h6>';
  html += renderListAsTable(state.mixedTeams || []);
  html += '<h6 class="mt-3">Male Teams</h6>';
  html += renderListAsTable(state.maleTeams || []);
  el.innerHTML = html;
}

function renderListAsTable(list) {
  if (!list || !list.length) return '<div class="small-muted">Không có</div>';
  let html = '<table class="table table-sm"><thead><tr><th>Team</th></tr></thead><tbody>';
  list.forEach(t => html += `<tr><td>${escapeHtml(t)}</td></tr>`);
  html += '</tbody></table>';
  return html;
}

function renderMatches() {
  const el = document.getElementById('matchesContent');
  let html = '<h6>Group A</h6>';
  html += renderMatchesTable(state.matchesA || []);
  html += '<h6 class="mt-3">Group B</h6>';
  html += renderMatchesTable(state.matchesB || []);
  el.innerHTML = html;
}

function renderMatchesTable(list) {
  if (!list || !list.length) return '<div class="small-muted">Không có lịch</div>';
  let html = '<table class="table table-sm"><thead><tr><th>Team A</th><th>Team B</th><th>Score A</th><th>Score B</th></tr></thead><tbody>';
  list.forEach(row => {
    html += `<tr><td>${escapeHtml(row[0])}</td><td>${escapeHtml(row[1])}</td><td>${row[2]}</td><td>${row[3]}</td></tr>`;
  });
  html += '</tbody></table>';
  return html;
}

function renderResults() {
  const el = document.getElementById('resultsContent');
  const fr = state.finalResults || {};
  let html = `<div><strong>Hạng 3:</strong> ${escapeHtml(fr.third||'')}</div><div><strong>Hạng 4:</strong> ${escapeHtml(fr.fourth||'')}</div>`;
  el.innerHTML = html;
}

/* ========= Helpers ========= */
function escapeHtml(s) {
  if (s === undefined || s === null) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* ========= Editing helpers (simple add player) ========= */
function openAddPlayer() {
  const name = prompt('Nhập tên người chơi (ví dụ: Nguyễn Văn A):');
  if (!name) return;
  const gender = prompt('Giới tính (Nam/Nữ):', 'Nam');
  if (!gender) return;
  if (/^nam$/i.test(gender)) {
    state.males = state.males || [];
    state.males.push(name);
  } else {
    state.females = state.females || [];
    state.females.push(name);
  }
  markStateChanged();
  renderPlayers();
}

/* ========= Config & local storage ========= */
function saveConfig() {
  const cfg = {
    owner: document.getElementById('cfgOwner').value.trim(),
    repo: document.getElementById('cfgRepo').value.trim(),
    folder: document.getElementById('cfgFolder').value.trim() || 'data',
    file: document.getElementById('cfgFile').value.trim() || 'players.json',
    token: document.getElementById('cfgToken').value.trim(),
    autoSave: document.getElementById('cfgAutoSave').checked
  };
  localStorage.setItem('pkb_config', JSON.stringify(cfg));
  loadConfigIntoUI();
  document.getElementById('cfgStatus').innerText = '✅ Cấu hình đã lưu (lưu cục bộ trên trình duyệt)';
  autoSaveEnabled = !!cfg.autoSave;
  updateAutoStatus();
}

function loadConfigFromLocal() {
  const cfg = JSON.parse(localStorage.getItem('pkb_config') || '{}');
  if (cfg) {
    document.getElementById('cfgOwner').value = cfg.owner || '';
    document.getElementById('cfgRepo').value = cfg.repo || '';
    document.getElementById('cfgFolder').value = cfg.folder || 'data';
    document.getElementById('cfgFile').value = cfg.file || 'players.json';
    document.getElementById('cfgToken').value = cfg.token || '';
    document.getElementById('cfgAutoSave').checked = !!cfg.autoSave;
    autoSaveEnabled = !!cfg.autoSave;
  }
}

function loadConfigIntoUI() {
  loadConfigFromLocal();
}

/* ========= Load from GitHub (manual) ========= */
async function loadFromGithub() {
  const cfg = JSON.parse(localStorage.getItem('pkb_config') || '{}');
  if (!cfg.owner || !cfg.repo || !cfg.file) {
    alert('Vui lòng cấu hình owner, repo và file trong tab Cấu hình trước.');
    return;
  }
  const token = cfg.token;
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder || 'data'}/${cfg.file}`;
  try {
    const res = await fetch(url, {
      headers: token ? { Authorization: `Bearer ${token}` } : {}
    });
    if (!res.ok) throw new Error('Không tải được file từ GitHub. Kiểm tra quyền/token và đường dẫn.');
    const j = await res.json();
    const content = decodeURIComponent(escape(atob(j.content))); // preserve utf-8
    // parse and replace state
    if (cfg.file.endsWith('.csv')) {
      // parse CSV -> simple data structure (put into state.males/females if structured)
      // for demo: store CSV raw into state.csvRaw
      state.csvRaw = content;
    } else {
      state = JSON.parse(content);
    }
    markStateSynced(); // set lastSavedState
    renderAll();
    alert('✅ Đã nạp dữ liệu từ GitHub.');
  } catch (err) {
    alert('❌ Lỗi khi tải từ GitHub: ' + err.message);
  }
}

/* ========= Auto-save logic ========= */
function markStateChanged() {
  // indicates there is unsaved change; actual save triggered by autoSaveCheck
  state.__changed = true;
  updateAutoStatus();
}

function markStateSynced() {
  lastSavedState = JSON.stringify(state);
  delete state.__changed;
  updateAutoStatus();
  document.getElementById('lastSaved').innerText = 'Đã lưu: ' + (new Date()).toLocaleString();
}

function updateAutoStatus() {
  document.getElementById('autoState').innerText = autoSaveEnabled ? 'Bật' : 'Tắt';
  const unsaved = state.__changed ? ' (chưa lưu)' : '';
  document.getElementById('autoSaveStatus').innerText = 'Auto-save: ' + (autoSaveEnabled ? 'Bật' : 'Tắt') + unsaved;
}

/* Throttle: ensure we don't send more than once per AUTO_SAVE_INTERVAL_MS */
let lastSentAt = 0;
let pendingSave = false;

async function autoSaveCheck() {
  const cfg = JSON.parse(localStorage.getItem('pkb_config') || '{}');
  autoSaveEnabled = !!(cfg && cfg.autoSave);
  if (!autoSaveEnabled) return;
  // Only proceed if there are changes
  if (!state.__changed) return;
  const now = Date.now();
  if (now - lastSentAt < AUTO_SAVE_INTERVAL_MS) {
    pendingSave = true;
    return;
  }
  // send save
  await sendSaveToGithub();
  lastSentAt = Date.now();
  pendingSave = false;
  // if there was another change flagged while we waited, schedule next send at interval
  if (state.__changed && !pendingSave) {
    setTimeout(() => { pendingSave = true; }, AUTO_SAVE_INTERVAL_MS);
  }
}

/* Prepare payload and call repository_dispatch endpoint */
async function sendSaveToGithub() {
  const cfg = JSON.parse(localStorage.getItem('pkb_config') || '{}');
  if (!cfg.owner || !cfg.repo || !cfg.file || !cfg.token) {
    console.log('Auto-save skipped: cấu hình chưa đầy đủ.');
    return;
  }
  // Build the full JSON content string
  const contentStr = JSON.stringify(state, null, 2);
  const payload = {
    event_type: 'auto_update_data',
    client_payload: {
      target_file: (cfg.folder ? (cfg.folder + '/') : '') + cfg.file,
      content: contentStr
    }
  };
  try {
    const res = await fetch(`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/dispatches`, {
      method: 'POST',
      headers: {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${cfg.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    if (res.ok || res.status === 204) {
      console.log('Auto-save request sent at', new Date().toLocaleTimeString());
      markStateSynced();
    } else {
      const txt = await res.text();
      console.error('Auto-save failed:', txt);
    }
  } catch (err) {
    console.error('Auto-save error:', err.message);
  }
}

/* Manual export */
function downloadJSON() {
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'players_export.json';
  a.click();
  URL.revokeObjectURL(url);
}

/* Utility: clear local token but keep config */
function clearLocalToken() {
  document.getElementById('cfgToken').value = '';
  const cfg = JSON.parse(localStorage.getItem('pkb_config') || '{}');
  cfg.token = '';
  localStorage.setItem('pkb_config', JSON.stringify(cfg));
  alert('✅ Token đã được xóa khỏi cấu hình cục bộ.');
}

/* Mark initial state as synced */
markStateSynced();

</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
