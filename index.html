<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TKD PICKLEBALL CHAMPIONSHIP 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f0f4f8; overflow-x: hidden; }
    #content-carousel { display: flex; width: 400vw; transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1); }
    .swipe-section { width: 100vw; flex-shrink: 0; padding: 1rem; min-height: calc(100vh - 160px); overflow-y: auto; }
    #refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; background-color: #0284c7; color: white; font-weight: bold; padding: 14px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
    #refresh-btn:hover { transform: scale(1.1); background-color: #0369a1; }
    .top1 { background-color: #d1fae5; font-weight: 700; animation: pulse1 1s ease-in-out infinite alternate; }
    .top2 { background-color: #e0f2fe; font-weight: 600; animation: pulse2 1s ease-in-out infinite alternate; }
    @keyframes pulse1 { from { box-shadow: 0 0 10px #22c55e; } to { box-shadow: 0 0 25px #22c55e; } }
    @keyframes pulse2 { from { box-shadow: 0 0 10px #0ea5e9; } to { box-shadow: 0 0 25px #0ea5e9; } }
    .tab-btn.active-knockout { background: linear-gradient(to right, #22c55e, #16a34a); color: #fff !important; box-shadow: 0 0 10px rgba(34,197,94,0.7); }
    .tab-btn.active-pick { background: linear-gradient(to right, #f59e0b, #d97706); color: white !important; box-shadow: 0 0 10px rgba(245,158,11,0.6); }
    pre.debug { background:#111827; color:#d1fae5; padding:8px; border-radius:6px; font-size:12px; overflow:auto; max-height:120px; }
  </style>
</head>
<body class="font-sans">
  <header class="fixed top-0 left-0 right-0 z-30 bg-white shadow-md p-4">
    <div class="flex items-center justify-center mb-2">
      <img src="https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/logoTKD.png" alt="Logo TKD" class="h-20 w-auto mr-2" />
      <h1 class="text-xl font-extrabold text-blue-800 text-center">TKD PICKLEBALL CHAMPIONSHIP 2025</h1>
    </div>
    <p class="text-center text-gray-600 text-sm">Ngày 18/10/2025</p>
    <div id="tab-controls" class="flex justify-around mt-3 mb-2 max-w-2xl mx-auto flex-wrap">
      <button onclick="goToSection(0)" class="tab-btn active px-3 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white">Vòng Bảng A</button>
      <button onclick="goToSection(1)" class="tab-btn px-3 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white">Vòng Bảng B</button>
      <button onclick="goToSection(2)" class="tab-btn px-3 py-2 text-sm font-semibold rounded-full bg-green-100 text-green-800">Knock-out</button>
      <button onclick="goToSection(3)" class="tab-btn px-3 py-2 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800">Pick thủ</button>
    </div>
    <div id="statusMessage" class="text-center text-sm font-medium text-gray-600">Đang tải dữ liệu...</div>
  </header>

  <main id="main-content-wrapper" class="pt-[180px] md:pt-[150px] overflow-hidden">
    <div id="content-carousel">
      <section class="swipe-section" id="roundsA"></section>
      <section class="swipe-section" id="roundsB"></section>
      <section class="swipe-section" id="knockout"></section>
      <section class="swipe-section" id="players"></section>
    </div>
  </main>

  <button id="refresh-btn" title="Tải lại dữ liệu" onclick="manualRefresh()">⟳</button>

  <div style="position:fixed;left:8px;bottom:8px;z-index:60;max-width:45vw;" id="debugBox"></div>

  <script>
    const BASE_URL = window.location.hostname.includes('github.io') ? './data/state.json' : 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
    const REFRESH_INTERVAL = 10000;

    const carousel = document.getElementById('content-carousel');
    let currentIndex = 0;
    let startX = 0, endX = 0;

    function goToSection(index) {
      currentIndex = Math.max(0, Math.min(3, index));
      carousel.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)';
      carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
      updateTabs();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateTabs() {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        btn.classList.remove('active-knockout', 'active-pick', 'bg-blue-600', 'text-white');
        if (i === currentIndex) {
          if (i === 0 || i === 1) btn.classList.add('bg-blue-600', 'text-white');
          if (i === 2) btn.classList.add('active-knockout');
          if (i === 3) btn.classList.add('active-pick');
        }
      });
    }

    carousel.addEventListener('touchstart', e => startX = e.touches[0].clientX);
    carousel.addEventListener('touchend', e => {
      endX = e.changedTouches[0].clientX;
      const delta = endX - startX;
      if (Math.abs(delta) > 50) {
        if (delta > 0) goToSection(currentIndex - 1);
        else goToSection(currentIndex + 1);
      }
    });

    async function fetchData() {
      const msg = document.getElementById('statusMessage');
      msg.textContent = 'Đang tải dữ liệu...';
      try {
        const res = await fetch(BASE_URL, { cache: 'no-store' });
        const data = await res.json();
        msg.textContent = 'Đã tải dữ liệu (' + new Date().toLocaleTimeString('vi-VN') + ')';
        // Debug dump to help find why team names or PF/PA are missing
        document.getElementById('debugBox').innerHTML = `<pre class="debug">tables:\nA=${JSON.stringify(data.tableA,null,2)}\nB=${JSON.stringify(data.tableB,null,2)}\n\nmatchesA length=${(data.matchesA||[]).length} matchesB length=${(data.matchesB||[]).length}</pre>`;
        console.debug('state.json preview', data);
        renderData(data);
      } catch (err) {
        msg.textContent = '⚠️ Lỗi tải dữ liệu: ' + err.message;
      }
    }

    function manualRefresh() {
      document.getElementById('refresh-btn').classList.add('animate-spin');
      fetchData().finally(() => setTimeout(() => document.getElementById('refresh-btn').classList.remove('animate-spin'), 800));
    }

    function renderData(data) {
      renderRound('roundsA', data.tableA, data.matchesA, 'A');
      renderRound('roundsB', data.tableB, data.matchesB, 'B');
      renderKnockout(data.semifinals, data.final);
      renderPlayers(data);
    }

    // compute totals from matches if table entry lacks PF/PA
    function computeTotalsForTeam(teamName, matches) {
      if (!Array.isArray(matches)) return { PF:0, PA:0, W:0, L:0 };
      let PF=0, PA=0, W=0, L=0;
      for (const m of matches) {
        if (!m) continue;
        const a = m.teamA, b = m.teamB;
        // normalize names exactly as provided in matches
        if (a === teamName) {
          PF += Number(m.scoreA || 0);
          PA += Number(m.scoreB || 0);
          if (typeof m.winner !== 'undefined') { if (m.winner === a) W++; else L++; }
        } else if (b === teamName) {
          PF += Number(m.scoreB || 0);
          PA += Number(m.scoreA || 0);
          if (typeof m.winner !== 'undefined') { if (m.winner === b) W++; else L++; }
        }
      }
      return { PF, PA, W, L };
    }

    function renderRound(id, table, matches, label) {
      const c = document.getElementById(id);
      let html = `<h2 class='text-2xl font-bold text-blue-700 mb-3 text-center'>Vòng Bảng ${label}</h2>`;
      html += renderTable(table, `Bảng ${label}`, matches);
      html += renderMatchList(matches, `Kết quả Bảng ${label}`);
      c.innerHTML = html;
    }

    function renderPlayers(data) {
      const c = document.getElementById('players');
      c.innerHTML = `<h2 class='text-2xl font-bold text-yellow-700 mb-3 text-center'>Pick thủ</h2>`;
      c.innerHTML += renderTeamsList(data.mixedTeams, 'Bảng A - Mixed');
      c.innerHTML += renderTeamsList(data.maleTeams, 'Bảng B - Nam');
    }

    function renderTeamsList(teams, title) {
      if (!teams) return '';
      let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3><ul class='grid grid-cols-2 md:grid-cols-3 gap-2 text-center'>`;
      teams.forEach(t => html += `<li class='bg-yellow-50 rounded-md py-2 font-medium'>${t}</li>`);
      html += '</ul></div>';
      return html;
    }

    // renderTable now accepts matches to compute PF/PA if missing in table entries
    function renderTable(table, title, matches) {
      if (!Array.isArray(table) || table.length === 0) return `<p class='text-center text-gray-500'>Chưa có dữ liệu bảng.</p>`;
      let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      const headers = ['Đội', 'Thắng', 'Thua', 'PF', 'PA', 'Hiệu số'];
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr>` +
        headers.map(h => `<th class='px-3 py-2 text-center'>${h}</th>`).join('') + `</tr></thead><tbody class='bg-white divide-y divide-gray-100'>`;

      table.forEach((row, i) => {
        // support row as object or simple string
        let teamName = '';
        if (typeof row === 'string') teamName = row;
        else if (row && typeof row === 'object') teamName = row.team || row.Team || row['Đội'] || row.name || '';

        if (!teamName) {
          // fallback: maybe row is like { team: 'Name' } under different key
          teamName = Object.values(row).find(v => typeof v === 'string') || 'Không xác định';
        }

        // read existing stats if present
        let wins =  row && typeof row === 'object' ? (row.W ?? row.wins ?? row.Wins ?? null) : null;
        let losses = row && typeof row === 'object' ? (row.L ?? row.losses ?? row.Losses ?? null) : null;
        let pf = row && typeof row === 'object' ? (row.PF ?? row.pointsFor ?? row.PF ?? null) : null;
        let pa = row && typeof row === 'object' ? (row.PA ?? row.pointsAgainst ?? row.PA ?? null) : null;

        // if pf/pa are null or NaN, compute from matches
        if ((pf === null || pa === null) && Array.isArray(matches)) {
          const totals = computeTotalsForTeam(teamName, matches);
          if (pf === null) pf = totals.PF;
          if (pa === null) pa = totals.PA;
          if (wins === null) wins = totals.W;
          if (losses === null) losses = totals.L;
        }

        // ensure numeric defaults
        wins = (wins === null || typeof wins === 'undefined') ? 0 : wins;
        losses = (losses === null || typeof losses === 'undefined') ? 0 : losses;
        pf = (pf === null || typeof pf === 'undefined' || isNaN(Number(pf))) ? 0 : Number(pf);
        pa = (pa === null || typeof pa === 'undefined' || isNaN(Number(pa))) ? 0 : Number(pa);
        const pd = pf - pa;

        let rowClass = i === 0 ? 'top1' : i === 1 ? 'top2' : '';
        html += `<tr class='hover:bg-blue-50 ${rowClass}'><td class='px-3 py-2 text-center'>${teamName}</td><td class='text-center'>${wins}</td><td class='text-center'>${losses}</td><td class='text-center'>${pf}</td><td class='text-center'>${pa}</td><td class='text-center font-semibold'>${pd>0?`+${pd}`:pd}</td></tr>`;
      });

      html += '</tbody></table></div></div>';
      return html;
    }

    function renderMatchList(matches, title) {
      if (!matches) return '';
      let html = `<div class='bg-white p-4 mt-4 rounded-xl shadow'><h3 class='text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      html += `<div class='overflow-x-auto'><table class='min-w-full divide-y divide-gray-200 text-sm'><thead class='bg-blue-600 text-white'><tr><th>Giờ</th><th>Sân</th><th>Đội A</th><th>Tỉ số</th><th>Đội B</th></tr></thead><tbody>`;
      matches.forEach(m => {
        const aClass = m.winner === m.teamA ? 'text-green-700 font-bold' : '';
        const bClass = m.winner === m.teamB ? 'text-green-700 font-bold' : '';
        html += `<tr class='hover:bg-blue-50'><td class='px-3 py-2 text-center'>${m.time}</td><td>${m.court}</td><td class='${aClass}'>${m.teamA}</td><td class='text-center'>${m.scoreA} - ${m.scoreB}</td><td class='${bClass}'>${m.teamB}</td></tr>`;
      });
      html += '</tbody></table></div></div>';
      return html;
    }

    function renderKnockout(semis, final) {
      const c = document.getElementById('knockout');
      let html = `<h2 class='text-2xl font-bold text-green-700 mb-3 text-center'>Knock-out</h2>`;
      if (semis) html += renderMatchList(semis, 'Bán Kết');
      if (final) html += `<div class='winner-box bg-white p-4 mt-4 rounded-xl shadow text-center'><h3 class='text-lg font-semibold text-green-800 mb-2'>Chung Kết</h3><p><strong>${final.teamA}</strong> (${final.scoreA}) vs (${final.scoreB}) <strong>${final.teamB}</strong></p><p class='mt-2 text-green-600 font-semibold'>🏆 Vô địch: ${final.winner}</p><p class='text-gray-700'>Á quân: ${final.runnerUp}</p></div>`;
      c.innerHTML = html;
    }

    setInterval(fetchData, REFRESH_INTERVAL);
    fetchData();
  </script>
</body>
</html>
