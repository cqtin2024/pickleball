<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pickleball Tournament - Data Manager</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; max-width: 720px; }
    h1 { color: #2c3e50; }
    input, button, textarea { padding: 8px; margin: 5px 0; font-size: 16px; width: 100%; box-sizing: border-box; }
    section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
    .hidden { display: none; }
    pre { background: #f6f6f6; padding: 10px; border-radius: 6px; font-size: 14px; overflow:auto; }
    .ok { color: #27ae60; }
    .err { color: #c0392b; }
    small { color: #666; }
  </style>
</head>
<body>
  <h1>🏓 Pickleball Tournament – Data Manager</h1>
  <p>Hướng dẫn nhanh: tạo <b>Fine-grained Personal Access Token</b> trên GitHub (Permissions: repo contents read & write) và dán vào ô bên dưới. <small>(Token được lưu cục bộ trên trình duyệt)</small></p>

  <section id="setupSection">
    <h2>🧩 Bước 1. Tạo GitHub Token</h2>
    <ol>
      <li>Mở: <a href="https://github.com/settings/tokens?type=fine-grained" target="_blank">https://github.com/settings/tokens?type=fine-grained</a></li>
      <li>Nhấn <b>Generate new token</b></li>
      <li>Repository access: chọn repo của bạn (ví dụ <code>Pickleball</code>)</li>
      <li>Permissions: <b>Contents → Read and write</b></li>
      <li>Sao chép token (chỉ hiện 1 lần)</li>
    </ol>

    <h2>🔑 Bước 2. Dán Token vào đây:</h2>
    <input type="password" id="tokenInput" placeholder="Dán GitHub token tại đây..." />
    <button id="saveTokenBtn">Lưu token & tiếp tục</button>
    <p id="tokenStatus"></p>
  </section>

  <section id="mainApp" class="hidden">
    <h2>🏅 Quản lý người chơi</h2>
    <label>Tên người chơi:</label>
    <input id="playerName" type="text" placeholder="Nhập tên người chơi..." />
    <button id="saveBtn">Lưu vào GitHub</button>
    <pre id="log"></pre>

    <h3>⚙️ Cấu hình hiện tại</h3>
    <pre id="configDisplay"></pre>
    <button id="clearTokenBtn" style="background:#eee;">Xoá token và cấu hình</button>

    <section>
      <h3>🔁 Hướng dẫn đồng bộ</h3>
      <ol>
        <li>Sau khi thêm người chơi, Action sẽ commit thay đổi vào <code>/data/players.json</code>.</li>
        <li>Mở repository trên GitHub để kiểm tra file <code>data/players.json</code> và các commit.</li>
        <li>Nếu muốn thay đổi tên repo trên giao diện, chỉnh biến <code>owner</code> hoặc <code>repo</code> bên dưới trong file <code>index.html</code>.</li>
      </ol>
    </section>
  </section>

  <script>
    // ====== CONFIG ======
    // Thay YOUR_GITHUB_USERNAME bằng tên user GitHub của bạn.
    const owner = "YOUR_GITHUB_USERNAME";
    const repo  = "Pickle";
    const eventType = "update_data";
    const tokenKey = "github_token_pickleb";

    // ====== UI refs ======
    const tokenInput = document.getElementById("tokenInput");
    const saveTokenBtn = document.getElementById("saveTokenBtn");
    const tokenStatus = document.getElementById("tokenStatus");
    const setupSection = document.getElementById("setupSection");
    const mainApp = document.getElementById("mainApp");
    const logEl = document.getElementById("log");
    const configDisplay = document.getElementById("configDisplay");

    // If token exists in localStorage, skip setup
    const savedToken = localStorage.getItem(tokenKey);
    if (savedToken) showMainApp(savedToken);

    saveTokenBtn.onclick = () => {
      const token = tokenInput.value.trim();
      if (!token) return alert("Vui lòng dán token GitHub!");
      localStorage.setItem(tokenKey, token);
      showMainApp(token);
    };

    function showMainApp(token) {
      setupSection.classList.add("hidden");
      mainApp.classList.remove("hidden");
      configDisplay.textContent = JSON.stringify({ owner, repo, token: token.slice(0, 6) + "..." }, null, 2);
    }

    document.getElementById("clearTokenBtn").onclick = () => {
      localStorage.removeItem(tokenKey);
      location.reload();
    };

    // Save player
    document.getElementById("saveBtn").onclick = async () => {
      const token = localStorage.getItem(tokenKey);
      const name = document.getElementById("playerName").value.trim();
      if (!token) return alert("Bạn chưa dán token!");
      if (!name) return alert("Nhập tên người chơi!");

      // Prepare payload for repository_dispatch
      const payload = {
        event_type: eventType,
        client_payload: {
          file: "players.json",
          newData: { name: name, time: new Date().toISOString() }
        }
      };

      logEl.textContent = "⏳ Đang gửi yêu cầu tới GitHub Actions...";
      logEl.className = "";
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/dispatches`, {
          method: "POST",
          headers: {
            "Accept": "application/vnd.github+json",
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (res.ok || res.status === 204) {
          logEl.textContent = "✅ Gửi thành công! Dữ liệu sẽ được cập nhật trong vài giây (kiểm tra commit trong repo).";
          logEl.className = "ok";
        } else {
          const txt = await res.text();
          logEl.textContent = "❌ Lỗi: " + txt;
          logEl.className = "err";
        }
      } catch (e) {
        logEl.textContent = "❌ Lỗi mạng hoặc fetch: " + e.message;
        logEl.className = "err";
      }
    };
  </script>
</body>
</html>
