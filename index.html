<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TKD PICKLEBALL CHAMPIONSHIP 2025</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Base styles for mobile */
    body { background-color: #f0f4f8; overflow-x: hidden; font-family: 'Inter', sans-serif; }
    #content-carousel { display: flex; width: 400vw; transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1); }
    .swipe-section { width: 100vw; flex-shrink: 0; padding: 0.5rem; min-height: calc(100vh - 160px); overflow-y: auto; }

    /* Adjust padding for content on mobile to avoid header overlap */
    #main-content-wrapper { padding-top: 140px; } 
    /* Adjust padding for content on desktop/large screens */
    @media (min-width: 768px) {
        #main-content-wrapper { padding-top: 150px; }
        .swipe-section { padding: 1rem; }
    }

    /* Table optimization for mobile - small text, compact */
    table.compact th, table.compact td { padding: 4px 4px !important; font-size: 12px !important; }
    /* Table optimization for desktop - slightly larger text, more padding */
    @media (min-width: 768px) {
        table.compact th, table.compact td { padding: 8px 8px !important; font-size: 14px !important; }
    }
    
    /* Ensure team name can wrap */
    .team-name-cell { min-width: 70px; }

    /* Custom styles for visual effects */
    #refresh-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; background-color: #0284c7; color: white; font-weight: bold; padding: 14px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
    #refresh-btn:hover { transform: scale(1.1); background-color: #0369a1; }
    .top1 { background-color: #d1fae5; font-weight: 700; animation: pulse1 1s ease-in-out infinite alternate; }
    .top2 { background-color: #e0f2fe; font-weight: 600; animation: pulse2 1s ease-in-out infinite alternate; }
    @keyframes pulse1 { from { box-shadow: 0 0 5px #22c55e; } to { box-shadow: 0 0 15px #22c55e; } }
    @keyframes pulse2 { from { box-shadow: 0 0 5px #0ea5e9; } to { box-shadow: 0 0 15px #0ea5e9; } }
    .tab-btn.active-knockout { background: linear-gradient(to right, #22c55e, #16a34a); color: #fff !important; box-shadow: 0 0 5px rgba(34,197,94,0.7); }
    .tab-btn.active-pick { background: linear-gradient(to right, #f59e0b, #d97706); color: white !important; box-shadow: 0 0 5px rgba(245,158,11,0.6); }

    /* Inactive styles for better contrast */
    .tab-btn:not(.active-knockout):not(.active-pick):not(.active-blue) { 
        background-color: #eff6ff; /* Blue-50 */
        color: #1d4ed8; /* Blue-700 */
    }
    .tab-btn.active-blue { 
        background-color: #2563eb; /* Blue-600 */
        color: white !important;
    }


    .champion-box { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #facc15; animation: glowGold 2s infinite alternate; }
    .runnerup-box { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); border: 2px solid #9ca3af; animation: glowSilver 2s infinite alternate; }
    @keyframes glowGold { from { box-shadow: 0 0 5px #facc15; } to { box-shadow: 0 0 15px #fbbf24; } }
    @keyframes glowSilver { from { box-shadow: 0 0 5px #9ca3af; } to { box-shadow: 0 0 15px #d1d5db; } }
  </style>
</head>
<body class="font-sans">

  <header class="fixed top-0 left-0 right-0 z-30 bg-white shadow-md p-4">
    <div class="flex items-center justify-center mb-1">
      <!-- Responsive Logo & Title: H-14 trên mobile, H-16 trên desktop/md -->
      <img src="https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/logoTKD.png" alt="Logo TKD" class="h-14 md:h-16 w-auto mr-2" />
      <!-- Text-lg trên mobile, Text-xl trên desktop/md -->
      <h1 class="text-lg md:text-xl font-extrabold text-blue-800 text-center">TKD PICKLEBALL CHAMPIONSHIP 2025</h1>
    </div>
    <p class="text-center text-gray-600 text-xs">Ngày 18/10/2025</p>
    
    <!-- Tab Controls: Tối ưu cho mobile bằng cuộn ngang, centered trên desktop -->
    <!-- Initial classes for default inactive state (will be overwritten by JS/Active states) -->
    <div id="tab-controls" class="flex justify-start md:justify-center overflow-x-auto flex-nowrap mt-2 mb-2 mx-auto space-x-2 p-1">
      <button onclick="goToSection(0)" class="tab-btn active-pick flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full">Pick thủ</button>
      <button onclick="goToSection(1)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full">Bảng A</button>
      <button onclick="goToSection(2)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full">Bảng B</button>
      <button onclick="goToSection(3)" class="tab-btn flex-shrink-0 px-3 py-2 text-sm font-semibold rounded-full">Knock-out</button>
    </div>
    <div id="statusMessage" class="text-center text-xs font-medium text-gray-600">Đang tải dữ liệu...</div>
  </header>

  <!-- Main Content Wrapper: Responsive padding top -->
  <main id="main-content-wrapper" class="overflow-hidden">
    <div id="content-carousel">
      <section class="swipe-section" id="players"></section>
      <section class="swipe-section" id="roundsA"></section>
      <section class="swipe-section" id="roundsB"></section>
      <section class="swipe-section" id="knockout"></section>
    </div>
  </main>

  <button id="refresh-btn" title="Tải lại dữ liệu" onclick="manualRefresh()">⟳</button>

  <script>
    const BASE_URL = 'https://raw.githubusercontent.com/cqtin2024/pickleball/main/data/state.json';
    const REFRESH_INTERVAL = 10000;
    const carousel = document.getElementById('content-carousel');
    let currentIndex = 0, startX = 0, endX = 0;

    // --- Navigation & UI Control ---

    function goToSection(index) {
      currentIndex = Math.max(0, Math.min(3, index));
      carousel.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)';
      carousel.style.transform = `translateX(${currentIndex * -100}vw)`;
      updateTabs();
      // Cuộn lên đầu trang khi chuyển tab
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateTabs() {
      document.querySelectorAll('.tab-btn').forEach((btn, i) => {
        // 1. Reset tất cả các active/inactive classes
        btn.classList.remove('active-knockout', 'active-pick', 'active-blue', 'bg-blue-600', 'text-white', 'bg-green-100', 'text-green-800');
        
        if (i === currentIndex) {
          // 2. Thiết lập trạng thái ACTIVE
          if (i === 3) {
             btn.classList.add('active-knockout'); // Màu xanh lá cây đậm
          } else if (i === 0) {
             btn.classList.add('active-pick'); // Màu vàng cam đậm
          } else {
             btn.classList.add('active-blue'); // Màu xanh dương đậm cho Bảng A, B
          }
        } else {
           // 3. Thiết lập trạng thái INACTIVE (Màu nền nhạt và chữ đậm)
           if (i === 3) {
             btn.classList.add('bg-green-100', 'text-green-800'); // Xanh lá nhạt
           } else if (i === 0) {
             btn.classList.add('bg-yellow-100', 'text-yellow-800'); // Vàng nhạt
           } else {
             btn.classList.add('bg-blue-100', 'text-blue-800'); // Xanh dương nhạt cho Bảng A, B
           }
        }
      });
    }

    // Swipe gestures for mobile
    carousel.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        // Tắt transition khi bắt đầu chạm để cuộn mượt mà hơn
        carousel.style.transition = 'none';
    });
    carousel.addEventListener('touchmove', e => {
        const currentX = e.touches[0].clientX;
        const delta = currentX - startX;
        // Kéo carousel theo chuyển động chạm
        carousel.style.transform = `translateX(calc(${currentIndex * -100}vw + ${delta}px))`;
    });
    carousel.addEventListener('touchend', e => {
      endX = e.changedTouches[0].clientX;
      const delta = endX - startX;
      // Kích hoạt transition trở lại
      carousel.style.transition = 'transform 0.35s cubic-bezier(0.25, 1, 0.5, 1)';

      if (Math.abs(delta) > 80) { // Ngưỡng swipe 80px
        if (delta > 0) goToSection(currentIndex - 1); // Swipe phải -> Tab trái
        else goToSection(currentIndex + 1); // Swipe trái -> Tab phải
      } else {
        // Quay lại vị trí cũ nếu không đủ ngưỡng swipe
        goToSection(currentIndex);
      }
    });

    // --- Data Fetching and Error Handling ---

    async function fetchData() {
      const msg = document.getElementById('statusMessage');
      document.getElementById('refresh-btn').classList.add('animate-spin');
      msg.textContent = 'Đang tải dữ liệu...';
      try {
        const res = await fetch(BASE_URL, { cache: 'no-store' });
        if (!res.ok) {
            throw new Error(`HTTP Error: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();
        
        // Đã loại bỏ kiểm tra if (!data) nghiêm ngặt để đảm bảo tải dữ liệu bình thường
        
        msg.textContent = 'Đã tải dữ liệu (' + new Date().toLocaleTimeString('vi-VN') + ')';
        renderData(data);
      } catch (err) {
        // Xử lý lỗi tải dữ liệu
        console.error("Error fetching data:", err);
        msg.textContent = '⚠️ Lỗi tải dữ liệu: ' + err.message;
      } finally {
        setTimeout(() => document.getElementById('refresh-btn').classList.remove('animate-spin'), 500);
      }
    }

    function manualRefresh() {
      fetchData();
    }

    function renderData(data) {
      if (!data) return; // Vẫn giữ kiểm tra này để ngăn lỗi nếu data là null/undefined

      renderRound('roundsA', data.tableA, data.matchesA, 'A');
      renderRound('roundsB', data.tableB, data.matchesB, 'B');
      renderKnockout(data.semifinals, data.final);
      renderPlayers(data);
    }

    // --- Data Calculation Helpers (unchanged structure) ---

    function computeTotalsForTeam(teamName, matches) {
      if (!Array.isArray(matches)) return { PF: 0, PA: 0, W: 0, L: 0 };
      let PF = 0, PA = 0, W = 0, L = 0;
      for (const m of matches) {
        if (!m || !m.winner) continue; // Bỏ qua trận chưa có kết quả
        const a = m.teamA, b = m.teamB;
        if (a === teamName) {
          PF += Number(m.scoreA || 0);
          PA += Number(m.scoreB || 0);
          if (m.winner === a) W++; else if (m.winner === b) L++;
        } else if (b === teamName) {
          PF += Number(m.scoreB || 0);
          PA += Number(m.scoreA || 0);
          if (m.winner === b) W++; else if (m.winner === a) L++;
        }
      }
      return { PF, PA, W, L };
    }

    // --- Rendering Functions ---

    function renderRound(id, table, matches, label) {
      const c = document.getElementById(id);
      // Responsive Title: text-xl mobile, text-2xl desktop
      c.innerHTML = `<h2 class='text-xl md:text-2xl font-bold text-blue-700 mb-3 text-center'>Bảng ${label}</h2>`; 
      c.innerHTML += renderTable(table, `Bảng ${label}`, matches);
      c.innerHTML += renderMatchList(matches, `Kết quả Bảng ${label}`);
    }

    function renderPlayers(data) {
      const c = document.getElementById('players');
      // Responsive Title: text-xl mobile, text-2xl desktop
      c.innerHTML = `<h2 class='text-xl md:text-2xl font-bold text-yellow-700 mb-3 text-center'>Pick thủ</h2>`;
      c.innerHTML += renderTeamsList(data.mixedTeams, 'Bảng A - Mixed');
      c.innerHTML += renderTeamsList(data.maleTeams, 'Bảng B - Nam');
    }

    function renderTeamsList(teams, title) {
      if (!teams) return '';
      // Responsive Padding & Font: p-3 mobile, p-4 desktop; text-base mobile, text-lg desktop
      let html = `<div class='bg-white p-3 md:p-4 mt-3 rounded-xl shadow'>
                    <h3 class='text-base md:text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>
                    <ul class='grid grid-cols-2 md:grid-cols-3 gap-2 text-center'>`;
      // Responsive list item: py-1 mobile, py-2 desktop; text-sm mobile, text-base desktop
      teams.forEach(t => html += `<li class='bg-yellow-50 rounded-md py-1 md:py-2 text-sm md:text-base font-medium'>${t}</li>`);
      html += '</ul></div>';
      return html;
    }

    function renderTable(table, title, matches) {
      if (!Array.isArray(table) || table.length === 0) return `<p class='text-center text-gray-500'>Chưa có dữ liệu bảng.</p>`;
      
      // Responsive Padding & Font: p-3 mobile, p-4 desktop; text-base mobile, text-lg desktop
      let html = `<div class='bg-white p-3 md:p-4 mt-3 rounded-xl shadow'>
                    <h3 class='text-base md:text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      const headers = ['Đội', 'T', 'B', 'PF', 'PA', '+/-'];
      
      // Sử dụng `overflow-x-auto` để cuộn ngang trên mobile nếu cần
      html += `<div class='overflow-x-auto'>
                <table class='min-w-full divide-y divide-gray-200 compact'>
                  <thead class='bg-blue-600 text-white'>
                    <tr>` +
                      headers.map(h => `<th class='text-center whitespace-nowrap'>${h}</th>`).join('') + 
                    `</tr>
                  </thead>
                  <tbody class='bg-white divide-y divide-gray-100'>`;

      table.forEach((row, i) => {
        let teamName = typeof row === 'string' ? row : row.team || row.Team || row.name || 'Không xác định';
        const totals = computeTotalsForTeam(teamName, matches);
        const pf = totals.PF, pa = totals.PA, pd = pf - pa;
        const wins = totals.W, losses = totals.L;
        let rowClass = i === 0 ? 'top1' : i === 1 ? 'top2' : '';
        
        // Cột tên đội cho phép xuống dòng (team-name-cell class)
        html += `<tr class='hover:bg-blue-50 ${rowClass}'>
                    <td class='text-center team-name-cell'>${teamName}</td>
                    <td class='text-center whitespace-nowrap'>${wins}</td>
                    <td class='text-center whitespace-nowrap'>${losses}</td>
                    <td class='text-center whitespace-nowrap'>${pf}</td>
                    <td class='text-center whitespace-nowrap'>${pa}</td>
                    <td class='text-center font-semibold whitespace-nowrap'>${pd>0?`+${pd}`:pd}</td>
                  </tr>`;
      });

      html += '</tbody></table></div></div>';
      return html;
    }

    function renderMatchList(matches, title) {
      if (!matches) return '';
      
      // Responsive Padding & Font: p-3 mobile, p-4 desktop
      let html = `<div class='bg-white p-3 md:p-4 mt-3 rounded-xl shadow'>
                    <h3 class='text-base md:text-lg font-semibold text-blue-800 mb-2 text-center'>${title}</h3>`;
      
      // Header: Gộp Giờ & Sân
      html += `<div class='overflow-x-auto'>
                <table class='min-w-full divide-y divide-gray-200'>
                  <thead class='bg-blue-600 text-white'>
                    <tr>
                        <th class='text-xs md:text-sm whitespace-nowrap'>Thời gian/Sân</th>
                        <th class='text-sm md:text-base'>Đội A</th>
                        <th class='text-sm md:text-base'>Tỉ số</th>
                        <th class='text-sm md:text-base'>Đội B</th>
                    </tr>
                  </thead>
                  <tbody>`;
      matches.forEach(m => {
        const aClass = m.winner === m.teamA ? 'text-green-700 font-bold' : '';
        const bClass = m.winner === m.teamB ? 'text-green-700 font-bold' : '';
        
        // Responsive Match Row: Text size 
        html += `<tr class='hover:bg-blue-50'>
                    <!-- Gộp Giờ/Sân, font nhỏ hơn để tiết kiệm không gian trên mobile -->
                    <td class='px-1 py-1 text-center text-xs md:text-sm whitespace-nowrap'>
                        ${m.time}<br/>(${m.court})
                    </td>
                    <!-- Tên đội: text-sm mobile, text-base desktop -->
                    <td class='${aClass} text-sm md:text-base'>${m.teamA}</td>
                    <!-- Tỉ số: text-sm mobile, text-base desktop -->
                    <td class='text-center text-sm md:text-base font-bold whitespace-nowrap'>
                        ${m.scoreA} - ${m.scoreB}
                    </td>
                    <td class='${bClass} text-sm md:text-base'>${m.teamB}</td>
                  </tr>`;
      });
      html += '</tbody></table></div></div>';
      return html;
    }

    function renderKnockout(semis, final) {
      const c = document.getElementById('knockout');
      // Responsive Title: text-xl mobile, text-2xl desktop
      let html = `<h2 class='text-xl md:text-2xl font-bold text-green-700 mb-3 text-center'>Knock-out</h2>`; 
      
      if (semis) html += renderMatchList(semis, 'Bán Kết');
      
      if (final) {
        // Vô Địch Box: Responsive Padding & Font
        html += `<div class='winner-box champion-box p-4 md:p-6 mt-4 md:mt-6 rounded-xl shadow text-center'>
          <h3 class='text-xl md:text-2xl font-extrabold text-yellow-700 mb-2 animate-pulse'>🏆 Vô Địch</h3>
          <p class='text-base md:text-lg font-semibold text-gray-800 mb-1'>${final.winner}</p>
          <p class='text-xs md:text-sm text-gray-700'>${final.teamA} (${final.scoreA}) vs (${final.scoreB}) ${final.teamB}</p>
        </div>
        
        <!-- Á Quân Box: Responsive Padding & Font -->
        <div class='winner-box runnerup-box p-3 md:p-4 mt-3 md:mt-4 rounded-xl shadow text-center'>
          <h3 class='text-lg md:text-xl font-semibold text-gray-700 mb-1'>🥈 Á Quân</h3>
          <p class='text-base md:text-lg font-medium text-gray-800'>${final.runnerUp}</p>
        </div>`;
      }
      
      if (Array.isArray(semis) && semis.length > 0) {
        const losers = semis.map(s => s.loser).filter(l => l);
        if (losers.length > 0) {
          // Đồng hạng 3 Box: Responsive Padding & Font
          html += `<div class='bg-amber-50 p-3 md:p-4 mt-3 rounded-xl shadow text-center'>
            <h3 class='text-base md:text-lg font-semibold text-amber-700 mb-2'>🥉 Giải Đồng hạng 3</h3>
            <p>${losers.join(' và ')}</p>
          </div>`;
        }
      }
      c.innerHTML = html;
    }

    // Khởi tạo đầu tiên và đặt hẹn giờ
    document.addEventListener('DOMContentLoaded', () => {
        goToSection(0); // Đảm bảo bắt đầu từ tab 0 và thiết lập vị trí carousel
        setInterval(fetchData, REFRESH_INTERVAL);
        fetchData();
    });
  </script>
</body>
</html>
