<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pickleball Data Sync (GitHub API)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background:#f8f9fa; padding:2rem; }
  .card { border-radius:12px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
  textarea { font-family: monospace; white-space: pre; }
</style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">🏓 Pickleball Data Sync (GitHub API)</h2>

  <!-- Cấu hình GitHub -->
  <div class="card p-3 mb-4">
    <h5>🔧 Cấu hình GitHub</h5>
    <div class="mb-3">
      <label class="form-label">👤 Chủ sở hữu (owner)</label>
      <input id="owner" type="text" class="form-control" placeholder="VD: tinle">
    </div>
    <div class="mb-3">
      <label class="form-label">📁 Tên kho (repository)</label>
      <input id="repo" type="text" class="form-control" placeholder="VD: Pickleball">
    </div>
    <div class="mb-3">
      <label class="form-label">📄 Đường dẫn file trong repo</label>
      <input id="filePath" type="text" class="form-control" value="data/players.json">
      <small class="text-muted">Mặc định: <code>data/players.json</code></small>
    </div>
    <div class="mb-3">
      <label class="form-label">🔑 Token truy cập cá nhân (PAT)</label>
      <input id="token" type="password" class="form-control" placeholder="Dán token GitHub tại đây">
    </div>
    <button id="saveConfig" class="btn btn-primary">💾 Lưu cấu hình</button>
  </div>

  <!-- Quản lý dữ liệu -->
  <div class="card p-3">
    <h5>📄 Quản lý dữ liệu JSON</h5>
    <textarea id="jsonData" rows="12" class="form-control mb-3" placeholder="Dữ liệu JSON sẽ hiển thị ở đây..."></textarea>
    <div class="d-flex gap-2 flex-wrap">
      <button id="loadBtn" class="btn btn-success">⬇️ Tải dữ liệu</button>
      <button id="saveBtn" class="btn btn-warning">⬆️ Ghi dữ liệu</button>
      <button id="formatBtn" class="btn btn-secondary">🧹 Định dạng JSON</button>
      <button id="clearCfgBtn" class="btn btn-outline-danger">🗑 Xoá cấu hình</button>
    </div>
    <div id="status" class="mt-3 text-muted"></div>
  </div>
</div>

<script>
function showStatus(msg, type = 'info') {
  const el = document.getElementById('status');
  el.innerText = msg;
  el.style.color = type === 'error' ? 'red' : (type === 'success' ? 'green' : 'gray');
}

function saveConfig() {
  const cfg = {
    owner: document.getElementById('owner').value.trim(),
    repo: document.getElementById('repo').value.trim(),
    token: document.getElementById('token').value.trim(),
    filePath: document.getElementById('filePath').value.trim() || 'data/players.json'
  };
  localStorage.setItem('githubConfig', JSON.stringify(cfg));
  showStatus('✅ Cấu hình đã được lưu!', 'success');
}

function loadConfig() {
  const cfg = JSON.parse(localStorage.getItem('githubConfig') || '{}');
  document.getElementById('owner').value = cfg.owner || '';
  document.getElementById('repo').value = cfg.repo || '';
  document.getElementById('token').value = cfg.token || '';
  document.getElementById('filePath').value = cfg.filePath || 'data/players.json';
}

function clearConfig() {
  localStorage.removeItem('githubConfig');
  showStatus('🗑 Cấu hình đã được xoá.', 'info');
}

async function loadData() {
  const cfg = JSON.parse(localStorage.getItem('githubConfig') || '{}');
  if (!cfg.token || !cfg.owner || !cfg.repo)
    return alert('⚠️ Vui lòng nhập đầy đủ cấu hình!');

  showStatus('⏳ Đang tải dữ liệu...');
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.filePath}`;
  
  try {
    const res = await fetch(url, {
      headers: { "Authorization": `token ${cfg.token}`, "Accept": "application/vnd.github.v3+json" }
    });
    if (!res.ok) throw new Error(`Không thể tải dữ liệu (${res.status})`);
    const data = await res.json();
    const decoded = new TextDecoder("utf-8").decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
    const pretty = JSON.stringify(JSON.parse(decoded), null, 2);
    document.getElementById('jsonData').value = pretty;
    showStatus(`✅ Đã tải dữ liệu từ ${cfg.filePath}`, 'success');
  } catch (err) {
    showStatus('❌ ' + err.message, 'error');
  }
}

async function saveData() {
  const cfg = JSON.parse(localStorage.getItem('githubConfig') || '{}');
  if (!cfg.token || !cfg.owner || !cfg.repo)
    return alert('⚠️ Vui lòng nhập đầy đủ cấu hình!');

  showStatus('💾 Đang ghi dữ liệu lên GitHub...');
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.filePath}`;
  
  try {
    const getRes = await fetch(url, {
      headers: { "Authorization": `token ${cfg.token}`, "Accept": "application/vnd.github.v3+json" }
    });
    const json = await getRes.json();
    const sha = json.sha;
    const newContent = btoa(unescape(encodeURIComponent(document.getElementById('jsonData').value)));

    const update = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `token ${cfg.token}`,
        "Accept": "application/vnd.github.v3+json",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Cập nhật dữ liệu (${cfg.filePath}) qua Pickleball WebApp`,
        content: newContent,
        sha: sha
      })
    });
    const result = await update.json();
    if (result.commit)
      showStatus(`✅ Ghi dữ liệu thành công vào ${cfg.filePath}`, 'success');
    else
      showStatus('❌ Ghi thất bại: ' + (result.message || 'Không rõ lỗi'), 'error');
  } catch (err) {
    showStatus('❌ ' + err.message, 'error');
  }
}

function formatJSON() {
  try {
    const formatted = JSON.stringify(JSON.parse(document.getElementById('jsonData').value), null, 2);
    document.getElementById('jsonData').value = formatted;
    showStatus('✨ JSON đã được định dạng!', 'success');
  } catch (e) {
    showStatus('⚠️ JSON không hợp lệ, không thể định dạng.', 'error');
  }
}

document.getElementById('saveConfig').onclick = saveConfig;
document.getElementById('loadBtn').onclick = loadData;
document.getElementById('saveBtn').onclick = saveData;
document.getElementById('formatBtn').onclick = formatJSON;
document.getElementById('clearCfgBtn').onclick = clearConfig;
loadConfig();
</script>
</body>
</html>
