<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V13 JSON Sync</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { width:64px; height:64px; object-fit:contain; border-radius:8px; border:1px solid #e6eefc; padding:6px; background:#fff; }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    .match-score-cell input { width:45px; text-align:center; padding:0.1rem; }
    @media (max-width: 576px) {.match-score-cell input { width:35px; }}
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ngày thi đấu: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState" class="text-danger">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">Tổng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches">Vòng Bảng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals">Vòng Chung Kết</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results">Kết quả Chung cuộc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config">Cấu hình</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
      <div id="overviewContent">Đang tải dữ liệu...</div>
    </div>
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-2 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">Tạo lịch Tối ưu</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">Tạo lịch Cố định</button>
        <button class="btn btn-sm btn-info" onclick="document.getElementById('fileInput').click()">Import CSV</button>
        <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export CSV</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">Điền kết quả tự động</button>
      </div>
      <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA">Chưa có lịch.</div>
      <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB">Chưa có lịch.</div>
      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">Tạo Lịch Chung kết</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
      <div id="semifinalMatches">Chưa có bán kết.</div>
      <div id="finalMatch" class="mt-4">Chưa có chung kết.</div>
    </div>

    <div class="tab-pane fade p-3" id="results">
      <div id="rankingTables" class="ranking-container"></div>
      <hr>
      <p id="champion"></p><p id="runnerUp"></p><p id="thirdPlace"></p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <p>Nhập cấu hình GitHub để lưu/truy xuất dữ liệu JSON.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="GitHub Token">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">Lưu cấu hình</button>
        <button class="btn btn-success" onclick="checkConnection()">Kiểm tra & Tải</button>
        <button class="btn btn-warning" onclick="exportAllJSON()">Xuất toàn bộ dữ liệu (JSON)</button>
      </div>
      <div id="configStatus" class="mt-2"></div>
    </div>
  </div>
</div>

<div class="modal fade" id="customAlertModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="customAlertModalLabel">Thông báo</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="customAlertModalBody"></div>
    <div class="modal-footer"><button class="btn btn-primary" data-bs-dismiss="modal">Đóng</button></div>
  </div></div>
</div>

<script>
// ==================== DỮ LIỆU CHÍNH ====================
let state = {
  mixedTeams:["Hậu/Dũng","Hạnh/Tiến","Giang/Long","Huyền/Luân","Linh/M.Hùng","Hường/Đạt"],
  maleTeams:["Tiệp/Thủy","Phương/Thanh","Triều/Minh","Tín/Khiêm","Ánh/Toàn","Hiển/P.Hùng"],
  matchesA:[], matchesB:[], tableA:[], tableB:[],
  semifinals:[
    {id:'SF1',teamA:'Nhất A',teamB:'Nhất B',scoreA:null,scoreB:null,winner:null,loser:null,time:'16:30',court:'Sân 1'},
    {id:'SF2',teamA:'Nhì B',teamB:'Nhì A',scoreA:null,scoreB:null,winner:null,loser:null,time:'16:30',court:'Sân 2'}
  ],
  final:{id:'F',teamA:'Thắng SF1',teamB:'Thắng SF2',scoreA:null,scoreB:null,winner:null,runnerUp:null,time:'17:00',court:'Sân 1'},
  config:{}
};
let stateChanged=false, currentSha=null, autoSaveInterval=null;

// ==================== TIỆN ÍCH ====================
function showModal(title,body){document.getElementById('customAlertModalLabel').textContent=title;document.getElementById('customAlertModalBody').innerHTML=body;new bootstrap.Modal(document.getElementById('customAlertModal')).show();}
function b64EncodeUnicode(str){return btoa(unescape(encodeURIComponent(str)));}
function b64DecodeUnicode(str){return decodeURIComponent(escape(atob(str)));}

// ==================== GITHUB I/O ====================
async function fetchFileSha(cfg){
  const url=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
  const r=await fetch(url,{headers:{'Authorization':`token ${cfg.token}`,'Accept':'application/vnd.github.v3+json'}});
  if(r.status===404)return{sha:null};
  if(!r.ok)throw new Error(`Lỗi lấy SHA: ${r.statusText}`);
  const d=await r.json(); currentSha=d.sha; return{sha:d.sha,content:d.content};
}

async function saveToGitHub(){
  if(!stateChanged)return;
  const cfg=state.config;
  if(!cfg.owner||!cfg.repo||!cfg.token){document.getElementById('autoState').textContent='Thiếu Config';return;}
  document.getElementById('autoState').textContent='Đang lưu...';
  const api=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
  const content=b64EncodeUnicode(JSON.stringify(state,null,2));
  try{
    const f=await fetchFileSha(cfg);
    const payload={message:`[Auto-save] ${new Date().toLocaleString('vi-VN')}`,content:content,sha:f.sha};
    const res=await fetch(api,{method:'PUT',headers:{'Authorization':`token ${cfg.token}`,'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok)throw new Error(res.statusText);
    stateChanged=false;
    document.getElementById('autoState').textContent='Đã Lưu';
    document.getElementById('lastSaved').textContent=`Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
  }catch(e){console.error(e);document.getElementById('autoState').textContent='Lỗi Lưu';}
}

async function loadFromGitHub(){
  const cfg=state.config;
  if(!cfg.owner||!cfg.repo||!cfg.token)return;
  try{
    updateStatus('configStatus','info','Đang tải dữ liệu từ GitHub...');
    const res=await fetchFileSha(cfg);
    if(res.content){
      const data=JSON.parse(b64DecodeUnicode(res.content));
      Object.assign(state,data);
      renderMatches();tinhVaCapNhatXepHang();renderFinals();renderFinalResults();renderOverview();
      updateStatus('configStatus','success','Tải dữ liệu thành công!');
      document.getElementById('lastSaved').textContent=`Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
    }else updateStatus('configStatus','warning','File chưa tồn tại.');
    startAutoSave();
  }catch(e){updateStatus('configStatus','danger',e.message);}
}

function exportAllJSON(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`TKD_full_data_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  showModal('Xuất JSON thành công','Toàn bộ dữ liệu đã được tải xuống.');
}

// ==================== CẤU HÌNH ====================
function saveConfig(){
  const cfg={owner:cfgOwner.value,repo:cfgRepo.value,folder:cfgFolder.value,file:cfgFile.value,token:cfgToken.value};
  state.config=cfg; localStorage.setItem('pkb_config',JSON.stringify(cfg));
  updateStatus('configStatus','success','Đã lưu cấu hình.');
}
function loadConfig(){const s=localStorage.getItem('pkb_config');if(s){state.config=JSON.parse(s);cfgOwner.value=state.config.owner||'';cfgRepo.value=state.config.repo||'';cfgFolder.value=state.config.folder||'data';cfgFile.value=state.config.file||'state.json';cfgToken.value=state.config.token||'';}}
async function checkConnection(){if(!state.config.owner||!state.config.repo||!state.config.token)return updateStatus('configStatus','warning','Thiếu thông tin.');await loadFromGitHub();}
function updateStatus(id,type,msg){document.getElementById(id).innerHTML=`<div class="alert alert-${type} p-2">${msg}</div>`;}
function startAutoSave(){if(autoSaveInterval)clearInterval(autoSaveInterval);autoSaveInterval=setInterval(saveToGitHub,60000);document.getElementById('autoState').textContent='Hoạt động';}

// ==================== KHỞI TẠO ====================
window.onload=()=>{loadConfig();if(state.config.token)loadFromGitHub();else{renderOverview();renderMatches();renderFinals();renderFinalResults();tinhVaCapNhatXepHang();startAutoSave();}};

// (Các hàm render, tạo lịch, tính điểm, ... giữ nguyên như bản bạn gửi, không thay đổi)
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
