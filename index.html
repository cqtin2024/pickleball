<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>github Data Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #fafafa; padding: 20px; }
    .card { margin-bottom: 20px; }
    textarea, input { font-family: monospace; }
    table { font-size: 14px; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="mb-4 text-center">üèì Pickleball Data Viewer</h3>

  <!-- C·∫•u h√¨nh -->
  <div class="card p-3">
    <h5>C·∫•u h√¨nh GitHub</h5>
    <div class="row g-2">
      <div class="col-md-3"><input id="owner" class="form-control" placeholder="Owner (VD: your-username)"></div>
      <div class="col-md-3"><input id="repo" class="form-control" placeholder="Repo (VD: Pickleball)"></div>
      <div class="col-md-3"><input id="folder" class="form-control" placeholder="Th∆∞ m·ª•c (VD: data)" value="data"></div>
      <div class="col-md-3"><input id="file" class="form-control" placeholder="T√™n file (VD: players.json)" value="players.json"></div>
    </div>
    <div class="mt-2"><input id="token" type="password" class="form-control" placeholder="D√°n GitHub Token t·∫°i ƒë√¢y"></div>
    <div class="mt-3 text-end">
      <button class="btn btn-primary me-2" onclick="loadData()">üîÑ ƒê·ªçc d·ªØ li·ªáu</button>
      <button class="btn btn-success" onclick="saveData()">üíæ Ghi d·ªØ li·ªáu</button>
    </div>
  </div>

  <!-- Hi·ªÉn th·ªã d·ªØ li·ªáu -->
  <div class="card p-3">
    <h5>D·ªØ li·ªáu hi·ªÉn th·ªã</h5>
    <div id="dataArea" class="table-responsive border p-2 bg-white rounded"></div>
  </div>
</div>

<script>
async function loadData() {
  const owner = document.getElementById('owner').value.trim();
  const repo = document.getElementById('repo').value.trim();
  const folder = document.getElementById('folder').value.trim();
  const file = document.getElementById('file').value.trim();
  const token = document.getElementById('token').value.trim();
  const dataArea = document.getElementById('dataArea');

  if (!owner || !repo || !file || !token) {
    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin: Owner, Repo, File, Token!');
    return;
  }

  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${file}`;

  try {
    const res = await fetch(url, {
      headers: { Authorization: `token ${token}` }
    });
    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ ƒë·ªçc file tr√™n GitHub");
    const json = await res.json();
    const content = atob(json.content);
    
    let data;
    if (file.endsWith('.csv')) {
      data = parseCSV(content);
      renderTable(data);
    } else {
      data = JSON.parse(content);
      renderTableFromJSON(data);
    }
  } catch (err) {
    dataArea.innerHTML = `<div class='text-danger'>‚ùå L·ªói: ${err.message}</div>`;
  }
}

function parseCSV(content) {
  const lines = content.trim().split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  return lines.slice(1).map(line => {
    const values = line.split(',');
    const obj = {};
    headers.forEach((h, i) => obj[h] = values[i] ? values[i].trim() : '');
    return obj;
  });
}

function renderTable(data) {
  if (!data.length) return document.getElementById('dataArea').innerHTML = "Kh√¥ng c√≥ d·ªØ li·ªáu.";
  const headers = Object.keys(data[0]);
  let html = "<table class='table table-bordered table-striped'>";
  html += "<thead><tr>" + headers.map(h => `<th>${h}</th>`).join('') + "</tr></thead><tbody>";
  html += data.map(row => "<tr>" + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + "</tr>").join('');
  html += "</tbody></table>";
  document.getElementById('dataArea').innerHTML = html;
}

function renderTableFromJSON(data) {
  if (Array.isArray(data)) {
    renderTable(data);
  } else if (typeof data === 'object') {
    const rows = Object.entries(data).map(([k, v]) => ({ Tr∆∞·ªùng: k, Gi√°_tr·ªã: JSON.stringify(v) }));
    renderTable(rows);
  } else {
    document.getElementById('dataArea').innerHTML = `<pre>${data}</pre>`;
  }
}

async function saveData() {
  const owner = document.getElementById('owner').value.trim();
  const repo = document.getElementById('repo').value.trim();
  const folder = document.getElementById('folder').value.trim();
  const file = document.getElementById('file').value.trim();
  const token = document.getElementById('token').value.trim();
  
  if (!owner || !repo || !file || !token) {
    alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
    return;
  }

  const newContent = prompt("Nh·∫≠p n·ªôi dung JSON m·ªõi ƒë·ªÉ l∆∞u:", "{}");
  if (!newContent) return;

  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${folder}/${file}`;
  const getRes = await fetch(url, { headers: { Authorization: `token ${token}` } });
  const getData = await getRes.json();
  const sha = getData.sha;

  const body = {
    message: "C·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ Web App",
    content: btoa(unescape(encodeURIComponent(newContent))),
    sha: sha
  };

  const res = await fetch(url, {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (res.ok) alert("‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ghi th√†nh c√¥ng l√™n GitHub!");
  else alert("‚ùå Ghi d·ªØ li·ªáu th·∫•t b·∫°i!");
}
</script>
</body>
</html>
