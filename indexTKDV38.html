<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 ‚Äî Qu·∫£n l√Ω gi·∫£i Pickleball V26 GitHub (Fix L·ªói X√≥a ƒêi·ªÉm V√≤ng B·∫£ng)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ng√†y thi ƒë·∫•u: 18/10/2025 (**V26**)</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save (30s): <span id="autoState" class="text-danger">T·∫Øt</span></div>
      <div id="lastSaved" class="text-end status">Ch∆∞a l∆∞u</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">T·ªïng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">V√≤ng B·∫£ng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals" onclick="renderFinals()">V√≤ng Chung K·∫øt</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" onclick="tinhVaCapNhatXepHang(); renderFinalResults();">K·∫øt qu·∫£ Chung cu·ªôc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">C·∫•u h√¨nh</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Ch·∫ø ƒë·ªô xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo B·∫£ng ƒë·∫•u</option>
            <option value="court" selected>Theo S√¢n thi ƒë·∫•u</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import L·ªãch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export L·ªãch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">B·∫£ng A (Nam - N·ªØ)</h6><div id="tableMatchesA">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
        
        <h6 class="mt-4">B·∫£ng B (Nam)</h6><div id="tableMatchesB">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">L√™n l·ªãch V√≤ng Chung k·∫øt (T·ª± ƒë·ªông h√≥a)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">V√≤ng B√°n k·∫øt (SF1: 16:40, SF2: 17:05, S√¢n 3)</h6>
            <div id="semifinalMatches">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u b√°n k·∫øt. K·∫øt qu·∫£ V√≤ng B·∫£ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch.</div>

            <h6 class="mt-4">Tr·∫≠n Chung k·∫øt (17:30, S√¢n 3)</h6>
            <div id="finalMatch">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u chung k·∫øt.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">B·∫£ng x·∫øp h·∫°ng V√≤ng B·∫£ng (∆Øu ti√™n: W > ƒê·ªëi ƒë·∫ßu > Hi·ªáu s·ªë > T·ªïng ƒëi·ªÉm)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hi·ªáu Chung cu·ªôc</h5>
        <p id="champion">V√¥ ƒë·ªãch: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="runnerUp">√Å qu√¢n: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="thirdPlace">H·∫°ng Ba ƒê·ªìng H·∫°ng: ƒêang ch·ªù k·∫øt qu·∫£...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">C√¥ng c·ª• L·∫≠p & ƒêi·ªÅn L·ªãch Thi ƒë·∫•u</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">T·∫°o l·ªãch thi ƒë·∫•u T·ªëi ∆∞u (T·ª± ƒë·ªông)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">T·∫£i l·ªãch M·∫´u (**CalendarTKD30**)</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">ƒêi·ªÅn k·∫øt qu·∫£ T·ª± ƒë·ªông (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">X√≥a To√†n b·ªô L·ªãch</button>
      </div>
      
      <hr>
      
      <h5 class="mt-4">üßπ C√¥ng c·ª• X√≥a K·∫øt qu·∫£ V√≤ng B·∫£ng</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
          <button class="btn btn-sm btn-outline-danger" onclick="clearGroupScores('A')">X√≥a K·∫øt qu·∫£ B·∫£ng A</button>
          <button class="btn btn-sm btn-outline-danger" onclick="clearGroupScores('B')">X√≥a K·∫øt qu·∫£ B·∫£ng B</button>
          <button class="btn btn-sm btn-danger ms-auto" onclick="clearGroupScores('ALL')">X√≥a To√†n b·ªô V√≤ng B·∫£ng</button>
      </div>
      <div id="clearScoreStatus"></div>
      <hr>
      <h5 class="mt-4">‚öôÔ∏è C·∫•u h√¨nh S√¢n thi ƒë·∫•u & L·ªãch T·ªëi ∆∞u</h5>
      <p class="text-muted small">Qu·∫£n l√Ω danh s√°ch s√¢n thi ƒë·∫•u. S√¢n ƒë∆∞·ª£c g√°n lo·∫°i b·∫£ng ƒë·∫•u (A/B) ƒë·ªÉ ph·ª•c v·ª• ch·ª©c nƒÉng t·∫°o l·ªãch T·ªëi ∆∞u.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Th√™m S√¢n M·ªõi</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">T·∫£i c·∫•u h√¨nh M·∫∑c ƒë·ªãnh</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>
      
      <h5 class="mt-4">üõ†Ô∏è C·∫•u h√¨nh T·ªëi ∆∞u L·ªãch thi ƒë·∫•u</h5>
      <div class="row g-2 mb-4">
        <div class="col-md-6">
          <label for="preferredCourtType" class="form-label">∆Øu ti√™n S√¢n n√†o cho tr·∫≠n ƒë·∫ßu ti√™n (Ch·ª©c nƒÉng T·∫°o l·ªãch T·ªëi ∆∞u)?</label>
          <select id="preferredCourtType" class="form-select" onchange="updatePreferredCourtType()">
            <option value="mixed">B·∫£ng A (Nam - N·ªØ) - M·∫∑c ƒë·ªãnh</option>
            <option value="male">B·∫£ng B (Nam)</option>
          </select>
          <div class="form-text">X√°c ƒë·ªãnh lo·∫°i s√¢n s·∫Ω ƒë∆∞·ª£c ∆∞u ti√™n g√°n tr·∫≠n ƒë·∫•u ƒë·∫ßu ti√™n trong thu·∫≠t to√°n t·∫°o l·ªãch.</div>
        </div>
        <div class="col-md-6">
            <label class="form-label">C√¥ng c·ª• Xu·∫•t/L∆∞u D·ªØ li·ªáu</label>
            <div class="d-flex gap-2">
                 <button class="btn btn-success" onclick="saveToGitHub(true)">C·∫≠p nh·∫≠t l√™n GitHub ngay</button>
                 <button class="btn btn-secondary" onclick="exportDataToJson()">Xu·∫•t t·∫•t c·∫£ ra JSON</button>
            </div>
            <div class="form-text">L∆∞u tr·∫°ng th√°i hi·ªán t·∫°i (state.json) l√™n GitHub ho·∫∑c t·∫£i v·ªÅ m√°y.</div>
        </div>
      </div>
      <hr>
      <h5 class="mt-4">üíæ C·∫•u h√¨nh K·∫øt n·ªëi GitHub</h5>
      <p class="text-muted">Nh·∫≠p th√¥ng tin kho l∆∞u tr·ªØ GitHub ƒë·ªÉ t·ª± ƒë·ªông l∆∞u tr·ªØ d·ªØ li·ªáu gi·∫£i ƒë·∫•u (Auto-save: 30s).</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (V√≠ d·ª•: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (V√≠ d·ª•: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="D√°n GitHub Personal Access Token (PAT) t·∫°i ƒë√¢y">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">L∆∞u c·∫•u h√¨nh Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Ki·ªÉm tra & T·∫£i D·ªØ li·ªáu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">üîë H∆∞·ªõng d·∫´n l·∫•y GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy c·∫≠p <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p).</li>
                <li>Ch·ªçn **Generate new token** (ho·∫∑c **Generate new token (classic)** n·∫øu b·∫°n d√πng t√†i kho·∫£n c≈©).</li>
                <li>**T√™n Token:** ƒê·∫∑t t√™n d·ªÖ nh·ªõ (v√≠ d·ª•: `TKDManager_AutoSave`).</li>
                <li>**Th·ªùi h·∫°n:** Ch·ªçn t√πy √Ω (n√™n ch·ªçn 90 ng√†y ho·∫∑c T√πy ch·ªânh).</li>
                <li>**Ph·∫°m vi (Scopes):** **B·∫ÆT BU·ªòC** t√≠ch ch·ªçn √¥ **`repo`** (cho ph√©p truy c·∫≠p v√†o kho l∆∞u tr·ªØ).</li>
                <li>Nh·∫•n **Generate token** v√† **SAO CH√âP** chu·ªói Token v·ª´a ƒë∆∞·ª£c t·∫°o.</li>
                <li>D√°n chu·ªói Token ƒë√≥ v√†o √¥ "D√°n GitHub Personal Access Token (PAT) t·∫°i ƒë√¢y" b√™n tr√™n.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">‚ö†Ô∏è **L∆∞u √Ω:** Token ch·ªâ hi·ªÉn th·ªã **M·ªòT L·∫¶N**. H√£y sao ch√©p ngay l·∫≠p t·ª©c v√† gi·ªØ b√≠ m·∫≠t. N·∫øu m·∫•t, b·∫°n ph·∫£i t·∫°o l·∫°i Token m·ªõi.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Th√™m/S·ª≠a C·∫•u h√¨nh S√¢n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">T√™n S√¢n</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Gi·ªù B·∫Øt ƒê·∫ßu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Th·ªùi L∆∞·ª£ng T·ªëi ƒêa (Ph√∫t)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              D√†nh cho B·∫£ng A (Nam - N·ªØ)
            </label>
            <div class="form-text">N·∫øu kh√¥ng ch·ªçn, s√¢n s·∫Ω d√†nh cho B·∫£ng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">L∆∞u Thay ƒê·ªïi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Th√¥ng b√°o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        N·ªôi dung th√¥ng b√°o
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 

<script>
// D·ªØ li·ªáu l·ªãch c·ªë ƒë·ªãnh t·ª´ file CalendarTKD30.csv (ƒê√É C·∫¨P NH·∫¨T theo y√™u c·∫ßu)
const FIXED_SCHEDULE_CSV = `teamA,teamB,time,court,bang,scoreA,scoreB
Tri·ªÅu/Minh,Hi·ªÉn/P.H√πng,14:00,S√¢n 1,B,,
Giang/Long,H∆∞·ªùng/ƒê·∫°t,14:00,S√¢n 2,A,,
H·∫≠u/D≈©ng,H·∫°nh/Ti·∫øn,14:00,S√¢n 3,A,,
Huy·ªÅn/Lu√¢n,Linh/M.H√πng,14:00,S√¢n 7,A,,
Ti·ªáp/Th·ªßy,Ph∆∞∆°ng/Thanh,14:15,S√¢n 1,B,,
T√≠n/Khi√™m,√Ånh/To√†n,14:15,S√¢n 2,B,,
H·∫≠u/D≈©ng,H∆∞·ªùng/ƒê·∫°t,14:15,S√¢n 3,A,,
Giang/Long,Huy·ªÅn/Lu√¢n,14:15,S√¢n 7,A,,
Tri·ªÅu/Minh,T√≠n/Khi√™m,14:30,S√¢n 1,B,,
Ti·ªáp/Th·ªßy,Hi·ªÉn/P.H√πng,14:30,S√¢n 2,B,,
H·∫°nh/Ti·∫øn,Linh/M.H√πng,14:30,S√¢n 3,A,,
Ph∆∞∆°ng/Thanh,√Ånh/To√†n,14:30,S√¢n 7,B,,
Huy·ªÅn/Lu√¢n,H∆∞·ªùng/ƒê·∫°t,14:45,S√¢n 2,A,,
H·∫°nh/Ti·∫øn,Giang/Long,14:45,S√¢n 3,A,,
H·∫≠u/D≈©ng,Linh/M.H√πng,14:45,S√¢n 7,A,,
Ti·ªáp/Th·ªßy,√Ånh/To√†n,15:00,S√¢n 2,B,,
T√≠n/Khi√™m,Hi·ªÉn/P.H√πng,15:00,S√¢n 3,B,,
Ph∆∞∆°ng/Thanh,Tri·ªÅu/Minh,15:15,S√¢n 2,B,,
Giang/Long,Linh/M.H√πng,15:15,S√¢n 3,A,,
H·∫°nh/Ti·∫øn,H∆∞·ªùng/ƒê·∫°t,15:30,S√¢n 2,A,,
H·∫≠u/D≈©ng,Huy·ªÅn/Lu√¢n,15:30,S√¢n 3,A,,
Ti·ªáp/Th·ªßy,T√≠n/Khi√™m,15:45,S√¢n 2,B,,
Ph∆∞∆°ng/Thanh,Hi·ªÉn/P.H√πng,15:45,S√¢n 3,B,,
Tri·ªÅu/Minh,√Ånh/To√†n,16:00,S√¢n 2,B,,
H·∫≠u/D≈©ng,Giang/Long,16:00,S√¢n 3,A,,
H·∫°nh/Ti·∫øn,Huy·ªÅn/Lu√¢n,16:15,S√¢n 2,A,,
Linh/M.H√πng,H∆∞·ªùng/ƒê·∫°t,16:15,S√¢n 3,A,,
Ti·ªáp/Th·ªßy,Tri·ªÅu/Minh,16:30,S√¢n 2,B,,
√Ånh/To√†n,Hi·ªÉn/P.H√πng,16:30,S√¢n 3,B,,
Ph∆∞∆°ng/Thanh,T√≠n/Khi√™m,16:45,S√¢n 2,B,`;

// Bi·∫øn state l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh c·ªßa ·ª©ng d·ª•ng.
let state = { 
  mixedTeams: [], // S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ players.json
  maleTeams: [],  // S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // B·∫£ng x·∫øp h·∫°ng A (S·∫Ω ƒë∆∞·ª£c l∆∞u v√† t·∫£i)
  tableB: [], // B·∫£ng x·∫øp h·∫°ng B (S·∫Ω ƒë∆∞·ª£c l∆∞u v√† t·∫£i)
  
  // Court Configuration
  courts: [
    { name: 'S√¢n 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'S√¢n 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'S√¢n 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'S√¢n 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'S√¢n 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'S√¢n 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'S√¢n 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'S√¢n 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } 
  ],
  
  // LOGIC B√ÅN K·∫æT 
  semifinals: [
    { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:40', court: 'S√¢n 3', winner: null, loser: null }, 
    { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '17:05', court: 'S√¢n 3', winner: null, loser: null }  
  ],
  final: { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:30', court: 'S√¢n 3', winner: null, runnerUp: null }, 
  config: { 
    preferredCourtType: 'mixed' 
  }
};

// ===============================================
// START V26 FIX: ƒê·ªãnh nghƒ©a c√°c Constants cho Reset
// ===============================================
const DEFAULT_SF1 = { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:40', court: 'S√¢n 3', winner: null, loser: null };
const DEFAULT_SF2 = { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '17:05', court: 'S√¢n 3', winner: null, loser: null };
const DEFAULT_FINAL = { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:30', court: 'S√¢n 3', winner: null, runnerUp: null };
// ===============================================
// END V26 FIX: ƒê·ªãnh nghƒ©a c√°c Constants cho Reset
// ===============================================


let stateChanged = false; // Bi·∫øn c·ªù theo d√µi thay ƒë·ªïi d·ªØ li·ªáu
let currentSha = null; // Bi·∫øn l∆∞u tr·ªØ SHA c·ªßa file tr√™n GitHub
let autoSaveInterval = null; // Bi·∫øn l∆∞u tr·ªØ ID c·ªßa interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * H√†m chuy·ªÉn ƒë·ªïi tab
 * @param {string} tabId - ID c·ªßa tab c·∫ßn chuy·ªÉn (v√≠ d·ª•: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // T·∫Øt tab ƒëang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // B·∫≠t tab m·ªõi
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // C·∫≠p nh·∫≠t view cho tab matches n·∫øu chuy·ªÉn ƒë·∫øn
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API Functions ---

/**
 * L·∫•y SHA m·ªõi nh·∫•t c·ªßa file tr√™n GitHub.
 * @param {object} cfg - C·∫•u h√¨nh GitHub (owner, repo, folder, file, token)
 * @param {string} fileName - T√™n file c·∫ßn l·∫•y SHA (m·∫∑c ƒë·ªãnh l√† cfg.file)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Ch·ªâ l∆∞u SHA c·ªßa state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            // L·ªói kh√°c (401, 403, 500...)
            throw new Error(`L·ªói HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`L·ªói Fetch SHA (${fileName}):`, error);
        throw new Error(`L·ªói k·∫øt n·ªëi ho·∫∑c API: ${error.message}`);
    }
}

/**
 * T·∫£i danh s√°ch ƒë·ªôi t·ª´ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'ƒêang t·∫£i danh s√°ch ƒë·ªôi t·ª´ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `T·∫£i danh s√°ch ƒë·ªôi th√†nh c√¥ng (${state.mixedTeams.length + state.maleTeams.length} ƒë·ªôi).`);
                return true;
            } else {
                throw new Error("File players.json kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (thi·∫øu mixedTeams/maleTeams).");
            }
        } else {
            updateStatus('configStatus', 'warning', 'Kh√¥ng t√¨m th·∫•y file players.json. D√πng danh s√°ch ƒë·ªôi kh·ªüi t·∫°o (tr·ªëng).');
            return false;
        }
    } catch (error) {
        console.error("L·ªói khi t·∫£i players.json:", error);
        updateStatus('configStatus', 'danger', `L·ªói t·∫£i danh s√°ch ƒë·ªôi: ${error.message}`);
        return false;
    }
}

/**
 * T·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u (state.json) t·ª´ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
         updateStatus('configStatus', 'warning', 'Thi·∫øu th√¥ng tin k·∫øt n·ªëi GitHub. Vui l√≤ng nh·∫≠p Token/Repo.');
         return;
    }

    // 1. Load Teams (danh s√°ch ƒë·ªôi)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'ƒêang t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u t·ª´ GitHub (state.json)...');
        // fetchFileSha s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t currentSha
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi ƒë√® c√°c gi√° tr·ªã kh√°c ngo√†i teams (teams ƒë√£ ƒë∆∞·ª£c load t·ª´ players.json)
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // NEW: T·∫£i b·∫£ng x·∫øp h·∫°ng n·∫øu c√≥ 
            state.tableA = loadedState.tableA || []; 
            state.tableB = loadedState.tableB || [];
            
            if (loadedState.courts) {
                state.courts = loadedState.courts;
            }
            
            // C·∫•u tr√∫c m·∫∑c ƒë·ªãnh m·ªõi cho b√°n k·∫øt/chung k·∫øt
            const defaultSF1 = { teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', court: 'S√¢n 3', time: '16:40' };
            const defaultSF2 = { teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', court: 'S√¢n 3', time: '17:05' };
            const defaultFinal = { teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', court: 'S√¢n 3', time: '17:30' };

            // Logic t·∫£i cho semifinals/final (gi·ªØ l·∫°i k·∫øt qu·∫£ n·∫øu ƒë√£ c√≥, reset ƒë·ªôi n·∫øu ƒë·ªôi v√≤ng b·∫£ng thay ƒë·ªïi)
            if (loadedState.semifinals && loadedState.semifinals.length === 2) {
                 // N·∫øu ƒë√£ c√≥ ƒë·ªôi th·ª±c t·∫ø ƒë∆∞·ª£c g√°n (v√≠ d·ª•: Team X), gi·ªØ nguy√™n 
                state.semifinals = loadedState.semifinals;
                // N·∫øu l√† tr·∫°ng th√°i r·ªóng default (Nh·∫•t A vs Nh√¨ A), c·∫≠p nh·∫≠t l·∫°i th·ªùi gian v√† s√¢n theo V24
                state.semifinals.forEach((sf, index) => {
                     if (sf.teamA === 'Nh·∫•t A' || sf.teamA === 'Nh·∫•t B') {
                        sf.court = defaultSF1.court;
                        sf.time = index === 0 ? defaultSF1.time : defaultSF2.time;
                    }
                });
            } else {
                 // D√πng default V24
                 state.semifinals = [
                     { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: defaultSF1.time, court: defaultSF1.court, winner: null, loser: null },
                     { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: defaultSF2.time, court: defaultSF2.court, winner: null, loser: null }
                 ];
            }
            
            state.final = loadedState.final || state.final;
            if (!state.final.winner) {
                state.final.court = defaultFinal.court;
                state.final.time = defaultFinal.time;
            }
            
            updateStatus('configStatus', 'success', `T·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u th√†nh c√¥ng t·ª´: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `L·∫ßn t·∫£i: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
             // File state.json kh√¥ng t·ªìn t·∫°i (404)
            updateStatus('configStatus', 'warning', 'File tr·∫°ng th√°i (state.json) ch∆∞a t·ªìn t·∫°i. Vui l√≤ng nh·∫•n L∆∞u ho·∫∑c T·ª± ƒë·ªông l∆∞u ƒë·ªÉ t·∫°o file.');
        }
        
        // Lu√¥n c·∫≠p nh·∫≠t giao di·ªán sau khi t·∫£i xong teams/state (ho·∫∑c d√πng m·∫∑c ƒë·ªãnh)
        tinhVaCapNhatXepHang(); 
        renderMatchesView(); 
        renderFinals();
        renderFinalResults();
        renderOverview();
        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `L·ªói t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u: ${error.message}. Vui l√≤ng ki·ªÉm tra l·∫°i Token/Repo.`);
        console.error("L·ªói khi t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u t·ª´ GitHub:", error);
    }
}

/**
 * L∆∞u tr·∫°ng th√°i gi·∫£i ƒë·∫•u (state.json) l√™n GitHub.
 * @param {boolean} force - B·∫Øt bu·ªôc l∆∞u ngay c·∫£ khi stateChanged l√† false.
 */
async function saveToGitHub(force = false) {
    // B·ªè qua n·∫øu kh√¥ng c√≥ thay ƒë·ªïi v√† kh√¥ng √©p bu·ªôc l∆∞u
    if (!stateChanged && !force) return;
    
    // **CHECKPOINT:** T√≠nh l·∫°i b·∫£ng x·∫øp h·∫°ng tr∆∞·ªõc khi l∆∞u (ƒë·∫£m b·∫£o d·ªØ li·ªáu ranking l√† m·ªõi nh·∫•t)
    tinhVaCapNhatXepHang();

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Kh√¥ng th·ªÉ t·ª± ƒë·ªông l∆∞u: Thi·∫øu c·∫•u h√¨nh GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'T·∫°m d·ª´ng (Thi·∫øu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'ƒêang l∆∞u...';
    if (force) {
         updateStatus('configStatus', 'info', 'ƒêang c·∫≠p nh·∫≠t d·ªØ li·ªáu l√™n GitHub...');
    }


    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Ch·ªâ l∆∞u c√°c tr∆∞·ªùng c·∫ßn thi·∫øt, bao g·ªìm c·∫£ b·∫£ng x·∫øp h·∫°ng (tableA, tableB)
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final,
        // **B·∫¢NG X·∫æP H·∫†NG V√íNG B·∫¢NG ƒê√É T√çNH TO√ÅN**
        tableA: state.tableA,
        tableB: state.tableB 
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Lu√¥n fetch SHA m·ªõi nh·∫•t tr∆∞·ªõc khi c·ªë g·∫Øng l∆∞u
        const result = await fetchFileSha(cfg, cfg.file); // L·∫•y SHA c·ªßa state.json
        const sha = result.sha; 
        
        const payload = {
            message: `${force ? '[Manual-save]' : '[Auto-save]'} C·∫≠p nh·∫≠t tr·∫°ng th√°i gi·∫£i ƒë·∫•u TKD l√∫c ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        // Th√™m SHA ƒë·ªÉ c·∫≠p nh·∫≠t, n·∫øu kh√¥ng c√≥ SHA s·∫Ω t·∫°o m·ªõi
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `L·∫ßn l∆∞u: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'ƒê√£ L∆∞u';
            if (force) {
                 updateStatus('configStatus', 'success', `C·∫≠p nh·∫≠t d·ªØ li·ªáu l√™n GitHub th√†nh c√¥ng l√∫c ${new Date().toLocaleTimeString('vi-VN')}.`);
            }
        } else {
            // X·ª≠ l√Ω l·ªói 409 Conflict
            if (response.status === 409) {
                console.warn("L·ªói 409 Conflict: D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi tr√™n GitHub. ƒêang c·ªë g·∫Øng l·∫•y SHA m·ªõi.");
                
                await fetchFileSha(cfg, cfg.file); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. S·∫Ω th·ª≠ l∆∞u l·∫°i sau 30s.';
                if (force) {
                     updateStatus('configStatus', 'warning', `L·ªói Conflict (D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi tr√™n GitHub). Vui l√≤ng th·ª≠ l·∫°i sau 30s.`);
                }
            } else {
                throw new Error(`L·ªói HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("L·ªói khi l∆∞u l√™n GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'L·ªói L∆∞u';
        if (force) {
             updateStatus('configStatus', 'danger', `L·ªói c·∫≠p nh·∫≠t l√™n GitHub: ${error.message}.`);
        }
    }
}

/**
 * Ki·ªÉm tra k·∫øt n·ªëi v√† T·∫£i d·ªØ li·ªáu
 */
async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Owner, Repo v√† Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'ƒêang ki·ªÉm tra k·∫øt n·ªëi t·ªõi kho l∆∞u tr·ªØ...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`L·ªói truy c·∫≠p kho l∆∞u tr·ªØ. M√£: ${repoResponse.status}. (Ki·ªÉm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', '‚úÖ K·∫øt n·ªëi GitHub th√†nh c√¥ng! ƒêang ti·∫øn h√†nh t·∫£i d·ªØ li·ªáu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `‚ùå Ki·ªÉm tra k·∫øt n·ªëi th·∫•t b·∫°i: ${error.message}.`);
        console.error("L·ªói ki·ªÉm tra k·∫øt n·ªëi:", error);
    }
}

/**
 * C·∫≠p nh·∫≠t c·∫•u h√¨nh ∆∞u ti√™n s√¢n cho t√≠nh nƒÉng T·∫°o l·ªãch T·ªëi ∆∞u v√† l∆∞u v√†o LocalStorage.
 */
function updatePreferredCourtType() {
    const select = document.getElementById('preferredCourtType');
    if (select) {
        state.config.preferredCourtType = select.value;
        saveConfig();
        updateStatus('configStatus', 'success', `ƒê√£ c·∫≠p nh·∫≠t ∆∞u ti√™n s√¢n th√†nh: ${select.options[select.selectedIndex].text}.`);
    }
}

/**
 * Xu·∫•t to√†n b·ªô d·ªØ li·ªáu (state) hi·ªán t·∫°i ra file JSON
 */
function exportDataToJson() {
    // **CHECKPOINT:** T√≠nh l·∫°i b·∫£ng x·∫øp h·∫°ng tr∆∞·ªõc khi xu·∫•t
    tinhVaCapNhatXepHang();
    
    // Ch·ªâ l∆∞u c√°c tr∆∞·ªùng c·∫ßn thi·∫øt, bao g·ªìm c·∫£ tableA/tableB
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final,
        tableA: state.tableA,
        tableB: state.tableB
    };
    const jsonString = JSON.stringify(stateToSave, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `data_tkd_export_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showModal('Export D·ªØ li·ªáu', 'ƒê√£ xu·∫•t to√†n b·ªô d·ªØ li·ªáu gi·∫£i ƒë·∫•u hi·ªán t·∫°i ra file JSON.');
}

// --- C·∫•u h√¨nh & Kh·ªüi t·∫°o ---
function renderConfig() {
    // Ch·ªâ c·∫ßn hi·ªÉn th·ªã c·∫•u h√¨nh s√¢n hi·ªán t·∫°i
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
    document.getElementById('clearScoreStatus').innerHTML = ''; // Clear new status div

    // C·∫≠p nh·∫≠t UI cho preferredCourtType khi v√†o tab config
    const select = document.getElementById('preferredCourtType');
    if (select) {
        select.value = state.config.preferredCourtType || 'mixed';
    }
}

/**
 * Hi·ªÉn th·ªã danh s√°ch s√¢n d∆∞·ªõi d·∫°ng b·∫£ng v·ªõi n√∫t S·ª≠a/X√≥a.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Ch∆∞a c√≥ s√¢n n√†o ƒë∆∞·ª£c c·∫•u h√¨nh.</div>`;
        return;
    }

    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>T√™n S√¢n</th>
                <th>Gi·ªù B·∫Øt ƒê·∫ßu</th>
                <th>Th·ªùi L∆∞·ª£ng Max (Ph√∫t)</th>
                <th>Ph√¢n Lo·∫°i</th>
                <th class="text-center">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>`;
    
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'B·∫£ng A (Nam - N·ªØ)' : 'B·∫£ng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">S·ª≠a</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">X√≥a</button>
            </td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * M·ªü modal th√™m/s·ª≠a s√¢n v√† ƒëi·ªÅn d·ªØ li·ªáu n·∫øu l√† ch·∫ø ƒë·ªô s·ª≠a.
 * @param {number | null} index - Ch·ªâ s·ªë c·ªßa s√¢n c·∫ßn s·ª≠a, ho·∫∑c null n·∫øu th√™m m·ªõi.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';
    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'S·ª≠a C·∫•u h√¨nh S√¢n' : 'Th√™m S√¢n M·ªõi';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Ch·∫ø ƒë·ªô th√™m m·ªõi: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = 180;
        document.getElementById('courtIsMixed').checked = true;
    }
    modal.show();
}

/**
 * L∆∞u thay ƒë·ªïi (th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t) c·∫•u h√¨nh s√¢n.
 */
function saveCourtChanges() {
    const index = document.getElementById('courtIndex').value;
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;
    
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        document.getElementById('courtFormStatus').innerHTML = '<div class="alert alert-danger">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin h·ª£p l·ªá.</div>';
        return;
    }

    const newCourt = { name, startTime, maxDurationMinutes, isMixed };

    if (index !== '') {
        // Ch·∫ø ƒë·ªô s·ª≠a
        state.courts[parseInt(index)] = newCourt;
        updateStatus('courtConfigStatus', 'success', `ƒê√£ c·∫≠p nh·∫≠t c·∫•u h√¨nh s√¢n ${name} th√†nh c√¥ng.`);
    } else {
        // Ch·∫ø ƒë·ªô th√™m m·ªõi
        state.courts.push(newCourt);
        updateStatus('courtConfigStatus', 'success', `ƒê√£ th√™m s√¢n ${name} m·ªõi th√†nh c√¥ng.`);
    }
    
    stateChanged = true;
    saveConfig(); 
    renderCourtList();
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();
}

/**
 * X√≥a m·ªôt s√¢n kh·ªèi danh s√°ch.
 * @param {number} index - Ch·ªâ s·ªë c·ªßa s√¢n c·∫ßn x√≥a.
 */
function deleteCourt(index) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√¢n "${state.courts[index].name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
        const deletedName = state.courts[index].name;
        state.courts.splice(index, 1);
        stateChanged = true;
        saveConfig();
        renderCourtList();
        updateStatus('courtConfigStatus', 'success', `ƒê√£ x√≥a s√¢n ${deletedName} th√†nh c√¥ng.`);
    }
}

/**
 * T·∫£i c·∫•u h√¨nh s√¢n m·∫∑c ƒë·ªãnh.
 */
function loadDefaultCourtConfig() {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën T·∫£i l·∫°i c·∫•u h√¨nh s√¢n M·∫∑c ƒë·ªãnh? M·ªçi thay ƒë·ªïi hi·ªán t·∫°i s·∫Ω b·ªã ghi ƒë√®.')) {
        state.courts = [
            { name: 'S√¢n 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'S√¢n 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'S√¢n 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'S√¢n 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'S√¢n 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'S√¢n 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'S√¢n 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'S√¢n 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } 
        ];
        stateChanged = true;
        saveConfig();
        renderCourtList();
        updateStatus('courtConfigStatus', 'success', 'ƒê√£ t·∫£i c·∫•u h√¨nh s√¢n m·∫∑c ƒë·ªãnh th√†nh c√¥ng.');
    }
}

/**
 * X√≥a to√†n b·ªô l·ªãch thi ƒë·∫•u (C·∫£ V√≤ng B·∫£ng v√† V√≤ng Chung K·∫øt)
 */
function clearAllSchedules() {
    if (confirm("‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò L·ªäCH THI ƒê·∫§U (c·∫£ k·∫øt qu·∫£, l·ªãch, v√≤ng chung k·∫øt)? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.")) {
        state.matchesA = [];
        state.matchesB = [];
        state.tableA = [];
        state.tableB = [];
        
        // Reset V√≤ng Chung k·∫øt v·ªÅ m·∫∑c ƒë·ªãnh
        state.semifinals = [ DEFAULT_SF1, DEFAULT_SF2 ];
        state.final = DEFAULT_FINAL;

        stateChanged = true;
        saveToGitHub();
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals();
        renderOverview();
        showModal('X√≥a th√†nh c√¥ng', 'ƒê√£ x√≥a to√†n b·ªô l·ªãch thi ƒë·∫•u v√† k·∫øt qu·∫£. Vui l√≤ng t·∫°o l·ªãch m·ªõi.');
    }
}

/**
 * X√≥a ƒëi·ªÉm s·ªë c√°c tr·∫≠n ƒë·∫•u V√≤ng B·∫£ng.
 * V26 FIX: Th√™m logic reset V√≤ng Chung k·∫øt
 */
function clearGroupScores(group) {
    const finalsCompleted = state.semifinals.some(sf => sf.winner !== null) || state.final.winner !== null;
    
    // N·∫øu V√≤ng Chung k·∫øt ƒë√£ c√≥ k·∫øt qu·∫£, kh√¥ng cho x√≥a V√≤ng B·∫£ng
    if (finalsCompleted) {
        showModal('L·ªói X√≥a K·∫øt Qu·∫£', 'Kh√¥ng th·ªÉ x√≥a k·∫øt qu·∫£ V√≤ng B·∫£ng. Vui l√≤ng **X√≥a to√†n b·ªô l·ªãch** (·ªü tab C·∫•u h√¨nh) n·∫øu mu·ªën reset V√≤ng Chung k·∫øt, ho·∫∑c x√≥a k·∫øt qu·∫£ V√≤ng CK th·ªß c√¥ng.');
        return;
    }
    
    const message = group === 'ALL' 
        ? "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò k·∫øt qu·∫£ V√≤ng B·∫£ng (B·∫£ng A & B)? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c."
        : `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò k·∫øt qu·∫£ c·ªßa B·∫£ng ${group}? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
    
    if (!confirm(message)) return;

    let clearedCount = 0;
    
    const matchesToClear = [];
    if (group === 'A' || group === 'ALL') matchesToClear.push(...state.matchesA);
    if (group === 'B' || group === 'ALL') matchesToClear.push(...state.matchesB);
    
    matchesToClear.forEach(match => {
        if (match.scoreA !== null || match.scoreB !== null) {
            match.scoreA = null;
            match.scoreB = null;
            match.winner = null;
            match.loser = null;
            clearedCount++;
        }
    });

    if (clearedCount > 0) {
        
        // ===============================================
        // START V26 FIX: Reset V√≤ng Chung K·∫øt
        // ===============================================
        state.semifinals = [ DEFAULT_SF1, DEFAULT_SF2 ];
        state.final = DEFAULT_FINAL;
        // ===============================================
        // END V26 FIX: Reset V√≤ng Chung K·∫øt
        // ===============================================
        
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals(); // C·∫≠p nh·∫≠t giao di·ªán tab Chung k·∫øt
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        updateStatus('clearScoreStatus', 'success', `ƒê√£ x√≥a ${clearedCount} k·∫øt qu·∫£ tr·∫≠n ƒë·∫•u th√†nh c√¥ng. V√≤ng Chung K·∫øt ƒë√£ ƒë∆∞·ª£c Reset.`);
    } else {
        updateStatus('clearScoreStatus', 'info', `Kh√¥ng c√≥ k·∫øt qu·∫£ n√†o c·ªßa B·∫£ng ${group} c·∫ßn x√≥a.`);
    }
}

// ... (c√°c h√†m kh√°c)
</script>
</body>
</html>
