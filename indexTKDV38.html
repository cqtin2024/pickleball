<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V14 GitHub (Court Config)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ngày thi đấu: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState" class="text-danger">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">Tổng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">Vòng Bảng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals" onclick="renderFinals()">Vòng Chung Kết</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" onclick="tinhVaCapNhatXepHang(); renderFinalResults();">Kết quả Chung cuộc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">Cấu hình</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">Đang tải dữ liệu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Chế độ xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo Bảng đấu</option>
            <option value="court" selected>Theo Sân thi đấu</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import Lịch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export Lịch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA">Chưa có lịch thi đấu.</div>
        
        <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB">Chưa có lịch thi đấu.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">Lên lịch Vòng Chung kết (Tự động hóa)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">Vòng Bán kết (16:30, Sân 1-2)</h6>
            <div id="semifinalMatches">Chưa có lịch thi đấu bán kết. Kết quả Vòng Bảng sẽ tự động cập nhật lịch.</div>

            <h6 class="mt-4">Trận Chung kết (17:00, Sân 1)</h6>
            <div id="finalMatch">Chưa có lịch thi đấu chung kết.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">Bảng xếp hạng Vòng Bảng (Cập nhật liên tục)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hiệu Chung cuộc</h5>
        <p id="champion">Vô địch: Đang chờ kết quả...</p>
        <p id="runnerUp">Á quân: Đang chờ kết quả...</p>
        <p id="thirdPlace">Hạng Ba Đồng Hạng: Đang chờ kết quả...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">Công cụ Lập & Điền Lịch Thi đấu</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">Tạo lịch thi đấu Tối ưu (Tự động)</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">Điền kết quả Tự động (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">Xóa Toàn bộ Lịch</button>
      </div>
      
      <hr>

      <h5 class="mt-4">⚙️ Cấu hình Sân thi đấu & Lịch Tối ưu</h5>
      <p class="text-muted small">Quản lý danh sách sân thi đấu. Sân được gán loại bảng đấu (A/B) để phục vụ chức năng tạo lịch Tối ưu.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Thêm Sân Mới</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">Tải cấu hình Mặc định</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>

      <h5 class="mt-4">💾 Cấu hình Kết nối GitHub</h5>
      <p class="text-muted">Nhập thông tin kho lưu trữ GitHub để tự động lưu trữ dữ liệu giải đấu.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (Ví dụ: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (Ví dụ: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="Dán GitHub Personal Access Token (PAT) tại đây">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">Lưu cấu hình Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Kiểm tra & Tải Dữ liệu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">🔑 Hướng dẫn lấy GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy cập <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (Bạn cần đăng nhập).</li>
                <li>Chọn **Generate new token** (hoặc **Generate new token (classic)** nếu bạn dùng tài khoản cũ).</li>
                <li>**Tên Token:** Đặt tên dễ nhớ (ví dụ: `TKDManager_AutoSave`).</li>
                <li>**Thời hạn:** Chọn tùy ý (nên chọn 90 ngày hoặc Tùy chỉnh).</li>
                <li>**Phạm vi (Scopes):** **BẮT BUỘC** tích chọn ô **`repo`** (cho phép truy cập vào kho lưu trữ).</li>
                <li>Nhấn **Generate token** và **SAO CHÉP** chuỗi Token vừa được tạo.</li>
                <li>Dán chuỗi Token đó vào ô "Dán GitHub Personal Access Token (PAT) tại đây" bên trên.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">⚠️ **Lưu ý:** Token chỉ hiển thị **MỘT LẦN**. Hãy sao chép ngay lập tức và giữ bí mật. Nếu mất, bạn phải tạo lại Token mới.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Thêm/Sửa Cấu hình Sân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">Tên Sân</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Giờ Bắt Đầu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Thời Lượng Tối Đa (Phút)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              Dành cho Bảng A (Nam - Nữ)
            </label>
            <div class="form-text">Nếu không chọn, sân sẽ dành cho Bảng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        Nội dung thông báo
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 

<script>
// Hằng số FIXED_SCHEDULE_CSV đã bị loại bỏ

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = { 
  mixedTeams: [], // Sẽ được tải từ players.json
  maleTeams: [],  // Sẽ được tải từ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // Bảng xếp hạng A
  tableB: [], // Bảng xếp hạng B
  
  // NEW: Court Configuration
  courts: [
    { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } // Bảng B (Male)
  ],
  
  // LOGIC BÁN KẾT (ĐÃ ĐIỀU CHỈNH: Nhất A vs Nhì A, Nhất B vs Nhì B)
  semifinals: [
    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null },
  config: {}
};

let stateChanged = false; // Biến cờ theo dõi thay đổi dữ liệu
let currentSha = null; // Biến lưu trữ SHA của file trên GitHub
let autoSaveInterval = null; // Biến lưu trữ ID của interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * Hàm chuyển đổi tab
 * @param {string} tabId - ID của tab cần chuyển (ví dụ: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // Tắt tab đang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // Bật tab mới
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // Cập nhật view cho tab matches nếu chuyển đến
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API Functions ---

/**
 * Lấy SHA mới nhất của file state.json trên GitHub.
 * @param {object} cfg - Cấu hình GitHub (owner, repo, folder, file, token)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Chỉ lưu SHA của state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            throw new Error(`Lỗi khi lấy SHA: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Lỗi Fetch SHA (${fileName}):`, error);
        throw new Error(`Lỗi kết nối hoặc API: ${error.message}`);
    }
}

/**
 * NEW: Tải danh sách đội từ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    // players.json phải nằm cùng thư mục với state.json
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'Đang tải danh sách đội từ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `Tải danh sách đội thành công (${state.mixedTeams.length + state.maleTeams.length} đội).`);
                return true;
            } else {
                throw new Error("File players.json không đúng định dạng (thiếu mixedTeams/maleTeams).");
            }
        } else {
             // 404 hoặc không có content
            updateStatus('configStatus', 'warning', 'Không tìm thấy file players.json. Dùng danh sách đội khởi tạo (trống).');
            return false;
        }
    } catch (error) {
        console.error("Lỗi khi tải players.json:", error);
        updateStatus('configStatus', 'danger', `Lỗi tải danh sách đội: ${error.message}`);
        return false;
    }
}

/**
 * Tải trạng thái giải đấu (state.json) từ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) return;

    // 1. Load Teams (danh sách đội)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'Đang tải trạng thái giải đấu từ GitHub (state.json)...');
        // fetchFileSha sẽ tự động cập nhật currentSha
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi đè các giá trị khác ngoài teams (teams đã được load từ players.json)
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // Tải cấu hình sân (NEW) - nếu không có, giữ nguyên mặc định
            if (loadedState.courts) {
                state.courts = loadedState.courts;
            }
            
            // Xử lý logic tải cho semifinals và final (đảm bảo không ghi đè lịch tự động)
            const loadedSemifinals = loadedState.semifinals;
            
            // Cấu trúc mặc định mới: Nhất A vs Nhì A, Nhất B vs Nhì B
            const defaultSF1 = { teamA: 'Nhất A', teamB: 'Nhì A' };
            const defaultSF2 = { teamA: 'Nhất B', teamB: 'Nhì B' };
            
            if (loadedSemifinals && loadedSemifinals.length === 2 && 
                (loadedSemifinals[0].teamA !== defaultSF1.teamA || loadedSemifinals[0].teamB !== defaultSF1.teamB ||
                 loadedSemifinals[1].teamA !== defaultSF2.teamA || loadedSemifinals[1].teamB !== defaultSF2.teamB)
            ) {
                // Nếu đã có đội thực tế được gán, giữ nguyên (đã tính từ data vòng bảng)
                state.semifinals = loadedSemifinals;
            } else if (loadedSemifinals && loadedSemifinals.length === 2) {
                // Nếu là trạng thái rỗng, vẫn load
                state.semifinals = loadedSemifinals;
            }

            state.final = loadedState.final || state.final;
            
            // Cập nhật giao diện
            renderMatches(); 
            tinhVaCapNhatXepHang();
            renderFinals();
            renderFinalResults();
            renderOverview();
            
            updateStatus('configStatus', 'success', `Tải trạng thái giải đấu thành công từ: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
            updateStatus('configStatus', 'warning', 'File trạng thái (state.json) chưa tồn tại. Vui lòng nhấn Lưu hoặc Tự động lưu để tạo file.');
        }

        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Lỗi tải trạng thái giải đấu: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi khi tải trạng thái giải đấu từ GitHub:", error);
    }
}

async function saveToGitHub() {
    // Bỏ qua nếu không có thay đổi
    if (!stateChanged) return;

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Không thể tự động lưu: Thiếu cấu hình GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Tạm dừng (Thiếu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'Đang lưu...';

    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Chỉ lưu các trường cần thiết, loại bỏ config và table (vì chúng được tính lại)
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Luôn fetch SHA mới nhất trước khi cố gắng lưu
        const result = await fetchFileSha(cfg, cfg.file); // Lấy SHA của state.json
        const sha = result.sha; 
        
        const payload = {
            message: `[Auto-save] Cập nhật trạng thái giải đấu TKD lúc ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        // Chỉ thêm SHA vào payload nếu nó đã tồn tại (để cập nhật), 
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'Đã Lưu';
        } else {
            // Trường hợp lỗi 409 Conflict (SHA cũ)
            if (response.status === 409) {
                console.warn("Lỗi 409 Conflict: Dữ liệu đã thay đổi trên GitHub. Đang cố gắng lấy SHA mới.");
                
                // Lấy lại SHA mới nhất. stateChanged vẫn là true, 
                // để AutoSave interval sẽ thử lại với SHA mới trong lần tiếp theo.
                await fetchFileSha(cfg, cfg.file); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. Sẽ thử lưu lại sau 1 phút.';
            } else {
                throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lưu lên GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Lỗi Lưu';
    }
}

async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui lòng nhập đầy đủ Owner, Repo và Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'Đang kiểm tra kết nối...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`Lỗi truy cập kho lưu trữ. Mã: ${repoResponse.status}. (Kiểm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', 'Kết nối GitHub thành công! Đang tải dữ liệu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Kiểm tra kết nối thất bại: ${error.message}.`);
        console.error("Lỗi kiểm tra kết nối:", error);
    }
}

// --- Cấu hình & Khởi tạo ---

function renderConfig() {
    // Chỉ cần hiển thị cấu hình sân hiện tại
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
}

/**
 * Hiển thị danh sách sân dưới dạng bảng với nút Sửa/Xóa.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Chưa có sân nào được cấu hình.</div>`;
        return;
    }
    
    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>Tên Sân</th>
                <th>Giờ Bắt Đầu</th>
                <th>Thời Lượng Max (Phút)</th>
                <th>Phân Loại</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>`;
        
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'Bảng A (Nam-Nữ)' : 'Bảng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">Xóa</button>
            </td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * Mở modal thêm/sửa sân và điền dữ liệu nếu là chế độ sửa.
 * @param {number | null} index - Chỉ số của sân cần sửa, hoặc null nếu thêm mới.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';

    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'Sửa Cấu hình Sân' : 'Thêm Sân Mới';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Chế độ thêm mới: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = '180';
        document.getElementById('courtIsMixed').checked = true; // Default to Mixed (Bảng A)
    }

    modal.show();
}

/**
 * Lưu thay đổi từ modal vào state.courts
 */
function saveCourtChanges() {
    const indexStr = document.getElementById('courtIndex').value;
    const index = indexStr === '' ? null : parseInt(indexStr);
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;
    const statusDiv = document.getElementById('courtFormStatus');

    // Validation
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui lòng nhập đầy đủ và hợp lệ các trường (Tên, Giờ, Thời lượng > 0).</div>`;
        return;
    }

    // Check for duplicate name (excluding the current edited court)
    const isDuplicate = state.courts.some((c, i) => i !== index && c.name.toLowerCase() === name.toLowerCase() );
    if (isDuplicate) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Tên sân "${name}" đã tồn tại.</div>`;
        return;
    }

    const newCourt = { name, startTime, maxDurationMinutes, isMixed };

    if (index !== null) {
        // Edit mode
        state.courts[index] = newCourt;
    } else {
        // Add mode
        state.courts.push(newCourt);
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();

    // Update UI and save
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', `Đã ${index !== null ? 'cập nhật' : 'thêm'} sân "${name}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
    saveToGitHub();
}

/**
 * Xóa sân khỏi danh sách.
 * @param {number} index - Chỉ số của sân cần xóa.
 */
function deleteCourt(index) {
    if (confirm(`Bạn có chắc chắn muốn xóa sân "${state.courts[index].name}"?`)) {
        const deletedCourtName = state.courts[index].name;
        state.courts.splice(index, 1);
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', `Đã xóa sân "${deletedCourtName}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
        saveToGitHub();
    }
}

/**
 * Tải cấu hình mặc định (phải được cập nhật để dùng logic mới)
 */
function loadDefaultCourtConfig() {
    state.courts = [
        { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }
    ];
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', 'Đã tải cấu hình sân Mặc định. Dữ liệu sẽ được tự động lưu lên GitHub.');
    saveToGitHub();
}

function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'state.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}

function saveConfig(){
    const cfg = {
        owner: document.getElementById('cfgOwner').value,
        repo: document.getElementById('cfgRepo').value,
        folder: document.getElementById('cfgFolder').value,
        file: document.getElementById('cfgFile').value,
        token: document.getElementById('cfgToken').value
    };
    state.config = cfg;
    localStorage.setItem('pkb_config', JSON.stringify(cfg));
    updateStatus('configStatus', 'success', 'Đã lưu cấu hình GitHub vào trình duyệt. Vui lòng Kiểm tra & Tải Dữ liệu.');
}

function updateStatus(id, type, message) {
    const statusDiv = document.getElementById(id);
    statusDiv.innerHTML = `<div class="alert alert-${type} p-2 mt-2">${message}</div>`;
}

function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    if (state.config.token && state.config.owner && state.config.repo) {
        autoSaveInterval = setInterval(saveToGitHub, 60000);
        document.getElementById('autoState').className = 'text-success';
        document.getElementById('autoState').textContent = 'Bật';
    } else {
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Tắt';
    }
}

// --- INITIALIZATION ---
loadConfig();
// checkConnection() sẽ được gọi thủ công hoặc sau khi người dùng nhập token

// --- Match Scheduling Logic (Simplified/Placeholder - Cần bổ sung đầy đủ) ---

// Placeholder cho hàm parse CSV - Giả định parse CSV match-list
function parseCSVToMatches(csv, isMixedGroup) {
    const lines = csv.trim().split('\n');
    if (lines.length <= 1) return [];

    const headers = lines[0].split(',').map(h => h.trim());
    const matchData = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        
        // Cần đảm bảo rằng các cột đủ
        if (values.length < 5) continue; 
        
        const match = {
            teamA: values[0],
            teamB: values[1],
            time: values[2],
            court: values[3],
            bang: values[4],
            scoreA: values[5] ? parseInt(values[5]) : null,
            scoreB: values[6] ? parseInt(values[6]) : null,
            winner: null,
            loser: null
        };
        
        // Đảm bảo chỉ lấy các trận thuộc bảng tương ứng
        if ((isMixedGroup && match.bang === 'A') || (!isMixedGroup && match.bang === 'B')) {
             // Logic tính winner/loser cho các trận có sẵn điểm
            if (match.scoreA !== null && match.scoreB !== null) {
                if (match.scoreA > match.scoreB) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else if (match.scoreB > match.scoreA) {
                    match.winner = match.teamB;
                    match.loser = match.teamA;
                }
            }
            matchData.push(match);
        }
    }
    return matchData;
}

// Hàm Tạo Lịch Cố Định đã bị xóa: taoLichCoDinh()

function taoLichThiDauCungGio() {
    // Hàm này cần logic phức tạp hơn, để trống cho phiên bản hiện tại
    showModal('Thông báo', 'Chức năng Tạo lịch Tối ưu (Tự động) cần danh sách đội (players.json) và logic lập lịch chi tiết. **Vui lòng sử dụng chức năng "Import Lịch (CSV)"** ở tab "Vòng Bảng" để tải lịch thi đấu.');
}

function autoFillScores() {
    // Điền kết quả tự động cho tất cả các trận chưa đấu
    const allMatches = [...state.matchesA, ...state.matchesB, ...state.semifinals, state.final];

    allMatches.forEach(match => {
        if (match.scoreA === null && match.scoreB === null) {
             // Kiểm tra nếu cặp đấu đã được gán đội thực tế
            const isAssigned = match.teamA !== 'Nhất A' && match.teamA !== 'Thắng SF1' && match.teamA !== 'Nhất B';
            
            if (isAssigned) {
                 if (Math.random() < 0.5) {
                    match.scoreA = 15;
                    match.scoreB = Math.floor(Math.random() * 15); // Điểm thua từ 0-14
                } else {
                    match.scoreB = 15;
                    match.scoreA = Math.floor(Math.random() * 15);
                }
                
                // Cập nhật winner/loser (sử dụng lại logic kiểm tra 15 điểm)
                if (match.scoreA === 15 && match.scoreB <= 14) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else if (match.scoreB === 15 && match.scoreA <= 14) {
                    match.winner = match.teamB;
                    match.loser = match.teamA;
                }
                
                if (match.id === 'F') {
                    match.runnerUp = match.loser;
                }
            }
        }
    });


    renderMatchesView();
    renderFinals();
    renderOverview();
    
    stateChanged = true;
    saveToGitHub();
    showModal('Điền kết quả Tự động', 'Đã điền kết quả Tự động cho các trận đấu chưa có điểm. Vui lòng kiểm tra lại để đảm bảo tính chính xác.');
    tinhVaCapNhatXepHang();
    renderFinalResults();
}

function clearAllSchedules() {
     if (confirm("Bạn có chắc chắn muốn XÓA TẤT CẢ LỊCH THI ĐẤU và KẾT QUẢ? Hành động này không thể hoàn tác.")) {
        state.matchesA = [];
        state.matchesB = [];
        state.semifinals = [
            { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null };
        state.tableA = [];
        state.tableB = [];

        renderMatchesView();
        renderFinals();
        renderFinalResults();
        renderOverview();

        stateChanged = true;
        saveToGitHub();
        showModal('Xóa lịch', 'Đã xóa toàn bộ lịch thi đấu và kết quả. Dữ liệu đã được lưu lên GitHub.');
    }
}


function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        
        // Sử dụng parseCSVToMatches để xử lý file được import.
        const importedMatchesA = parseCSVToMatches(csvContent, true);
        const importedMatchesB = parseCSVToMatches(csvContent, false);
        
        if (importedMatchesA.length === 0 && importedMatchesB.length === 0) {
            showModal('Import Lịch', 'Lỗi: Không thể đọc dữ liệu trận đấu từ file CSV. Vui lòng đảm bảo file có header: teamA,teamB,time,court,bang,scoreA,scoreB');
            return;
        }

        state.matchesA = importedMatchesA;
        state.matchesB = importedMatchesB;
        
        // Reset vòng chung kết khi import lịch mới
        state.semifinals = [
            { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null };


        renderMatchesView();
        renderFinals();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal('Import Lịch', `Đã Import thành công ${state.matchesA.length + state.matchesB.length} trận đấu từ file "${file.name}".`);
    };

    reader.readAsText(file);
    // Reset input để có thể import lại cùng file nếu cần
    event.target.value = null; 
}

function exportSchedule() {
    // Tạo mảng dữ liệu xuất
    const header = "teamA,teamB,time,court,bang,scoreA,scoreB\n";
    let data = header;

    // Xuất trận vòng bảng
    [...state.matchesA, ...state.matchesB].forEach(match => {
        const scoreA = match.scoreA !== null ? match.scoreA : '';
        const scoreB = match.scoreB !== null ? match.scoreB : '';
        data += `${match.teamA},${match.teamB},${match.time},${match.court},${match.bang},${scoreA},${scoreB}\n`;
    });
    
    // Tạo Blob và link download
    const blob = new Blob([data], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) { 
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `LichThiDau_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    showModal('Export Lịch', 'Đã xuất lịch thi đấu vòng bảng ra file CSV.');
}


/**
 * Cập nhật điểm và tính toán thắng/thua.
 * @param {string} bang - 'A' hoặc 'B'
 * @param {number} index - Chỉ số trận đấu trong mảng matchesA/B
 * @param {string} teamKey - 'A' hoặc 'B' (chỉ team nào được gán điểm)
 * @param {number} score - Điểm số
 */
function updateMatchScore(bang, index, teamKey, score) {
    const match = (bang === 'A' ? state.matchesA : state.matchesB)[index];
    score = parseInt(score);
    
    if (isNaN(score) || score < 0) {
        // Xóa điểm
        if (teamKey === 'A') {
            match.scoreA = null;
        } else {
            match.scoreB = null;
        }
    } else {
        // Cập nhật điểm
        if (teamKey === 'A') {
            match.scoreA = score;
        } else {
            match.scoreB = score;
        }
    }

    // Cập nhật Winner/Loser nếu cả 2 điểm đã có
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA === 15 && match.scoreB <= 14) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB === 15 && match.scoreA <= 14) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        } else {
            // Trường hợp điểm không hợp lệ (ví dụ: 15-15, 16-14, hoặc < 15) -> reset winner/loser
            match.winner = null;
            match.loser = null;
            if (match.scoreA >= 15 && match.scoreB >= 15 && Math.abs(match.scoreA - match.scoreB) === 1) {
                // Giả định game 15, thắng cách 2. Cần phải có 15-x (x<14) hoặc 16-14, 17-15, ...
                if (match.scoreA > match.scoreB && match.scoreA >= 15 && (match.scoreA - match.scoreB >= 2 || (match.scoreA === 15 && match.scoreB <= 13))) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else if (match.scoreB > match.scoreA && match.scoreB >= 15 && (match.scoreB - match.scoreA >= 2 || (match.scoreB === 15 && match.scoreA <= 13))) {
                     match.winner = match.teamB;
                    match.loser = match.teamA;
                } else if (match.scoreA === match.scoreB && match.scoreA >= 14) {
                    // Xử lý điểm hòa 14-14, 15-15, ...
                    match.winner = null; 
                    match.loser = null;
                }
            } else if (match.scoreA > match.scoreB && match.scoreA === 15 && match.scoreB <= 14) {
                match.winner = match.teamA;
                match.loser = match.teamB;
            } else if (match.scoreB > match.scoreA && match.scoreB === 15 && match.scoreA <= 14) {
                match.winner = match.teamB;
                match.loser = match.teamA;
            } else if (match.scoreA === 11 && match.scoreB <= 9) {
                 // Game 11 điểm
                match.winner = match.teamA;
                match.loser = match.teamB;
            } else if (match.scoreB === 11 && match.scoreA <= 9) {
                 // Game 11 điểm
                match.winner = match.teamB;
                match.loser = match.teamA;
            } else if (match.scoreA >= 11 && match.scoreB >= 11 && Math.abs(match.scoreA - match.scoreB) >= 2) {
                // Trường hợp thắng cách 2 điểm từ 10-10 trở lên (12-10, 13-11, ...)
                if (match.scoreA > match.scoreB) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else {
                    match.winner = match.teamB;
                    match.loser = match.teamA;
                }
            } else {
                match.winner = null;
                match.loser = null;
            }
        }
    } else {
        match.winner = null;
        match.loser = null;
    }

    renderMatchesView();
    stateChanged = true;
    tinhVaCapNhatXepHang();
    scheduleFinalsAuto(); // Tự động cập nhật vòng CK
    saveToGitHub();
}

// Hàm render match view theo bảng đấu (chưa hoàn thiện logic đầy đủ)
function renderMatchesView() {
    // Chế độ xem theo Bảng đấu: Hiện 2 bảng A, B
    if (document.getElementById('viewMode').value === 'table') {
        document.getElementById('scheduleAHeader').textContent = 'Bảng A (Nam - Nữ) - Theo Lượt';
        document.getElementById('tableMatchesA').innerHTML = renderMatchTable(state.matchesA, 'A');
        
        const headerB = document.querySelector('#matchesViewContent h6:nth-child(3)');
        headerB.textContent = 'Bảng B (Nam) - Theo Lượt';
        document.getElementById('tableMatchesB').innerHTML = renderMatchTable(state.matchesB, 'B');
        document.querySelector('#matchesViewContent h6:nth-child(3)').style.display = 'block';
    } 
    // Chế độ xem theo Sân thi đấu: Nhóm trận theo sân và thời gian
    else if (document.getElementById('viewMode').value === 'court') {
         document.getElementById('scheduleAHeader').textContent = 'Lịch thi đấu theo Sân';

         // Lấy tất cả trận đấu và sắp xếp theo thời gian, sân
        const allMatches = [...state.matchesA, ...state.matchesB];
        
        // Sắp xếp theo time (string comparison) và court
        allMatches.sort((a, b) => {
            if (a.time < b.time) return -1;
            if (a.time > b.time) return 1;
            if (a.court < b.court) return -1;
            if (a.court > b.court) return 1;
            return 0;
        });

        // Nhóm theo sân
        const matchesByCourt = allMatches.reduce((acc, match) => {
            if (!acc[match.court]) {
                acc[match.court] = [];
            }
            acc[match.court].push(match);
            return acc;
        }, {});
        
        let courtViewHtml = '';
        const sortedCourtNames = Object.keys(matchesByCourt).sort();

        sortedCourtNames.forEach(courtName => {
            const matches = matchesByCourt[courtName];
            courtViewHtml += `<h6 class="mt-4">${courtName}</h6>`;
            courtViewHtml += renderMatchTable(matches, 'CourtView', true); // dùng flag isCourtView
        });
        
        document.getElementById('tableMatchesA').innerHTML = courtViewHtml;
        document.querySelector('#matchesViewContent h6:nth-child(3)').style.display = 'none';
        document.getElementById('tableMatchesB').innerHTML = '';
    }
}

/**
 * Hiển thị bảng trận đấu.
 * @param {Array} matches - Mảng các trận đấu.
 * @param {string} bang - Tên bảng ('A', 'B')
 * @param {boolean} isCourtView - Cờ cho chế độ xem theo sân
 */
function renderMatchTable(matches, bang, isCourtView = false) {
    if (matches.length === 0) {
        return `<div class="alert alert-info">Chưa có lịch thi đấu cho bảng ${bang}.</div>`;
    }

    let html = `<div class="table-responsive"><table class="table table-sm table-hover table-striped">
        <thead class="sticky-top">
            <tr>
                ${isCourtView ? '<th>Giờ</th><th>Bảng</th>' : ''}
                <th>Lượt Trận</th>
                <th>Đội A</th>
                <th class="text-center">VS</th>
                <th>Đội B</th>
                <th class="text-center">Sân</th>
                <th class="text-center">Điểm A</th>
                <th class="text-center">Điểm B</th>
                <th class="text-center">Thắng</th>
            </tr>
        </thead>
        <tbody>`;

    matches.forEach((match, index) => {
        const trClass = match.winner ? (match.winner === match.teamA || match.winner === match.teamB ? 'table-success' : 'table-light') : '';
        const teamAClass = match.winner === match.teamA ? 'winner' : (match.loser === match.teamA ? 'loser' : '');
        const teamBClass = match.winner === match.teamB ? 'winner' : (match.loser === match.teamB ? 'loser' : '');
        const actualBang = isCourtView ? match.bang : bang; // Lấy bảng thật nếu đang xem theo sân
        
        // Tìm index thực tế trong mảng matchesA/B để update
        const actualIndex = actualBang === 'A' ? state.matchesA.indexOf(match) : state.matchesB.indexOf(match);

        html += `<tr class="${trClass}">
            ${isCourtView ? `<td>${match.time}</td><td><span class="badge bg-${actualBang === 'A' ? 'primary' : 'info'}">${actualBang}</span></td>` : ''}
            <td>${index + 1}</td>
            <td class="${teamAClass}">${match.teamA}</td>
            <td class="text-center">|</td>
            <td class="${teamBClass}">${match.teamB}</td>
            <td class="text-center">${match.court}</td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}"
                       onchange="updateMatchScore('${actualBang}', ${actualIndex}, 'A', this.value)">
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}"
                       onchange="updateMatchScore('${actualBang}', ${actualIndex}, 'B', this.value)">
            </td>
            <td class="text-center">
                ${match.winner ? '🏆' : ''}
            </td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    return html;
}

// --- Ranking Logic (Simplified/Placeholder) ---
function tinhVaCapNhatXepHang() {
    state.tableA = tinhXepHang(state.matchesA, state.mixedTeams);
    state.tableB = tinhXepHang(state.matchesB, state.maleTeams);
    renderRankingTables();
}

function tinhXepHang(matches, teams) {
    if (teams.length === 0) {
        // Nếu danh sách đội trống, tạo danh sách từ các trận đấu
        const teamNames = new Set();
        matches.forEach(match => {
            teamNames.add(match.teamA);
            teamNames.add(match.teamB);
        });
        teams = Array.from(teamNames).map(name => ({ name: name }));
    }
    
    // Khởi tạo điểm số
    const rankings = teams.map(team => ({
        name: team.name,
        won: 0,
        lost: 0,
        for: 0,
        against: 0,
        diff: 0,
        points: 0 // Thắng 3, Thua 1 (hoặc 0)
    }));

    // Cập nhật điểm
    matches.filter(m => m.winner).forEach(match => {
        const winner = rankings.find(r => r.name === match.winner);
        const loser = rankings.find(r => r.name === match.loser);
        
        if (winner) {
            winner.won += 1;
            winner.points += 3;
            winner.for += (match.winner === match.teamA ? match.scoreA : match.scoreB);
            winner.against += (match.winner === match.teamA ? match.scoreB : match.scoreA);
        }
        
        if (loser) {
            loser.lost += 1;
            loser.points += 1; // Thua vẫn được 1 điểm (giả định)
            loser.for += (match.loser === match.teamA ? match.scoreA : match.scoreB);
            loser.against += (match.loser === match.teamA ? match.scoreB : match.scoreA);
        }
    });
    
    // Tính hiệu số và sắp xếp
    rankings.forEach(r => {
        r.diff = r.for - r.against;
    });

    // Sắp xếp: 1. Điểm, 2. Hiệu số, 3. Điểm Thắng
    rankings.sort((a, b) => {
        if (a.points !== b.points) return b.points - a.points;
        if (a.diff !== b.diff) return b.diff - a.diff;
        return b.for - a.for;
    });

    return rankings;
}

function renderRankingTables() {
    const container = document.getElementById('rankingTables');
    container.innerHTML = `
        <div>
            <h6>Bảng A (Nam - Nữ)</h6>
            ${renderSingleRankingTable(state.tableA)}
        </div>
        <div>
            <h6>Bảng B (Nam)</h6>
            ${renderSingleRankingTable(state.tableB)}
        </div>
    `;
}

function renderSingleRankingTable(table) {
    if (table.length === 0) {
        return `<div class="alert alert-warning small">Chưa có kết quả để xếp hạng.</div>`;
    }

    let html = `<div class="table-responsive"><table class="table table-sm table-hover table-bordered">
        <thead class="table-info">
            <tr>
                <th>#</th>
                <th>Đội</th>
                <th class="text-center">Thắng</th>
                <th class="text-center">Thua</th>
                <th class="text-center">HS</th>
                <th class="text-center">Điểm</th>
            </tr>
        </thead>
        <tbody>`;

    table.forEach((team, index) => {
        html += `<tr>
            <td>${index + 1}</td>
            <td>${team.name}</td>
            <td class="text-center">${team.won}</td>
            <td class="text-center">${team.lost}</td>
            <td class="text-center">${team.diff}</td>
            <td class="text-center"><strong>${team.points}</strong></td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    return html;
}

// --- Finals Logic (Simplified/Placeholder) ---

/**
 * Tự động lên lịch và cập nhật các đội vào Vòng Chung kết dựa trên kết quả Vòng Bảng.
 */
function scheduleFinalsAuto() {
    // 1. Lấy Nhất/Nhì các bảng
    const nhatA = state.tableA.length >= 1 ? state.tableA[0].name : 'Nhất A';
    const nhiA = state.tableA.length >= 2 ? state.tableA[1].name : 'Nhì A';
    const nhatB = state.tableB.length >= 1 ? state.tableB[0].name : 'Nhất B';
    const nhiB = state.tableB.length >= 2 ? state.tableB[1].name : 'Nhì B';
    
    // Lấy Hạng Ba các bảng
    const hangBaA = state.tableA.length >= 3 ? state.tableA[2].name : null;
    const hangBaB = state.tableB.length >= 3 ? state.tableB[2].name : null;
    
    // 2. Cập nhật Bán kết
    const sf1 = state.semifinals.find(s => s.id === 'SF1');
    const sf2 = state.semifinals.find(s => s.id === 'SF2');

    if (sf1.teamA === 'Nhất A' || sf1.teamA === 'Nhất B') { // Nếu chưa gán đội thực tế
        sf1.teamA = nhatA;
        sf1.teamB = nhiA;
    }
    if (sf2.teamA === 'Nhất B' || sf2.teamA === 'Nhất A') { // Nếu chưa gán đội thực tế
        sf2.teamA = nhatB;
        sf2.teamB = nhiB;
    }

    // 3. Cập nhật Chung kết
    const finalMatch = state.final;
    const winnerSF1 = sf1.winner || 'Thắng SF1';
    const winnerSF2 = sf2.winner || 'Thắng SF2';

    finalMatch.teamA = winnerSF1;
    finalMatch.teamB = winnerSF2;
    
    // 4. Cập nhật Hạng Ba Đồng Hạng (Là hai đội thua Bán kết)
    const loserSF1 = sf1.loser || 'Thua SF1';
    const loserSF2 = sf2.loser || 'Thua SF2';
    
    // Xử lý Hạng Ba Đồng Hạng
    if (loserSF1 !== 'Thua SF1' || loserSF2 !== 'Thua SF2') {
        finalMatch.thirdPlaceTeams = [loserSF1, loserSF2].filter(t => t);
    } else {
        finalMatch.thirdPlaceTeams = [hangBaA, hangBaB].filter(t => t); // Nếu chưa có kết quả BK, dùng H3 VB
        // Giả sử có 2 bảng nên Hạng 3 là đồng hạng
    }
    
    // 5. Tính toán kết quả Vòng CK
    updateFinalsWinner(sf1);
    updateFinalsWinner(sf2);
    updateFinalsWinner(finalMatch);


    renderFinals();
    renderFinalResults();
    stateChanged = true;
    saveToGitHub();
}

/**
 * Cập nhật winner/loser cho các trận Vòng Chung kết
 * @param {object} match - Trận đấu (SF1, SF2, F)
 */
function updateFinalsWinner(match) {
    if (match.scoreA !== null && match.scoreB !== null) {
        // Giả định chung kết là 15 điểm cách 2
        if (match.scoreA >= 15 && match.scoreA - match.scoreB >= 2) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB >= 15 && match.scoreB - match.scoreA >= 2) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        } else if (match.scoreA >= 11 && match.scoreA - match.scoreB >= 2) { // Giả định game 11 điểm
             match.winner = match.teamA;
             match.loser = match.teamB;
        } else if (match.scoreB >= 11 && match.scoreB - match.scoreA >= 2) {
             match.winner = match.teamB;
             match.loser = match.teamA;
        } else {
            match.winner = null;
            match.loser = null;
        }
        
        if (match.id === 'F' && match.loser) {
            match.runnerUp = match.loser;
            match.thirdPlaceTeams = [
                state.semifinals.find(s => s.id === 'SF1').loser, 
                state.semifinals.find(s => s.id === 'SF2').loser
            ].filter(t => t);
        }
    } else {
        match.winner = null;
        match.loser = null;
        if (match.id === 'F') {
            match.runnerUp = null;
        }
    }
}

/**
 * Cập nhật điểm và tính toán thắng/thua cho trận Vòng CK.
 * @param {string} matchId - ID trận đấu ('SF1', 'SF2', 'F')
 * @param {string} teamKey - 'A' hoặc 'B' (chỉ team nào được gán điểm)
 * @param {number} score - Điểm số
 */
function updateFinalsScore(matchId, teamKey, score) {
    let match = null;
    if (matchId === 'F') {
        match = state.final;
    } else {
        match = state.semifinals.find(s => s.id === matchId);
    }
    
    if (!match) return;

    score = parseInt(score);

    if (isNaN(score) || score < 0) {
        // Xóa điểm
        if (teamKey === 'A') {
            match.scoreA = null;
        } else {
            match.scoreB = null;
        }
    } else {
        // Cập nhật điểm
        if (teamKey === 'A') {
            match.scoreA = score;
        } else {
            match.scoreB = score;
        }
    }
    
    // Tính lại winner/loser
    updateFinalsWinner(match);

    // Tự động cập nhật trận tiếp theo (chung kết)
    if (matchId !== 'F') {
        scheduleFinalsAuto();
    }

    renderFinals();
    renderFinalResults();
    renderOverview();
    stateChanged = true;
    saveToGitHub();
}

function renderFinals() {
    const renderMatchRow = (match, isFinal = false) => {
        // Không render nếu chưa gán đội thực tế (hoặc là "Thắng SFx")
        if (match.teamA.includes('Nhất') || match.teamB.includes('Nhì') || (isFinal && (match.teamA.includes('Thắng') || match.teamB.includes('Thắng')))) {
            // Hiển thị tên placeholder nhưng không cho nhập điểm
            const teamAClass = '';
            const teamBClass = '';
            return `<tr class="table-light">
                <td>${match.time}</td>
                <td>${match.court}</td>
                <td class="text-center"><span class="badge bg-${match.bang === 'A' ? 'primary' : 'info'}">${match.id}</span></td>
                <td class="text-nowrap">${match.teamA}</td>
                <td class="text-center">|</td>
                <td class="text-nowrap">${match.teamB}</td>
                <td colspan="3" class="text-center text-muted">Chờ kết quả Vòng Bảng</td>
            </tr>`;
        }

        const trClass = match.winner ? 'table-success' : 'table-light';
        const teamAClass = match.winner === match.teamA ? 'winner' : (match.loser === match.teamA ? 'loser' : '');
        const teamBClass = match.winner === match.teamB ? 'winner' : (match.loser === match.teamB ? 'loser' : '');
        
        return `<tr class="${trClass}">
            <td>${match.time}</td>
            <td>${match.court}</td>
            <td class="text-center"><span class="badge bg-${match.bang === 'A' ? 'primary' : 'info'}">${match.id}</span></td>
            <td class="text-nowrap ${teamAClass}">${match.teamA}</td>
            <td class="text-center">|</td>
            <td class="text-nowrap ${teamBClass}">${match.teamB}</td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}"
                       onchange="updateFinalsScore('${match.id}', 'A', this.value)">
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}"
                       onchange="updateFinalsScore('${match.id}', 'B', this.value)">
            </td>
            <td class="text-center">${match.winner ? '🏆' : ''}</td>
        </tr>`;
    };

    let tableHtml = `<div class="table-responsive"><table class="table table-sm table-hover table-striped table-bordered">
        <thead class="table-primary">
            <tr>
                <th>Giờ</th>
                <th>Sân</th>
                <th>Vòng</th>
                <th>Đội A</th>
                <th class="text-center">VS</th>
                <th>Đội B</th>
                <th class="text-center">Điểm A</th>
                <th class="text-center">Điểm B</th>
                <th class="text-center">Thắng</th>
            </tr>
        </thead>
        <tbody>`;

    // Render Bán kết
    state.semifinals.forEach(sf => {
        tableHtml += renderMatchRow(sf);
    });

    document.getElementById('semifinalMatches').innerHTML = tableHtml + '</tbody></table></div>';
    
    // Render Chung kết
    const finalTableHtml = `<div class="table-responsive"><table class="table table-sm table-hover table-striped table-bordered">
        <thead class="table-danger">
            <tr>
                <th>Giờ</th>
                <th>Sân</th>
                <th>Vòng</th>
                <th>Đội A</th>
                <th class="text-center">VS</th>
                <th>Đội B</th>
                <th class="text-center">Điểm A</th>
                <th class="text-center">Điểm B</th>
                <th class="text-center">Thắng</th>
            </tr>
        </thead>
        <tbody>${renderMatchRow(state.final, true)}</tbody></table></div>`;
    
    document.getElementById('finalMatch').innerHTML = finalTableHtml;
}

function renderFinalResults() {
    const finalMatch = state.final;
    
    document.getElementById('champion').innerHTML = `Vô địch: <strong>${finalMatch.winner || 'Đang chờ kết quả...'}</strong>`;
    document.getElementById('runnerUp').innerHTML = `Á quân: <strong>${finalMatch.runnerUp || 'Đang chờ kết quả...'}</strong>`;
    
    let thirdPlaceText = 'Đang chờ kết quả...';
    if (finalMatch.thirdPlaceTeams && finalMatch.thirdPlaceTeams.length > 0) {
        thirdPlaceText = `<strong>${finalMatch.thirdPlaceTeams.join(' & ')}</strong>`;
    }
    
    document.getElementById('thirdPlace').innerHTML = `Hạng Ba Đồng Hạng: ${thirdPlaceText}`;
}

// --- Overview Logic (Simplified/Placeholder) ---
function renderOverview() {
    const totalMatches = state.matchesA.length + state.matchesB.length;
    const playedMatches = [...state.matchesA, ...state.matchesB].filter(m => m.winner).length;
    
    let totalTimeA = calculateTotalMatchTime(state.matchesA);
    let totalTimeB = calculateTotalMatchTime(state.matchesB);
    
    // Tính tổng thời gian dự kiến (15 phút/trận)
    let totalScheduledTimeMinutes = totalMatches * 15;
    let totalScheduledHours = Math.floor(totalScheduledTimeMinutes / 60);
    let totalScheduledMinutes = totalScheduledTimeMinutes % 60;
    let totalScheduledTime = `${totalScheduledHours}h ${totalScheduledMinutes}p`;

    const overviewHtml = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">Thống kê Vòng Bảng</div>
                    <div class="card-body">
                        <p class="card-text">Tổng số trận: <strong>${totalMatches}</strong></p>
                        <p class="card-text text-success">Số trận đã đấu: <strong>${playedMatches}</strong></p>
                        <p class="card-text text-info">Số trận còn lại: <strong>${totalMatches - playedMatches}</strong></p>
                        <hr>
                        <p class="card-text">Tổng thời gian dự kiến: <strong>${totalScheduledTime}</strong> ((${totalMatches} trận x 15 phút))</p>
                        <p class="card-text">Thời gian thực tế Bảng A: <strong>${totalTimeA}</strong></p>
                        <p class="card-text">Thời gian thực tế Bảng B: <strong>${totalTimeB}</strong></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-danger text-white">Kết quả Chung kết</div>
                    <div class="card-body">
                        <p class="card-text text-success">Vô địch: <strong>${state.final.winner || 'Đang chờ...'}</strong></p>
                        <p class="card-text text-warning">Á quân: <strong>${state.final.runnerUp || 'Đang chờ...'}</strong></p>
                        <p class="card-text text-info">Hạng Ba ĐH: <strong>${state.final.thirdPlaceTeams && state.final.thirdPlaceTeams.length > 0 ? state.final.thirdPlaceTeams.join(' & ') : 'Đang chờ...'}</strong></p>
                        <hr>
                        <p class="card-text">Tổng số đội Bảng A: <strong>${state.mixedTeams.length || state.tableA.length}</strong></p>
                        <p class="card-text">Tổng số đội Bảng B: <strong>${state.maleTeams.length || state.tableB.length}</strong></p>
                    </div>
                </div>
            </div>
        </div>
        
        <h5 class="mt-4">Tiến độ Trận đấu</h5>
        <div id="progressChart">
            ${renderProgressBar(playedMatches, totalMatches)}
        </div>
    `;
    
    document.getElementById('overviewContent').innerHTML = overviewHtml;
}

function calculateTotalMatchTime(matches) {
    let totalMinutes = matches.filter(m => m.winner).length * 15; // Giả định mỗi trận đã đấu tốn 15 phút
    const hours = Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return `${hours}h ${minutes}p`;
}

function renderProgressBar(played, total) {
    if (total === 0) return `<div class="alert alert-warning">Chưa có trận đấu nào được lập lịch.</div>`;
    const percentage = Math.round((played / total) * 100);
    return `<div class="progress" role="progressbar" aria-label="Tiến độ" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-bar bg-success" style="width: ${percentage}%">${percentage}% (${played}/${total})</div>
    </div>`;
}

// Gọi hàm khởi tạo
document.addEventListener('DOMContentLoaded', () => {
    // Gọi hàm load config ngay khi DOM được tải
    loadConfig();
    // Chạy render tổng quan lần đầu
    renderOverview(); 
    // Tự động tải dữ liệu nếu có config hợp lệ (cần được gọi sau khi kiểm tra kết nối)
    // Tạm thời gọi lại loadConfig() và startAutoSave() để cập nhật trạng thái UI
    if (state.config.token) {
        // Nếu có token đã lưu, khuyến khích người dùng nhấn Kiểm tra & Tải Dữ liệu
        document.getElementById('configStatus').innerHTML = '<div class="alert alert-info p-2 mt-2">Đã tìm thấy cấu hình GitHub đã lưu. Vui lòng nhấn **Kiểm tra & Tải Dữ liệu** để đồng bộ.</div>';
    } else {
        startAutoSave(); // Sẽ tắt auto-save nếu thiếu token/config
    }
});
</script> 
</body>
</html>
