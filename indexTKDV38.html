<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V39 GitHub (Match Edit)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ngày thi đấu: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState" class="text-danger">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">Tổng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">Vòng Bảng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals" onclick="renderFinals()">Vòng Chung Kết</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" onclick="tinhVaCapNhatXepHang(); renderFinalResults();">Kết quả Chung cuộc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">Cấu hình</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">Đang tải dữ liệu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Chế độ xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo Bảng đấu</option>
            <option value="court" selected>Theo Sân thi đấu</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import Lịch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export Lịch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA">Chưa có lịch thi đấu.</div>
        
        <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB">Chưa có lịch thi đấu.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">Lên lịch Vòng Chung kết (Tự động hóa)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">Vòng Bán kết (16:30, Sân 3)</h6>
            <div id="semifinalMatches">Chưa có lịch thi đấu bán kết. Kết quả Vòng Bảng sẽ tự động cập nhật lịch.</div>

            <h6 class="mt-4">Trận Chung kết (17:00, Sân 3)</h6>
            <div id="finalMatch">Chưa có lịch thi đấu chung kết.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">Bảng xếp hạng Vòng Bảng (Cập nhật liên tục)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hiệu Chung cuộc</h5>
        <p id="champion">Vô địch: Đang chờ kết quả...</p>
        <p id="runnerUp">Á quân: Đang chờ kết quả...</p>
        <p id="thirdPlace">Hạng Ba Đồng Hạng: Đang chờ kết quả...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">Công cụ Lập & Điền Lịch Thi đấu</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">Tạo lịch thi đấu Tối ưu (Tự động)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">Tạo lịch Cố định</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">Điền kết quả Tự động (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">Xóa Toàn bộ Lịch</button>
      </div>
      
      <hr>

      <h5 class="mt-4">⚙️ Cấu hình Sân thi đấu & Lịch Tối ưu</h5>
      <p class="text-muted small">Quản lý danh sách sân thi đấu. Sân được gán loại bảng đấu (A/B) để phục vụ chức năng tạo lịch Tối ưu.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Thêm Sân Mới</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">Tải cấu hình Mặc định</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>

      <h5 class="mt-4">💾 Cấu hình Kết nối GitHub</h5>
      <p class="text-muted">Nhập thông tin kho lưu trữ GitHub để tự động lưu trữ dữ liệu giải đấu.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (Ví dụ: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (Ví dụ: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="Dán GitHub Personal Access Token (PAT) tại đây">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">Lưu cấu hình Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Kiểm tra & Tải Dữ liệu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">🔑 Hướng dẫn lấy GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy cập <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (Bạn cần đăng nhập).</li>
                <li>Chọn **Generate new token** (hoặc **Generate new token (classic)** nếu bạn dùng tài khoản cũ).</li>
                <li>**Tên Token:** Đặt tên dễ nhớ (ví dụ: `TKDManager_AutoSave`).</li>
                <li>**Thời hạn:** Chọn tùy ý (nên chọn 90 ngày hoặc Tùy chỉnh).</li>
                <li>**Phạm vi (Scopes):** **BẮT BUỘC** tích chọn ô **`repo`** (cho phép truy cập vào kho lưu trữ).</li>
                <li>Nhấn **Generate token** và **SAO CHÉP** chuỗi Token vừa được tạo.</li>
                <li>Dán chuỗi Token đó vào ô "Dán GitHub Personal Access Token (PAT) tại đây" bên trên.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">⚠️ **Lưu ý:** Token chỉ hiển thị **MỘT LẦN**. Hãy sao chép ngay lập tức và giữ bí mật. Nếu mất, bạn phải tạo lại Token mới.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Thêm/Sửa Cấu hình Sân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">Tên Sân</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Giờ Bắt Đầu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Thời Lượng Tối Đa (Phút)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              Dành cho Bảng A (Nam - Nữ)
            </label>
            <div class="form-text">Nếu không chọn, sân sẽ dành cho Bảng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="matchEditModal" tabindex="-1" aria-labelledby="matchEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="matchEditModalLabel">Sửa Lịch Trận Đấu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="matchEditForm">
          <input type="hidden" id="matchEditId" value="">
          <input type="hidden" id="matchEditIsFinal" value="">

          <div class="mb-3">
            <label class="form-label">Cặp đấu:</label>
            <p class="form-control-static fw-bold" id="matchEditTeams"></p>
          </div>

          <div class="mb-3">
            <label for="matchEditTime" class="form-label">Giờ thi đấu (HH:mm)</label>
            <input type="time" class="form-control" id="matchEditTime" required>
          </div>

          <div class="mb-3">
            <label for="matchEditCourt" class="form-label">Sân thi đấu</label>
            <select class="form-select" id="matchEditCourt" required>
            </select>
          </div>
          <div id="matchEditFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveMatchChanges()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        Nội dung thông báo
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 

<script>
// Dữ liệu mẫu CSV chuẩn hóa cho chức năng Tạo Lịch Cố Định (ĐÃ CẬP NHẬT THEO YÊU CẦU MỚI)
const STANDARDIZED_SCHEDULE_CSV_SAMPLE = `teamA,teamB,time,court,bang,scoreA,scoreB
Triều/Minh,Hiển/P.Hùng,14:00,Sân 1,B,,
Giang/Long,Hường/Đạt,14:00,Sân 2,A,,
Hậu/Dũng,Hạnh/Tiến,14:00,Sân 3,A,,
Huyền/Luân,Linh/M.Hùng,14:00,Sân7,A,,
Tiệp/Thủy,Phương/Thanh,14:15,Sân 1,B,,
Tín/Khiêm,Ánh/Toàn,14:15,Sân 2,B,,
Hậu/Dũng,Hường/Đạt,14:15,Sân 3,A,,
Giang/Long,Huyền/Luân,14:15,Sân7,A,,
Triều/Minh,Tín/Khiêm,14:30,Sân 1,B,,
Tiệp/Thủy,Hiển/P.Hùng,14:30,Sân 2,B,,
Hạnh/Tiến,Linh/M.Hùng,14:30,Sân 3,A,,
Phương/Thanh,Ánh/Toàn,14:30,Sân7,B,,
Huyền/Luân,Hường/Đạt,14:45,Sân 2,A,,
Hạnh/Tiến,Giang/Long,14:45,Sân 3,A,,
Hậu/Dũng,Linh/M.Hùng,14:45,Sân7,A,,
Tiệp/Thủy,Ánh/Toàn,15:00,Sân 2,B,,
Tín/Khiêm,Hiển/P.Hùng,15:00,Sân 3,B,,
Phương/Thanh,Triều/Minh,15:15,Sân 2,B,,
Giang/Long,Linh/M.Hùng,15:15,Sân 3,A,,
Hạnh/Tiến,Hường/Đạt,15:30,Sân 2,A,,
Hậu/Dũng,Huyền/Luân,15:30,Sân 3,A,,
Tiệp/Thủy,Tín/Khiêm,15:45,Sân 2,B,,
Phương/Thanh,Hiển/P.Hùng,15:45,Sân 3,B,,
Triều/Minh,Ánh/Toàn,16:00,Sân 2,B,,
Hậu/Dũng,Giang/Long,16:00,Sân 3,A,,
Hạnh/Tiến,Huyền/Luân,16:15,Sân 2,A,,
Linh/M.Hùng,Hường/Đạt,16:15,Sân 3,A,,
Tiệp/Thủy,Triều/Minh,16:30,Sân 2,B,,
Ánh/Toàn,Hiển/P.Hùng,16:30,Sân 3,B,,
Phương/Thanh,Tín/Khiêm,16:45,Sân 2,B,,
`;

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = { 
  mixedTeams: [], // Sẽ được tải từ players.json
  maleTeams: [],  // Sẽ được tải từ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // Bảng xếp hạng A
  tableB: [], // Bảng xếp hạng B
  
  // NEW: Court Configuration (8 Sân mặc định theo yêu cầu mới)
  courts: [
    { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }  // Bảng B (Male)
  ],
  
  // LOGIC BÁN KẾT (Court mặc định là Sân 3 theo yêu cầu mới)
  semifinals: [
    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 3', winner: null, runnerUp: null },
  config: {}
};

let stateChanged = false; // Biến cờ theo dõi thay đổi dữ liệu
let currentSha = null; // Biến lưu trữ SHA của file trên GitHub
let autoSaveInterval = null; // Biến lưu trữ ID của interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * Hàm chuyển đổi tab
 * @param {string} tabId - ID của tab cần chuyển (ví dụ: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // Tắt tab đang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // Bật tab mới
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // Cập nhật view cho tab matches nếu chuyển đến
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- CSV Helper (NEW/MODIFIED) ---

/**
 * Phân tích cú pháp CSV thành mảng các đối tượng.
 * @param {string} csvText - Chuỗi CSV.
 * @returns {Array<Object>} Mảng các đối tượng, key là header (lowercase, trimmed).
 */
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length === 0) return [];
    
    // Chuẩn hóa header: trim và lowercase
    const header = lines[0].split(',').map(h => h.trim().toLowerCase()); 
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === '') continue; // Bỏ qua dòng trống
        
        // Split dòng (dùng regex đơn giản để handle quote nếu cần, nhưng tốt nhất là không dùng quote)
        const rowData = line.split(','); 
        if (rowData.length !== header.length) continue; // Bỏ qua dòng không khớp số lượng cột
        
        const row = {};
        header.forEach((key, index) => {
            row[key] = rowData[index].trim().replace(/^"|"$/g, '').replace(/""/g, '"'); // Xử lý quote đơn giản
        });
        
        data.push(row);
    }
    return data;
}

// --- GitHub API Functions ---

/**
 * Lấy SHA mới nhất của file state.json trên GitHub.
 * @param {object} cfg - Cấu hình GitHub (owner, repo, folder, file, token)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Chỉ lưu SHA của state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            throw new Error(`Lỗi khi lấy SHA: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Lỗi Fetch SHA (${fileName}):`, error);
        throw new Error(`Lỗi kết nối hoặc API: ${error.message}`);
    }
}

/**
 * NEW: Tải danh sách đội từ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    // players.json phải nằm cùng thư mục với state.json
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'Đang tải danh sách đội từ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `Tải danh sách đội thành công (${state.mixedTeams.length + state.maleTeams.length} đội).`);
                return true;
            } else {
                throw new Error("File players.json không đúng định dạng (thiếu mixedTeams/maleTeams).");
            }
        } else {
             // 404 hoặc không có content
            updateStatus('configStatus', 'warning', 'Không tìm thấy file players.json. Dùng danh sách đội khởi tạo (trống).');
            return false;
        }
    } catch (error) {
        console.error("Lỗi khi tải players.json:", error);
        updateStatus('configStatus', 'danger', `Lỗi tải danh sách đội: ${error.message}`);
        return false;
    }
}

/**
 * Tải trạng thái giải đấu (state.json) từ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) return;

    // 1. Load Teams (danh sách đội)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'Đang tải trạng thái giải đấu từ GitHub (state.json)...');
        // fetchFileSha sẽ tự động cập nhật currentSha
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi đè các giá trị khác ngoài teams (teams đã được load từ players.json)
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // Tải cấu hình sân (NEW) - nếu không có, giữ nguyên mặc định
            if (loadedState.courts && loadedState.courts.length > 0) {
                state.courts = loadedState.courts;
            } else {
                // Nếu không có, dùng cấu hình mặc định 8 sân mới
                loadDefaultCourtConfig(false); 
            }
            
            // Tải cấu hình finals (giữ nguyên Sân 3 mặc định nếu chưa được gán)
            const defaultSF1 = { teamA: 'Nhất A', teamB: 'Nhì A', court: 'Sân 3' };
            const defaultSF2 = { teamA: 'Nhất B', teamB: 'Nhì B', court: 'Sân 3' };
            
            if (loadedState.semifinals && loadedState.semifinals.length === 2) {
                state.semifinals = loadedState.semifinals;
                // Nếu teamA, teamB chưa bị gán, nhưng court lại khác 'Sân 3', thì cập nhật lại court
                if (state.semifinals[0].teamA === defaultSF1.teamA && state.semifinals[0].teamB === defaultSF1.teamB) {
                    state.semifinals[0].court = defaultSF1.court;
                }
                if (state.semifinals[1].teamA === defaultSF2.teamA && state.semifinals[1].teamB === defaultSF2.teamB) {
                    state.semifinals[1].court = defaultSF2.court;
                }
            } else {
                 // Nếu không có, dùng mặc định
                 state.semifinals = [
                    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null },
                    { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null }
                 ];
            }

            state.final = loadedState.final || state.final;
            if (state.final.teamA === 'Thắng SF1' && state.final.teamB === 'Thắng SF2') {
                 state.final.court = 'Sân 3'; // Cập nhật Sân 3 nếu chưa gán đội
            }
            
            // Cập nhật giao diện
            renderMatches(); 
            tinhVaCapNhatXepHang();
            renderFinals();
            renderFinalResults();
            renderOverview();
            
            updateStatus('configStatus', 'success', `Tải trạng thái giải đấu thành công từ: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
            updateStatus('configStatus', 'warning', 'File trạng thái (state.json) chưa tồn tại. Vui lòng nhấn Lưu hoặc Tự động lưu để tạo file.');
        }

        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Lỗi tải trạng thái giải đấu: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi khi tải trạng thái giải đấu từ GitHub:", error);
    }
}

async function saveToGitHub() {
    // Bỏ qua nếu không có thay đổi
    if (!stateChanged) return;

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Không thể tự động lưu: Thiếu cấu hình GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Tạm dừng (Thiếu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'Đang lưu...';

    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Chỉ lưu các trường cần thiết, loại bỏ config và table (vì chúng được tính lại)
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Luôn fetch SHA mới nhất trước khi cố gắng lưu
        const result = await fetchFileSha(cfg, cfg.file); // Lấy SHA của state.json
        const sha = result.sha; 
        
        const payload = {
            message: `[Auto-save] Cập nhật trạng thái giải đấu TKD V39 lúc ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        // Chỉ thêm SHA vào payload nếu nó đã tồn tại (để cập nhật), 
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'Đã Lưu';
        } else {
            // Trường hợp lỗi 409 Conflict (SHA cũ)
            if (response.status === 409) {
                console.warn("Lỗi 409 Conflict: Dữ liệu đã thay đổi trên GitHub. Đang cố gắng lấy SHA mới.");
                
                // Lấy lại SHA mới nhất. stateChanged vẫn là true, 
                // để AutoSave interval sẽ thử lại với SHA mới trong lần tiếp theo.
                await fetchFileSha(cfg, cfg.file); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. Sẽ thử lưu lại sau 1 phút.';
            } else {
                throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lưu lên GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Lỗi Lưu';
    }
}

async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui lòng nhập đầy đủ Owner, Repo và Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'Đang kiểm tra kết nối...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`Lỗi truy cập kho lưu trữ. Mã: ${repoResponse.status}. (Kiểm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', 'Kết nối GitHub thành công! Đang tải dữ liệu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Kiểm tra kết nối thất bại: ${error.message}.`);
        console.error("Lỗi kiểm tra kết nối:", error);
    }
}

// --- Cấu hình & Khởi tạo ---

function renderConfig() {
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
}

/**
 * Hiển thị danh sách sân dưới dạng bảng với nút Sửa/Xóa.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Chưa có sân nào được cấu hình.</div>`;
        return;
    }
    
    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>Tên Sân</th>
                <th>Giờ Bắt Đầu</th>
                <th>Thời Lượng Max (Phút)</th>
                <th>Phân Loại</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>`;
        
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'Bảng A (Nam-Nữ)' : 'Bảng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">Xóa</button>
            </td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * Mở modal thêm/sửa sân và điền dữ liệu nếu là chế độ sửa.
 * @param {number | null} index - Chỉ số của sân cần sửa, hoặc null nếu thêm mới.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';

    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'Sửa Cấu hình Sân' : 'Thêm Sân Mới';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Chế độ thêm mới: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = '180';
        document.getElementById('courtIsMixed').checked = true; // Default to Mixed (Bảng A)
    }

    modal.show();
}

/**
 * Lưu thay đổi từ modal vào state.courts
 */
function saveCourtChanges() {
    const indexStr = document.getElementById('courtIndex').value;
    const index = indexStr === '' ? null : parseInt(indexStr);
    
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;

    const statusDiv = document.getElementById('courtFormStatus');

    // Validation
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui lòng nhập đầy đủ và hợp lệ các trường (Tên, Giờ, Thời lượng > 0).</div>`;
        return;
    }
    
    // Check for duplicate name (excluding the current edited court)
    const isDuplicate = state.courts.some((c, i) => 
        i !== index && c.name.toLowerCase() === name.toLowerCase()
    );

    if (isDuplicate) {
         statusDiv.innerHTML = `<div class="alert alert-danger p-2">Tên sân "${name}" đã tồn tại.</div>`;
        return;
    }

    const newCourt = { 
        name, 
        startTime, 
        maxDurationMinutes, 
        isMixed 
    };

    if (index !== null) {
        // Edit mode
        state.courts[index] = newCourt;
    } else {
        // Add mode
        state.courts.push(newCourt);
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();

    // Update UI and save
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', `Đã ${index !== null ? 'cập nhật' : 'thêm'} sân "${name}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
    saveToGitHub();
}

/**
 * Xóa sân khỏi danh sách.
 * @param {number} index - Chỉ số của sân cần xóa.
 */
function deleteCourt(index) {
    if (confirm(`Bạn có chắc chắn muốn xóa sân "${state.courts[index].name}"?`)) {
        const deletedCourtName = state.courts[index].name;
        state.courts.splice(index, 1);
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', `Đã xóa sân "${deletedCourtName}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
        saveToGitHub();
    }
}

/**
 * Tải cấu hình mặc định (8 sân)
 */
function loadDefaultCourtConfig(showMsg = true) {
    state.courts = [
        { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }
    ];
    if (showMsg) {
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', 'Đã tải cấu hình sân Mặc định (8 Sân). Dữ liệu sẽ được tự động lưu lên GitHub.');
        saveToGitHub();
    }
}

function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'state.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}

function saveConfig(){
    const cfg = {
        owner: document.getElementById('cfgOwner').value,
        repo: document.getElementById('cfgRepo').value,
        folder: document.getElementById('cfgFolder').value,
        file: document.getElementById('cfgFile').value,
        token: document.getElementById('cfgToken').value
    };
    state.config = cfg;
    localStorage.setItem('pkb_config', JSON.stringify(cfg));
    updateStatus('configStatus', 'success', 'Đã lưu cấu hình GitHub vào trình duyệt. Vui lòng Kiểm tra & Tải Dữ liệu.');
}

function updateStatus(id, type, message) {
    const statusDiv = document.getElementById(id);
    statusDiv.innerHTML = `<div class="alert alert-${type} p-2 mt-2">${message}</div>`;
}

function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    if (state.config.token && state.config.owner && state.config.repo) {
        autoSaveInterval = setInterval(saveToGitHub, 60000);
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Hoạt động...';
    } else {
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Tắt';
    }
}

// --- Import/Export Functions (MODIFIED FOR SYNCHRONIZATION) ---

/**
 * Xử lý Import lịch thi đấu từ tệp CSV theo mẫu chuẩn: teamA,teamB,time,court,bang,scoreA,scoreB
 */
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        showModal("Lỗi Import", "Vui lòng chọn một tệp CSV.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const rows = parseCSV(csvText);
            
            if (rows.length === 0 || !rows[0].teama || !rows[0].teamb || !rows[0].bang) {
                showModal("Lỗi Import", "Không thể đọc dữ liệu hoặc tệp không đúng định dạng. Cần có các cột: teamA, teamB, time, court, bang, scoreA, scoreB.");
                document.getElementById('fileInput').value = ''; // Clear file input
                return;
            }

            // Xóa lịch cũ
            state.matchesA = [];
            state.matchesB = [];
            
            let idCounterA = 1;
            let idCounterB = 1;

            rows.forEach(row => {
                const bangCode = row.bang.toUpperCase();
                const isMixed = bangCode === 'A';
                
                // Tạo đối tượng trận đấu mới theo cấu trúc chuẩn
                const newMatch = {
                    id: isMixed ? `A${idCounterA++}` : `B${idCounterB++}`,
                    teamA: row.teama || '',
                    teamB: row.teamb || '',
                    // Xử lý điểm số, nếu có thì parse, không thì là null
                    scoreA: (row.scorea && row.scorea.trim().length > 0) ? parseInt(row.scorea) : null,
                    scoreB: (row.scoreb && row.scoreb.trim().length > 0) ? parseInt(row.scoreb) : null,
                    time: row.time || '',
                    court: row.court || 'Chưa gán',
                    bang: bangCode,
                    winner: null,
                    loser: null
                };
                
                // Cập nhật winner/loser nếu có điểm số
                if (newMatch.scoreA !== null && newMatch.scoreB !== null) {
                    if (newMatch.scoreA > newMatch.scoreB) {
                        newMatch.winner = newMatch.teamA;
                        newMatch.loser = newMatch.teamB;
                    } else if (newMatch.scoreB > newMatch.scoreA) {
                        newMatch.winner = newMatch.teamB;
                        newMatch.loser = newMatch.teamA;
                    }
                }

                if (isMixed) {
                    state.matchesA.push(newMatch);
                } else {
                    state.matchesB.push(newMatch);
                }
            });

            document.getElementById('fileInput').value = ''; // Clear file input
            renderMatchesView();
            tinhVaCapNhatXepHang();
            renderOverview();
            
            stateChanged = true;
            saveToGitHub();
            showModal("Thành công", `Đã Import thành công ${state.matchesA.length + state.matchesB.length} trận đấu theo mẫu chuẩn.`);

        } catch (error) {
            console.error("Lỗi khi xử lý CSV:", error);
            document.getElementById('fileInput').value = ''; 
            showModal("Lỗi Import", `Đã xảy ra lỗi khi đọc tệp: ${error.message}`);
        }
    };
    reader.readAsText(file);
}

/**
 * Xuất lịch thi đấu hiện tại ra tệp CSV theo mẫu chuẩn: teamA,teamB,time,court,bang,scoreA,scoreB
 */
function exportSchedule() {
    // Header chuẩn hóa
    const header = ['teamA', 'teamB', 'time', 'court', 'bang', 'scoreA', 'scoreB'];
    let csvContent = header.join(',') + '\n';

    const allMatches = [...state.matchesA, ...state.matchesB];

    allMatches.forEach(match => {
        // Dùng quote để tránh lỗi khi tên đội có dấu phẩy
        const row = [
            `"${(match.teamA || '').replace(/"/g, '""')}"`, 
            `"${(match.teamB || '').replace(/"/g, '""')}"`,
            match.time || '',
            match.court || '',
            match.bang || '',
            match.scoreA !== null ? match.scoreA : '',
            match.scoreB !== null ? match.scoreB : ''
        ];
        csvContent += row.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    link.setAttribute("href", url);
    link.setAttribute("download", `lich_thi_dau_V39_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showModal("Xuất dữ liệu", "Đã xuất lịch thi đấu hiện tại ra tệp CSV theo mẫu đồng bộ.");
}


/**
 * Tạo lịch cố định từ dữ liệu mẫu chuẩn hóa (STANDARDIZED_SCHEDULE_CSV_SAMPLE)
 */
function taoLichCoDinh() {
    if (confirm("Thao tác này sẽ xóa toàn bộ lịch hiện tại và thay bằng lịch cố định (dữ liệu mẫu chuẩn hóa). Bạn có chắc chắn?")) {
        const rows = parseCSV(STANDARDIZED_SCHEDULE_CSV_SAMPLE);
        
        if (rows.length === 0) {
            showModal("Lỗi Tạo Lịch", "Không có dữ liệu mẫu cố định để tạo lịch.");
            return;
        }

        // Xóa lịch cũ
        state.matchesA = [];
        state.matchesB = [];

        let idCounterA = 1;
        let idCounterB = 1;

        rows.forEach(row => {
            const bangCode = row.bang.toUpperCase();
            const isMixed = bangCode === 'A';
            
            const newMatch = {
                id: isMixed ? `A${idCounterA++}` : `B${idCounterB++}`,
                teamA: row.teama || '',
                teamB: row.teamb || '',
                scoreA: null, // Luôn reset điểm số khi tạo lịch cố định
                scoreB: null, 
                time: row.time || '',
                court: row.court || 'Chưa gán',
                bang: bangCode,
                winner: null,
                loser: null
            };
            
            if (isMixed) {
                state.matchesA.push(newMatch);
            } else {
                state.matchesB.push(newMatch);
            }
        });
        
        // Reset lịch chung kết về mặc định Sân 3
        state.semifinals = [
            { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 3', winner: null, runnerUp: null };


        renderMatchesView();
        tinhVaCapNhatXepHang();
        renderFinals();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal("Thành công", `Đã tạo ${state.matchesA.length + state.matchesB.length} trận đấu từ lịch cố định mẫu chuẩn hóa.`);
    }
}

// --- Helper for Match Edit (MỚI) ---
/**
 * Helper: Tìm trận đấu theo ID (Bao gồm vòng bảng, bán kết, chung kết)
 */
function findMatchById(id) {
    let match = state.matchesA.find(m => m.id === id);
    if (match) return { match: match, isFinal: false, array: state.matchesA };
    
    match = state.matchesB.find(m => m.id === id);
    if (match) return { match: match, isFinal: false, array: state.matchesB };

    match = state.semifinals.find(m => m.id === id);
    if (match) return { match: match, isFinal: true, array: state.semifinals };
    
    if (state.final.id === id) return { match: state.final, isFinal: true, array: null };
    
    return null;
}

/**
 * Mở modal sửa lịch (Giờ và Sân)
 * @param {string} id - ID trận đấu
 * @param {boolean} isFinal - Trận đấu thuộc vòng chung kết?
 */
function openMatchEdit(id, isFinal) {
    const result = findMatchById(id);
    if (!result) {
        showModal("Lỗi", "Không tìm thấy trận đấu này.");
        return;
    }
    
    const match = result.match;
    const modal = new bootstrap.Modal(document.getElementById('matchEditModal'));
    
    document.getElementById('matchEditFormStatus').innerHTML = '';
    document.getElementById('matchEditModalLabel').textContent = `Sửa Lịch Trận: ${match.id} (${match.bang || (isFinal ? (match.id === 'F' ? 'CK' : 'BK') : 'Vòng Bảng')})`;
    
    document.getElementById('matchEditId').value = id;
    document.getElementById('matchEditIsFinal').value = isFinal ? 'true' : 'false';
    document.getElementById('matchEditTeams').textContent = `${match.teamA} vs ${match.teamB}`;
    document.getElementById('matchEditTime').value = match.time || '14:00';
    
    const courtSelect = document.getElementById('matchEditCourt');
    courtSelect.innerHTML = '';
    
    // Thêm các sân vào dropdown
    let currentCourtExists = false;
    state.courts.forEach(court => {
        const option = document.createElement('option');
        option.value = court.name;
        option.textContent = court.name;
        if (court.name === match.court) {
            option.selected = true;
            currentCourtExists = true;
        }
        courtSelect.appendChild(option);
    });
    
    // Nếu match.court không có trong danh sách sân (ví dụ: Sân7 trong lịch cố định), vẫn thêm vào
    if (match.court && !currentCourtExists) {
        const option = document.createElement('option');
        option.value = match.court;
        option.textContent = `${match.court} (Sân không có trong Config)`;
        option.selected = true;
        courtSelect.prepend(option); // Đưa lên đầu
    }

    modal.show();
}

/**
 * Lưu thay đổi Giờ và Sân của trận đấu từ modal (MỚI)
 */
function saveMatchChanges() {
    const id = document.getElementById('matchEditId').value;
    const isFinal = document.getElementById('matchEditIsFinal').value === 'true';
    const newTime = document.getElementById('matchEditTime').value;
    const newCourt = document.getElementById('matchEditCourt').value;
    
    const statusDiv = document.getElementById('matchEditFormStatus');

    if (!newTime || !newCourt) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui lòng nhập đầy đủ Giờ và Sân.</div>`;
        return;
    }

    const result = findMatchById(id);
    if (!result) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Lỗi: Không tìm thấy trận đấu để lưu.</div>`;
        return;
    }
    
    result.match.time = newTime;
    result.match.court = newCourt;

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('matchEditModal')).hide();
    
    // Update UI and save
    if (isFinal) {
        renderFinals();
    } else {
        renderMatchesView();
    }
    tinhVaCapNhatXepHang();
    
    stateChanged = true;
    saveToGitHub();
    showModal("Thành công", `Đã cập nhật lịch thi đấu cho trận ${id}: ${newTime} tại ${newCourt}.`);
}


// --- Placeholder/Reconstructed Functions (Để đảm bảo ứng dụng chạy) ---

function generateMatchHtml(match, isFinal = false) {
    const winnerClass = match.winner ? (match.winner === match.teamA ? 'winner' : 'loser') : '';
    const loserClass = match.loser ? (match.loser === match.teamB ? 'winner' : 'loser') : '';
    const teamAClass = match.scoreA !== null ? (match.scoreA > match.scoreB ? 'winner' : (match.scoreA < match.scoreB ? 'loser' : '')) : '';
    const teamBClass = match.scoreB !== null ? (match.scoreB > match.scoreA ? 'winner' : (match.scoreB < match.scoreA ? 'loser' : '')) : '';
    
    const scoreA = match.scoreA !== null ? match.scoreA : '';
    const scoreB = match.scoreB !== null ? match.scoreB : '';
    
    // Nút Sửa/Lưu
    // Gọi openMatchEdit() (Đã cập nhật)
    const editButton = `<button class="btn btn-sm btn-outline-secondary me-1" onclick="openMatchEdit('${match.id}', ${isFinal})">Sửa Lịch</button>`;

    return `
        <tr>
            <td>${match.id}</td>
            <td>${match.time || ''}</td>
            <td>${match.court || ''}</td>
            <td class="${teamAClass}">
                <span title="${match.teamA}">${match.teamA}</span>
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" max="99" value="${scoreA}" data-match-id="${match.id}" data-team="A" onchange="updateScore('${match.id}', 'A', this.value, ${isFinal})" onfocus="this.select()">
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" max="99" value="${scoreB}" data-match-id="${match.id}" data-team="B" onchange="updateScore('${match.id}', 'B', this.value, ${isFinal})" onfocus="this.select()">
            </td>
            <td class="${teamBClass}">
                <span title="${match.teamB}">${match.teamB}</span>
            </td>
            <td>
                ${editButton}
            </td>
        </tr>
    `;
}

function renderMatches() {
    renderMatchesView();
}

function renderMatchesView() {
    const viewMode = document.getElementById('viewMode').value;
    const tableMatchesA = document.getElementById('tableMatchesA');
    const tableMatchesB = document.getElementById('tableMatchesB');

    const allMatches = [...state.matchesA, ...state.matchesB];

    if (viewMode === 'court') {
        const matchesByCourt = {};
        // Khởi tạo các sân từ config
        state.courts.forEach(c => matchesByCourt[c.name] = []);
        
        allMatches.forEach(match => {
             // Thêm các sân không có trong config (ví dụ: Sân7) vào danh sách nếu có trận đấu ở đó
            if (!matchesByCourt[match.court]) {
                matchesByCourt[match.court] = [];
            }
            if (match.court) {
                matchesByCourt[match.court].push(match);
            }
        });
        
        let htmlA = '';
        let htmlB = '';
        
        // Lấy danh sách sân duy nhất, sắp xếp theo tên (hoặc theo config nếu có)
        const allCourtNames = Object.keys(matchesByCourt);
        const sortedCourtNames = allCourtNames.sort((a, b) => {
            // Cố gắng sắp xếp Sân N theo số thứ tự (Sân 1, Sân 2, ...)
            const numA = parseInt(a.replace('Sân', '').trim()) || Infinity;
            const numB = parseInt(b.replace('Sân', '').trim()) || Infinity;
            return numA - numB;
        });

        sortedCourtNames.forEach(courtName => {
            const matches = matchesByCourt[courtName] || [];
            
            // Tìm config để xác định loại bảng
            const courtConfig = state.courts.find(c => c.name === courtName);
            const isMixed = courtConfig ? courtConfig.isMixed : (matches.length > 0 ? matches[0].bang === 'A' : false);
            const startTime = courtConfig ? courtConfig.startTime : '';

            if (matches.length > 0) {
                const header = `<h6 class="mt-4">${courtName} (${isMixed ? 'Bảng A' : 'Bảng B'}) - Bắt đầu: ${startTime || '??:??'}</h6>`;
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-striped table-sm align-middle">
                            <thead>
                                <tr><th>ID</th><th>Giờ</th><th>Sân</th><th>Đội A</th><th colspan="2">Kết quả</th><th>Đội B</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                ${matches.sort((a, b) => a.time.localeCompare(b.time)).map(m => generateMatchHtml(m)).join('')}
                            </tbody>
                        </table>
                    </div>`;

                if (isMixed) {
                    htmlA += header + tableHtml;
                } else {
                    htmlB += header + tableHtml;
                }
            }
        });

        document.getElementById('scheduleAHeader').textContent = 'Bảng A (Nam - Nữ) theo Sân';
        tableMatchesA.innerHTML = htmlA || '<div class="alert alert-info">Chưa có lịch thi đấu cho các sân Bảng A.</div>';
        
        document.querySelector('#matchesViewContent > h6:nth-child(3)').textContent = 'Bảng B (Nam) theo Sân';
        tableMatchesB.innerHTML = htmlB || '<div class="alert alert-info">Chưa có lịch thi đấu cho các sân Bảng B.</div>';
        

    } else { // viewMode === 'table'
        document.getElementById('scheduleAHeader').textContent = 'Bảng A (Nam - Nữ) theo Bảng đấu';
        tableMatchesA.innerHTML = generateMatchTable(state.matchesA);
        
        document.querySelector('#matchesViewContent > h6:nth-child(3)').textContent = 'Bảng B (Nam) theo Bảng đấu';
        tableMatchesB.innerHTML = generateMatchTable(state.matchesB);
    }
}

function generateMatchTable(matches) {
    if (matches.length === 0) {
        return '<div class="alert alert-info">Chưa có lịch thi đấu cho bảng này.</div>';
    }
    return `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Giờ</th><th>Sân</th><th>Đội A</th><th colspan="2">Kết quả</th><th>Đội B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${matches.map(m => generateMatchHtml(m)).join('')}
                </tbody>
            </table>
        </div>`;
}

// Logic cập nhật điểm số (minimal implementation)
function updateScore(id, team, value, isFinal) {
    // Tìm trận đấu
    const result = findMatchById(id);
    if (!result) return;
    const match = result.match;
    
    const score = value.trim() === '' ? null : parseInt(value);

    if (team === 'A') {
        match.scoreA = score;
    } else {
        match.scoreB = score;
    }

    // Cập nhật winner/loser (logic sơ bộ)
    match.winner = null;
    match.loser = null;
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA > match.scoreB) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB > match.scoreA) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        }
    }

    // Tự động cập nhật giao diện
    renderMatchesView(); 
    if (result.isFinal) {
        renderFinals();
    }
    tinhVaCapNhatXepHang(); 
    renderOverview();
    
    stateChanged = true;
    saveToGitHub();
}

// Hàm giả lập các chức năng tính toán khác
function tinhVaCapNhatXepHang() {
    // Minimal implementation: chỉ để render không bị lỗi
    state.tableA = state.mixedTeams.map(t => ({ team: t, wins: 0, points: 0 }));
    state.tableB = state.maleTeams.map(t => ({ team: t, wins: 0, points: 0 }));
    renderRankingTables();
}
function renderRankingTables() {
    const container = document.getElementById('rankingTables');
    // ... (logic render bảng xếp hạng thực tế)
    container.innerHTML = `
        <div>
            <h6>Bảng A (Nam - Nữ)</h6>
            <div class="alert alert-info small">Chức năng tính điểm đang được cập nhật...</div>
        </div>
        <div>
            <h6>Bảng B (Nam)</h6>
            <div class="alert alert-info small">Chức năng tính điểm đang được cập nhật...</div>
        </div>
    `;
}

// Cập nhật renderFinals để hiển thị và cho phép sửa điểm + lịch
function renderFinals() {
    const containerSF = document.getElementById('semifinalMatches');
    const containerFinal = document.getElementById('finalMatch');
    
    // SF Matches
    const sfMatchesHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Giờ</th><th>Sân</th><th>Đội A</th><th colspan="2">Kết quả</th><th>Đội B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${state.semifinals.map(m => generateMatchHtml(m, true)).join('')}
                </tbody>
            </table>
        </div>
    `;
    containerSF.innerHTML = sfMatchesHtml;

    // Final Match
    const finalMatchHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Giờ</th><th>Sân</th><th>Đội A</th><th colspan="2">Kết quả</th><th>Đội B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${generateMatchHtml(state.final, true)}
                </tbody>
            </table>
        </div>
    `;
    containerFinal.innerHTML = finalMatchHtml;
    
    // Cập nhật Header
    document.querySelector('#finalsContent h6:nth-child(1)').textContent = `Vòng Bán kết (${state.semifinals[0].time}, ${state.semifinals[0].court})`;
    document.querySelector('#finalsContent h6:nth-child(2)').textContent = `Trận Chung kết (${state.final.time}, ${state.final.court})`;
}

function renderFinalResults() {
    // ... (logic render kết quả chung cuộc)
}
function renderOverview() {
    const totalMatches = state.matchesA.length + state.matchesB.length;
    const completedMatches = [...state.matchesA, ...state.matchesB].filter(m => m.scoreA !== null && m.scoreB !== null).length;
    document.getElementById('overviewContent').innerHTML = `
        <div class="card shadow-sm border-primary">
            <div class="card-body">
                <h5 class="card-title text-primary">📊 Thông tin Giải đấu (V39 - Hỗ trợ Sửa Lịch Trận)</h5>
                <p><strong>Tổng số Trận đấu:</strong> <span class="badge bg-primary">${totalMatches}</span></p>
                <p><strong>Trận đấu đã hoàn thành:</strong> <span class="badge bg-success">${completedMatches}</span> / ${totalMatches}</p>
                <p><strong>Tình trạng Đồng bộ:</strong> Import/Export theo mẫu chuẩn: <code>teamA,teamB,time,court,bang,scoreA,scoreB</code></p>
            </div>
        </div>
    `;
}

function scheduleFinalsAuto() {
    showModal('Tính toán Vòng Chung kết', 'Chức năng tự động gán đội cho Vòng Bán kết đang được thực hiện sau khi vòng bảng hoàn tất. Vui lòng hoàn thành điểm số vòng bảng trước.');
}
function taoLichThiDauCungGio() {
     showModal('Tạo Lịch Tối ưu', 'Chức năng tạo lịch tối ưu tự động chưa được triển khai trong phiên bản này.');
}
function autoFillScores() {
    showModal('Điền kết quả Tự động', 'Chức năng này được dùng để điền nhanh kết quả. Vui lòng sử dụng cẩn thận.');
}
function clearAllSchedules() {
    if (confirm("Bạn có chắc chắn muốn xóa TOÀN BỘ lịch thi đấu (Vòng Bảng và Chung kết)?")) {
        state.matchesA = [];
        state.matchesB = [];
        // Reset về cấu hình mặc định Sân 3
        state.semifinals = [
            { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 3', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 3', winner: null, runnerUp: null };
        
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal('Thành công', 'Đã xóa toàn bộ lịch thi đấu.');
    }
}
// Chức năng này đã được thay thế bằng openMatchEdit(id, isFinal) (ĐÃ CẬP NHẬT)
// function openMatchEdit(id, isFinal) {
//     showModal('Sửa Trận đấu', `Tính năng sửa trận đấu (ID: ${id}) qua modal đang được phát triển. Vui lòng chỉnh sửa trực tiếp trên bảng điểm.`);
// }

// Khởi tạo ứng dụng
window.onload = function() {
    loadConfig(); 
    const viewModeSelect = document.getElementById('viewMode'); 
    if (viewModeSelect && viewModeSelect.value !== 'court') {
        viewModeSelect.value = 'court';
    }
    
    // Nếu có token, bắt đầu quy trình tải Teams và App State từ GitHub
    if (state.config.token) { 
        loadFromGitHub();
    } else { 
        // Tải cấu hình sân mặc định (8 sân) nếu không có kết nối GitHub
        loadDefaultCourtConfig(false); // Load silently
        renderConfig();
        renderMatches();
        tinhVaCapNhatXepHang();
        renderFinals();
        renderFinalResults();
        renderOverview();
        startAutoSave();
    }
};

</script>
</body>
</html>
