// Dữ liệu lịch cố định từ file CalendarTKD36.csv (ĐÃ CẬP NHẬT)
const FIXED_SCHEDULE_CSV = `Giờ bắt đầu,Giờ kết thúc,Lượt trận,Sân 1,Sân 2,Sân 3,Sân 7,Thời lượng dự kiến
2:00,2:15,1,Tiệp/Thủy - Phương/Thanh,Giang/Long - Hường/Đạt,Hậu/Dũng - Hạnh/Tiến,Huyền/Luân - Linh/M.Hùng,0:15
2:15,2:30,2,Triều/Minh - Hiển/P.Hùng,Tín/Khiêm - Ánh/Toàn,Hậu/Dũng - Hường/Đạt,Giang/Long - Huyền/Luân,0:15
2:30,2:45,3,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,Hạnh/Tiến - Linh/M.Hùng,Triều/Minh - Hiển/P.Hùng,0:15
2:45,3:00,4,,Hạnh/Tiến - Giang/Long,Huyền/Luân - Hường/Đạt,Hậu/Dũng - Linh/M.Hùng,0:15
3:00,3:15,5,,Tiệp/Thủy - Ánh/Toàn,Tín/Khiêm - Hiển/M.Hùng,,0:15
3:15,3:30,6,,Phương/Thanh - Triều/Minh,Giang/Long - Linh/M.Hùng,,0:15
3:30,3:45,7,,Hạnh/Tiến - Hường/Đạt,Hậu/Dũng - Huyền/Luân,,0:15
3:45,4:00,8,,Tiệp/Thủy - Tín/Khiêm,Phương/Thanh - Hiển/P.Hùng,,0:15
4:00,4:15,9,,Triều/Minh - Ánh/Toàn,Tiệp/Thủy - Phương/Thanh,Hạnh/Tiến - Huyền/Luân,0:15
4:15,4:30,10,,Tín/Khiêm - Phương/Thanh,Giang/Long - Hậu/Dũng,,0:15
4:30,4:45,11,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Hậu/Dũng - Linh/M.Hùng,0:15
4:45,5:00,12,,,,0:15
5:00,5:15,13,Hậu/Dũng - Giang/Long,Huyền/Luân - Hạnh/Tiến,Linh/M.Hùng - Hường/Đạt,,0:15
5:15,5:30,14,Triều/Minh - Tiệp/Thủy,Ánh/Toàn - Hiển/P.Hùng,Phương/Thanh - Tín/Khiêm,,0:15
5:30,5:45,15,Hậu/Dũng - Huyền/Luân,Giang/Long - Linh/M.Hùng,Hạnh/Tiến - Hường/Đạt,,0:15
5:45,6:00,16,,,,0:15
6:00,6:15,17,Huyền/Luân - Giang/Long,Hậu/Dũng - Hường/Đạt,Hạnh/Tiến - Linh/M.Hùng,,0:15
6:15,6:30,18,Tiệp/Thủy - Hiển/P.Hùng,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,,0:15
6:30,6:45,19,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Tiệp/Thủy - Phương/Thanh,0:15
6:45,7:00,20,Triều/Minh - Hiển/P.Hùng,Tín/Khiêm - Ánh/Toàn,Hậu/Dũng - Hường/Đạt,Giang/Long - Huyền/Luân,0:15
7:00,7:15,21,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,Hạnh/Tiến - Linh/M.Hùng,Tiệp/Thủy - Hiển/P.Hùng,0:15
7:15,7:30,22,,Hạnh/Tiến - Giang/Long,Huyền/Luân - Hường/Đạt,Hậu/Dũng - Linh/M.Hùng,0:15
7:30,7:45,23,,Tiệp/Thủy - Ánh/Toàn,Tín/Khiêm - Hiển/P.Hùng,,0:15
7:45,8:00,24,,Phương/Thanh - Triều/Minh,Giang/Long - Linh/M.Hùng,,0:15
8:00,8:15,25,,Hạnh/Tiến - Hường/Đạt,Hậu/Dũng - Huyền/Luân,,0:15
8:15,8:30,26,,Tiệp/Thủy - Tín/Khiêm,Phương/Thanh - Hiển/P.Pùng,,0:15
8:30,8:45,27,,Triều/Minh - Ánh/Toàn,Tiệp/Thủy - Phương/Thanh,Hạnh/Tiến - Huyền/Luân,0:15
8:45,9:00,28,,Tín/Khiêm - Phương/Thanh,Giang/Long - Hậu/Dũng,,0:15
9:00,9:15,29,Hậu/Dũng - Hạnh/Tiến,Giang/Long - Hường/Đạt,Huyền/Luân - Linh/M.Hùng,Hậu/Dũng - Linh/M.Hùng,0:15
9:15,9:30,30,,,,0:15
9:30,9:45,31,Hậu/Dũng - Giang/Long,Huyền/Luân - Hạnh/Tiến,Linh/M.Hùng - Hường/Đạt,,0:15
9:45,10:00,32,Triều/Minh - Tiệp/Thủy,Ánh/Toàn - Hiển/P.Hùng,Phương/Thanh - Tín/Khiêm,,0:15
10:00,10:15,33,Hậu/Dũng - Huyền/Luân,Giang/Long - Linh/M.Hùng,Hạnh/Tiến - Hường/Đạt,,0:15
10:15,10:30,34,,,,0:15
10:30,10:45,35,Huyền/Luân - Giang/Long,Hậu/Dũng - Hường/Đạt,Hạnh/Tiến - Linh/M.Hùng,,0:15
10:45,11:00,36,Tiệp/Thủy - Hiển/P.Hùng,Phương/Thanh - Ánh/Toàn,Triều/Minh - Tín/Khiêm,,0:15`;

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = {
  mixedTeams: [], // Sẽ được tải từ players.json
  maleTeams: [],  // Sẽ được tải từ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // Bảng xếp hạng A
  tableB: [], // Bảng xếp hạng B
  
  // NEW: Court Configuration
  courts: [
    { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // Bảng A (Mixed)
    { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // Bảng B (Male)
    { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } // Bảng B (Male)
  ],
  
  // LOGIC BÁN KẾT (Nhất A vs Nhì A, Nhất B vs Nhì B)
  semifinals: [
    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null },
  config: {}
};

let stateChanged = false; // Biến cờ theo dõi thay đổi dữ liệu
let currentSha = null; // Biến lưu trữ SHA của file trên GitHub
let autoSaveInterval = null; // Biến lưu trữ ID của interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * Hàm chuyển đổi tab
 * @param {string} tabId - ID của tab cần chuyển (ví dụ: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // Tắt tab đang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // Bật tab mới
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // Cập nhật view cho tab matches nếu chuyển đến
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API Functions ---

/**
 * Lấy SHA mới nhất của file state.json trên GitHub.
 * @param {object} cfg - Cấu hình GitHub (owner, repo, folder, file, token)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Chỉ lưu SHA của state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            throw new Error(`Lỗi khi lấy SHA: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Lỗi Fetch SHA (${fileName}):`, error);
        throw new Error(`Lỗi kết nối hoặc API: ${error.message}`);
    }
}

/**
 * Tải danh sách đội từ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'Đang tải danh sách đội từ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `Tải danh sách đội thành công (${state.mixedTeams.length + state.maleTeams.length} đội).`);
                return true;
            } else {
                throw new Error("File players.json không đúng định dạng (thiếu mixedTeams/maleTeams).");
            }
        } else {
            updateStatus('configStatus', 'warning', 'Không tìm thấy file players.json. Vui lòng tạo file này trên GitHub.');
            return false;
        }
    } catch (error) {
        console.error("Lỗi khi tải players.json:", error);
        updateStatus('configStatus', 'danger', `Lỗi tải danh sách đội: ${error.message}`);
        return false;
    }
}

/**
 * Tải trạng thái giải đấu (state.json) từ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) return;

    // 1. Load Teams (danh sách đội)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'Đang tải trạng thái giải đấu từ GitHub (state.json)...');
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi đè các giá trị cần thiết
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            if (loadedState.courts) {
                state.courts = loadedState.courts;
            }
            state.semifinals = loadedState.semifinals || state.semifinals;
            state.final = loadedState.final || state.final;
            
            // Cập nhật giao diện
            renderMatches(); 
            tinhVaCapNhatXepHang();
            renderFinals();
            renderFinalResults();
            renderOverview();
            
            updateStatus('configStatus', 'success', `Tải trạng thái giải đấu thành công từ: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
            updateStatus('configStatus', 'warning', 'File trạng thái (state.json) chưa tồn tại. Vui lòng nhấn Lưu hoặc Tự động lưu để tạo file.');
        }

        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Lỗi tải trạng thái giải đấu: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi khi tải trạng thái giải đấu từ GitHub:", error);
    }
}

async function saveToGitHub() {
    // Bỏ qua nếu không có thay đổi
    if (!stateChanged) return;

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Không thể tự động lưu: Thiếu cấu hình GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Tạm dừng (Thiếu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'Đang lưu...';

    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Chỉ lưu các trường cần thiết
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Luôn fetch SHA mới nhất trước khi cố gắng lưu
        const result = await fetchFileSha(cfg, cfg.file); // Lấy SHA của state.json
        const sha = result.sha; 
        
        const payload = {
            message: `[Auto-save] Cập nhật trạng thái giải đấu TKD lúc ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'Đã Lưu';
        } else {
            if (response.status === 409) {
                console.warn("Lỗi 409 Conflict: Dữ liệu đã thay đổi trên GitHub. Đang cố gắng lấy SHA mới.");
                await fetchFileSha(cfg, cfg.file); 
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. Sẽ thử lưu lại sau 1 phút.';
            } else {
                throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lưu lên GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Lỗi Lưu';
    }
}

async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui lòng nhập đầy đủ Owner, Repo và Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'Đang kiểm tra kết nối...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`Lỗi truy cập kho lưu trữ. Mã: ${repoResponse.status}. (Kiểm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', 'Kết nối GitHub thành công! Đang tải dữ liệu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Kiểm tra kết nối thất bại: ${error.message}.`);
        console.error("Lỗi kiểm tra kết nối:", error);
    }
}

function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    if (state.config.token && state.config.owner && state.config.repo) {
        autoSaveInterval = setInterval(saveToGitHub, 60000); // Lưu mỗi 60 giây
        document.getElementById('autoState').className = 'text-success';
        document.getElementById('autoState').textContent = 'Bật';
    } else {
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Tắt';
    }
}

// --- Cấu hình & Khởi tạo ---

function renderConfig() {
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
}

/**
 * Hiển thị danh sách sân dưới dạng bảng với nút Sửa/Xóa.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Chưa có sân nào được cấu hình.</div>`;
        return;
    }
    
    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>Tên Sân</th>
                <th>Giờ Bắt Đầu</th>
                <th>Thời Lượng Max (Phút)</th>
                <th>Phân Loại</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>`;
        
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'Bảng A (Nam-Nữ)' : 'Bảng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">Xóa</button>
            </td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * Mở modal thêm/sửa sân và điền dữ liệu nếu là chế độ sửa.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';

    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'Sửa Cấu hình Sân' : 'Thêm Sân Mới';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Chế độ thêm mới: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = '180';
        document.getElementById('courtIsMixed').checked = true; // Default to Mixed (Bảng A)
    }

    modal.show();
}

/**
 * Lưu thay đổi từ modal vào state.courts
 */
function saveCourtChanges() {
    const indexStr = document.getElementById('courtIndex').value;
    const index = indexStr === '' ? null : parseInt(indexStr);
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;
    const statusDiv = document.getElementById('courtFormStatus');

    // Validation
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui lòng nhập đầy đủ và hợp lệ các trường (Tên, Giờ, Thời lượng > 0).</div>`;
        return;
    }

    // Check for duplicate name (excluding the current edited court)
    const isDuplicate = state.courts.some((c, i) => i !== index && c.name.toLowerCase() === name.toLowerCase() );
    if (isDuplicate) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Tên sân "${name}" đã tồn tại.</div>`;
        return;
    }

    const newCourt = { name, startTime, maxDurationMinutes, isMixed };
    if (index !== null) { // Edit mode
        state.courts[index] = newCourt;
    } else { // Add mode
        state.courts.push(newCourt);
    }

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();

    // Update UI and save
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', `Đã ${index !== null ? 'cập nhật' : 'thêm'} sân "${name}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
    saveToGitHub();
}

/**
 * Xóa sân khỏi danh sách.
 */
function deleteCourt(index) {
    if (confirm(`Bạn có chắc chắn muốn xóa sân "${state.courts[index].name}"?`)) {
        const deletedCourtName = state.courts[index].name;
        state.courts.splice(index, 1);
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', `Đã xóa sân "${deletedCourtName}". Dữ liệu sẽ được tự động lưu lên GitHub.`);
        saveToGitHub();
    }
}

/**
 * Tải cấu hình mặc định
 */
function loadDefaultCourtConfig() {
    state.courts = [
        { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }
    ];
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', 'Đã tải cấu hình sân Mặc định. Dữ liệu sẽ được tự động lưu lên GitHub.');
    saveToGitHub();
}

function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'state.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}

function saveConfig(){
    const cfg = {
        owner: document.getElementById('cfgOwner').value,
        repo: document.getElementById('cfgRepo').value,
        folder: document.getElementById('cfgFolder').value,
        file: document.getElementById('cfgFile').value,
        token: document.getElementById('cfgToken').value
    };
    state.config = cfg;
    localStorage.setItem('pkb_config', JSON.stringify(cfg));
    updateStatus('configStatus', 'success', 'Đã lưu cấu hình GitHub vào trình duyệt. Vui lòng Kiểm tra & Tải Dữ liệu.');
}

function updateStatus(id, type, message) {
    const statusDiv = document.getElementById(id);
    statusDiv.innerHTML = `<div class="alert alert-${type} p-2 mt-2">${message}</div>`;
}

// --- CSV/Lịch Thi Đấu Helper Functions ---

/**
 * Chuyển đổi CSV sang mảng đối tượng.
 */
function csvToArray(text) {
    const lines = text.split('\n').filter(line => line.trim() !== '');
    if (lines.length < 2) return [];

    // Header: Giờ bắt đầu,Giờ kết thúc,Lượt trận,Sân 1,Sân 2,Sân 3,Sân 7,Thời lượng dự kiến
    const headers = lines[0].split(',').map(h => h.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        // Chỉ lấy các trận đấu thực tế (cột Sân 1 trở đi)
        for (let j = 3; j < headers.length - 1; j++) {
            const matchString = values[j] ? values[j].trim() : '';
            if (matchString) {
                const [teamA, teamB] = matchString.split('-').map(t => t.trim());
                if (teamA && teamB) {
                    result.push({
                        time: values[0].trim(),
                        court: headers[j].trim(),
                        teamA: teamA,
                        teamB: teamB,
                        scoreA: null,
                        scoreB: null,
                        bang: null // Sẽ được gán sau
                    });
                }
            }
        }
    }
    return result;
}

/**
 * Tách đội A và B từ chuỗi (Ví dụ: "Đội A - Đội B")
 */
function parseTeamName(matchString) {
    const parts = matchString.split('-').map(t => t.trim());
    return { teamA: parts[0], teamB: parts[1] };
}

// --- Scheduling Functions ---

/**
 * Tạo tất cả các cặp đấu (All Play All)
 */
function generateAllMatches(teams, bang) {
    const matches = [];
    for (let i = 0; i < teams.length; i++) {
        for (let j = i + 1; j < teams.length; j++) {
            matches.push({
                id: `${bang}-${teams[i]}-${teams[j]}`,
                teamA: teams[i],
                teamB: teams[j],
                scoreA: null,
                scoreB: null,
                time: null,
                court: null,
                bang: bang
            });
        }
    }
    return matches;
}

/**
 * Hàm Lên lịch Tối ưu (Tự động)
 * Phân bổ các trận đấu vào các sân theo thời gian bắt đầu
 */
function taoLichThiDauCungGio() {
    if (state.mixedTeams.length < 2 && state.maleTeams.length < 2) {
        showModal('Lỗi', 'Vui lòng đảm bảo đã tải danh sách đội từ file players.json (tại tab Cấu hình).');
        return;
    }
    
    // 1. Khởi tạo danh sách trận đấu
    let allMatchesA = generateAllMatches(state.mixedTeams, 'A');
    let allMatchesB = generateAllMatches(state.maleTeams, 'B');

    // 2. Khởi tạo trạng thái sân
    const courtStates = state.courts.map(court => ({
        ...court,
        currentTime: court.startTime,
        matches: []
    }));

    // Hàm kiểm tra đội đang bận
    const isTeamPlaying = (teamName, matchArray) => {
        return matchArray.some(match => 
            (match.teamA === teamName || match.teamB === teamName) && 
            match.scoreA === null // Chỉ coi là bận nếu trận đấu chưa kết thúc (chưa có điểm)
        );
    };

    let matchIdCounter = 1;
    let availableMatchesA = [...allMatchesA];
    let availableMatchesB = [...allMatchesB];
    const totalMatches = allMatchesA.length + allMatchesB.length;
    
    // Lặp cho đến khi hết trận đấu hoặc hết thời gian sân
    while (availableMatchesA.length > 0 || availableMatchesB.length > 0) {
        let isMatchScheduledInCycle = false;

        // Sắp xếp sân theo thời gian sớm nhất có thể bắt đầu
        courtStates.sort((a, b) => a.currentTime.localeCompare(b.currentTime));
        
        const currentCycleTime = courtStates[0].currentTime;

        for (const court of courtStates) {
            // Kiểm tra xem sân còn thời gian hoạt động không
            const courtEndTime = addMinutes(court.startTime, court.maxDurationMinutes);
            if (court.currentTime.localeCompare(courtEndTime) >= 0) continue;

            const matchesToSchedule = court.isMixed ? availableMatchesA : availableMatchesB;
            const teamsInBang = court.isMixed ? state.mixedTeams : state.maleTeams;
            
            // Tìm trận đấu phù hợp
            let matchIndex = -1;
            for (let i = 0; i < matchesToSchedule.length; i++) {
                const match = matchesToSchedule[i];
                // Kiểm tra đội không trùng lặp
                const teamAIsPlaying = isTeamPlaying(match.teamA, court.matches);
                const teamBIsPlaying = isTeamPlaying(match.teamB, court.matches);
                
                if (!teamAIsPlaying && !teamBIsPlaying) {
                    matchIndex = i;
                    break;
                }
            }

            if (matchIndex !== -1) {
                const scheduledMatch = matchesToSchedule.splice(matchIndex, 1)[0];
                scheduledMatch.time = currentCycleTime;
                scheduledMatch.court = court.name;
                scheduledMatch.id = court.isMixed ? `A-${matchIdCounter}` : `B-${matchIdCounter}`;
                
                court.matches.push(scheduledMatch);
                isMatchScheduledInCycle = true;
                matchIdCounter++;
            }
        }
        
        // Nếu không có trận nào được xếp lịch trong chu kỳ này, tăng thời gian cho sân sớm nhất
        if (isMatchScheduledInCycle) {
            // Lần lượt tăng thời gian của các sân có trận đấu được xếp lịch trong chu kỳ
             courtStates.forEach(court => {
                if (court.matches.length > 0 && court.matches[court.matches.length - 1].time === currentCycleTime) {
                    court.currentTime = addMinutes(currentCycleTime, 15); // Giả sử mỗi trận 15 phút
                }
            });
        } else {
            // Nếu không xếp được trận nào, chuyển sang thời điểm 15 phút sau
            courtStates[0].currentTime = addMinutes(currentCycleTime, 15);
        }
    }
    
    // Gộp kết quả
    state.matchesA = courtStates.filter(c => c.isMixed).flatMap(c => c.matches);
    state.matchesB = courtStates.filter(c => !c.isMixed).flatMap(c => c.matches);

    showModal('Thành công', `Đã tạo ${state.matchesA.length + state.matchesB.length} trận đấu tối ưu (${allMatchesA.length} A, ${allMatchesB.length} B).`);
    renderMatchesView();
    stateChanged = true;
    saveToGitHub();
}

/**
 * Tạo lịch từ dữ liệu CSV cố định
 */
function taoLichCoDinh() {
    const rawMatches = csvToArray(FIXED_SCHEDULE_CSV);
    
    // 1. Phân loại theo Bảng A (Mixed) và Bảng B (Male)
    const matchesA = [];
    const matchesB = [];

    rawMatches.forEach((match, index) => {
        // Tạm thời dựa vào data mẫu có gán bảng (thường là trong file CSV)
        // Nhưng vì CSV không có cột 'bang', ta phải đoán thủ công dựa trên tên đội.
        // Tuy nhiên, để đảm bảo khớp với logic, ta phải kiểm tra nếu lịch được tạo từ một file CSV
        // thực tế có cột 'bang'. Nếu không, ta sẽ dựa vào việc kiểm tra tên đội với state.mixedTeams/maleTeams
        
        // Lấy danh sách đội hợp lệ từ state (nếu đã được tải từ players.json)
        const allTeamsA = state.mixedTeams;
        const allTeamsB = state.maleTeams;

        // Giả định: Nếu cả 2 đội đều có trong MixedTeams (Bảng A) và không có trong MaleTeams (Bảng B)
        const isTeamA_Mixed = allTeamsA.includes(match.teamA);
        const isTeamB_Mixed = allTeamsA.includes(match.teamB);
        
        const isTeamA_Male = allTeamsB.includes(match.teamA);
        const isTeamB_Male = allTeamsB.includes(match.teamB);

        // Logic phân loại (có thể cần điều chỉnh nếu data sample không rõ ràng)
        let bang = 'A'; // Mặc định là A
        if (isTeamA_Male && isTeamB_Male && !isTeamA_Mixed && !isTeamB_Mixed) {
             bang = 'B';
        } 
        
        const newMatch = {
            id: `${bang}-${index + 1}`,
            teamA: match.teamA,
            teamB: match.teamB,
            scoreA: null,
            scoreB: null,
            time: match.time,
            court: match.court,
            bang: bang
        };

        if (bang === 'A') {
            matchesA.push(newMatch);
        } else {
            matchesB.push(newMatch);
        }
    });

    state.matchesA = matchesA;
    state.matchesB = matchesB;
    showModal('Thành công', `Đã nhập ${matchesA.length + matchesB.length} trận đấu từ Lịch Cố định.`);
    renderMatchesView();
    stateChanged = true;
    saveToGitHub();
}

/**
 * Xóa toàn bộ lịch thi đấu (Vòng Bảng và Chung kết)
 */
function clearAllSchedules() {
    if (confirm("Bạn có chắc chắn muốn XÓA TOÀN BỘ lịch thi đấu Vòng Bảng và Vòng Chung kết không? Hành động này không thể hoàn tác.")) {
        state.matchesA = [];
        state.matchesB = [];
        state.semifinals = [
             { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 1', winner: null, loser: null },
             { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '16:30', court: 'Sân 2', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'Sân 1', winner: null, runnerUp: null };
        state.tableA = [];
        state.tableB = [];

        renderMatchesView();
        renderFinals();
        renderFinalResults();
        renderOverview();

        stateChanged = true;
        saveToGitHub();
        showModal('Thành công', 'Đã xóa toàn bộ lịch thi đấu.');
    }
}

/**
 * Điền kết quả ngẫu nhiên (11 - X) cho các trận chưa đấu
 */
function autoFillScores() {
    [...state.matchesA, ...state.matchesB].forEach(match => {
        if (match.scoreA === null && match.scoreB === null) {
            // Điền ngẫu nhiên (15 điểm)
            if (Math.random() < 0.5) {
                match.scoreA = 15;
                match.scoreB = Math.floor(Math.random() * 15); // Điểm thua từ 0-14
            } else {
                match.scoreB = 15;
                match.scoreA = Math.floor(Math.random() * 15);
            }
        }
    });
    
    // Điền ngẫu nhiên cho Vòng Chung kết (nếu đã được gán đội)
    [...state.semifinals, state.final].forEach(match => {
        if (match.scoreA === null && match.scoreB === null) {
             // Kiểm tra nếu cặp đấu đã được gán đội thực tế
            const isAssigned = match.teamA !== 'Nhất A' && match.teamA !== 'Thắng SF1' && match.teamA !== 'Nhất B';
            
            if (isAssigned) {
                 if (Math.random() < 0.5) {
                    match.scoreA = 15;
                    match.scoreB = Math.floor(Math.random() * 15); // Điểm thua từ 0-14
                } else {
                    match.scoreB = 15;
                    match.scoreA = Math.floor(Math.random() * 15);
                }
                
                // Cập nhật winner/loser (sử dụng lại logic kiểm tra 15 điểm)
                if (match.scoreA === 15 && match.scoreB <= 14) {
                    match.winner = match.teamA;
                    match.loser = match.teamB;
                } else if (match.scoreB === 15 && match.scoreA <= 14) {
                    match.winner = match.teamB;
                    match.loser = match.teamA;
                }
                
                if (match.id === 'F') {
                    match.runnerUp = match.loser;
                }
            }
        }
    });


    tinhVaCapNhatXepHang();
    renderMatchesView();
    renderFinals();
    renderOverview();
    
    stateChanged = true;
    saveToGitHub();
    showModal('Điền kết quả Tự động', 'Đã điền kết quả (15 - X) cho các trận đấu chưa hoàn thành.');
}

/**
 * Xử lý nhập file CSV
 */
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const importedMatches = csvToArray(text);
        
        if (importedMatches.length === 0) {
            showModal('Lỗi', 'File CSV không chứa dữ liệu trận đấu hợp lệ.');
            return;
        }

        if (confirm(`Bạn có muốn nhập ${importedMatches.length} trận đấu từ file CSV này không? Dữ liệu lịch cũ sẽ bị XÓA.`)) {
            // Phân loại và gán id lại
            let idA = 1, idB = 1;
            state.matchesA = [];
            state.matchesB = [];

            importedMatches.forEach(match => {
                const teamsA = state.mixedTeams.map(t => t.trim());
                const teamsB = state.maleTeams.map(t => t.trim());

                let bang = 'A';
                // Logic phán đoán bảng (tạm thời)
                if (teamsB.includes(match.teamA) && teamsB.includes(match.teamB)) {
                    bang = 'B';
                }
                // Nếu không có danh sách đội, phải dựa vào cột 'bang' trong CSV
                // Nhưng CSV mẫu không có, nên ta sẽ chấp nhận cách phân loại đơn giản nếu không có data teams.

                match.bang = bang;
                match.id = bang === 'A' ? `A-${idA++}` : `B-${idB++}`;
                
                if (bang === 'A') {
                    state.matchesA.push(match);
                } else {
                    state.matchesB.push(match);
                }
            });

            showModal('Thành công', `Đã nhập ${importedMatches.length} trận đấu. Vui lòng kiểm tra lại sự phân loại Bảng A/B.`);
            renderMatchesView();
            stateChanged = true;
            saveToGitHub();
        }
    };
    reader.readAsText(file);
}

/**
 * Xuất lịch thi đấu hiện tại ra file CSV
 */
function exportSchedule() {
    const allMatches = [...state.matchesA, ...state.matchesB];
    if (allMatches.length === 0) {
        showModal('Lỗi', 'Không có lịch thi đấu để xuất.');
        return;
    }
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "teamA,teamB,time,court,bang,scoreA,scoreB\n";

    allMatches.forEach(match => {
        const row = [
            match.teamA,
            match.teamB,
            match.time || '',
            match.court || '',
            match.bang,
            match.scoreA === null ? '' : match.scoreA,
            match.scoreB === null ? '' : match.scoreB
        ];
        csvContent += row.join(",") + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "LichThiDau_TKD.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showModal('Xuất CSV', 'Đã xuất file LịchThiDau_TKD.csv');
}

// --- Ranking & Final Logic ---

/**
 * Tính toán và cập nhật Bảng xếp hạng
 */
function tinhVaCapNhatXepHang() {
    const calculateRanking = (teams, matches, bang) => {
        const stats = {};
        teams.forEach(team => {
            stats[team] = {
                team: team,
                P: 0, // Played
                W: 0, // Win
                L: 0, // Loss
                PF: 0, // Points For
                PA: 0, // Points Against
                PD: 0, // Point Difference
                Pts: 0 // Total Points (Win=2, Loss=1)
            };
        });

        matches.forEach(match => {
            const { teamA, teamB, scoreA, scoreB } = match;

            if (scoreA !== null && scoreB !== null) {
                // Cập nhật trận đã đấu
                stats[teamA].P += 1;
                stats[teamB].P += 1;

                // Cập nhật điểm Thắng/Thua
                if (scoreA > scoreB) {
                    stats[teamA].W += 1;
                    stats[teamB].L += 1;
                    stats[teamA].Pts += 2; // Thắng: 2 điểm
                    stats[teamB].Pts += 1; // Thua: 1 điểm
                } else if (scoreB > scoreA) {
                    stats[B].W += 1;
                    stats[A].L += 1;
                    stats[teamB].Pts += 2; // Thắng: 2 điểm
                    stats[teamA].Pts += 1; // Thua: 1 điểm
                }
                
                // Cập nhật điểm ghi được/bị ghi
                stats[teamA].PF += scoreA;
                stats[teamA].PA += scoreB;
                stats[teamB].PF += scoreB;
                stats[teamB].PA += scoreA;
            }
        });
        
        // Tính điểm chênh lệch và chuyển thành mảng
        const rankingTable = Object.values(stats).map(s => {
            s.PD = s.PF - s.PA;
            return s;
        });

        // Sắp xếp: 
        // 1. Tổng điểm (Pts)
        // 2. Hiệu số điểm (PD)
        // 3. Điểm ghi được (PF)
        rankingTable.sort((a, b) => {
            if (b.Pts !== a.Pts) return b.Pts - a.Pts;
            if (b.PD !== a.PD) return b.PD - a.PD;
            return b.PF - a.PF;
        });
        
        return rankingTable;
    };

    // Chỉ tính khi có đội
    if (state.mixedTeams.length > 0) {
        state.tableA = calculateRanking(state.mixedTeams, state.matchesA, 'A');
    }
    if (state.maleTeams.length > 0) {
        state.tableB = calculateRanking(state.maleTeams, state.matchesB, 'B');
    }

    // Cập nhật hiển thị (sẽ được gọi lại bởi hàm gọi bên ngoài)
    renderRankingTables();
}

/**
 * Lên lịch Vòng Chung kết (Tự động hóa)
 */
function scheduleFinalsAuto() {
    if (state.tableA.length < 2 || state.tableB.length < 2) {
        showModal('Lỗi', 'Vòng Bảng chưa hoàn thành hoặc chưa đủ dữ liệu để xếp hạng. Cần ít nhất 2 đội đã đấu ở mỗi bảng.');
        return;
    }

    // Kiểm tra tất cả các trận vòng bảng đã đấu xong chưa
    const remainingA = state.matchesA.filter(m => m.scoreA === null).length;
    const remainingB = state.matchesB.filter(m => m.scoreA === null).length;
    
    if (remainingA > 0 || remainingB > 0) {
         showModal('Cảnh báo', `Vòng Bảng còn ${remainingA + remainingB} trận chưa hoàn thành. Xếp hạng có thể chưa chính xác.`);
         // Vẫn tiếp tục nếu user muốn xem trước
    }
    
    // Lấy Nhất/Nhì các bảng
    const nhatA = state.tableA[0]?.team;
    const nhiA = state.tableA[1]?.team;
    const nhatB = state.tableB[0]?.team;
    const nhiB = state.tableB[1]?.team;

    // Gán vào Bán kết (giữ nguyên thời gian/sân mặc định)
    state.semifinals[0].teamA = nhatA;
    state.semifinals[0].teamB = nhiA;
    state.semifinals[0].scoreA = null;
    state.semifinals[0].scoreB = null;
    state.semifinals[0].winner = null;
    state.semifinals[0].loser = null;

    state.semifinals[1].teamA = nhatB;
    state.semifinals[1].teamB = nhiB;
    state.semifinals[1].scoreA = null;
    state.semifinals[1].scoreB = null;
    state.semifinals[1].winner = null;
    state.semifinals[1].loser = null;
    
    // Reset Chung kết
    state.final.teamA = 'Thắng SF1';
    state.final.teamB = 'Thắng SF2';
    state.final.scoreA = null;
    state.final.scoreB = null;
    state.final.winner = null;
    state.final.runnerUp = null;


    showModal('Lên lịch Chung kết', `Đã tự động gán: Bán kết 1 (${nhatA} vs ${nhiA}), Bán kết 2 (${nhatB} vs ${nhiB}).`);
    renderFinals();
    stateChanged = true;
    saveToGitHub();
}

/**
 * Cập nhật điểm trận đấu (Vòng Bảng hoặc Vòng Chung kết)
 */
function updateScore(matchId, bang, scoreType, value) {
    let matchesArray;
    let isFinals = false;

    if (bang === 'A') {
        matchesArray = state.matchesA;
    } else if (bang === 'B') {
        matchesArray = state.matchesB;
    } else { // Finals
        matchesArray = [...state.semifinals, state.final];
        isFinals = true;
    }

    const match = matchesArray.find(m => m.id === matchId);
    if (!match) return;

    const score = parseInt(value);
    if (isNaN(score) || score < 0) {
        match[scoreType] = null;
    } else {
        match[scoreType] = score;
    }

    if (isFinals) {
        // Cập nhật winner/loser cho Chung kết
        if (match.scoreA !== null && match.scoreB !== null) {
            if (match.scoreA === 15 && match.scoreB <= 14) { // Thắng
                match.winner = match.teamA;
                match.loser = match.teamB;
            } else if (match.scoreB === 15 && match.scoreA <= 14) {
                match.winner = match.teamB;
                match.loser = match.teamA;
            } else { // Chưa phân định thắng thua (chưa đủ 15)
                match.winner = null;
                match.loser = null;
            }

            if (match.id === 'F' && match.winner) {
                match.runnerUp = match.loser;
            }
        }
        
        // Cập nhật đội vào trận tiếp theo (tự động)
        if (match.id === 'SF1' && match.winner) {
            state.final.teamA = match.winner;
            state.final.scoreA = null; // Reset điểm trận sau
            state.final.scoreB = null;
        } else if (match.id === 'SF2' && match.winner) {
            state.final.teamB = match.winner;
            state.final.scoreA = null; // Reset điểm trận sau
            state.final.scoreB = null;
        } else if (match.id.startsWith('SF') && !match.winner) {
            // Reset đội nếu chưa có người thắng
            const defaultTeam = match.id === 'SF1' ? 'Thắng SF1' : 'Thắng SF2';
            const target = match.id === 'SF1' ? 'teamA' : 'teamB';
            
            if (state.final[target] !== defaultTeam) {
                state.final[target] = defaultTeam;
                state.final.scoreA = null; 
                state.final.scoreB = null;
            }
        }

        renderFinals();
        renderFinalResults();

    } else {
        // Vòng bảng: Chỉ cần cập nhật giao diện
        // Cập nhật xếp hạng ngay để thấy thay đổi
        tinhVaCapNhatXepHang();
        renderMatchesView();
    }

    renderOverview(); // Cập nhật tổng quan

    stateChanged = true;
    saveToGitHub();
}


// --- Rendering Functions ---

function renderMatchesTable(matches, tableId, bangName) {
    const tableDiv = document.getElementById(tableId);
    if (matches.length === 0) {
        tableDiv.innerHTML = `<div class="alert alert-info">Chưa có lịch thi đấu cho ${bangName}.</div>`;
        return;
    }

    let html = `<div class='table-responsive'><table class='table table-bordered table-hover table-sm'>
        <thead>
            <tr>
                <th>ID</th>
                <th>Giờ</th>
                <th>Sân</th>
                <th>Đội A</th>
                <th>Điểm A</th>
                <th>Điểm B</th>
                <th>Đội B</th>
                <th>Kết quả</th>
            </tr>
        </thead>
        <tbody>`;

    matches.forEach(match => {
        const resultClass = match.scoreA !== null ? 'table-light' : '';
        const winner = match.scoreA > match.scoreB ? 'winner' : (match.scoreB > match.scoreA ? 'loser' : '');
        const loser = match.scoreB > match.scoreA ? 'winner' : (match.scoreA > match.scoreB ? 'loser' : '');

        html += `<tr class="${resultClass}">
            <td>${match.id}</td>
            <td>${match.time || 'N/A'}</td>
            <td>${match.court || 'N/A'}</td>
            <td class="${winner === 'winner' ? 'winner' : ''}">${match.teamA}</td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}" 
                       onchange="updateScore('${match.id}', '${match.bang}', 'scoreA', this.value)">
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}"
                       onchange="updateScore('${match.id}', '${match.bang}', 'scoreB', this.value)">
            </td>
            <td class="${loser === 'winner' ? 'winner' : ''}">${match.teamB}</td>
            <td>${match.scoreA !== null ? (match.scoreA > match.scoreB ? 'A thắng' : (match.scoreB > match.scoreA ? 'B thắng' : 'Hòa')) : 'Chưa đấu'}</td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    tableDiv.innerHTML = html;
}

function renderMatchesCourt(matches, contentDivId) {
    const container = document.getElementById(contentDivId);
    if (!container) return;
    
    if (matches.length === 0) {
        container.innerHTML = `<div class="alert alert-info">Chưa có lịch thi đấu.</div>`;
        return;
    }

    // Nhóm trận đấu theo Sân và Giờ
    const groupedMatches = {};
    matches.forEach(match => {
        if (!groupedMatches[match.court]) {
            groupedMatches[match.court] = {};
        }
        if (!groupedMatches[match.court][match.time]) {
            groupedMatches[match.court][match.time] = [];
        }
        groupedMatches[match.court][match.time].push(match);
    });
    
    // Sắp xếp theo Sân
    const sortedCourts = Object.keys(groupedMatches).sort();
    
    let html = '';
    
    // Lặp qua từng Sân
    sortedCourts.forEach(courtName => {
        html += `<h6 class="mt-4 border-bottom pb-1 text-primary">Sân ${courtName}</h6>`;
        
        const courtTimeSlots = groupedMatches[courtName];
        // Sắp xếp theo Giờ
        const sortedTimes = Object.keys(courtTimeSlots).sort();
        
        html += `<div class='table-responsive'><table class='table table-bordered table-hover table-sm'>
            <thead>
                <tr>
                    <th>Giờ</th>
                    <th>Đội A</th>
                    <th>Điểm A</th>
                    <th>Điểm B</th>
                    <th>Đội B</th>
                </tr>
            </thead>
            <tbody>`;
            
        sortedTimes.forEach(time => {
            courtTimeSlots[time].forEach(match => {
                 const resultClass = match.scoreA !== null ? 'table-light' : '';
                 const winnerA = (match.scoreA !== null && match.scoreA > match.scoreB) ? 'winner' : '';
                 const winnerB = (match.scoreB !== null && match.scoreB > match.scoreA) ? 'winner' : '';

                 html += `<tr class="${resultClass}">
                    <td>${match.time || 'N/A'}</td>
                    <td class="${winnerA}">${match.teamA}</td>
                    <td class="match-score-cell">
                        <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}" 
                               onchange="updateScore('${match.id}', '${match.bang}', 'scoreA', this.value)">
                    </td>
                    <td class="match-score-cell">
                        <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}"
                               onchange="updateScore('${match.id}', '${match.bang}', 'scoreB', this.value)">
                    </td>
                    <td class="${winnerB}">${match.teamB}</td>
                </tr>`;
            });
        });
        
        html += `</tbody></table></div>`;
    });

    container.innerHTML = html;
}

function renderMatchesView() {
    const viewMode = document.getElementById('viewMode').value;
    const container = document.getElementById('matchesViewContent');

    if (viewMode === 'table') {
        container.innerHTML = `
            <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA"></div>
            <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB"></div>
        `;
        renderMatchesTable(state.matchesA, 'tableMatchesA', 'Bảng A');
        renderMatchesTable(state.matchesB, 'tableMatchesB', 'Bảng B');
    } else { // court view
        container.innerHTML = `<div id="courtMatchesContent"></div>`;
        renderMatchesCourt([...state.matchesA, ...state.matchesB], 'courtMatchesContent');
    }
}

function renderFinals() {
    const container = document.getElementById('finalsContent');
    
    let html = `
        <h6 class="mt-4">Vòng Bán kết (16:30, Sân 1-2)</h6>
        <div id="semifinalMatches">`;
    
    if (state.semifinals.length === 0) {
        html += `<div class="alert alert-info">Chưa có lịch thi đấu bán kết.</div>`;
    } else {
        html += `<div class='table-responsive'><table class='table table-bordered table-hover table-sm'>
            <thead>
                <tr>
                    <th>Trận</th>
                    <th>Giờ</th>
                    <th>Sân</th>
                    <th>Đội A</th>
                    <th>Điểm A</th>
                    <th>Điểm B</th>
                    <th>Đội B</th>
                    <th>Kết quả</th>
                </tr>
            </thead>
            <tbody>`;
        
        state.semifinals.forEach(match => {
             const resultClass = match.scoreA !== null ? 'table-warning' : '';
             const winnerA = (match.scoreA !== null && match.scoreA > match.scoreB) ? 'winner' : '';
             const winnerB = (match.scoreB !== null && match.scoreB > match.scoreA) ? 'winner' : '';
             
             html += `<tr class="${resultClass}">
                <td>${match.id}</td>
                <td>${match.time || 'N/A'}</td>
                <td>${match.court || 'N/A'}</td>
                <td class="${winnerA}">${match.teamA}</td>
                <td class="match-score-cell">
                    <input type="number" min="0" value="${match.scoreA !== null ? match.scoreA : ''}" 
                           onchange="updateScore('${match.id}', 'Finals', 'scoreA', this.value)">
                </td>
                <td class="match-score-cell">
                    <input type="number" min="0" value="${match.scoreB !== null ? match.scoreB : ''}"
                           onchange="updateScore('${match.id}', 'Finals', 'scoreB', this.value)">
                </td>
                <td class="${winnerB}">${match.teamB}</td>
                <td>${match.winner ? `${match.winner} (Thắng)` : 'Chưa đấu'}</td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
    }

    html += `</div>
        <h6 class="mt-4">Trận Chung kết (17:00, Sân 1)</h6>
        <div id="finalMatch">`;

    const finalMatch = state.final;
    const finalResultClass = finalMatch.scoreA !== null ? 'table-danger' : '';
    const finalWinnerA = (finalMatch.scoreA !== null && finalMatch.scoreA > finalMatch.scoreB) ? 'winner' : '';
    const finalWinnerB = (finalMatch.scoreB !== null && finalMatch.scoreB > finalMatch.scoreA) ? 'winner' : '';


    html += `<div class='table-responsive'><table class='table table-bordered table-sm'>
            <thead>
                <tr>
                    <th>Giờ</th>
                    <th>Sân</th>
                    <th>Đội A</th>
                    <th>Điểm A</th>
                    <th>Điểm B</th>
                    <th>Đội B</th>
                    <th>Kết quả</th>
                </tr>
            </thead>
            <tbody>
                <tr class="${finalResultClass}">
                    <td>${finalMatch.time || 'N/A'}</td>
                    <td>${finalMatch.court || 'N/A'}</td>
                    <td class="${finalWinnerA}">${finalMatch.teamA}</td>
                    <td class="match-score-cell">
                        <input type="number" min="0" value="${finalMatch.scoreA !== null ? finalMatch.scoreA : ''}" 
                               onchange="updateScore('${finalMatch.id}', 'Finals', 'scoreA', this.value)">
                    </td>
                    <td class="match-score-cell">
                        <input type="number" min="0" value="${finalMatch.scoreB !== null ? finalMatch.scoreB : ''}"
                               onchange="updateScore('${finalMatch.id}', 'Finals', 'scoreB', this.value)">
                    </td>
                    <td class="${finalWinnerB}">${finalMatch.teamB}</td>
                    <td>${finalMatch.winner ? `🏆 ${finalMatch.winner}` : 'Chưa đấu'}</td>
                </tr>
            </tbody></table></div>`;
            
    html += `</div>`;
    
    container.innerHTML = html;
}

function renderFinalResults() {
    const championEl = document.getElementById('champion');
    const runnerUpEl = document.getElementById('runnerUp');
    const thirdPlaceEl = document.getElementById('thirdPlace');
    
    const finalWinner = state.final.winner;
    const finalRunnerUp = state.final.runnerUp;
    
    // Hạng Ba: Đội thua 2 trận Bán kết
    const thirdPlaceTeams = state.semifinals.map(sf => sf.loser).filter(l => l && l !== finalWinner && l !== finalRunnerUp);
    
    championEl.innerHTML = finalWinner ? `🏆 **Vô địch:** ${finalWinner}` : 'Vô địch: Đang chờ kết quả...';
    runnerUpEl.innerHTML = finalRunnerUp ? `🥈 **Á quân:** ${finalRunnerUp}` : 'Á quân: Đang chờ kết quả...';
    
    if (thirdPlaceTeams.length === 2) {
        thirdPlaceEl.innerHTML = `🥉 **Hạng Ba Đồng Hạng:** ${thirdPlaceTeams.join(' & ')}`;
    } else {
         thirdPlaceEl.innerHTML = 'Hạng Ba Đồng Hạng: Đang chờ kết quả...';
    }
}

function renderRankingTables() {
    const container = document.getElementById('rankingTables');
    container.innerHTML = '';

    if (state.tableA.length > 0) {
        container.innerHTML += renderRankingTable(state.tableA, 'Bảng A (Nam - Nữ)');
    } else {
         container.innerHTML += `<div><h6 class="border-bottom pb-1">Bảng A (Nam - Nữ)</h6><div class="alert alert-info">Chưa có dữ liệu.</div></div>`;
    }
    
     if (state.tableB.length > 0) {
        container.innerHTML += renderRankingTable(state.tableB, 'Bảng B (Nam)');
    } else {
         container.innerHTML += `<div><h6 class="border-bottom pb-1">Bảng B (Nam)</h6><div class="alert alert-info">Chưa có dữ liệu.</div></div>`;
    }
}

function renderRankingTable(tableData, title) {
    let html = `<div><h6 class="border-bottom pb-1">${title}</h6>
        <div class='table-responsive'><table class='table table-bordered table-sm'>
        <thead>
            <tr>
                <th>Hạng</th>
                <th>Đội</th>
                <th>P</th>
                <th>W</th>
                <th>L</th>
                <th>PD</th>
                <th>Pts</th>
            </tr>
        </thead>
        <tbody>`;
        
    tableData.forEach((team, index) => {
        html += `<tr class="${index < 2 ? 'table-success' : ''}">
            <td>${index + 1}</td>
            <td>${team.team}</td>
            <td>${team.P}</td>
            <td>${team.W}</td>
            <td>${team.L}</td>
            <td>${team.PD}</td>
            <td><strong>${team.Pts}</strong></td>
        </tr>`;
    });
    
    html += `</tbody></table></div></div>`;
    return html;
}


function renderOverview() {
    tinhVaCapNhatXepHang(); // Đảm bảo bảng xếp hạng được tính toán
    const content = document.getElementById('overviewContent');
    const totalMatchesA = state.matchesA.length;
    const playedA = state.matchesA.filter(m => m.scoreA !== null).length;
    const totalMatchesB = state.matchesB.length;
    const playedB = state.matchesB.filter(m => m.scoreA !== null).length;
    
    const totalSemis = state.semifinals.length;
    const playedSemis = state.semifinals.filter(m => m.winner !== null).length;
    const finalStatus = state.final.winner ? `Hoàn thành (Vô địch: **${state.final.winner}**)` : (state.final.scoreA !== null ? 'Đã đấu, chưa hoàn thành' : 'Chưa đấu');

    let html = `
        <h5>Thống kê Chung</h5>
        <ul class="list-group mb-4">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Tổng số Đội tham gia:
                <span class="badge bg-primary rounded-pill">${state.mixedTeams.length + state.maleTeams.length}</span>
            </li>
             <li class="list-group-item d-flex justify-content-between align-items-center">
                Đội Bảng A (Nam - Nữ):
                <span class="badge bg-info rounded-pill">${state.mixedTeams.length}</span>
            </li>
             <li class="list-group-item d-flex justify-content-between align-items-center">
                Đội Bảng B (Nam):
                <span class="badge bg-info rounded-pill">${state.maleTeams.length}</span>
            </li>
        </ul>
        
        <h5>Tiến độ Vòng Bảng</h5>
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-primary">Bảng A (Nam - Nữ)</h6>
                        <p class="card-text mb-1">Tổng số trận: **${totalMatchesA}**</p>
                        <p class="card-text mb-1">Trận đã đấu: **${playedA}/${totalMatchesA}**</p>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${totalMatchesA > 0 ? (playedA / totalMatchesA) * 100 : 0}%">
                                ${totalMatchesA > 0 ? Math.round((playedA / totalMatchesA) * 100) : 0}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h6 class="card-title text-info">Bảng B (Nam)</h6>
                        <p class="card-text mb-1">Tổng số trận: **${totalMatchesB}**</p>
                        <p class="card-text mb-1">Trận đã đấu: **${playedB}/${totalMatchesB}**</p>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${totalMatchesB > 0 ? (playedB / totalMatchesB) * 100 : 0}%">
                                ${totalMatchesB > 0 ? Math.round((playedB / totalMatchesB) * 100) : 0}%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h5>Tiến độ Vòng Chung kết</h5>
        <ul class="list-group mb-4">
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Vòng Bán kết:
                <span class="badge ${playedSemis === totalSemis ? 'bg-success' : 'bg-warning'} rounded-pill">
                    ${playedSemis}/${totalSemis} trận đã đấu
                </span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
                Trận Chung kết:
                <span class="badge ${state.final.winner ? 'bg-success' : 'bg-secondary'} rounded-pill">
                    ${finalStatus}
                </span>
            </li>
        </ul>
        
        <button class="btn btn-primary" onclick="switchTab('matches')">Xem chi tiết Lịch thi đấu</button>
        <button class="btn btn-secondary" onclick="switchTab('results')">Xem Bảng xếp hạng</button>
        `;
        
    content.innerHTML = html;
}

// --- Time Utilities ---

/**
 * Thêm số phút vào một chuỗi thời gian (HH:mm)
 */
function addMinutes(time, minsToAdd) {
    const [hours, minutes] = time.split(':').map(Number);
    let date = new Date();
    date.setHours(hours, minutes, 0);
    date.setMinutes(date.getMinutes() + minsToAdd);
    return padTime(date.getHours()) + ':' + padTime(date.getMinutes());
}

/**
 * Thêm số 0 vào trước nếu giá trị < 10
 */
function padTime(value) {
    return value.toString().padStart(2, '0');
}

// --- Init ---

function init() {
    loadConfig();
    
    // Tải cấu hình GitHub ngay khi load
    document.getElementById('cfgOwner').value = state.config.owner || '';
    document.getElementById('cfgRepo').value = state.config.repo || '';
    document.getElementById('cfgFolder').value = state.config.folder || 'data';
    document.getElementById('cfgFile').value = state.config.file || 'state.json';
    document.getElementById('cfgToken').value = state.config.token || '';

    // Khởi tạo các lần render đầu tiên
    renderOverview();
    renderCourtList();
    
    // Tự động kiểm tra và tải dữ liệu nếu có config
    if (state.config.owner && state.config.repo && state.config.token) {
        checkConnection();
    }
}

// Lắng nghe sự kiện tab switch để đảm bảo nội dung được render lại chính xác
document.addEventListener('DOMContentLoaded', () => {
    init();
});

// Hoàn thành đoạn code cuối cùng của snippet (chỉ để đảm bảo syntax)
// document.... đã được thay thế bằng init() và DOMContentLoaded
