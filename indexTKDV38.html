<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 — Quản lý giải Pickleball V26 GitHub (Fix Lỗi Xóa Điểm Vòng Bảng)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ngày thi đấu: 18/10/2025 (**V26**)</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save (30s): <span id="autoState" class="text-danger">Tắt</span></div>
      <div id="lastSaved" class="text-end status">Chưa lưu</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">Tổng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">Vòng Bảng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals" onclick="renderFinals()">Vòng Chung Kết</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" onclick="tinhVaCapNhatXepHang(); renderFinalResults();">Kết quả Chung cuộc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">Cấu hình</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">Đang tải dữ liệu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Chế độ xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo Bảng đấu</option>
            <option value="court" selected>Theo Sân thi đấu</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import Lịch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export Lịch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">Bảng A (Nam - Nữ)</h6><div id="tableMatchesA">Chưa có lịch thi đấu.</div>
        
        <h6 class="mt-4">Bảng B (Nam)</h6><div id="tableMatchesB">Chưa có lịch thi đấu.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">Lên lịch Vòng Chung kết (Tự động hóa)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">Vòng Bán kết (SF1: 16:40, SF2: 17:05, Sân 3)</h6>
            <div id="semifinalMatches">Chưa có lịch thi đấu bán kết. Kết quả Vòng Bảng sẽ tự động cập nhật lịch.</div>

            <h6 class="mt-4">Trận Chung kết (17:30, Sân 3)</h6>
            <div id="finalMatch">Chưa có lịch thi đấu chung kết.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">Bảng xếp hạng Vòng Bảng (Ưu tiên: W > Đối đầu > Hiệu số > Tổng điểm)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hiệu Chung cuộc</h5>
        <p id="champion">Vô địch: Đang chờ kết quả...</p>
        <p id="runnerUp">Á quân: Đang chờ kết quả...</p>
        <p id="thirdPlace">Hạng Ba Đồng Hạng: Đang chờ kết quả...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">Công cụ Lập & Điền Lịch Thi đấu</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">Tạo lịch thi đấu Tối ưu (Tự động)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">Tải lịch Mẫu (**CalendarTKD30**)</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">Điền kết quả Tự động (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">Xóa Toàn bộ Lịch</button>
      </div>
      
      <hr>
      
      <h5 class="mt-4">🧹 Công cụ Xóa Kết quả Vòng Bảng</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
          <button class="btn btn-sm btn-outline-danger" onclick="clearGroupScores('A')">Xóa Kết quả Bảng A</button>
          <button class="btn btn-sm btn-outline-danger" onclick="clearGroupScores('B')">Xóa Kết quả Bảng B</button>
          <button class="btn btn-sm btn-danger ms-auto" onclick="clearGroupScores('ALL')">Xóa Toàn bộ Vòng Bảng</button>
      </div>
      <div id="clearScoreStatus"></div>
      <hr>
      <h5 class="mt-4">⚙️ Cấu hình Sân thi đấu & Lịch Tối ưu</h5>
      <p class="text-muted small">Quản lý danh sách sân thi đấu. Sân được gán loại bảng đấu (A/B) để phục vụ chức năng tạo lịch Tối ưu.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Thêm Sân Mới</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">Tải cấu hình Mặc định</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>
      
      <h5 class="mt-4">🛠️ Cấu hình Tối ưu Lịch thi đấu</h5>
      <div class="row g-2 mb-4">
        <div class="col-md-6">
          <label for="preferredCourtType" class="form-label">Ưu tiên Sân nào cho trận đầu tiên (Chức năng Tạo lịch Tối ưu)?</label>
          <select id="preferredCourtType" class="form-select" onchange="updatePreferredCourtType()">
            <option value="mixed">Bảng A (Nam - Nữ) - Mặc định</option>
            <option value="male">Bảng B (Nam)</option>
          </select>
          <div class="form-text">Xác định loại sân sẽ được ưu tiên gán trận đấu đầu tiên trong thuật toán tạo lịch.</div>
        </div>
        <div class="col-md-6">
            <label class="form-label">Công cụ Xuất/Lưu Dữ liệu</label>
            <div class="d-flex gap-2">
                 <button class="btn btn-success" onclick="saveToGitHub(true)">Cập nhật lên GitHub ngay</button>
                 <button class="btn btn-secondary" onclick="exportDataToJson()">Xuất tất cả ra JSON</button>
            </div>
            <div class="form-text">Lưu trạng thái hiện tại (state.json) lên GitHub hoặc tải về máy.</div>
        </div>
      </div>
      <hr>
      <h5 class="mt-4">💾 Cấu hình Kết nối GitHub</h5>
      <p class="text-muted">Nhập thông tin kho lưu trữ GitHub để tự động lưu trữ dữ liệu giải đấu (Auto-save: 30s).</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (Ví dụ: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (Ví dụ: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="Dán GitHub Personal Access Token (PAT) tại đây">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">Lưu cấu hình Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Kiểm tra & Tải Dữ liệu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">🔑 Hướng dẫn lấy GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy cập <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (Bạn cần đăng nhập).</li>
                <li>Chọn **Generate new token** (hoặc **Generate new token (classic)** nếu bạn dùng tài khoản cũ).</li>
                <li>**Tên Token:** Đặt tên dễ nhớ (ví dụ: `TKDManager_AutoSave`).</li>
                <li>**Thời hạn:** Chọn tùy ý (nên chọn 90 ngày hoặc Tùy chỉnh).</li>
                <li>**Phạm vi (Scopes):** **BẮT BUỘC** tích chọn ô **`repo`** (cho phép truy cập vào kho lưu trữ).</li>
                <li>Nhấn **Generate token** và **SAO CHÉP** chuỗi Token vừa được tạo.</li>
                <li>Dán chuỗi Token đó vào ô "Dán GitHub Personal Access Token (PAT) tại đây" bên trên.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">⚠️ **Lưu ý:** Token chỉ hiển thị **MỘT LẦN**. Hãy sao chép ngay lập tức và giữ bí mật. Nếu mất, bạn phải tạo lại Token mới.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Thêm/Sửa Cấu hình Sân</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">Tên Sân</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Giờ Bắt Đầu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Thời Lượng Tối Đa (Phút)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              Dành cho Bảng A (Nam - Nữ)
            </label>
            <div class="form-text">Nếu không chọn, sân sẽ dành cho Bảng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">Lưu Thay Đổi</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        Nội dung thông báo
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 

<script>
// Dữ liệu lịch cố định từ file CalendarTKD30.csv (ĐÃ CẬP NHẬT theo yêu cầu)
const FIXED_SCHEDULE_CSV = `teamA,teamB,time,court,bang,scoreA,scoreB
Triều/Minh,Hiển/P.Hùng,14:00,Sân 1,B,,
Giang/Long,Hường/Đạt,14:00,Sân 2,A,,
Hậu/Dũng,Hạnh/Tiến,14:00,Sân 3,A,,
Huyền/Luân,Linh/M.Hùng,14:00,Sân 7,A,,
Tiệp/Thủy,Phương/Thanh,14:15,Sân 1,B,,
Tín/Khiêm,Ánh/Toàn,14:15,Sân 2,B,,
Hậu/Dũng,Hường/Đạt,14:15,Sân 3,A,,
Giang/Long,Huyền/Luân,14:15,Sân 7,A,,
Triều/Minh,Tín/Khiêm,14:30,Sân 1,B,,
Tiệp/Thủy,Hiển/P.Hùng,14:30,Sân 2,B,,
Hạnh/Tiến,Linh/M.Hùng,14:30,Sân 3,A,,
Phương/Thanh,Ánh/Toàn,14:30,Sân 7,B,,
Huyền/Luân,Hường/Đạt,14:45,Sân 2,A,,
Hạnh/Tiến,Giang/Long,14:45,Sân 3,A,,
Hậu/Dũng,Linh/M.Hùng,14:45,Sân 7,A,,
Tiệp/Thủy,Ánh/Toàn,15:00,Sân 2,B,,
Tín/Khiêm,Hiển/P.Hùng,15:00,Sân 3,B,,
Phương/Thanh,Triều/Minh,15:15,Sân 2,B,,
Giang/Long,Linh/M.Hùng,15:15,Sân 3,A,,
Hạnh/Tiến,Hường/Đạt,15:30,Sân 2,A,,
Hậu/Dũng,Huyền/Luân,15:30,Sân 3,A,,
Tiệp/Thủy,Tín/Khiêm,15:45,Sân 2,B,,
Phương/Thanh,Hiển/P.Hùng,15:45,Sân 3,B,,
Triều/Minh,Ánh/Toàn,16:00,Sân 2,B,,
Hậu/Dũng,Giang/Long,16:00,Sân 3,A,,
Hạnh/Tiến,Huyền/Luân,16:15,Sân 2,A,,
Linh/M.Hùng,Hường/Đạt,16:15,Sân 3,A,,
Tiệp/Thủy,Triều/Minh,16:30,Sân 2,B,,
Ánh/Toàn,Hiển/P.Hùng,16:30,Sân 3,B,,
Phương/Thanh,Tín/Khiêm,16:45,Sân 2,B,`;

// Biến state lưu trữ dữ liệu chính của ứng dụng.
let state = { 
  mixedTeams: [], // Sẽ được tải từ players.json
  maleTeams: [],  // Sẽ được tải từ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // Bảng xếp hạng A (Sẽ được lưu và tải)
  tableB: [], // Bảng xếp hạng B (Sẽ được lưu và tải)
  
  // Court Configuration
  courts: [
    { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
    { name: 'Sân 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'Sân 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'Sân 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
    { name: 'Sân 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } 
  ],
  
  // LOGIC BÁN KẾT 
  semifinals: [
    { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:40', court: 'Sân 3', winner: null, loser: null }, 
    { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '17:05', court: 'Sân 3', winner: null, loser: null }  
  ],
  final: { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:30', court: 'Sân 3', winner: null, runnerUp: null }, 
  config: { 
    preferredCourtType: 'mixed' 
  }
};

// ===============================================
// START V26 FIX: Định nghĩa các Constants cho Reset
// ===============================================
const DEFAULT_SF1 = { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: '16:40', court: 'Sân 3', winner: null, loser: null };
const DEFAULT_SF2 = { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: '17:05', court: 'Sân 3', winner: null, loser: null };
const DEFAULT_FINAL = { id: 'F', teamA: 'Thắng SF1', teamB: 'Thắng SF2', scoreA: null, scoreB: null, time: '17:30', court: 'Sân 3', winner: null, runnerUp: null };
// ===============================================
// END V26 FIX: Định nghĩa các Constants cho Reset
// ===============================================


let stateChanged = false; // Biến cờ theo dõi thay đổi dữ liệu
let currentSha = null; // Biến lưu trữ SHA của file trên GitHub
let autoSaveInterval = null; // Biến lưu trữ ID của interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * Hàm chuyển đổi tab
 * @param {string} tabId - ID của tab cần chuyển (ví dụ: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // Tắt tab đang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // Bật tab mới
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // Cập nhật view cho tab matches nếu chuyển đến
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- GitHub API Functions ---

/**
 * Lấy SHA mới nhất của file trên GitHub.
 * @param {object} cfg - Cấu hình GitHub (owner, repo, folder, file, token)
 * @param {string} fileName - Tên file cần lấy SHA (mặc định là cfg.file)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Chỉ lưu SHA của state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            // Lỗi khác (401, 403, 500...)
            throw new Error(`Lỗi HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`Lỗi Fetch SHA (${fileName}):`, error);
        throw new Error(`Lỗi kết nối hoặc API: ${error.message}`);
    }
}

/**
 * Tải danh sách đội từ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'Đang tải danh sách đội từ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `Tải danh sách đội thành công (${state.mixedTeams.length + state.maleTeams.length} đội).`);
                return true;
            } else {
                throw new Error("File players.json không đúng định dạng (thiếu mixedTeams/maleTeams).");
            }
        } else {
            updateStatus('configStatus', 'warning', 'Không tìm thấy file players.json. Dùng danh sách đội khởi tạo (trống).');
            return false;
        }
    } catch (error) {
        console.error("Lỗi khi tải players.json:", error);
        updateStatus('configStatus', 'danger', `Lỗi tải danh sách đội: ${error.message}`);
        return false;
    }
}

/**
 * Tải trạng thái giải đấu (state.json) từ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
         updateStatus('configStatus', 'warning', 'Thiếu thông tin kết nối GitHub. Vui lòng nhập Token/Repo.');
         return;
    }

    // 1. Load Teams (danh sách đội)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'Đang tải trạng thái giải đấu từ GitHub (state.json)...');
        // fetchFileSha sẽ tự động cập nhật currentSha
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi đè các giá trị khác ngoài teams (teams đã được load từ players.json)
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // NEW: Tải bảng xếp hạng nếu có 
            state.tableA = loadedState.tableA || []; 
            state.tableB = loadedState.tableB || [];
            
            if (loadedState.courts) {
                state.courts = loadedState.courts;
            }
            
            // Cấu trúc mặc định mới cho bán kết/chung kết
            const defaultSF1 = { teamA: 'Nhất A', teamB: 'Nhì A', court: 'Sân 3', time: '16:40' };
            const defaultSF2 = { teamA: 'Nhất B', teamB: 'Nhì B', court: 'Sân 3', time: '17:05' };
            const defaultFinal = { teamA: 'Thắng SF1', teamB: 'Thắng SF2', court: 'Sân 3', time: '17:30' };

            // Logic tải cho semifinals/final (giữ lại kết quả nếu đã có, reset đội nếu đội vòng bảng thay đổi)
            if (loadedState.semifinals && loadedState.semifinals.length === 2) {
                 // Nếu đã có đội thực tế được gán (ví dụ: Team X), giữ nguyên 
                state.semifinals = loadedState.semifinals;
                // Nếu là trạng thái rỗng default (Nhất A vs Nhì A), cập nhật lại thời gian và sân theo V24
                state.semifinals.forEach((sf, index) => {
                     if (sf.teamA === 'Nhất A' || sf.teamA === 'Nhất B') {
                        sf.court = defaultSF1.court;
                        sf.time = index === 0 ? defaultSF1.time : defaultSF2.time;
                    }
                });
            } else {
                 // Dùng default V24
                 state.semifinals = [
                     { id: 'SF1', teamA: 'Nhất A', teamB: 'Nhì A', scoreA: null, scoreB: null, time: defaultSF1.time, court: defaultSF1.court, winner: null, loser: null },
                     { id: 'SF2', teamA: 'Nhất B', teamB: 'Nhì B', scoreA: null, scoreB: null, time: defaultSF2.time, court: defaultSF2.court, winner: null, loser: null }
                 ];
            }
            
            state.final = loadedState.final || state.final;
            if (!state.final.winner) {
                state.final.court = defaultFinal.court;
                state.final.time = defaultFinal.time;
            }
            
            updateStatus('configStatus', 'success', `Tải trạng thái giải đấu thành công từ: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `Lần tải: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
             // File state.json không tồn tại (404)
            updateStatus('configStatus', 'warning', 'File trạng thái (state.json) chưa tồn tại. Vui lòng nhấn Lưu hoặc Tự động lưu để tạo file.');
        }
        
        // Luôn cập nhật giao diện sau khi tải xong teams/state (hoặc dùng mặc định)
        tinhVaCapNhatXepHang(); 
        renderMatchesView(); 
        renderFinals();
        renderFinalResults();
        renderOverview();
        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Lỗi tải trạng thái giải đấu: ${error.message}. Vui lòng kiểm tra lại Token/Repo.`);
        console.error("Lỗi khi tải trạng thái giải đấu từ GitHub:", error);
    }
}

/**
 * Lưu trạng thái giải đấu (state.json) lên GitHub.
 * @param {boolean} force - Bắt buộc lưu ngay cả khi stateChanged là false.
 */
async function saveToGitHub(force = false) {
    // Bỏ qua nếu không có thay đổi và không ép buộc lưu
    if (!stateChanged && !force) return;
    
    // **CHECKPOINT:** Tính lại bảng xếp hạng trước khi lưu (đảm bảo dữ liệu ranking là mới nhất)
    tinhVaCapNhatXepHang();

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Không thể tự động lưu: Thiếu cấu hình GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Tạm dừng (Thiếu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'Đang lưu...';
    if (force) {
         updateStatus('configStatus', 'info', 'Đang cập nhật dữ liệu lên GitHub...');
    }


    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Chỉ lưu các trường cần thiết, bao gồm cả bảng xếp hạng (tableA, tableB)
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final,
        // **BẢNG XẾP HẠNG VÒNG BẢNG ĐÃ TÍNH TOÁN**
        tableA: state.tableA,
        tableB: state.tableB 
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Luôn fetch SHA mới nhất trước khi cố gắng lưu
        const result = await fetchFileSha(cfg, cfg.file); // Lấy SHA của state.json
        const sha = result.sha; 
        
        const payload = {
            message: `${force ? '[Manual-save]' : '[Auto-save]'} Cập nhật trạng thái giải đấu TKD lúc ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        // Thêm SHA để cập nhật, nếu không có SHA sẽ tạo mới
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `Lần lưu: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'Đã Lưu';
            if (force) {
                 updateStatus('configStatus', 'success', `Cập nhật dữ liệu lên GitHub thành công lúc ${new Date().toLocaleTimeString('vi-VN')}.`);
            }
        } else {
            // Xử lý lỗi 409 Conflict
            if (response.status === 409) {
                console.warn("Lỗi 409 Conflict: Dữ liệu đã thay đổi trên GitHub. Đang cố gắng lấy SHA mới.");
                
                await fetchFileSha(cfg, cfg.file); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. Sẽ thử lưu lại sau 30s.';
                if (force) {
                     updateStatus('configStatus', 'warning', `Lỗi Conflict (Dữ liệu đã thay đổi trên GitHub). Vui lòng thử lại sau 30s.`);
                }
            } else {
                throw new Error(`Lỗi HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("Lỗi khi lưu lên GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'Lỗi Lưu';
        if (force) {
             updateStatus('configStatus', 'danger', `Lỗi cập nhật lên GitHub: ${error.message}.`);
        }
    }
}

/**
 * Kiểm tra kết nối và Tải dữ liệu
 */
async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui lòng nhập đầy đủ Owner, Repo và Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'Đang kiểm tra kết nối tới kho lưu trữ...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`Lỗi truy cập kho lưu trữ. Mã: ${repoResponse.status}. (Kiểm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', '✅ Kết nối GitHub thành công! Đang tiến hành tải dữ liệu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `❌ Kiểm tra kết nối thất bại: ${error.message}.`);
        console.error("Lỗi kiểm tra kết nối:", error);
    }
}

/**
 * Cập nhật cấu hình ưu tiên sân cho tính năng Tạo lịch Tối ưu và lưu vào LocalStorage.
 */
function updatePreferredCourtType() {
    const select = document.getElementById('preferredCourtType');
    if (select) {
        state.config.preferredCourtType = select.value;
        saveConfig();
        updateStatus('configStatus', 'success', `Đã cập nhật ưu tiên sân thành: ${select.options[select.selectedIndex].text}.`);
    }
}

/**
 * Xuất toàn bộ dữ liệu (state) hiện tại ra file JSON
 */
function exportDataToJson() {
    // **CHECKPOINT:** Tính lại bảng xếp hạng trước khi xuất
    tinhVaCapNhatXepHang();
    
    // Chỉ lưu các trường cần thiết, bao gồm cả tableA/tableB
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final,
        tableA: state.tableA,
        tableB: state.tableB
    };
    const jsonString = JSON.stringify(stateToSave, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `data_tkd_export_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showModal('Export Dữ liệu', 'Đã xuất toàn bộ dữ liệu giải đấu hiện tại ra file JSON.');
}

// --- Cấu hình & Khởi tạo ---
function renderConfig() {
    // Chỉ cần hiển thị cấu hình sân hiện tại
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
    document.getElementById('clearScoreStatus').innerHTML = ''; // Clear new status div

    // Cập nhật UI cho preferredCourtType khi vào tab config
    const select = document.getElementById('preferredCourtType');
    if (select) {
        select.value = state.config.preferredCourtType || 'mixed';
    }
}

/**
 * Hiển thị danh sách sân dưới dạng bảng với nút Sửa/Xóa.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Chưa có sân nào được cấu hình.</div>`;
        return;
    }

    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>Tên Sân</th>
                <th>Giờ Bắt Đầu</th>
                <th>Thời Lượng Max (Phút)</th>
                <th>Phân Loại</th>
                <th class="text-center">Hành động</th>
            </tr>
        </thead>
        <tbody>`;
    
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'Bảng A (Nam - Nữ)' : 'Bảng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">Sửa</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">Xóa</button>
            </td>
        </tr>`;
    });

    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * Mở modal thêm/sửa sân và điền dữ liệu nếu là chế độ sửa.
 * @param {number | null} index - Chỉ số của sân cần sửa, hoặc null nếu thêm mới.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';
    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'Sửa Cấu hình Sân' : 'Thêm Sân Mới';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Chế độ thêm mới: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = 180;
        document.getElementById('courtIsMixed').checked = true;
    }
    modal.show();
}

/**
 * Lưu thay đổi (thêm mới hoặc cập nhật) cấu hình sân.
 */
function saveCourtChanges() {
    const index = document.getElementById('courtIndex').value;
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;
    
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        document.getElementById('courtFormStatus').innerHTML = '<div class="alert alert-danger">Vui lòng nhập đầy đủ thông tin hợp lệ.</div>';
        return;
    }

    const newCourt = { name, startTime, maxDurationMinutes, isMixed };

    if (index !== '') {
        // Chế độ sửa
        state.courts[parseInt(index)] = newCourt;
        updateStatus('courtConfigStatus', 'success', `Đã cập nhật cấu hình sân ${name} thành công.`);
    } else {
        // Chế độ thêm mới
        state.courts.push(newCourt);
        updateStatus('courtConfigStatus', 'success', `Đã thêm sân ${name} mới thành công.`);
    }
    
    stateChanged = true;
    saveConfig(); 
    renderCourtList();
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();
}

/**
 * Xóa một sân khỏi danh sách.
 * @param {number} index - Chỉ số của sân cần xóa.
 */
function deleteCourt(index) {
    if (confirm(`Bạn có chắc chắn muốn xóa sân "${state.courts[index].name}"? Hành động này không thể hoàn tác.`)) {
        const deletedName = state.courts[index].name;
        state.courts.splice(index, 1);
        stateChanged = true;
        saveConfig();
        renderCourtList();
        updateStatus('courtConfigStatus', 'success', `Đã xóa sân ${deletedName} thành công.`);
    }
}

/**
 * Tải cấu hình sân mặc định.
 */
function loadDefaultCourtConfig() {
    if (confirm('Bạn có chắc chắn muốn Tải lại cấu hình sân Mặc định? Mọi thay đổi hiện tại sẽ bị ghi đè.')) {
        state.courts = [
            { name: 'Sân 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'Sân 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'Sân 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'Sân 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, 
            { name: 'Sân 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'Sân 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'Sân 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, 
            { name: 'Sân 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false } 
        ];
        stateChanged = true;
        saveConfig();
        renderCourtList();
        updateStatus('courtConfigStatus', 'success', 'Đã tải cấu hình sân mặc định thành công.');
    }
}

/**
 * Xóa toàn bộ lịch thi đấu (Cả Vòng Bảng và Vòng Chung Kết)
 */
function clearAllSchedules() {
    if (confirm("⚠️ CẢNH BÁO: Bạn có chắc chắn muốn XÓA TOÀN BỘ LỊCH THI ĐẤU (cả kết quả, lịch, vòng chung kết)? Hành động này không thể hoàn tác.")) {
        state.matchesA = [];
        state.matchesB = [];
        state.tableA = [];
        state.tableB = [];
        
        // Reset Vòng Chung kết về mặc định
        state.semifinals = [ DEFAULT_SF1, DEFAULT_SF2 ];
        state.final = DEFAULT_FINAL;

        stateChanged = true;
        saveToGitHub();
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals();
        renderOverview();
        showModal('Xóa thành công', 'Đã xóa toàn bộ lịch thi đấu và kết quả. Vui lòng tạo lịch mới.');
    }
}

/**
 * Xóa điểm số các trận đấu Vòng Bảng.
 * V26 FIX: Thêm logic reset Vòng Chung kết
 */
function clearGroupScores(group) {
    const finalsCompleted = state.semifinals.some(sf => sf.winner !== null) || state.final.winner !== null;
    
    // Nếu Vòng Chung kết đã có kết quả, không cho xóa Vòng Bảng
    if (finalsCompleted) {
        showModal('Lỗi Xóa Kết Quả', 'Không thể xóa kết quả Vòng Bảng. Vui lòng **Xóa toàn bộ lịch** (ở tab Cấu hình) nếu muốn reset Vòng Chung kết, hoặc xóa kết quả Vòng CK thủ công.');
        return;
    }
    
    const message = group === 'ALL' 
        ? "Bạn có chắc chắn muốn XÓA TOÀN BỘ kết quả Vòng Bảng (Bảng A & B)? Hành động này không thể hoàn tác."
        : `Bạn có chắc chắn muốn XÓA TOÀN BỘ kết quả của Bảng ${group}? Hành động này không thể hoàn tác.`;
    
    if (!confirm(message)) return;

    let clearedCount = 0;
    
    const matchesToClear = [];
    if (group === 'A' || group === 'ALL') matchesToClear.push(...state.matchesA);
    if (group === 'B' || group === 'ALL') matchesToClear.push(...state.matchesB);
    
    matchesToClear.forEach(match => {
        if (match.scoreA !== null || match.scoreB !== null) {
            match.scoreA = null;
            match.scoreB = null;
            match.winner = null;
            match.loser = null;
            clearedCount++;
        }
    });

    if (clearedCount > 0) {
        
        // ===============================================
        // START V26 FIX: Reset Vòng Chung Kết
        // ===============================================
        state.semifinals = [ DEFAULT_SF1, DEFAULT_SF2 ];
        state.final = DEFAULT_FINAL;
        // ===============================================
        // END V26 FIX: Reset Vòng Chung Kết
        // ===============================================
        
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals(); // Cập nhật giao diện tab Chung kết
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        updateStatus('clearScoreStatus', 'success', `Đã xóa ${clearedCount} kết quả trận đấu thành công. Vòng Chung Kết đã được Reset.`);
    } else {
        updateStatus('clearScoreStatus', 'info', `Không có kết quả nào của Bảng ${group} cần xóa.`);
    }
}

// ... (các hàm khác)
</script>
</body>
</html>
