<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TKD Championship 2025 ‚Äî Qu·∫£n l√Ω gi·∫£i Pickleball V39 GitHub (Match Edit)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#222; padding:18px; }
    .tab-content { margin-top: 18px; }
    .logo { 
      width:64px; 
      height:64px; 
      object-fit:contain; 
      border-radius:8px; 
      border:1px solid #e6eefc; 
      padding:6px; 
      background:#fff; 
    }
    table th { background:#0d6efd; color:#fff; position:sticky; top:0; }
    .status { font-size:0.95rem; color:#555; }
    /* Responsive adjustment for match inputs */
    .match-score-cell input {
      width: 45px;
      text-align: center;
      padding: 0.1rem;
    }
    @media (max-width: 576px) {
      .match-score-cell input {
        width: 35px;
      }
    }
    .winner { font-weight: bold; color: green; }
    .loser { color: red; }
    .ranking-container { display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .ranking-container { flex-direction: row; }
        .ranking-container > div { flex: 1; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <img class="logo" src="data/logoTKD.png" alt="Logo TKD">
      <div>
        <h3 class="mb-0">TKD Championship 2025</h3>
        <div>Ng√†y thi ƒë·∫•u: 18/10/2025</div>
      </div>
    </div>
    <div>
      <div id="autoSaveStatus" class="text-end status">Auto-save: <span id="autoState" class="text-danger">T·∫Øt</span></div>
      <div id="lastSaved" class="text-end status">Ch∆∞a l∆∞u</div>
    </div>
  </div>

  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" onclick="renderOverview()">T·ªïng quan</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matches" id="matchesTabButton" onclick="renderMatchesView()">V√≤ng B·∫£ng</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#finals" onclick="renderFinals()">V√≤ng Chung K·∫øt</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#results" onclick="tinhVaCapNhatXepHang(); renderFinalResults();">K·∫øt qu·∫£ Chung cu·ªôc</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#config" id="configTabButton" onclick="renderConfig()">C·∫•u h√¨nh</button></li>
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active p-3" id="overview">
        <div id="overviewContent">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
    
    <div class="tab-pane fade p-3" id="matches">
      <div class="d-flex gap-2 mb-3 flex-wrap">
        <label for="viewMode" class="form-label mb-0 align-self-center text-nowrap">Ch·∫ø ƒë·ªô xem:</label>
        <select id="viewMode" class="form-select form-select-sm w-auto" onchange="renderMatchesView()">
            <option value="table">Theo B·∫£ng ƒë·∫•u</option>
            <option value="court" selected>Theo S√¢n thi ƒë·∫•u</option>
        </select>
        
        <button class="btn btn-sm btn-info ms-auto" onclick="document.getElementById('fileInput').click()">Import L·ªãch (CSV)</button>
        <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
        
        <button class="btn btn-sm btn-warning" onclick="exportSchedule()">Export L·ªãch (CSV)</button>
      </div>
      
      <div id="matchesViewContent">
        <h6 id="scheduleAHeader" class="mt-4">B·∫£ng A (Nam - N·ªØ)</h6><div id="tableMatchesA">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
        
        <h6 class="mt-4">B·∫£ng B (Nam)</h6><div id="tableMatchesB">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u.</div>
      </div>

      <button class="btn btn-warning mt-4" onclick="scheduleFinalsAuto()">L√™n l·ªãch V√≤ng Chung k·∫øt (T·ª± ƒë·ªông h√≥a)</button>
    </div>

    <div class="tab-pane fade p-3" id="finals">
        <div id="finalsContent">
            <h6 class="mt-4">V√≤ng B√°n k·∫øt (16:30, S√¢n 3)</h6>
            <div id="semifinalMatches">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u b√°n k·∫øt. K·∫øt qu·∫£ V√≤ng B·∫£ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch.</div>

            <h6 class="mt-4">Tr·∫≠n Chung k·∫øt (17:00, S√¢n 3)</h6>
            <div id="finalMatch">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u chung k·∫øt.</div>
        </div>
    </div>

    <div class="tab-pane fade p-3" id="results">
        <h5 class="mb-3">B·∫£ng x·∫øp h·∫°ng V√≤ng B·∫£ng (C·∫≠p nh·∫≠t li√™n t·ª•c)</h5>
        <div id="rankingTables" class="ranking-container">
            </div>

        <hr class="my-4">

        <h5 class="mb-3">Danh hi·ªáu Chung cu·ªôc</h5>
        <p id="champion">V√¥ ƒë·ªãch: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="runnerUp">√Å qu√¢n: ƒêang ch·ªù k·∫øt qu·∫£...</p>
        <p id="thirdPlace">H·∫°ng Ba ƒê·ªìng H·∫°ng: ƒêang ch·ªù k·∫øt qu·∫£...</p>
    </div>

    <div class="tab-pane fade p-3" id="config">
      <h5 class="mb-3">C√¥ng c·ª• L·∫≠p & ƒêi·ªÅn L·ªãch Thi ƒë·∫•u</h5>
      <div class="d-flex gap-2 mb-4 flex-wrap">
        <button class="btn btn-sm btn-primary" onclick="taoLichThiDauCungGio()">T·∫°o l·ªãch thi ƒë·∫•u T·ªëi ∆∞u (T·ª± ƒë·ªông)</button>
        <button class="btn btn-sm btn-secondary" onclick="taoLichCoDinh()">T·∫°o l·ªãch C·ªë ƒë·ªãnh</button>
        <button class="btn btn-sm btn-success" onclick="autoFillScores()">ƒêi·ªÅn k·∫øt qu·∫£ T·ª± ƒë·ªông (11 - X)</button>
        <button class="btn btn-sm btn-danger" onclick="clearAllSchedules()">X√≥a To√†n b·ªô L·ªãch</button>
      </div>
      
      <hr>

      <h5 class="mt-4">‚öôÔ∏è C·∫•u h√¨nh S√¢n thi ƒë·∫•u & L·ªãch T·ªëi ∆∞u</h5>
      <p class="text-muted small">Qu·∫£n l√Ω danh s√°ch s√¢n thi ƒë·∫•u. S√¢n ƒë∆∞·ª£c g√°n lo·∫°i b·∫£ng ƒë·∫•u (A/B) ƒë·ªÉ ph·ª•c v·ª• ch·ª©c nƒÉng t·∫°o l·ªãch T·ªëi ∆∞u.</p>
      <div class="d-flex gap-2 mb-3 flex-wrap">
          <button class="btn btn-sm btn-primary" onclick="openCourtModal()">+ Th√™m S√¢n M·ªõi</button>
          <button class="btn btn-sm btn-outline-info" onclick="loadDefaultCourtConfig()">T·∫£i c·∫•u h√¨nh M·∫∑c ƒë·ªãnh</button>
      </div>
      <div id="courtListContainer">
          </div>
      <div id="courtConfigStatus"></div>
      <hr>

      <h5 class="mt-4">üíæ C·∫•u h√¨nh K·∫øt n·ªëi GitHub</h5>
      <p class="text-muted">Nh·∫≠p th√¥ng tin kho l∆∞u tr·ªØ GitHub ƒë·ªÉ t·ª± ƒë·ªông l∆∞u tr·ªØ d·ªØ li·ªáu gi·∫£i ƒë·∫•u.</p>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="cfgOwner" class="form-control" placeholder="Owner (V√≠ d·ª•: user_name)"></div>
        <div class="col-md-3"><input id="cfgRepo" class="form-control" placeholder="Repo (V√≠ d·ª•: my-data-repo)"></div>
        <div class="col-md-3"><input id="cfgFolder" class="form-control" value="data"></div>
        <div class="col-md-3"><input id="cfgFile" class="form-control" value="state.json"></div>
      </div>
      <input id="cfgToken" type="password" class="form-control mb-2" placeholder="D√°n GitHub Personal Access Token (PAT) t·∫°i ƒë√¢y">
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveConfig()">L∆∞u c·∫•u h√¨nh Local</button>
        <button class="btn btn-success" onclick="checkConnection()">Ki·ªÉm tra & T·∫£i D·ªØ li·ªáu</button>
      </div>
      <div class="mt-2" id="configStatus"></div>
      
      <div class="card bg-light mt-4 shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-info">üîë H∆∞·ªõng d·∫´n l·∫•y GitHub Token (PAT)</h5>
            <ol class="small mb-0">
                <li>Truy c·∫≠p <a href="https://github.com/settings/tokens" target="_blank" class="text-info">GitHub Tokens Settings</a> (B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p).</li>
                <li>Ch·ªçn **Generate new token** (ho·∫∑c **Generate new token (classic)** n·∫øu b·∫°n d√πng t√†i kho·∫£n c≈©).</li>
                <li>**T√™n Token:** ƒê·∫∑t t√™n d·ªÖ nh·ªõ (v√≠ d·ª•: `TKDManager_AutoSave`).</li>
                <li>**Th·ªùi h·∫°n:** Ch·ªçn t√πy √Ω (n√™n ch·ªçn 90 ng√†y ho·∫∑c T√πy ch·ªânh).</li>
                <li>**Ph·∫°m vi (Scopes):** **B·∫ÆT BU·ªòC** t√≠ch ch·ªçn √¥ **`repo`** (cho ph√©p truy c·∫≠p v√†o kho l∆∞u tr·ªØ).</li>
                <li>Nh·∫•n **Generate token** v√† **SAO CH√âP** chu·ªói Token v·ª´a ƒë∆∞·ª£c t·∫°o.</li>
                <li>D√°n chu·ªói Token ƒë√≥ v√†o √¥ "D√°n GitHub Personal Access Token (PAT) t·∫°i ƒë√¢y" b√™n tr√™n.</li>
            </ol>
            <p class="mt-2 mb-0 text-danger small">‚ö†Ô∏è **L∆∞u √Ω:** Token ch·ªâ hi·ªÉn th·ªã **M·ªòT L·∫¶N**. H√£y sao ch√©p ngay l·∫≠p t·ª©c v√† gi·ªØ b√≠ m·∫≠t. N·∫øu m·∫•t, b·∫°n ph·∫£i t·∫°o l·∫°i Token m·ªõi.</p>
        </div>
      </div>
      </div>
  </div>
</div>

<div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="courtModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courtModalLabel">Th√™m/S·ª≠a C·∫•u h√¨nh S√¢n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="courtForm">
          <input type="hidden" id="courtIndex" value="">
          <div class="mb-3">
            <label for="courtName" class="form-label">T√™n S√¢n</label>
            <input type="text" class="form-control" id="courtName" required>
          </div>
          <div class="mb-3">
            <label for="courtStartTime" class="form-label">Gi·ªù B·∫Øt ƒê·∫ßu (HH:mm)</label>
            <input type="time" class="form-control" id="courtStartTime" required>
          </div>
          <div class="mb-3">
            <label for="courtMaxDuration" class="form-label">Th·ªùi L∆∞·ª£ng T·ªëi ƒêa (Ph√∫t)</label>
            <input type="number" class="form-control" id="courtMaxDuration" min="1" required>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="courtIsMixed">
            <label class="form-check-label" for="courtIsMixed">
              D√†nh cho B·∫£ng A (Nam - N·ªØ)
            </label>
            <div class="form-text">N·∫øu kh√¥ng ch·ªçn, s√¢n s·∫Ω d√†nh cho B·∫£ng B (Nam).</div>
          </div>
          <div id="courtFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-primary" onclick="saveCourtChanges()">L∆∞u Thay ƒê·ªïi</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="matchEditModal" tabindex="-1" aria-labelledby="matchEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="matchEditModalLabel">S·ª≠a L·ªãch Tr·∫≠n ƒê·∫•u</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="matchEditForm">
          <input type="hidden" id="matchEditId" value="">
          <input type="hidden" id="matchEditIsFinal" value="">

          <div class="mb-3">
            <label class="form-label">C·∫∑p ƒë·∫•u:</label>
            <p class="form-control-static fw-bold" id="matchEditTeams"></p>
          </div>

          <div class="mb-3">
            <label for="matchEditTime" class="form-label">Gi·ªù thi ƒë·∫•u (HH:mm)</label>
            <input type="time" class="form-control" id="matchEditTime" required>
          </div>

          <div class="mb-3">
            <label for="matchEditCourt" class="form-label">S√¢n thi ƒë·∫•u</label>
            <select class="form-select" id="matchEditCourt" required>
            </select>
          </div>
          <div id="matchEditFormStatus" class="mt-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
        <button type="button" class="btn btn-primary" onclick="saveMatchChanges()">L∆∞u Thay ƒê·ªïi</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customAlertModalLabel">Th√¥ng b√°o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customAlertModalBody">
        N·ªôi dung th√¥ng b√°o
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script> 

<script>
// D·ªØ li·ªáu m·∫´u CSV chu·∫©n h√≥a cho ch·ª©c nƒÉng T·∫°o L·ªãch C·ªë ƒê·ªãnh (ƒê√É C·∫¨P NH·∫¨T THEO Y√äU C·∫¶U M·ªöI)
const STANDARDIZED_SCHEDULE_CSV_SAMPLE = `teamA,teamB,time,court,bang,scoreA,scoreB
Tri·ªÅu/Minh,Hi·ªÉn/P.H√πng,14:00,S√¢n 1,B,,
Giang/Long,H∆∞·ªùng/ƒê·∫°t,14:00,S√¢n 2,A,,
H·∫≠u/D≈©ng,H·∫°nh/Ti·∫øn,14:00,S√¢n 3,A,,
Huy·ªÅn/Lu√¢n,Linh/M.H√πng,14:00,S√¢n7,A,,
Ti·ªáp/Th·ªßy,Ph∆∞∆°ng/Thanh,14:15,S√¢n 1,B,,
T√≠n/Khi√™m,√Ånh/To√†n,14:15,S√¢n 2,B,,
H·∫≠u/D≈©ng,H∆∞·ªùng/ƒê·∫°t,14:15,S√¢n 3,A,,
Giang/Long,Huy·ªÅn/Lu√¢n,14:15,S√¢n7,A,,
Tri·ªÅu/Minh,T√≠n/Khi√™m,14:30,S√¢n 1,B,,
Ti·ªáp/Th·ªßy,Hi·ªÉn/P.H√πng,14:30,S√¢n 2,B,,
H·∫°nh/Ti·∫øn,Linh/M.H√πng,14:30,S√¢n 3,A,,
Ph∆∞∆°ng/Thanh,√Ånh/To√†n,14:30,S√¢n7,B,,
Huy·ªÅn/Lu√¢n,H∆∞·ªùng/ƒê·∫°t,14:45,S√¢n 2,A,,
H·∫°nh/Ti·∫øn,Giang/Long,14:45,S√¢n 3,A,,
H·∫≠u/D≈©ng,Linh/M.H√πng,14:45,S√¢n7,A,,
Ti·ªáp/Th·ªßy,√Ånh/To√†n,15:00,S√¢n 2,B,,
T√≠n/Khi√™m,Hi·ªÉn/P.H√πng,15:00,S√¢n 3,B,,
Ph∆∞∆°ng/Thanh,Tri·ªÅu/Minh,15:15,S√¢n 2,B,,
Giang/Long,Linh/M.H√πng,15:15,S√¢n 3,A,,
H·∫°nh/Ti·∫øn,H∆∞·ªùng/ƒê·∫°t,15:30,S√¢n 2,A,,
H·∫≠u/D≈©ng,Huy·ªÅn/Lu√¢n,15:30,S√¢n 3,A,,
Ti·ªáp/Th·ªßy,T√≠n/Khi√™m,15:45,S√¢n 2,B,,
Ph∆∞∆°ng/Thanh,Hi·ªÉn/P.H√πng,15:45,S√¢n 3,B,,
Tri·ªÅu/Minh,√Ånh/To√†n,16:00,S√¢n 2,B,,
H·∫≠u/D≈©ng,Giang/Long,16:00,S√¢n 3,A,,
H·∫°nh/Ti·∫øn,Huy·ªÅn/Lu√¢n,16:15,S√¢n 2,A,,
Linh/M.H√πng,H∆∞·ªùng/ƒê·∫°t,16:15,S√¢n 3,A,,
Ti·ªáp/Th·ªßy,Tri·ªÅu/Minh,16:30,S√¢n 2,B,,
√Ånh/To√†n,Hi·ªÉn/P.H√πng,16:30,S√¢n 3,B,,
Ph∆∞∆°ng/Thanh,T√≠n/Khi√™m,16:45,S√¢n 2,B,,
`;

// Bi·∫øn state l∆∞u tr·ªØ d·ªØ li·ªáu ch√≠nh c·ªßa ·ª©ng d·ª•ng.
let state = { 
  mixedTeams: [], // S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ players.json
  maleTeams: [],  // S·∫Ω ƒë∆∞·ª£c t·∫£i t·ª´ players.json
  matchesA: [], 
  matchesB: [],
  tableA: [], // B·∫£ng x·∫øp h·∫°ng A
  tableB: [], // B·∫£ng x·∫øp h·∫°ng B
  
  // NEW: Court Configuration (8 S√¢n m·∫∑c ƒë·ªãnh theo y√™u c·∫ßu m·ªõi)
  courts: [
    { name: 'S√¢n 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // B·∫£ng A (Mixed)
    { name: 'S√¢n 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // B·∫£ng A (Mixed)
    { name: 'S√¢n 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // B·∫£ng A (Mixed)
    { name: 'S√¢n 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true }, // B·∫£ng A (Mixed)
    { name: 'S√¢n 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // B·∫£ng B (Male)
    { name: 'S√¢n 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // B·∫£ng B (Male)
    { name: 'S√¢n 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }, // B·∫£ng B (Male)
    { name: 'S√¢n 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }  // B·∫£ng B (Male)
  ],
  
  // LOGIC B√ÅN K·∫æT (Court m·∫∑c ƒë·ªãnh l√† S√¢n 3 theo y√™u c·∫ßu m·ªõi)
  semifinals: [
    { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null },
    { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null }
  ],
  final: { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'S√¢n 3', winner: null, runnerUp: null },
  config: {}
};

let stateChanged = false; // Bi·∫øn c·ªù theo d√µi thay ƒë·ªïi d·ªØ li·ªáu
let currentSha = null; // Bi·∫øn l∆∞u tr·ªØ SHA c·ªßa file tr√™n GitHub
let autoSaveInterval = null; // Bi·∫øn l∆∞u tr·ªØ ID c·ªßa interval

// --- Custom Modal Function ---
function showModal(title, body) {
    document.getElementById('customAlertModalLabel').textContent = title;
    document.getElementById('customAlertModalBody').innerHTML = body;
    const modal = new bootstrap.Modal(document.getElementById('customAlertModal'));
    modal.show();
}

/**
 * H√†m chuy·ªÉn ƒë·ªïi tab
 * @param {string} tabId - ID c·ªßa tab c·∫ßn chuy·ªÉn (v√≠ d·ª•: 'matches', 'overview')
 */
function switchTab(tabId) {
    const tabElement = document.querySelector(`#mainTabs button[data-bs-target="#${tabId}"]`);
    if (tabElement) {
        // T·∫Øt tab ƒëang active
        document.querySelectorAll('#mainTabs .nav-link').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content .tab-pane').forEach(pane => pane.classList.remove('show', 'active'));

        // B·∫≠t tab m·ªõi
        tabElement.classList.add('active');
        document.getElementById(tabId).classList.add('show', 'active');
        
        // C·∫≠p nh·∫≠t view cho tab matches n·∫øu chuy·ªÉn ƒë·∫øn
        if (tabId === 'matches') {
            renderMatchesView();
        }
    }
}

// --- Helper Functions cho Base64 ---
function b64EncodeUnicode(str) {
  return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
    function(match, p1) {
      return String.fromCharCode('0x' + p1);
    }));
}

function b64DecodeUnicode(str) {
  return decodeURIComponent(atob(str).split('').map(function(c) {
    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
  }).join(''));
}

// --- CSV Helper (NEW/MODIFIED) ---

/**
 * Ph√¢n t√≠ch c√∫ ph√°p CSV th√†nh m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng.
 * @param {string} csvText - Chu·ªói CSV.
 * @returns {Array<Object>} M·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng, key l√† header (lowercase, trimmed).
 */
function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    if (lines.length === 0) return [];
    
    // Chu·∫©n h√≥a header: trim v√† lowercase
    const header = lines[0].split(',').map(h => h.trim().toLowerCase()); 
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line === '') continue; // B·ªè qua d√≤ng tr·ªëng
        
        // Split d√≤ng (d√πng regex ƒë∆°n gi·∫£n ƒë·ªÉ handle quote n·∫øu c·∫ßn, nh∆∞ng t·ªët nh·∫•t l√† kh√¥ng d√πng quote)
        const rowData = line.split(','); 
        if (rowData.length !== header.length) continue; // B·ªè qua d√≤ng kh√¥ng kh·ªõp s·ªë l∆∞·ª£ng c·ªôt
        
        const row = {};
        header.forEach((key, index) => {
            row[key] = rowData[index].trim().replace(/^"|"$/g, '').replace(/""/g, '"'); // X·ª≠ l√Ω quote ƒë∆°n gi·∫£n
        });
        
        data.push(row);
    }
    return data;
}

// --- GitHub API Functions ---

/**
 * L·∫•y SHA m·ªõi nh·∫•t c·ªßa file state.json tr√™n GitHub.
 * @param {object} cfg - C·∫•u h√¨nh GitHub (owner, repo, folder, file, token)
 * @returns {Promise<{sha: string|null, content: string|null}>}
 */
async function fetchFileSha(cfg, fileName = cfg.file) {
    const filePath = `${cfg.folder}/${fileName}`;
    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${filePath}`;
    
    try {
        const response = await fetch(apiUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (fileName === cfg.file) {
                 currentSha = data.sha; // Ch·ªâ l∆∞u SHA c·ªßa state.json
            }
            return { sha: data.sha, content: data.content };
        } else if (response.status === 404) {
            if (fileName === cfg.file) {
                 currentSha = null; 
            }
            return { sha: null, content: null };
        } else {
            throw new Error(`L·ªói khi l·∫•y SHA: ${response.statusText}`);
        }
    } catch (error) {
        console.error(`L·ªói Fetch SHA (${fileName}):`, error);
        throw new Error(`L·ªói k·∫øt n·ªëi ho·∫∑c API: ${error.message}`);
    }
}

/**
 * NEW: T·∫£i danh s√°ch ƒë·ªôi t·ª´ players.json
 */
async function loadPlayersFromGitHub(cfg) {
    // players.json ph·∫£i n·∫±m c√πng th∆∞ m·ª•c v·ªõi state.json
    const fileName = 'players.json';
    
    try {
        updateStatus('configStatus', 'info', 'ƒêang t·∫£i danh s√°ch ƒë·ªôi t·ª´ GitHub (players.json)...');
        const result = await fetchFileSha(cfg, fileName); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedTeams = JSON.parse(jsonString);

            if (Array.isArray(loadedTeams.mixedTeams) && Array.isArray(loadedTeams.maleTeams)) {
                state.mixedTeams = loadedTeams.mixedTeams;
                state.maleTeams = loadedTeams.maleTeams;
                updateStatus('configStatus', 'success', `T·∫£i danh s√°ch ƒë·ªôi th√†nh c√¥ng (${state.mixedTeams.length + state.maleTeams.length} ƒë·ªôi).`);
                return true;
            } else {
                throw new Error("File players.json kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng (thi·∫øu mixedTeams/maleTeams).");
            }
        } else {
             // 404 ho·∫∑c kh√¥ng c√≥ content
            updateStatus('configStatus', 'warning', 'Kh√¥ng t√¨m th·∫•y file players.json. D√πng danh s√°ch ƒë·ªôi kh·ªüi t·∫°o (tr·ªëng).');
            return false;
        }
    } catch (error) {
        console.error("L·ªói khi t·∫£i players.json:", error);
        updateStatus('configStatus', 'danger', `L·ªói t·∫£i danh s√°ch ƒë·ªôi: ${error.message}`);
        return false;
    }
}

/**
 * T·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u (state.json) t·ª´ GitHub.
 */
async function loadFromGitHub() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) return;

    // 1. Load Teams (danh s√°ch ƒë·ªôi)
    await loadPlayersFromGitHub(cfg); 

    // 2. Load App State (state.json)
    try {
        updateStatus('configStatus', 'info', 'ƒêang t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u t·ª´ GitHub (state.json)...');
        // fetchFileSha s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t currentSha
        const result = await fetchFileSha(cfg, cfg.file); 
        
        if (result.content) {
            const jsonString = b64DecodeUnicode(result.content);
            const loadedState = JSON.parse(jsonString);

            // Ghi ƒë√® c√°c gi√° tr·ªã kh√°c ngo√†i teams (teams ƒë√£ ƒë∆∞·ª£c load t·ª´ players.json)
            state.matchesA = loadedState.matchesA || [];
            state.matchesB = loadedState.matchesB || [];
            
            // T·∫£i c·∫•u h√¨nh s√¢n (NEW) - n·∫øu kh√¥ng c√≥, gi·ªØ nguy√™n m·∫∑c ƒë·ªãnh
            if (loadedState.courts && loadedState.courts.length > 0) {
                state.courts = loadedState.courts;
            } else {
                // N·∫øu kh√¥ng c√≥, d√πng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh 8 s√¢n m·ªõi
                loadDefaultCourtConfig(false); 
            }
            
            // T·∫£i c·∫•u h√¨nh finals (gi·ªØ nguy√™n S√¢n 3 m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a ƒë∆∞·ª£c g√°n)
            const defaultSF1 = { teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', court: 'S√¢n 3' };
            const defaultSF2 = { teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', court: 'S√¢n 3' };
            
            if (loadedState.semifinals && loadedState.semifinals.length === 2) {
                state.semifinals = loadedState.semifinals;
                // N·∫øu teamA, teamB ch∆∞a b·ªã g√°n, nh∆∞ng court l·∫°i kh√°c 'S√¢n 3', th√¨ c·∫≠p nh·∫≠t l·∫°i court
                if (state.semifinals[0].teamA === defaultSF1.teamA && state.semifinals[0].teamB === defaultSF1.teamB) {
                    state.semifinals[0].court = defaultSF1.court;
                }
                if (state.semifinals[1].teamA === defaultSF2.teamA && state.semifinals[1].teamB === defaultSF2.teamB) {
                    state.semifinals[1].court = defaultSF2.court;
                }
            } else {
                 // N·∫øu kh√¥ng c√≥, d√πng m·∫∑c ƒë·ªãnh
                 state.semifinals = [
                    { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null },
                    { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null }
                 ];
            }

            state.final = loadedState.final || state.final;
            if (state.final.teamA === 'Th·∫Øng SF1' && state.final.teamB === 'Th·∫Øng SF2') {
                 state.final.court = 'S√¢n 3'; // C·∫≠p nh·∫≠t S√¢n 3 n·∫øu ch∆∞a g√°n ƒë·ªôi
            }
            
            // C·∫≠p nh·∫≠t giao di·ªán
            renderMatches(); 
            tinhVaCapNhatXepHang();
            renderFinals();
            renderFinalResults();
            renderOverview();
            
            updateStatus('configStatus', 'success', `T·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u th√†nh c√¥ng t·ª´: ${cfg.owner}/${cfg.repo}/${cfg.folder}/${cfg.file}`);
            document.getElementById('lastSaved').textContent = `L·∫ßn t·∫£i: ${new Date().toLocaleTimeString('vi-VN')}`;
        } else {
            updateStatus('configStatus', 'warning', 'File tr·∫°ng th√°i (state.json) ch∆∞a t·ªìn t·∫°i. Vui l√≤ng nh·∫•n L∆∞u ho·∫∑c T·ª± ƒë·ªông l∆∞u ƒë·ªÉ t·∫°o file.');
        }

        startAutoSave();

    } catch (error) {
        updateStatus('configStatus', 'danger', `L·ªói t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u: ${error.message}. Vui l√≤ng ki·ªÉm tra l·∫°i Token/Repo.`);
        console.error("L·ªói khi t·∫£i tr·∫°ng th√°i gi·∫£i ƒë·∫•u t·ª´ GitHub:", error);
    }
}

async function saveToGitHub() {
    // B·ªè qua n·∫øu kh√¥ng c√≥ thay ƒë·ªïi
    if (!stateChanged) return;

    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        console.warn("Kh√¥ng th·ªÉ t·ª± ƒë·ªông l∆∞u: Thi·∫øu c·∫•u h√¨nh GitHub.");
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'T·∫°m d·ª´ng (Thi·∫øu Config)';
        return;
    }

    document.getElementById('autoState').className = 'text-info';
    document.getElementById('autoState').textContent = 'ƒêang l∆∞u...';

    const apiUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${cfg.folder}/${cfg.file}`;
    
    // Ch·ªâ l∆∞u c√°c tr∆∞·ªùng c·∫ßn thi·∫øt, lo·∫°i b·ªè config v√† table (v√¨ ch√∫ng ƒë∆∞·ª£c t√≠nh l·∫°i)
    const stateToSave = {
        mixedTeams: state.mixedTeams,
        maleTeams: state.maleTeams,
        matchesA: state.matchesA,
        matchesB: state.matchesB,
        courts: state.courts,
        semifinals: state.semifinals,
        final: state.final
    };
    const content = b64EncodeUnicode(JSON.stringify(stateToSave));
    
    try {
        // Lu√¥n fetch SHA m·ªõi nh·∫•t tr∆∞·ªõc khi c·ªë g·∫Øng l∆∞u
        const result = await fetchFileSha(cfg, cfg.file); // L·∫•y SHA c·ªßa state.json
        const sha = result.sha; 
        
        const payload = {
            message: `[Auto-save] C·∫≠p nh·∫≠t tr·∫°ng th√°i gi·∫£i ƒë·∫•u TKD V39 l√∫c ${new Date().toLocaleString('vi-VN')}`,
            content: content
        };
        
        // Ch·ªâ th√™m SHA v√†o payload n·∫øu n√≥ ƒë√£ t·ªìn t·∫°i (ƒë·ªÉ c·∫≠p nh·∫≠t), 
        if (sha) {
             payload.sha = sha;
        }

        const response = await fetch(apiUrl, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/vnd.github.v3+json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const data = await response.json();
            currentSha = data.content.sha;
            stateChanged = false;
            document.getElementById('lastSaved').textContent = `L·∫ßn l∆∞u: ${new Date().toLocaleTimeString('vi-VN')}`;
            document.getElementById('autoState').className = 'text-success';
            document.getElementById('autoState').textContent = 'ƒê√£ L∆∞u';
        } else {
            // Tr∆∞·ªùng h·ª£p l·ªói 409 Conflict (SHA c≈©)
            if (response.status === 409) {
                console.warn("L·ªói 409 Conflict: D·ªØ li·ªáu ƒë√£ thay ƒë·ªïi tr√™n GitHub. ƒêang c·ªë g·∫Øng l·∫•y SHA m·ªõi.");
                
                // L·∫•y l·∫°i SHA m·ªõi nh·∫•t. stateChanged v·∫´n l√† true, 
                // ƒë·ªÉ AutoSave interval s·∫Ω th·ª≠ l·∫°i v·ªõi SHA m·ªõi trong l·∫ßn ti·∫øp theo.
                await fetchFileSha(cfg, cfg.file); 
                
                document.getElementById('autoState').className = 'text-warning';
                document.getElementById('autoState').textContent = 'Conflict. S·∫Ω th·ª≠ l∆∞u l·∫°i sau 1 ph√∫t.';
            } else {
                throw new Error(`L·ªói HTTP: ${response.status} - ${response.statusText}`);
            }
        }
    } catch (error) {
        console.error("L·ªói khi l∆∞u l√™n GitHub:", error);
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'L·ªói L∆∞u';
    }
}

async function checkConnection() {
    const cfg = state.config;
    if (!cfg.owner || !cfg.repo || !cfg.token) {
        updateStatus('configStatus', 'warning', 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Owner, Repo v√† Token.');
        return;
    }

    try {
        updateStatus('configStatus', 'info', 'ƒêang ki·ªÉm tra k·∫øt n·ªëi...');
        
        const repoCheckUrl = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}`;
        const repoResponse = await fetch(repoCheckUrl, {
            headers: {
                'Authorization': `token ${cfg.token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });

        if (!repoResponse.ok) {
            throw new Error(`L·ªói truy c·∫≠p kho l∆∞u tr·ªØ. M√£: ${repoResponse.status}. (Ki·ªÉm tra Token/Repo/Owner)`);
        }
        
        updateStatus('configStatus', 'success', 'K·∫øt n·ªëi GitHub th√†nh c√¥ng! ƒêang t·∫£i d·ªØ li·ªáu...');
        await loadFromGitHub();

    } catch (error) {
        updateStatus('configStatus', 'danger', `Ki·ªÉm tra k·∫øt n·ªëi th·∫•t b·∫°i: ${error.message}.`);
        console.error("L·ªói ki·ªÉm tra k·∫øt n·ªëi:", error);
    }
}

// --- C·∫•u h√¨nh & Kh·ªüi t·∫°o ---

function renderConfig() {
    renderCourtList();
    document.getElementById('courtConfigStatus').innerHTML = '';
}

/**
 * Hi·ªÉn th·ªã danh s√°ch s√¢n d∆∞·ªõi d·∫°ng b·∫£ng v·ªõi n√∫t S·ª≠a/X√≥a.
 */
function renderCourtList() {
    const container = document.getElementById('courtListContainer');
    if (!container) return;
    
    if (state.courts.length === 0) {
        container.innerHTML = `<div class="alert alert-warning">Ch∆∞a c√≥ s√¢n n√†o ƒë∆∞·ª£c c·∫•u h√¨nh.</div>`;
        return;
    }
    
    let html = `<div class='table-responsive'><table class='table table-striped table-sm'>
        <thead>
            <tr>
                <th>T√™n S√¢n</th>
                <th>Gi·ªù B·∫Øt ƒê·∫ßu</th>
                <th>Th·ªùi L∆∞·ª£ng Max (Ph√∫t)</th>
                <th>Ph√¢n Lo·∫°i</th>
                <th class="text-center">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>`;
        
    state.courts.forEach((court, index) => {
        const type = court.isMixed ? 'B·∫£ng A (Nam-N·ªØ)' : 'B·∫£ng B (Nam)';
        const typeClass = court.isMixed ? 'badge bg-primary' : 'badge bg-info';
        
        html += `<tr>
            <td>${court.name}</td>
            <td>${court.startTime}</td>
            <td>${court.maxDurationMinutes}</td>
            <td><span class="${typeClass}">${type}</span></td>
            <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary me-1" onclick="openCourtModal(${index})">S·ª≠a</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCourt(${index})">X√≥a</button>
            </td>
        </tr>`;
    });
    
    html += `</tbody></table></div>`;
    container.innerHTML = html;
}

/**
 * M·ªü modal th√™m/s·ª≠a s√¢n v√† ƒëi·ªÅn d·ªØ li·ªáu n·∫øu l√† ch·∫ø ƒë·ªô s·ª≠a.
 * @param {number | null} index - Ch·ªâ s·ªë c·ªßa s√¢n c·∫ßn s·ª≠a, ho·∫∑c null n·∫øu th√™m m·ªõi.
 */
function openCourtModal(index = null) {
    const modal = new bootstrap.Modal(document.getElementById('courtModal'));
    document.getElementById('courtFormStatus').innerHTML = '';

    document.getElementById('courtIndex').value = index !== null ? index : '';
    document.getElementById('courtModalLabel').textContent = index !== null ? 'S·ª≠a C·∫•u h√¨nh S√¢n' : 'Th√™m S√¢n M·ªõi';

    if (index !== null) {
        const court = state.courts[index];
        document.getElementById('courtName').value = court.name || '';
        document.getElementById('courtStartTime').value = court.startTime || '14:00';
        document.getElementById('courtMaxDuration').value = court.maxDurationMinutes || 180;
        document.getElementById('courtIsMixed').checked = court.isMixed || false;
    } else {
        // Ch·∫ø ƒë·ªô th√™m m·ªõi: Reset form
        document.getElementById('courtName').value = '';
        document.getElementById('courtStartTime').value = '14:00';
        document.getElementById('courtMaxDuration').value = '180';
        document.getElementById('courtIsMixed').checked = true; // Default to Mixed (B·∫£ng A)
    }

    modal.show();
}

/**
 * L∆∞u thay ƒë·ªïi t·ª´ modal v√†o state.courts
 */
function saveCourtChanges() {
    const indexStr = document.getElementById('courtIndex').value;
    const index = indexStr === '' ? null : parseInt(indexStr);
    
    const name = document.getElementById('courtName').value.trim();
    const startTime = document.getElementById('courtStartTime').value;
    const maxDurationMinutes = parseInt(document.getElementById('courtMaxDuration').value);
    const isMixed = document.getElementById('courtIsMixed').checked;

    const statusDiv = document.getElementById('courtFormStatus');

    // Validation
    if (!name || !startTime || isNaN(maxDurationMinutes) || maxDurationMinutes <= 0) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† h·ª£p l·ªá c√°c tr∆∞·ªùng (T√™n, Gi·ªù, Th·ªùi l∆∞·ª£ng > 0).</div>`;
        return;
    }
    
    // Check for duplicate name (excluding the current edited court)
    const isDuplicate = state.courts.some((c, i) => 
        i !== index && c.name.toLowerCase() === name.toLowerCase()
    );

    if (isDuplicate) {
         statusDiv.innerHTML = `<div class="alert alert-danger p-2">T√™n s√¢n "${name}" ƒë√£ t·ªìn t·∫°i.</div>`;
        return;
    }

    const newCourt = { 
        name, 
        startTime, 
        maxDurationMinutes, 
        isMixed 
    };

    if (index !== null) {
        // Edit mode
        state.courts[index] = newCourt;
    } else {
        // Add mode
        state.courts.push(newCourt);
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('courtModal')).hide();

    // Update UI and save
    renderCourtList();
    stateChanged = true;
    updateStatus('courtConfigStatus', 'success', `ƒê√£ ${index !== null ? 'c·∫≠p nh·∫≠t' : 'th√™m'} s√¢n "${name}". D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u l√™n GitHub.`);
    saveToGitHub();
}

/**
 * X√≥a s√¢n kh·ªèi danh s√°ch.
 * @param {number} index - Ch·ªâ s·ªë c·ªßa s√¢n c·∫ßn x√≥a.
 */
function deleteCourt(index) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s√¢n "${state.courts[index].name}"?`)) {
        const deletedCourtName = state.courts[index].name;
        state.courts.splice(index, 1);
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', `ƒê√£ x√≥a s√¢n "${deletedCourtName}". D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u l√™n GitHub.`);
        saveToGitHub();
    }
}

/**
 * T·∫£i c·∫•u h√¨nh m·∫∑c ƒë·ªãnh (8 s√¢n)
 */
function loadDefaultCourtConfig(showMsg = true) {
    state.courts = [
        { name: 'S√¢n 1', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'S√¢n 2', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'S√¢n 3', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'S√¢n 4', startTime: '14:00', maxDurationMinutes: 180, isMixed: true },
        { name: 'S√¢n 5', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'S√¢n 6', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'S√¢n 7', startTime: '14:00', maxDurationMinutes: 180, isMixed: false },
        { name: 'S√¢n 8', startTime: '14:00', maxDurationMinutes: 180, isMixed: false }
    ];
    if (showMsg) {
        renderCourtList();
        stateChanged = true;
        updateStatus('courtConfigStatus', 'success', 'ƒê√£ t·∫£i c·∫•u h√¨nh s√¢n M·∫∑c ƒë·ªãnh (8 S√¢n). D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u l√™n GitHub.');
        saveToGitHub();
    }
}

function loadConfig() {
    const savedConfig = localStorage.getItem('pkb_config');
    if (savedConfig) {
        state.config = JSON.parse(savedConfig);
        document.getElementById('cfgOwner').value = state.config.owner || '';
        document.getElementById('cfgRepo').value = state.config.repo || '';
        document.getElementById('cfgFolder').value = state.config.folder || 'data';
        document.getElementById('cfgFile').value = state.config.file || 'state.json';
        document.getElementById('cfgToken').value = state.config.token || '';
    }
}

function saveConfig(){
    const cfg = {
        owner: document.getElementById('cfgOwner').value,
        repo: document.getElementById('cfgRepo').value,
        folder: document.getElementById('cfgFolder').value,
        file: document.getElementById('cfgFile').value,
        token: document.getElementById('cfgToken').value
    };
    state.config = cfg;
    localStorage.setItem('pkb_config', JSON.stringify(cfg));
    updateStatus('configStatus', 'success', 'ƒê√£ l∆∞u c·∫•u h√¨nh GitHub v√†o tr√¨nh duy·ªát. Vui l√≤ng Ki·ªÉm tra & T·∫£i D·ªØ li·ªáu.');
}

function updateStatus(id, type, message) {
    const statusDiv = document.getElementById(id);
    statusDiv.innerHTML = `<div class="alert alert-${type} p-2 mt-2">${message}</div>`;
}

function startAutoSave() {
    if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
    }
    if (state.config.token && state.config.owner && state.config.repo) {
        autoSaveInterval = setInterval(saveToGitHub, 60000);
        document.getElementById('autoState').className = 'text-warning';
        document.getElementById('autoState').textContent = 'Ho·∫°t ƒë·ªông...';
    } else {
        document.getElementById('autoState').className = 'text-danger';
        document.getElementById('autoState').textContent = 'T·∫Øt';
    }
}

// --- Import/Export Functions (MODIFIED FOR SYNCHRONIZATION) ---

/**
 * X·ª≠ l√Ω Import l·ªãch thi ƒë·∫•u t·ª´ t·ªáp CSV theo m·∫´u chu·∫©n: teamA,teamB,time,court,bang,scoreA,scoreB
 */
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        showModal("L·ªói Import", "Vui l√≤ng ch·ªçn m·ªôt t·ªáp CSV.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const csvText = e.target.result;
            const rows = parseCSV(csvText);
            
            if (rows.length === 0 || !rows[0].teama || !rows[0].teamb || !rows[0].bang) {
                showModal("L·ªói Import", "Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu ho·∫∑c t·ªáp kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng. C·∫ßn c√≥ c√°c c·ªôt: teamA, teamB, time, court, bang, scoreA, scoreB.");
                document.getElementById('fileInput').value = ''; // Clear file input
                return;
            }

            // X√≥a l·ªãch c≈©
            state.matchesA = [];
            state.matchesB = [];
            
            let idCounterA = 1;
            let idCounterB = 1;

            rows.forEach(row => {
                const bangCode = row.bang.toUpperCase();
                const isMixed = bangCode === 'A';
                
                // T·∫°o ƒë·ªëi t∆∞·ª£ng tr·∫≠n ƒë·∫•u m·ªõi theo c·∫•u tr√∫c chu·∫©n
                const newMatch = {
                    id: isMixed ? `A${idCounterA++}` : `B${idCounterB++}`,
                    teamA: row.teama || '',
                    teamB: row.teamb || '',
                    // X·ª≠ l√Ω ƒëi·ªÉm s·ªë, n·∫øu c√≥ th√¨ parse, kh√¥ng th√¨ l√† null
                    scoreA: (row.scorea && row.scorea.trim().length > 0) ? parseInt(row.scorea) : null,
                    scoreB: (row.scoreb && row.scoreb.trim().length > 0) ? parseInt(row.scoreb) : null,
                    time: row.time || '',
                    court: row.court || 'Ch∆∞a g√°n',
                    bang: bangCode,
                    winner: null,
                    loser: null
                };
                
                // C·∫≠p nh·∫≠t winner/loser n·∫øu c√≥ ƒëi·ªÉm s·ªë
                if (newMatch.scoreA !== null && newMatch.scoreB !== null) {
                    if (newMatch.scoreA > newMatch.scoreB) {
                        newMatch.winner = newMatch.teamA;
                        newMatch.loser = newMatch.teamB;
                    } else if (newMatch.scoreB > newMatch.scoreA) {
                        newMatch.winner = newMatch.teamB;
                        newMatch.loser = newMatch.teamA;
                    }
                }

                if (isMixed) {
                    state.matchesA.push(newMatch);
                } else {
                    state.matchesB.push(newMatch);
                }
            });

            document.getElementById('fileInput').value = ''; // Clear file input
            renderMatchesView();
            tinhVaCapNhatXepHang();
            renderOverview();
            
            stateChanged = true;
            saveToGitHub();
            showModal("Th√†nh c√¥ng", `ƒê√£ Import th√†nh c√¥ng ${state.matchesA.length + state.matchesB.length} tr·∫≠n ƒë·∫•u theo m·∫´u chu·∫©n.`);

        } catch (error) {
            console.error("L·ªói khi x·ª≠ l√Ω CSV:", error);
            document.getElementById('fileInput').value = ''; 
            showModal("L·ªói Import", `ƒê√£ x·∫£y ra l·ªói khi ƒë·ªçc t·ªáp: ${error.message}`);
        }
    };
    reader.readAsText(file);
}

/**
 * Xu·∫•t l·ªãch thi ƒë·∫•u hi·ªán t·∫°i ra t·ªáp CSV theo m·∫´u chu·∫©n: teamA,teamB,time,court,bang,scoreA,scoreB
 */
function exportSchedule() {
    // Header chu·∫©n h√≥a
    const header = ['teamA', 'teamB', 'time', 'court', 'bang', 'scoreA', 'scoreB'];
    let csvContent = header.join(',') + '\n';

    const allMatches = [...state.matchesA, ...state.matchesB];

    allMatches.forEach(match => {
        // D√πng quote ƒë·ªÉ tr√°nh l·ªói khi t√™n ƒë·ªôi c√≥ d·∫•u ph·∫©y
        const row = [
            `"${(match.teamA || '').replace(/"/g, '""')}"`, 
            `"${(match.teamB || '').replace(/"/g, '""')}"`,
            match.time || '',
            match.court || '',
            match.bang || '',
            match.scoreA !== null ? match.scoreA : '',
            match.scoreB !== null ? match.scoreB : ''
        ];
        csvContent += row.join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    link.setAttribute("href", url);
    link.setAttribute("download", `lich_thi_dau_V39_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showModal("Xu·∫•t d·ªØ li·ªáu", "ƒê√£ xu·∫•t l·ªãch thi ƒë·∫•u hi·ªán t·∫°i ra t·ªáp CSV theo m·∫´u ƒë·ªìng b·ªô.");
}


/**
 * T·∫°o l·ªãch c·ªë ƒë·ªãnh t·ª´ d·ªØ li·ªáu m·∫´u chu·∫©n h√≥a (STANDARDIZED_SCHEDULE_CSV_SAMPLE)
 */
function taoLichCoDinh() {
    if (confirm("Thao t√°c n√†y s·∫Ω x√≥a to√†n b·ªô l·ªãch hi·ªán t·∫°i v√† thay b·∫±ng l·ªãch c·ªë ƒë·ªãnh (d·ªØ li·ªáu m·∫´u chu·∫©n h√≥a). B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
        const rows = parseCSV(STANDARDIZED_SCHEDULE_CSV_SAMPLE);
        
        if (rows.length === 0) {
            showModal("L·ªói T·∫°o L·ªãch", "Kh√¥ng c√≥ d·ªØ li·ªáu m·∫´u c·ªë ƒë·ªãnh ƒë·ªÉ t·∫°o l·ªãch.");
            return;
        }

        // X√≥a l·ªãch c≈©
        state.matchesA = [];
        state.matchesB = [];

        let idCounterA = 1;
        let idCounterB = 1;

        rows.forEach(row => {
            const bangCode = row.bang.toUpperCase();
            const isMixed = bangCode === 'A';
            
            const newMatch = {
                id: isMixed ? `A${idCounterA++}` : `B${idCounterB++}`,
                teamA: row.teama || '',
                teamB: row.teamb || '',
                scoreA: null, // Lu√¥n reset ƒëi·ªÉm s·ªë khi t·∫°o l·ªãch c·ªë ƒë·ªãnh
                scoreB: null, 
                time: row.time || '',
                court: row.court || 'Ch∆∞a g√°n',
                bang: bangCode,
                winner: null,
                loser: null
            };
            
            if (isMixed) {
                state.matchesA.push(newMatch);
            } else {
                state.matchesB.push(newMatch);
            }
        });
        
        // Reset l·ªãch chung k·∫øt v·ªÅ m·∫∑c ƒë·ªãnh S√¢n 3
        state.semifinals = [
            { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'S√¢n 3', winner: null, runnerUp: null };


        renderMatchesView();
        tinhVaCapNhatXepHang();
        renderFinals();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal("Th√†nh c√¥ng", `ƒê√£ t·∫°o ${state.matchesA.length + state.matchesB.length} tr·∫≠n ƒë·∫•u t·ª´ l·ªãch c·ªë ƒë·ªãnh m·∫´u chu·∫©n h√≥a.`);
    }
}

// --- Helper for Match Edit (M·ªöI) ---
/**
 * Helper: T√¨m tr·∫≠n ƒë·∫•u theo ID (Bao g·ªìm v√≤ng b·∫£ng, b√°n k·∫øt, chung k·∫øt)
 */
function findMatchById(id) {
    let match = state.matchesA.find(m => m.id === id);
    if (match) return { match: match, isFinal: false, array: state.matchesA };
    
    match = state.matchesB.find(m => m.id === id);
    if (match) return { match: match, isFinal: false, array: state.matchesB };

    match = state.semifinals.find(m => m.id === id);
    if (match) return { match: match, isFinal: true, array: state.semifinals };
    
    if (state.final.id === id) return { match: state.final, isFinal: true, array: null };
    
    return null;
}

/**
 * M·ªü modal s·ª≠a l·ªãch (Gi·ªù v√† S√¢n)
 * @param {string} id - ID tr·∫≠n ƒë·∫•u
 * @param {boolean} isFinal - Tr·∫≠n ƒë·∫•u thu·ªôc v√≤ng chung k·∫øt?
 */
function openMatchEdit(id, isFinal) {
    const result = findMatchById(id);
    if (!result) {
        showModal("L·ªói", "Kh√¥ng t√¨m th·∫•y tr·∫≠n ƒë·∫•u n√†y.");
        return;
    }
    
    const match = result.match;
    const modal = new bootstrap.Modal(document.getElementById('matchEditModal'));
    
    document.getElementById('matchEditFormStatus').innerHTML = '';
    document.getElementById('matchEditModalLabel').textContent = `S·ª≠a L·ªãch Tr·∫≠n: ${match.id} (${match.bang || (isFinal ? (match.id === 'F' ? 'CK' : 'BK') : 'V√≤ng B·∫£ng')})`;
    
    document.getElementById('matchEditId').value = id;
    document.getElementById('matchEditIsFinal').value = isFinal ? 'true' : 'false';
    document.getElementById('matchEditTeams').textContent = `${match.teamA} vs ${match.teamB}`;
    document.getElementById('matchEditTime').value = match.time || '14:00';
    
    const courtSelect = document.getElementById('matchEditCourt');
    courtSelect.innerHTML = '';
    
    // Th√™m c√°c s√¢n v√†o dropdown
    let currentCourtExists = false;
    state.courts.forEach(court => {
        const option = document.createElement('option');
        option.value = court.name;
        option.textContent = court.name;
        if (court.name === match.court) {
            option.selected = true;
            currentCourtExists = true;
        }
        courtSelect.appendChild(option);
    });
    
    // N·∫øu match.court kh√¥ng c√≥ trong danh s√°ch s√¢n (v√≠ d·ª•: S√¢n7 trong l·ªãch c·ªë ƒë·ªãnh), v·∫´n th√™m v√†o
    if (match.court && !currentCourtExists) {
        const option = document.createElement('option');
        option.value = match.court;
        option.textContent = `${match.court} (S√¢n kh√¥ng c√≥ trong Config)`;
        option.selected = true;
        courtSelect.prepend(option); // ƒê∆∞a l√™n ƒë·∫ßu
    }

    modal.show();
}

/**
 * L∆∞u thay ƒë·ªïi Gi·ªù v√† S√¢n c·ªßa tr·∫≠n ƒë·∫•u t·ª´ modal (M·ªöI)
 */
function saveMatchChanges() {
    const id = document.getElementById('matchEditId').value;
    const isFinal = document.getElementById('matchEditIsFinal').value === 'true';
    const newTime = document.getElementById('matchEditTime').value;
    const newCourt = document.getElementById('matchEditCourt').value;
    
    const statusDiv = document.getElementById('matchEditFormStatus');

    if (!newTime || !newCourt) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß Gi·ªù v√† S√¢n.</div>`;
        return;
    }

    const result = findMatchById(id);
    if (!result) {
        statusDiv.innerHTML = `<div class="alert alert-danger p-2">L·ªói: Kh√¥ng t√¨m th·∫•y tr·∫≠n ƒë·∫•u ƒë·ªÉ l∆∞u.</div>`;
        return;
    }
    
    result.match.time = newTime;
    result.match.court = newCourt;

    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('matchEditModal')).hide();
    
    // Update UI and save
    if (isFinal) {
        renderFinals();
    } else {
        renderMatchesView();
    }
    tinhVaCapNhatXepHang();
    
    stateChanged = true;
    saveToGitHub();
    showModal("Th√†nh c√¥ng", `ƒê√£ c·∫≠p nh·∫≠t l·ªãch thi ƒë·∫•u cho tr·∫≠n ${id}: ${newTime} t·∫°i ${newCourt}.`);
}


// --- Placeholder/Reconstructed Functions (ƒê·ªÉ ƒë·∫£m b·∫£o ·ª©ng d·ª•ng ch·∫°y) ---

function generateMatchHtml(match, isFinal = false) {
    const winnerClass = match.winner ? (match.winner === match.teamA ? 'winner' : 'loser') : '';
    const loserClass = match.loser ? (match.loser === match.teamB ? 'winner' : 'loser') : '';
    const teamAClass = match.scoreA !== null ? (match.scoreA > match.scoreB ? 'winner' : (match.scoreA < match.scoreB ? 'loser' : '')) : '';
    const teamBClass = match.scoreB !== null ? (match.scoreB > match.scoreA ? 'winner' : (match.scoreB < match.scoreA ? 'loser' : '')) : '';
    
    const scoreA = match.scoreA !== null ? match.scoreA : '';
    const scoreB = match.scoreB !== null ? match.scoreB : '';
    
    // N√∫t S·ª≠a/L∆∞u
    // G·ªçi openMatchEdit() (ƒê√£ c·∫≠p nh·∫≠t)
    const editButton = `<button class="btn btn-sm btn-outline-secondary me-1" onclick="openMatchEdit('${match.id}', ${isFinal})">S·ª≠a L·ªãch</button>`;

    return `
        <tr>
            <td>${match.id}</td>
            <td>${match.time || ''}</td>
            <td>${match.court || ''}</td>
            <td class="${teamAClass}">
                <span title="${match.teamA}">${match.teamA}</span>
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" max="99" value="${scoreA}" data-match-id="${match.id}" data-team="A" onchange="updateScore('${match.id}', 'A', this.value, ${isFinal})" onfocus="this.select()">
            </td>
            <td class="match-score-cell">
                <input type="number" min="0" max="99" value="${scoreB}" data-match-id="${match.id}" data-team="B" onchange="updateScore('${match.id}', 'B', this.value, ${isFinal})" onfocus="this.select()">
            </td>
            <td class="${teamBClass}">
                <span title="${match.teamB}">${match.teamB}</span>
            </td>
            <td>
                ${editButton}
            </td>
        </tr>
    `;
}

function renderMatches() {
    renderMatchesView();
}

function renderMatchesView() {
    const viewMode = document.getElementById('viewMode').value;
    const tableMatchesA = document.getElementById('tableMatchesA');
    const tableMatchesB = document.getElementById('tableMatchesB');

    const allMatches = [...state.matchesA, ...state.matchesB];

    if (viewMode === 'court') {
        const matchesByCourt = {};
        // Kh·ªüi t·∫°o c√°c s√¢n t·ª´ config
        state.courts.forEach(c => matchesByCourt[c.name] = []);
        
        allMatches.forEach(match => {
             // Th√™m c√°c s√¢n kh√¥ng c√≥ trong config (v√≠ d·ª•: S√¢n7) v√†o danh s√°ch n·∫øu c√≥ tr·∫≠n ƒë·∫•u ·ªü ƒë√≥
            if (!matchesByCourt[match.court]) {
                matchesByCourt[match.court] = [];
            }
            if (match.court) {
                matchesByCourt[match.court].push(match);
            }
        });
        
        let htmlA = '';
        let htmlB = '';
        
        // L·∫•y danh s√°ch s√¢n duy nh·∫•t, s·∫Øp x·∫øp theo t√™n (ho·∫∑c theo config n·∫øu c√≥)
        const allCourtNames = Object.keys(matchesByCourt);
        const sortedCourtNames = allCourtNames.sort((a, b) => {
            // C·ªë g·∫Øng s·∫Øp x·∫øp S√¢n N theo s·ªë th·ª© t·ª± (S√¢n 1, S√¢n 2, ...)
            const numA = parseInt(a.replace('S√¢n', '').trim()) || Infinity;
            const numB = parseInt(b.replace('S√¢n', '').trim()) || Infinity;
            return numA - numB;
        });

        sortedCourtNames.forEach(courtName => {
            const matches = matchesByCourt[courtName] || [];
            
            // T√¨m config ƒë·ªÉ x√°c ƒë·ªãnh lo·∫°i b·∫£ng
            const courtConfig = state.courts.find(c => c.name === courtName);
            const isMixed = courtConfig ? courtConfig.isMixed : (matches.length > 0 ? matches[0].bang === 'A' : false);
            const startTime = courtConfig ? courtConfig.startTime : '';

            if (matches.length > 0) {
                const header = `<h6 class="mt-4">${courtName} (${isMixed ? 'B·∫£ng A' : 'B·∫£ng B'}) - B·∫Øt ƒë·∫ßu: ${startTime || '??:??'}</h6>`;
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="table table-striped table-sm align-middle">
                            <thead>
                                <tr><th>ID</th><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th colspan="2">K·∫øt qu·∫£</th><th>ƒê·ªôi B</th><th>Actions</th></tr>
                            </thead>
                            <tbody>
                                ${matches.sort((a, b) => a.time.localeCompare(b.time)).map(m => generateMatchHtml(m)).join('')}
                            </tbody>
                        </table>
                    </div>`;

                if (isMixed) {
                    htmlA += header + tableHtml;
                } else {
                    htmlB += header + tableHtml;
                }
            }
        });

        document.getElementById('scheduleAHeader').textContent = 'B·∫£ng A (Nam - N·ªØ) theo S√¢n';
        tableMatchesA.innerHTML = htmlA || '<div class="alert alert-info">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u cho c√°c s√¢n B·∫£ng A.</div>';
        
        document.querySelector('#matchesViewContent > h6:nth-child(3)').textContent = 'B·∫£ng B (Nam) theo S√¢n';
        tableMatchesB.innerHTML = htmlB || '<div class="alert alert-info">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u cho c√°c s√¢n B·∫£ng B.</div>';
        

    } else { // viewMode === 'table'
        document.getElementById('scheduleAHeader').textContent = 'B·∫£ng A (Nam - N·ªØ) theo B·∫£ng ƒë·∫•u';
        tableMatchesA.innerHTML = generateMatchTable(state.matchesA);
        
        document.querySelector('#matchesViewContent > h6:nth-child(3)').textContent = 'B·∫£ng B (Nam) theo B·∫£ng ƒë·∫•u';
        tableMatchesB.innerHTML = generateMatchTable(state.matchesB);
    }
}

function generateMatchTable(matches) {
    if (matches.length === 0) {
        return '<div class="alert alert-info">Ch∆∞a c√≥ l·ªãch thi ƒë·∫•u cho b·∫£ng n√†y.</div>';
    }
    return `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th colspan="2">K·∫øt qu·∫£</th><th>ƒê·ªôi B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${matches.map(m => generateMatchHtml(m)).join('')}
                </tbody>
            </table>
        </div>`;
}

// Logic c·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë (minimal implementation)
function updateScore(id, team, value, isFinal) {
    // T√¨m tr·∫≠n ƒë·∫•u
    const result = findMatchById(id);
    if (!result) return;
    const match = result.match;
    
    const score = value.trim() === '' ? null : parseInt(value);

    if (team === 'A') {
        match.scoreA = score;
    } else {
        match.scoreB = score;
    }

    // C·∫≠p nh·∫≠t winner/loser (logic s∆° b·ªô)
    match.winner = null;
    match.loser = null;
    if (match.scoreA !== null && match.scoreB !== null) {
        if (match.scoreA > match.scoreB) {
            match.winner = match.teamA;
            match.loser = match.teamB;
        } else if (match.scoreB > match.scoreA) {
            match.winner = match.teamB;
            match.loser = match.teamA;
        }
    }

    // T·ª± ƒë·ªông c·∫≠p nh·∫≠t giao di·ªán
    renderMatchesView(); 
    if (result.isFinal) {
        renderFinals();
    }
    tinhVaCapNhatXepHang(); 
    renderOverview();
    
    stateChanged = true;
    saveToGitHub();
}

// H√†m gi·∫£ l·∫≠p c√°c ch·ª©c nƒÉng t√≠nh to√°n kh√°c
function tinhVaCapNhatXepHang() {
    // Minimal implementation: ch·ªâ ƒë·ªÉ render kh√¥ng b·ªã l·ªói
    state.tableA = state.mixedTeams.map(t => ({ team: t, wins: 0, points: 0 }));
    state.tableB = state.maleTeams.map(t => ({ team: t, wins: 0, points: 0 }));
    renderRankingTables();
}
function renderRankingTables() {
    const container = document.getElementById('rankingTables');
    // ... (logic render b·∫£ng x·∫øp h·∫°ng th·ª±c t·∫ø)
    container.innerHTML = `
        <div>
            <h6>B·∫£ng A (Nam - N·ªØ)</h6>
            <div class="alert alert-info small">Ch·ª©c nƒÉng t√≠nh ƒëi·ªÉm ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</div>
        </div>
        <div>
            <h6>B·∫£ng B (Nam)</h6>
            <div class="alert alert-info small">Ch·ª©c nƒÉng t√≠nh ƒëi·ªÉm ƒëang ƒë∆∞·ª£c c·∫≠p nh·∫≠t...</div>
        </div>
    `;
}

// C·∫≠p nh·∫≠t renderFinals ƒë·ªÉ hi·ªÉn th·ªã v√† cho ph√©p s·ª≠a ƒëi·ªÉm + l·ªãch
function renderFinals() {
    const containerSF = document.getElementById('semifinalMatches');
    const containerFinal = document.getElementById('finalMatch');
    
    // SF Matches
    const sfMatchesHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th colspan="2">K·∫øt qu·∫£</th><th>ƒê·ªôi B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${state.semifinals.map(m => generateMatchHtml(m, true)).join('')}
                </tbody>
            </table>
        </div>
    `;
    containerSF.innerHTML = sfMatchesHtml;

    // Final Match
    const finalMatchHtml = `
        <div class="table-responsive">
            <table class="table table-striped table-sm align-middle">
                <thead>
                    <tr><th>ID</th><th>Gi·ªù</th><th>S√¢n</th><th>ƒê·ªôi A</th><th colspan="2">K·∫øt qu·∫£</th><th>ƒê·ªôi B</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    ${generateMatchHtml(state.final, true)}
                </tbody>
            </table>
        </div>
    `;
    containerFinal.innerHTML = finalMatchHtml;
    
    // C·∫≠p nh·∫≠t Header
    document.querySelector('#finalsContent h6:nth-child(1)').textContent = `V√≤ng B√°n k·∫øt (${state.semifinals[0].time}, ${state.semifinals[0].court})`;
    document.querySelector('#finalsContent h6:nth-child(2)').textContent = `Tr·∫≠n Chung k·∫øt (${state.final.time}, ${state.final.court})`;
}

function renderFinalResults() {
    // ... (logic render k·∫øt qu·∫£ chung cu·ªôc)
}
function renderOverview() {
    const totalMatches = state.matchesA.length + state.matchesB.length;
    const completedMatches = [...state.matchesA, ...state.matchesB].filter(m => m.scoreA !== null && m.scoreB !== null).length;
    document.getElementById('overviewContent').innerHTML = `
        <div class="card shadow-sm border-primary">
            <div class="card-body">
                <h5 class="card-title text-primary">üìä Th√¥ng tin Gi·∫£i ƒë·∫•u (V39 - H·ªó tr·ª£ S·ª≠a L·ªãch Tr·∫≠n)</h5>
                <p><strong>T·ªïng s·ªë Tr·∫≠n ƒë·∫•u:</strong> <span class="badge bg-primary">${totalMatches}</span></p>
                <p><strong>Tr·∫≠n ƒë·∫•u ƒë√£ ho√†n th√†nh:</strong> <span class="badge bg-success">${completedMatches}</span> / ${totalMatches}</p>
                <p><strong>T√¨nh tr·∫°ng ƒê·ªìng b·ªô:</strong> Import/Export theo m·∫´u chu·∫©n: <code>teamA,teamB,time,court,bang,scoreA,scoreB</code></p>
            </div>
        </div>
    `;
}

function scheduleFinalsAuto() {
    showModal('T√≠nh to√°n V√≤ng Chung k·∫øt', 'Ch·ª©c nƒÉng t·ª± ƒë·ªông g√°n ƒë·ªôi cho V√≤ng B√°n k·∫øt ƒëang ƒë∆∞·ª£c th·ª±c hi·ªán sau khi v√≤ng b·∫£ng ho√†n t·∫•t. Vui l√≤ng ho√†n th√†nh ƒëi·ªÉm s·ªë v√≤ng b·∫£ng tr∆∞·ªõc.');
}
function taoLichThiDauCungGio() {
     showModal('T·∫°o L·ªãch T·ªëi ∆∞u', 'Ch·ª©c nƒÉng t·∫°o l·ªãch t·ªëi ∆∞u t·ª± ƒë·ªông ch∆∞a ƒë∆∞·ª£c tri·ªÉn khai trong phi√™n b·∫£n n√†y.');
}
function autoFillScores() {
    showModal('ƒêi·ªÅn k·∫øt qu·∫£ T·ª± ƒë·ªông', 'Ch·ª©c nƒÉng n√†y ƒë∆∞·ª£c d√πng ƒë·ªÉ ƒëi·ªÅn nhanh k·∫øt qu·∫£. Vui l√≤ng s·ª≠ d·ª•ng c·∫©n th·∫≠n.');
}
function clearAllSchedules() {
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò l·ªãch thi ƒë·∫•u (V√≤ng B·∫£ng v√† Chung k·∫øt)?")) {
        state.matchesA = [];
        state.matchesB = [];
        // Reset v·ªÅ c·∫•u h√¨nh m·∫∑c ƒë·ªãnh S√¢n 3
        state.semifinals = [
            { id: 'SF1', teamA: 'Nh·∫•t A', teamB: 'Nh√¨ A', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null },
            { id: 'SF2', teamA: 'Nh·∫•t B', teamB: 'Nh√¨ B', scoreA: null, scoreB: null, time: '16:30', court: 'S√¢n 3', winner: null, loser: null }
        ];
        state.final = { id: 'F', teamA: 'Th·∫Øng SF1', teamB: 'Th·∫Øng SF2', scoreA: null, scoreB: null, time: '17:00', court: 'S√¢n 3', winner: null, runnerUp: null };
        
        tinhVaCapNhatXepHang();
        renderMatchesView();
        renderFinals();
        renderOverview();
        
        stateChanged = true;
        saveToGitHub();
        showModal('Th√†nh c√¥ng', 'ƒê√£ x√≥a to√†n b·ªô l·ªãch thi ƒë·∫•u.');
    }
}
// Ch·ª©c nƒÉng n√†y ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng openMatchEdit(id, isFinal) (ƒê√É C·∫¨P NH·∫¨T)
// function openMatchEdit(id, isFinal) {
//     showModal('S·ª≠a Tr·∫≠n ƒë·∫•u', `T√≠nh nƒÉng s·ª≠a tr·∫≠n ƒë·∫•u (ID: ${id}) qua modal ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng ch·ªânh s·ª≠a tr·ª±c ti·∫øp tr√™n b·∫£ng ƒëi·ªÉm.`);
// }

// Kh·ªüi t·∫°o ·ª©ng d·ª•ng
window.onload = function() {
    loadConfig(); 
    const viewModeSelect = document.getElementById('viewMode'); 
    if (viewModeSelect && viewModeSelect.value !== 'court') {
        viewModeSelect.value = 'court';
    }
    
    // N·∫øu c√≥ token, b·∫Øt ƒë·∫ßu quy tr√¨nh t·∫£i Teams v√† App State t·ª´ GitHub
    if (state.config.token) { 
        loadFromGitHub();
    } else { 
        // T·∫£i c·∫•u h√¨nh s√¢n m·∫∑c ƒë·ªãnh (8 s√¢n) n·∫øu kh√¥ng c√≥ k·∫øt n·ªëi GitHub
        loadDefaultCourtConfig(false); // Load silently
        renderConfig();
        renderMatches();
        tinhVaCapNhatXepHang();
        renderFinals();
        renderFinalResults();
        renderOverview();
        startAutoSave();
    }
};

</script>
</body>
</html>
